<!doctype html>
<html lang="zh-hans">

<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
    <title>Web Locks API</title>
    <meta content="WD" name="w3c-status">
    <!-- <meta content="Bikeshed version 3f621ba99, updated Mon Jul 28 15:38:36 2025 -0700" name="generator"> -->
    <link href="https://www.w3.org/TR/web-locks/" rel="canonical">
    <!-- <meta content="a61a77307d2a0b0928320a2ff9c897b7658a9e2e" name="revision"> -->
    <meta content="dark light" name="color-scheme">
    <style>
        .domintro::before {
            content: 'For web developers (non-normative)';
            text-transform: initial;
        }

        .domintro dt {
            font-family: Menlo, Consolas, "DejaVu Sans Mono", Monaco, monospace;

            padding-top: 0.5em;
            padding-bottom: 1em;
        }

        .domintro dt a {
            color: inherit;
            border-bottom-style: none;
        }

        .domintro dt code {
            font-size: inherit;
        }
    </style>
    <style>
        #speclogo {
            height: 100px;
            width: 100px;
            background-color: transparent;
        }

        main #speclogo {
            position: absolute;
            right: 20px;
            top: 30px;
        }

        .logo #speclogo {
            margin-top: 20px;
        }
    </style>
    <style>
        /* Boilerplate: style-autolinks */
        .css.css,
        .property.property,
        .descriptor.descriptor {
            color: var(--a-normal-text);
            font-size: inherit;
            font-family: inherit;
        }

        .css::before,
        .property::before,
        .descriptor::before {
            content: "‘";
        }

        .css::after,
        .property::after,
        .descriptor::after {
            content: "’";
        }

        .property,
        .descriptor {
            /* Don't wrap property and descriptor names */
            white-space: nowrap;
        }

        .type {
            /* CSS value <type> */
            font-style: italic;
        }

        pre .property::before,
        pre .property::after {
            content: "";
        }

        [data-link-type="property"]::before,
        [data-link-type="propdesc"]::before,
        [data-link-type="descriptor"]::before,
        [data-link-type="value"]::before,
        [data-link-type="function"]::before,
        [data-link-type="at-rule"]::before,
        [data-link-type="selector"]::before,
        [data-link-type="maybe"]::before {
            content: "‘";
        }

        [data-link-type="property"]::after,
        [data-link-type="propdesc"]::after,
        [data-link-type="descriptor"]::after,
        [data-link-type="value"]::after,
        [data-link-type="function"]::after,
        [data-link-type="at-rule"]::after,
        [data-link-type="selector"]::after,
        [data-link-type="maybe"]::after {
            content: "’";
        }

        [data-link-type].production::before,
        [data-link-type].production::after,
        .prod [data-link-type]::before,
        .prod [data-link-type]::after {
            content: "";
        }

        [data-link-type=element],
        [data-link-type=element-attr] {
            font-family: Menlo, Consolas, "DejaVu Sans Mono", monospace;
            font-size: .9em;
        }

        [data-link-type=element]::before {
            content: "<"
        }

        [data-link-type=element]::after {
            content: ">"
        }

        [data-link-type=biblio] {
            white-space: pre;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --selflink-text: black;
                --selflink-bg: silver;
                --selflink-hover-text: white;
            }
        }
    </style>
    <style>
        /* Boilerplate: style-colors */
        /* Any --*-text not paired with a --*-bg is assumed to have a transparent bg */
        :root {
            color-scheme: light dark;

            --text: black;
            --bg: white;

            --unofficial-watermark: url(https://www.w3.org/StyleSheets/TR/2016/logos/UD-watermark);

            --logo-bg: #1a5e9a;
            --logo-active-bg: #c00;
            --logo-text: white;

            --tocnav-normal-text: #707070;
            --tocnav-normal-bg: var(--bg);
            --tocnav-hover-text: var(--tocnav-normal-text);
            --tocnav-hover-bg: #f8f8f8;
            --tocnav-active-text: #c00;
            --tocnav-active-bg: var(--tocnav-normal-bg);

            --tocsidebar-text: var(--text);
            --tocsidebar-bg: #f7f8f9;
            --tocsidebar-shadow: rgba(0, 0, 0, .1);
            --tocsidebar-heading-text: hsla(203, 20%, 40%, .7);

            --toclink-text: var(--text);
            --toclink-underline: #3980b5;
            --toclink-visited-text: var(--toclink-text);
            --toclink-visited-underline: #054572;

            --heading-text: #005a9c;

            --hr-text: var(--text);

            --algo-border: #def;

            --del-text: red;
            --del-bg: transparent;
            --ins-text: #080;
            --ins-bg: transparent;

            --a-normal-text: #034575;
            --a-normal-underline: #bbb;
            --a-visited-text: var(--a-normal-text);
            --a-visited-underline: #707070;
            --a-hover-bg: rgba(75%, 75%, 75%, .25);
            --a-active-text: #c00;
            --a-active-underline: #c00;

            --blockquote-border: silver;
            --blockquote-bg: transparent;
            --blockquote-text: currentcolor;

            --issue-border: #e05252;
            --issue-bg: #fbe9e9;
            --issue-text: var(--text);
            --issueheading-text: #831616;

            --example-border: #e0cb52;
            --example-bg: #fcfaee;
            --example-text: var(--text);
            --exampleheading-text: #574b0f;

            --note-border: #52e052;
            --note-bg: #e9fbe9;
            --note-text: var(--text);
            --noteheading-text: hsl(120, 70%, 30%);
            --notesummary-underline: silver;

            --assertion-border: #aaa;
            --assertion-bg: #eee;
            --assertion-text: black;

            --advisement-border: orange;
            --advisement-bg: #fec;
            --advisement-text: var(--text);
            --advisementheading-text: #b35f00;

            --warning-border: red;
            --warning-bg: hsla(40, 100%, 50%, 0.95);
            --warning-text: var(--text);

            --amendment-border: #330099;
            --amendment-bg: #F5F0FF;
            --amendment-text: var(--text);
            --amendmentheading-text: #220066;

            --def-border: #8ccbf2;
            --def-bg: #def;
            --def-text: var(--text);
            --defrow-border: #bbd7e9;

            --datacell-border: silver;

            --indexinfo-text: #707070;

            --indextable-hover-text: black;
            --indextable-hover-bg: #f7f8f9;

            --outdatedspec-bg: rgba(0, 0, 0, .5);
            --outdatedspec-text: black;
            --outdated-bg: maroon;
            --outdated-text: white;
            --outdated-shadow: red;

            --editedrec-bg: darkorange;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --text: #ddd;
                --bg: black;

                --unofficial-watermark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Cg fill='%23100808' transform='translate(200 200) rotate(-45) translate(-200 -200)' stroke='%23100808' stroke-width='3'%3E%3Ctext x='50%25' y='220' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EUNOFFICIAL%3C/text%3E%3Ctext x='50%25' y='305' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EDRAFT%3C/text%3E%3C/g%3E%3C/svg%3E");

                --logo-bg: #1a5e9a;
                --logo-active-bg: #c00;
                --logo-text: white;

                --tocnav-normal-text: #999;
                --tocnav-normal-bg: var(--bg);
                --tocnav-hover-text: var(--tocnav-normal-text);
                --tocnav-hover-bg: #080808;
                --tocnav-active-text: #f44;
                --tocnav-active-bg: var(--tocnav-normal-bg);

                --tocsidebar-text: var(--text);
                --tocsidebar-bg: #080808;
                --tocsidebar-shadow: rgba(255, 255, 255, .1);
                --tocsidebar-heading-text: hsla(203, 20%, 40%, .7);

                --toclink-text: var(--text);
                --toclink-underline: #6af;
                --toclink-visited-text: var(--toclink-text);
                --toclink-visited-underline: #054572;

                --heading-text: #8af;

                --hr-text: var(--text);

                --algo-border: #456;

                --del-text: #f44;
                --del-bg: transparent;
                --ins-text: #4a4;
                --ins-bg: transparent;

                --a-normal-text: #6af;
                --a-normal-underline: #555;
                --a-visited-text: var(--a-normal-text);
                --a-visited-underline: var(--a-normal-underline);
                --a-hover-bg: rgba(25%, 25%, 25%, .2);
                --a-active-text: #f44;
                --a-active-underline: var(--a-active-text);

                --borderedblock-bg: rgba(255, 255, 255, .05);

                --blockquote-border: silver;
                --blockquote-bg: var(--borderedblock-bg);
                --blockquote-text: currentcolor;

                --issue-border: #e05252;
                --issue-bg: var(--borderedblock-bg);
                --issue-text: var(--text);
                --issueheading-text: hsl(0deg, 70%, 70%);

                --example-border: hsl(50deg, 90%, 60%);
                --example-bg: var(--borderedblock-bg);
                --example-text: var(--text);
                --exampleheading-text: hsl(50deg, 70%, 70%);

                --note-border: hsl(120deg, 100%, 35%);
                --note-bg: var(--borderedblock-bg);
                --note-text: var(--text);
                --noteheading-text: hsl(120, 70%, 70%);
                --notesummary-underline: silver;

                --assertion-border: #444;
                --assertion-bg: var(--borderedblock-bg);
                --assertion-text: var(--text);

                --advisement-border: orange;
                --advisement-bg: #222218;
                --advisement-text: var(--text);
                --advisementheading-text: #f84;

                --warning-border: red;
                --warning-bg: hsla(40, 100%, 20%, 0.95);
                --warning-text: var(--text);

                --amendment-border: #330099;
                --amendment-bg: #080010;
                --amendment-text: var(--text);
                --amendmentheading-text: #cc00ff;

                --def-border: #8ccbf2;
                --def-bg: #080818;
                --def-text: var(--text);
                --defrow-border: #136;

                --datacell-border: silver;

                --indexinfo-text: #aaa;

                --indextable-hover-text: var(--text);
                --indextable-hover-bg: #181818;

                --outdatedspec-bg: rgba(255, 255, 255, .5);
                --outdatedspec-text: black;
                --outdated-bg: maroon;
                --outdated-text: white;
                --outdated-shadow: red;

                --editedrec-bg: darkorange;
            }

            /* In case a transparent-bg image doesn't expect to be on a dark bg,
       which is quite common in practice... */
            img {
                background: white;
            }
        }
    </style>
    <style>
        /* Boilerplate: style-counters */
        body {
            counter-reset: example figure issue;
        }

        .issue {
            counter-increment: issue;
        }

        .issue:not(.no-marker)::before {
            content: "Issue " counter(issue);
        }

        .example {
            counter-increment: example;
        }

        .example:not(.no-marker)::before {
            content: "Example " counter(example);
        }

        .invalid.example:not(.no-marker)::before,
        .illegal.example:not(.no-marker)::before {
            content: "Invalid Example" counter(example);
        }

        figcaption {
            counter-increment: figure;
        }

        figcaption:not(.no-marker)::before {
            content: "Figure " counter(figure) " ";
        }
    </style>
    <style>
        /* Boilerplate: style-dfn-panel */
        :root {
            --dfnpanel-bg: #ddd;
            --dfnpanel-text: var(--text);
            --dfnpanel-target-bg: #ffc;
            --dfnpanel-target-outline: orange;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --dfnpanel-bg: #222;
                --dfnpanel-text: var(--text);
                --dfnpanel-target-bg: #333;
                --dfnpanel-target-outline: silver;
            }
        }

        .dfn-panel {
            position: absolute;
            z-index: 35;
            width: 20em;
            width: 300px;
            height: auto;
            max-height: 500px;
            overflow: auto;
            padding: 0.5em 0.75em;
            font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
            background: var(--dfnpanel-bg);
            color: var(--dfnpanel-text);
            border: outset 0.2em;
            white-space: normal;
            /* in case it's moved into a pre */
        }

        .dfn-panel:not(.on) {
            display: none;
        }

        .dfn-panel * {
            margin: 0;
            padding: 0;
            text-indent: 0;
        }

        .dfn-panel>b {
            display: block;
        }

        .dfn-panel a {
            color: var(--dfnpanel-text);
        }

        .dfn-panel a:not(:hover) {
            text-decoration: none !important;
            border-bottom: none !important;
        }

        .dfn-panel a:focus {
            outline: 5px auto Highlight;
            outline: 5px auto -webkit-focus-ring-color;
        }

        .dfn-panel>b+b {
            margin-top: 0.25em;
        }

        .dfn-panel ul {
            padding: 0 0 0 1em;
            list-style: none;
        }

        .dfn-panel li a {
            max-width: calc(300px - 1.5em - 1em);
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .dfn-panel.activated {
            display: inline-block;
            position: fixed;
            left: 8px;
            bottom: 2em;
            margin: 0 auto;
            max-width: calc(100vw - 1.5em - .4em - .5em);
            max-height: 30vh;
            transition: left 1s ease-out, bottom 1s ease-out;
        }

        .dfn-panel .link-item:hover {
            text-decoration: underline;
        }

        .dfn-panel .link-item .copy-icon {
            opacity: 0;
        }

        .dfn-panel .link-item:hover .copy-icon,
        .dfn-panel .link-item .copy-icon:focus {
            opacity: 1;
        }

        .dfn-panel .copy-icon {
            display: inline-block;
            margin-right: 0.5em;
            width: 0.85em;
            height: 1em;
            border-radius: 3px;
            background-color: #ccc;
            cursor: pointer;
        }

        .dfn-panel .copy-icon .icon {
            width: 100%;
            height: 100%;
            background-color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .dfn-panel .copy-icon .icon::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 1px solid black;
            background-color: #ccc;
            opacity: 0.25;
            transform: translate(3px, -3px);
        }

        .dfn-panel .copy-icon:active .icon::before {
            opacity: 1;
        }

        .dfn-paneled[role="button"] {
            cursor: help;
        }

        .highlighted {
            animation: target-fade 3s;
        }

        @keyframes target-fade {
            from {
                background-color: var(--dfnpanel-target-bg);
                outline: 5px solid var(--dfnpanel-target-outline);
            }

            to {
                color: var(--a-normal-text);
                background-color: transparent;
                outline: transparent;
            }
        }
    </style>
    <style>
        /* Boilerplate: style-idl-highlighting */
        pre.idl.highlight {
            background: var(--borderedblock-bg, var(--def-bg));
        }
    </style>
    <style>
        /* Boilerplate: style-issues */
        a[href].issue-return {
            float: right;
            float: inline-end;
            color: var(--issueheading-text);
            font-weight: bold;
            text-decoration: none;
        }
    </style>
    <style>
        /* Boilerplate: style-md-lists */
        /* This is a weird hack for me not yet following the commonmark spec
   regarding paragraph and lists. */
        [data-md]> :first-child {
            margin-top: 0;
        }

        [data-md]> :last-child {
            margin-bottom: 0;
        }
    </style>
    <style>
        /* Boilerplate: style-mdn-anno */
        :root {
            --mdn-bg: #EEE;
            --mdn-shadow: #999;
            --mdn-nosupport-text: #ccc;
            --mdn-pass: green;
            --mdn-fail: red;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --mdn-bg: #222;
                --mdn-shadow: #444;
                --mdn-nosupport-text: #666;
                --mdn-pass: #690;
                --mdn-fail: #d22;
            }
        }

        .mdn-anno {
            background: var(--mdn-bg, #EEE);
            border-radius: .25em;
            box-shadow: 0 0 3px var(--mdn-shadow, #999);
            color: var(--text, black);
            font: 1em sans-serif;
            hyphens: none;
            max-width: min-content;
            overflow: hidden;
            padding: 0.2em;
            position: absolute;
            right: 0.3em;
            top: auto;
            white-space: nowrap;
            word-wrap: normal;
            z-index: 8;
        }

        .mdn-anno.unpositioned {
            display: none;
        }

        .mdn-anno.overlapping-main {
            opacity: .2;
            transition: opacity .1s;
        }

        .mdn-anno[open] {
            opacity: 1;
            z-index: 9;
            min-width: 9em;
        }

        .mdn-anno:hover {
            opacity: 1;
            outline: var(--text, black) 1px solid;
        }

        .mdn-anno>summary {
            font-weight: normal;
            text-align: right;
            cursor: pointer;
            display: block;
        }

        .mdn-anno>summary>.less-than-two-engines-flag {
            color: var(--mdn-fail);
            padding-right: 2px;
        }

        .mdn-anno>summary>.all-engines-flag {
            color: var(--mdn-pass);
            padding-right: 2px;
        }

        .mdn-anno>summary>span {
            color: #fff;
            background-color: #000;
            font-weight: normal;
            font-family: zillaslab, Palatino, "Palatino Linotype", serif;
            padding: 2px 3px 0px 3px;
            line-height: 1.3em;
            vertical-align: top;
        }

        .mdn-anno>.feature {
            margin-top: 20px;
        }

        .mdn-anno>.feature:not(:first-of-type) {
            border-top: 1px solid #999;
            margin-top: 6px;
            padding-top: 2px;
        }

        .mdn-anno>.feature>.less-than-two-engines-text {
            color: var(--mdn-fail);
        }

        .mdn-anno>.feature>.all-engines-text {
            color: var(--mdn-pass);
        }

        .mdn-anno>.feature>p {
            font-size: .75em;
            margin-top: 6px;
            margin-bottom: 0;
        }

        .mdn-anno>.feature>p+p {
            margin-top: 3px;
        }

        .mdn-anno>.feature>.support {
            display: block;
            font-size: 0.6em;
            margin: 0;
            padding: 0;
            margin-top: 2px;
        }

        .mdn-anno>.feature>.support+div {
            padding-top: 0.5em;
        }

        .mdn-anno>.feature>.support>hr {
            display: block;
            border: none;
            border-top: 1px dotted #999;
            padding: 3px 0px 0px 0px;
            margin: 2px 3px 0px 3px;
        }

        .mdn-anno>.feature>.support>hr::before {
            content: "";
        }

        .mdn-anno>.feature>.support>span {
            padding: 0.2em 0;
            display: block;
            display: table;
        }

        .mdn-anno>.feature>.support>span.no {
            color: var(--mdn-nosupport-text);
            filter: grayscale(100%);
        }

        .mdn-anno>.feature>.support>span.no::before {
            opacity: 0.5;
        }

        .mdn-anno>.feature>.support>span:first-of-type {
            padding-top: 0.5em;
        }

        .mdn-anno>.feature>.support>span>span {
            padding: 0 0.5em;
            display: table-cell;
        }

        .mdn-anno>.feature>.support>span>span:first-child {
            width: 100%;
        }

        .mdn-anno>.feature>.support>span>span:last-child {
            width: 100%;
            white-space: pre;
            padding: 0;
        }

        .mdn-anno>.feature>.support>span::before {
            content: ' ';
            display: table-cell;
            min-width: 1.5em;
            height: 1.5em;
            background: no-repeat center center;
            background-size: contain;
            text-align: right;
            font-size: 0.75em;
            font-weight: bold;
        }

        .mdn-anno>.feature>.support>.chrome_android::before {
            background-image: url(https://resources.whatwg.org/browser-logos/chrome.svg);
        }

        .mdn-anno>.feature>.support>.firefox_android::before {
            background-image: url(https://resources.whatwg.org/browser-logos/firefox.png);
        }

        .mdn-anno>.feature>.support>.chrome::before {
            background-image: url(https://resources.whatwg.org/browser-logos/chrome.svg);
        }

        .mdn-anno>.feature>.support>.edge_blink::before {
            background-image: url(https://resources.whatwg.org/browser-logos/edge.svg);
        }

        .mdn-anno>.feature>.support>.edge::before {
            background-image: url(https://resources.whatwg.org/browser-logos/edge_legacy.svg);
        }

        .mdn-anno>.feature>.support>.firefox::before {
            background-image: url(https://resources.whatwg.org/browser-logos/firefox.png);
        }

        .mdn-anno>.feature>.support>.ie::before {
            background-image: url(https://resources.whatwg.org/browser-logos/ie.png);
        }

        .mdn-anno>.feature>.support>.safari_ios::before {
            background-image: url(https://resources.whatwg.org/browser-logos/safari-ios.svg);
        }

        .mdn-anno>.feature>.support>.nodejs::before {
            background-image: url(https://nodejs.org/favicon.ico);
        }

        .mdn-anno>.feature>.support>.opera_android::before {
            background-image: url(https://resources.whatwg.org/browser-logos/opera.svg);
        }

        .mdn-anno>.feature>.support>.opera::before {
            background-image: url(https://resources.whatwg.org/browser-logos/opera.svg);
        }

        .mdn-anno>.feature>.support>.safari::before {
            background-image: url(https://resources.whatwg.org/browser-logos/safari.png);
        }

        .mdn-anno>.feature>.support>.samsunginternet_android::before {
            background-image: url(https://resources.whatwg.org/browser-logos/samsung.svg);
        }

        .mdn-anno>.feature>.support>.webview_android::before {
            background-image: url(https://resources.whatwg.org/browser-logos/android-webview.png);
        }

        .name-slug-mismatch {
            color: red;
        }

        .caniuse-status:hover {
            z-index: 9;
        }

        /* dt, li, .issue, .note, and .example are "position: relative", so to put annotation at right margin, must move to right of containing block */
        ;

        .h-entry:not(.status-LS) dt>.mdn-anno,
        .h-entry:not(.status-LS) li>.mdn-anno,
        .h-entry:not(.status-LS) .issue>.mdn-anno,
        .h-entry:not(.status-LS) .note>.mdn-anno,
        .h-entry:not(.status-LS) .example>.mdn-anno {
            right: -6.7em;
        }

        .h-entry p+.mdn-anno {
            margin-top: 0;
        }

        h2+.mdn-anno.after {
            margin: -48px 0 0 0;
        }

        h3+.mdn-anno.after {
            margin: -46px 0 0 0;
        }

        h4+.mdn-anno.after {
            margin: -42px 0 0 0;
        }

        h5+.mdn-anno.after {
            margin: -40px 0 0 0;
        }

        h6+.mdn-anno.after {
            margin: -40px 0 0 0;
        }
    </style>
    <style>
        /* Boilerplate: style-ref-hints */
        :root {
            --ref-hint-bg: #ddd;
            --ref-hint-text: var(--text);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --ref-hint-bg: #222;
                --ref-hint-text: var(--text);
            }
        }

        .ref-hint {
            display: inline-block;
            position: absolute;
            z-index: 35;
            width: 20em;
            width: 300px;
            height: auto;
            max-height: 500px;
            overflow: auto;
            padding: 0.5em 0.5em;
            font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
            background: var(--ref-hint-bg);
            color: var(--ref-hint-text);
            border: outset 0.2em;
            white-space: normal;
            /* in case it's moved into a pre */
        }

        .ref-hint * {
            margin: 0;
            padding: 0;
            text-indent: 0;
        }

        .ref-hint ul {
            padding: 0 0 0 1em;
            list-style: none;
        }
    </style>
    <style>
        /* Boilerplate: style-selflinks */
        :root {
            --selflink-text: white;
            --selflink-bg: gray;
            --selflink-hover-text: black;
        }

        .heading,
        .issue,
        .note,
        .example,
        li,
        dt {
            position: relative;
        }

        a.self-link {
            position: absolute;
            top: 0;
            left: calc(-1 * (3.5rem - 26px));
            width: calc(3.5rem - 26px);
            height: 2em;
            text-align: center;
            border: none;
            transition: opacity .2s;
            opacity: .5;
        }

        a.self-link:hover {
            opacity: 1;
        }

        .heading>a.self-link {
            font-size: 83%;
        }

        .example>a.self-link,
        .note>a.self-link,
        .issue>a.self-link {
            /* These blocks are overflow:auto, so positioning outside
       doesn't work. */
            left: auto;
            right: 0;
        }

        li>a.self-link {
            left: calc(-1 * (3.5rem - 26px) - 2em);
        }

        dfn>a.self-link {
            top: auto;
            left: auto;
            opacity: 0;
            width: 1.5em;
            height: 1.5em;
            background: var(--selflink-bg);
            color: var(--selflink-text);
            font-style: normal;
            transition: opacity .2s, background-color .2s, color .2s;
        }

        dfn:hover>a.self-link {
            opacity: 1;
        }

        dfn>a.self-link:hover {
            color: var(--selflink-hover-text);
        }

        a.self-link::before {
            content: "¶";
        }

        .heading>a.self-link::before {
            content: "§";
        }

        dfn>a.self-link::before {
            content: "#";
        }
    </style>
    <style>
        /* Boilerplate: style-syntax-highlighting */
        code.highlight {
            padding: .1em;
            border-radius: .3em;
        }

        pre.highlight,
        pre>code.highlight {
            display: block;
            padding: 1em;
            margin: .5em 0;
            overflow: auto;
            border-radius: 0;
        }

        .highlight:not(.idl) {
            background: rgba(0, 0, 0, .03);
        }

        c-[a] {
            color: #990055
        }

        /* Keyword.Declaration */
        c-[b] {
            color: #990055
        }

        /* Keyword.Type */
        c-[c] {
            color: #708090
        }

        /* Comment */
        c-[d] {
            color: #708090
        }

        /* Comment.Multiline */
        c-[e] {
            color: #0077aa
        }

        /* Name.Attribute */
        c-[f] {
            color: #669900
        }

        /* Name.Tag */
        c-[g] {
            color: #222222
        }

        /* Name.Variable */
        c-[k] {
            color: #990055
        }

        /* Keyword */
        c-[l] {
            color: #000000
        }

        /* Literal */
        c-[m] {
            color: #000000
        }

        /* Literal.Number */
        c-[n] {
            color: #0077aa
        }

        /* Name */
        c-[o] {
            color: #999999
        }

        /* Operator */
        c-[p] {
            color: #999999
        }

        /* Punctuation */
        c-[s] {
            color: #a67f59
        }

        /* Literal.String */
        c-[t] {
            color: #a67f59
        }

        /* Literal.String.Single */
        c-[u] {
            color: #a67f59
        }

        /* Literal.String.Double */
        c-[cp] {
            color: #708090
        }

        /* Comment.Preproc */
        c-[c1] {
            color: #708090
        }

        /* Comment.Single */
        c-[cs] {
            color: #708090
        }

        /* Comment.Special */
        c-[kc] {
            color: #990055
        }

        /* Keyword.Constant */
        c-[kn] {
            color: #990055
        }

        /* Keyword.Namespace */
        c-[kp] {
            color: #990055
        }

        /* Keyword.Pseudo */
        c-[kr] {
            color: #990055
        }

        /* Keyword.Reserved */
        c-[ld] {
            color: #000000
        }

        /* Literal.Date */
        c-[nc] {
            color: #0077aa
        }

        /* Name.Class */
        c-[no] {
            color: #0077aa
        }

        /* Name.Constant */
        c-[nd] {
            color: #0077aa
        }

        /* Name.Decorator */
        c-[ni] {
            color: #0077aa
        }

        /* Name.Entity */
        c-[ne] {
            color: #0077aa
        }

        /* Name.Exception */
        c-[nf] {
            color: #0077aa
        }

        /* Name.Function */
        c-[nl] {
            color: #0077aa
        }

        /* Name.Label */
        c-[nn] {
            color: #0077aa
        }

        /* Name.Namespace */
        c-[py] {
            color: #0077aa
        }

        /* Name.Property */
        c-[ow] {
            color: #999999
        }

        /* Operator.Word */
        c-[mb] {
            color: #000000
        }

        /* Literal.Number.Bin */
        c-[mf] {
            color: #000000
        }

        /* Literal.Number.Float */
        c-[mh] {
            color: #000000
        }

        /* Literal.Number.Hex */
        c-[mi] {
            color: #000000
        }

        /* Literal.Number.Integer */
        c-[mo] {
            color: #000000
        }

        /* Literal.Number.Oct */
        c-[sb] {
            color: #a67f59
        }

        /* Literal.String.Backtick */
        c-[sc] {
            color: #a67f59
        }

        /* Literal.String.Char */
        c-[sd] {
            color: #a67f59
        }

        /* Literal.String.Doc */
        c-[se] {
            color: #a67f59
        }

        /* Literal.String.Escape */
        c-[sh] {
            color: #a67f59
        }

        /* Literal.String.Heredoc */
        c-[si] {
            color: #a67f59
        }

        /* Literal.String.Interpol */
        c-[sx] {
            color: #a67f59
        }

        /* Literal.String.Other */
        c-[sr] {
            color: #a67f59
        }

        /* Literal.String.Regex */
        c-[ss] {
            color: #a67f59
        }

        /* Literal.String.Symbol */
        c-[vc] {
            color: #0077aa
        }

        /* Name.Variable.Class */
        c-[vg] {
            color: #0077aa
        }

        /* Name.Variable.Global */
        c-[vi] {
            color: #0077aa
        }

        /* Name.Variable.Instance */
        c-[il] {
            color: #000000
        }

        /* Literal.Number.Integer.Long */

        @media (prefers-color-scheme: dark) {
            .highlight:not(.idl) {
                background: rgba(255, 255, 255, .05);
            }

            c-[a] {
                color: #d33682
            }

            /* Keyword.Declaration */
            c-[b] {
                color: #d33682
            }

            /* Keyword.Type */
            c-[c] {
                color: #2aa198
            }

            /* Comment */
            c-[d] {
                color: #2aa198
            }

            /* Comment.Multiline */
            c-[e] {
                color: #268bd2
            }

            /* Name.Attribute */
            c-[f] {
                color: #b58900
            }

            /* Name.Tag */
            c-[g] {
                color: #cb4b16
            }

            /* Name.Variable */
            c-[k] {
                color: #d33682
            }

            /* Keyword */
            c-[l] {
                color: #657b83
            }

            /* Literal */
            c-[m] {
                color: #657b83
            }

            /* Literal.Number */
            c-[n] {
                color: #268bd2
            }

            /* Name */
            c-[o] {
                color: #657b83
            }

            /* Operator */
            c-[p] {
                color: #657b83
            }

            /* Punctuation */
            c-[s] {
                color: #6c71c4
            }

            /* Literal.String */
            c-[t] {
                color: #6c71c4
            }

            /* Literal.String.Single */
            c-[u] {
                color: #6c71c4
            }

            /* Literal.String.Double */
            c-[ch] {
                color: #2aa198
            }

            /* Comment.Hashbang */
            c-[cp] {
                color: #2aa198
            }

            /* Comment.Preproc */
            c-[cpf] {
                color: #2aa198
            }

            /* Comment.PreprocFile */
            c-[c1] {
                color: #2aa198
            }

            /* Comment.Single */
            c-[cs] {
                color: #2aa198
            }

            /* Comment.Special */
            c-[kc] {
                color: #d33682
            }

            /* Keyword.Constant */
            c-[kn] {
                color: #d33682
            }

            /* Keyword.Namespace */
            c-[kp] {
                color: #d33682
            }

            /* Keyword.Pseudo */
            c-[kr] {
                color: #d33682
            }

            /* Keyword.Reserved */
            c-[ld] {
                color: #657b83
            }

            /* Literal.Date */
            c-[nc] {
                color: #268bd2
            }

            /* Name.Class */
            c-[no] {
                color: #268bd2
            }

            /* Name.Constant */
            c-[nd] {
                color: #268bd2
            }

            /* Name.Decorator */
            c-[ni] {
                color: #268bd2
            }

            /* Name.Entity */
            c-[ne] {
                color: #268bd2
            }

            /* Name.Exception */
            c-[nf] {
                color: #268bd2
            }

            /* Name.Function */
            c-[nl] {
                color: #268bd2
            }

            /* Name.Label */
            c-[nn] {
                color: #268bd2
            }

            /* Name.Namespace */
            c-[py] {
                color: #268bd2
            }

            /* Name.Property */
            c-[ow] {
                color: #657b83
            }

            /* Operator.Word */
            c-[mb] {
                color: #657b83
            }

            /* Literal.Number.Bin */
            c-[mf] {
                color: #657b83
            }

            /* Literal.Number.Float */
            c-[mh] {
                color: #657b83
            }

            /* Literal.Number.Hex */
            c-[mi] {
                color: #657b83
            }

            /* Literal.Number.Integer */
            c-[mo] {
                color: #657b83
            }

            /* Literal.Number.Oct */
            c-[sa] {
                color: #6c71c4
            }

            /* Literal.String.Affix */
            c-[sb] {
                color: #6c71c4
            }

            /* Literal.String.Backtick */
            c-[sc] {
                color: #6c71c4
            }

            /* Literal.String.Char */
            c-[dl] {
                color: #6c71c4
            }

            /* Literal.String.Delimiter */
            c-[sd] {
                color: #6c71c4
            }

            /* Literal.String.Doc */
            c-[se] {
                color: #6c71c4
            }

            /* Literal.String.Escape */
            c-[sh] {
                color: #6c71c4
            }

            /* Literal.String.Heredoc */
            c-[si] {
                color: #6c71c4
            }

            /* Literal.String.Interpol */
            c-[sx] {
                color: #6c71c4
            }

            /* Literal.String.Other */
            c-[sr] {
                color: #6c71c4
            }

            /* Literal.String.Regex */
            c-[ss] {
                color: #6c71c4
            }

            /* Literal.String.Symbol */
            c-[fm] {
                color: #268bd2
            }

            /* Name.Function.Magic */
            c-[vc] {
                color: #cb4b16
            }

            /* Name.Variable.Class */
            c-[vg] {
                color: #cb4b16
            }

            /* Name.Variable.Global */
            c-[vi] {
                color: #cb4b16
            }

            /* Name.Variable.Instance */
            c-[vm] {
                color: #cb4b16
            }

            /* Name.Variable.Magic */
            c-[il] {
                color: #657b83
            }

            /* Literal.Number.Integer.Long */
        }
    </style>
    <style>
        /* Boilerplate: style-var-click-highlighting */
        /*
Colors were chosen in Lab using https://nixsensor.com/free-color-converter/
D50 2deg illuminant, L in [0,100], a and b in [-128, 128]
0 = lab(85,0,85)
1 = lab(85,80,30)
2 = lab(85,-40,40)
3 = lab(85,-50,0)
4 = lab(85,5,15)
5 = lab(85,-10,-50)
6 = lab(85,35,-15)

For darkmode:
0 = oklab(50%   0%  108%)
1 = oklab(50% -51%   51%)
2 = oklab(50% -64%  -20%)
3 = oklab(50%   6%   19%)
4 = oklab(50% -12%  -64%)
5 = oklab(50%  44%  -19%)  
6 = oklab(50% 102%   38%)
*/

        [data-algorithm] var {
            cursor: pointer;
        }

        var[data-var-color] {
            background-color: var(--var-bg);
            box-shadow: 0 0 0 2px var(--var-bg);
        }

        var[data-var-color] {
            --var-bg: #F4D200;
        }

        var[data-var-color="1"] {
            --var-bg: #FF87A2;
        }

        var[data-var-color="2"] {
            --var-bg: #96E885;
        }

        var[data-var-color="3"] {
            --var-bg: #3EEED2;
        }

        var[data-var-color="4"] {
            --var-bg: #EACFB6;
        }

        var[data-var-color="5"] {
            --var-bg: #82DDFF;
        }

        var[data-var-color="6"] {
            --var-vg: #FFBCF2;
        }

        @media (prefers-color-scheme: dark) {
            var[data-var-color] {
                --var-bg: #bc1a00;
            }

            var[data-var-color="1"] {
                --var-bg: #007f00;
            }

            var[data-var-color="2"] {
                --var-bg: #008698;
            }

            var[data-var-color="3"] {
                --var-bg: #7f5b2b;
            }

            var[data-var-color="4"] {
                --var-bg: #004df3;
            }

            var[data-var-color="5"] {
                --var-bg: #a1248a;
            }

            var[data-var-color="6"] {
                --var-vg: #ff0000;
            }
        }
    </style>
    <link href="https://www.w3.org/StyleSheets/TR/2021/W3C-WD" rel="stylesheet">
    <link href="https://www.w3.org/StyleSheets/TR/2021/dark.css" media="(prefers-color-scheme: dark)" rel="stylesheet"
        type="text/css">

<body class="h-entry">
    <div class="head">
        <p data-fill-with="logo"><a class="logo" href="https://www.w3.org/">
                <img alt="W3C" height="48" src="https://www.w3.org/StyleSheets/TR/2021/logos/W3C" width="72">
            </a>
        </p>
        <h1 class="p-name no-ref" id="title">Web Locks API</h1>
        <p id="w3c-state"><a href="https://www.w3.org/standards/types/#WD">W3C 工作草案</a>，
            <time class="dt-updated" datetime="2025-09-24">2025年9月24日</time>
        </p>
        <details open>
            <summary>关于本文档的更多信息</summary>
            <div data-fill-with="spec-metadata">
                <dl>
                    <dt>本版本：
                    <dd><a class="u-url"
                            href="https://www.w3.org/TR/2025/WD-web-locks-20250924/">https://www.w3.org/TR/2025/WD-web-locks-20250924/</a>
                    <dt>最新发布版本：
                    <dd><a href="https://www.w3.org/TR/web-locks/">https://www.w3.org/TR/web-locks/</a>
                    <dt>编辑草稿：
                    <dd><a href="https://w3c.github.io/web-locks/">https://w3c.github.io/web-locks/</a>
                    <dt>历史版本：
                    <dd><a href="https://www.w3.org/TR/2023/WD-web-locks-20230105/"
                            rel="prev">https://www.w3.org/TR/2023/WD-web-locks-20230105/</a>
                    <dt>历史记录：
                    <dd><a class="u-url"
                            href="https://www.w3.org/standards/history/web-locks/">https://www.w3.org/standards/history/web-locks/</a>
                    <dt>测试套件：
                    <dd><a
                            href="https://github.com/web-platform-tests/wpt/tree/master/web-locks">https://github.com/web-platform-tests/wpt/tree/master/web-locks</a>
                    <dt>反馈：
                    <dd><a href="https://github.com/w3c/web-locks/issues/">GitHub</a>
                    <dd><a href="#issues-index">规范内反馈</a>
                    <dt class="editor">编辑：
                    <dd class="editor p-author h-card vcard" data-editor-id="107856"><a class="p-name fn u-email email"
                            href="mailto:krosylight@mozilla.com">Kagami Rosylight</a> (<a class="p-org org"
                            href="https://www.mozilla.org/">Mozilla</a>)
                    <dt class="editor">前任编辑：
                    <dd class="editor p-author h-card vcard" data-editor-id="61302"><a class="p-name fn u-email email"
                            href="mailto:jsbell@google.com">Joshua Bell</a> (<a class="p-org org"
                            href="https://google.com">Google Inc.</a>)
                </dl>
            </div>
        </details>
        <div data-fill-with="warning"></div>
        <p class="copyright" data-fill-with="copyright"><a href="https://www.w3.org/policies/#copyright">Copyright</a> ©
            2025 <a href="https://www.w3.org/">World Wide Web Consortium</a>. <abbr
                title="World Wide Web Consortium">W3C</abbr><sup>®</sup> <a
                href="https://www.w3.org/policies/#Legal_Disclaimer">liability</a>, <a
                href="https://www.w3.org/policies/#W3C_Trademarks">trademark</a> and <a
                href="https://www.w3.org/copyright/software-license/" rel="license"
                title="W3C Software and Document License">permissive document license</a> rules apply.
        </p>
        <hr title="Separator for header">
    </div>
    <div class="p-summary" data-fill-with="abstract">
        <h2 class="no-num no-toc no-ref heading settled" id="abstract"><span class="content">摘要</span></h2>
        <p>本文档定义了一个 Web 平台 API，允许脚本异步获取某个资源的锁，在执行任务期间持有该锁，然后释放锁。锁被持有时，来自同一源的其他脚本无法获取对同一资源的锁。这使得 Web
            应用中的上下文（窗口、工作者）能够协调资源的使用。</p>
    </div>
    <h2 class="no-num no-toc no-ref heading settled" id="sotd"><span class="content">本文档状态</span></h2>
    <div data-fill-with="status">
        <p><em>本节描述了本文档在发布时的状态。当前 <abbr title="World Wide Web Consortium">W3C</abbr> 发布文档列表及本技术报告的最新版本可在 <a
                    href="https://www.w3.org/TR/"><abbr title="World Wide Web Consortium">W3C</abbr>
                    标准和草案索引</a>中找到。</em>
        </p>
        <p>
            本文档由 <a href="https://www.w3.org/groups/wg/webapps">Web 应用工作组</a>
            按照 <a href="https://www.w3.org/policies/process/20250818/#recs-and-notes">推荐流程</a>
            作为<strong>工作草案</strong>发布。
            作为工作草案发布并不意味着 <abbr title="World Wide Web Consortium">W3C</abbr> 及其成员的认可。
        </p>
        <p>
            这是一个草稿文档，
            可能随时被更新、替换或废弃，
            不应将本文件作为正式成果引用，仅可视为正在进行的工作。
        </p>
        <p>本文档由遵循 <a href="https://www.w3.org/policies/patent-policy/"><abbr
                    title="World Wide Web Consortium">W3C</abbr>
                专利政策</a>的小组制作。<abbr title="World Wide Web Consortium">W3C</abbr> 维护着<a
                href="https://www.w3.org/groups/wg/webapps/ipr"
                rel="disclosure">关于本小组成果的专利公开列表</a>；该页面还包括专利披露说明。如个人知晓某专利包含<a
                href="https://www.w3.org/policies/patent-policy/#def-essential">必要权利要求</a>，必须根据<a
                href="https://www.w3.org/policies/patent-policy/#sec-Disclosure">W3C 专利政策第6节</a>进行披露。
        </p>
        <p>本文档受
            <a href="https://www.w3.org/policies/process/20250818/" id="w3c_process_revision">2025年8月18日 W3C 流程文档</a>
            管辖。
        </p>
    </div>
    <div data-fill-with="at-risk"></div>
    <nav data-fill-with="table-of-contents" id="toc">
        <h2 class="no-num no-toc no-ref" id="contents">目录</h2>
        <ol class="toc" role="directory">
            <li>
                <a href="#introduction"><span class="secno">1</span> <span class="content">简介</span></a>
                <ol class="toc">
                    <li><a href="#usage-overview"><span class="secno">1.1</span> <span class="content">用法概述</span></a>
                    <li><a href="#motivations"><span class="secno">1.2</span> <span class="content">应用动机与场景</span></a>
                </ol>
            <li>
                <a href="#concepts"><span class="secno">2</span> <span class="content">基本概念</span></a>
                <ol class="toc">
                    <li><a href="#resource-names"><span class="secno">2.1</span> <span class="content">资源名称</span></a>
                    <li><a href="#lock-managers"><span class="secno">2.2</span> <span class="content">锁管理器</span></a>
                    <li><a href="#modes-scheduling"><span class="secno">2.3</span> <span
                                class="content">锁模式与调度</span></a>
                    <li><a href="#concept-lock"><span class="secno">2.4</span> <span class="content">锁</span></a>
                    <li><a href="#concept-lock-request"><span class="secno">2.5</span> <span
                                class="content">锁请求</span></a>
                    <li><a href="#termination-of-locks"><span class="secno">2.6</span> <span
                                class="content">锁的终止</span></a>
                </ol>
            <li>
                <a href="#api"><span class="secno">3</span> <span class="content">API</span></a>
                <ol class="toc">
                    <li><a href="#navigator-mixins"><span class="secno">3.1</span> <span class="content">Navigator
                                混入</span></a>
                    <li>
                        <a href="#api-lock-manager"><span class="secno">3.2</span> <span class="content"><code
                                    class="idl"><span>LockManager</span></code> 类</span></a>
                        <ol class="toc">
                            <li><a href="#api-lock-manager-request"><span class="secno">3.2.1</span> <span
                                        class="content"><code class="idl"><span>request()</span></code>
                                        方法</span></a>
                            <li><a href="#api-lock-manager-query"><span class="secno">3.2.2</span> <span
                                        class="content"><code class="idl"><span>query()</span></code>
                                        方法</span></a>
                        </ol>
                    <li><a href="#api-lock"><span class="secno">3.3</span> <span class="content"><code
                                    class="idl"><span>Lock</span></code> 类</span></a>
                </ol>
            <li>
                <a href="#algorithms"><span class="secno">4</span> <span class="content">算法</span></a>
                <ol class="toc">
                    <li><a href="#algorithm-request-lock"><span class="secno">4.1</span> <span
                                class="content">请求锁</span></a>
                    <li><a href="#algorithm-release-lock"><span class="secno">4.2</span> <span
                                class="content">释放锁</span></a>
                    <li><a href="#algorithm-abort-request"><span class="secno">4.3</span> <span
                                class="content">中止请求</span></a>
                    <li><a href="#algorithm-process-request"><span class="secno">4.4</span> <span
                                class="content">处理指定资源名的锁请求队列</span></a>
                    <li><a href="#algorithm-snapshot-state"><span class="secno">4.5</span> <span
                                class="content">锁状态快照</span></a>
                </ol>
            <li>
                <a href="#usage-considerations"><span class="secno">5</span> <span class="content">使用注意事项</span></a>
                <ol class="toc">
                    <li><a href="#deadlocks"><span class="secno">5.1</span> <span class="content">死锁</span></a>
                </ol>
            <li>
                <a href="#security-privacy"><span class="secno">6</span> <span class="content">安全与隐私注意事项</span></a>
                <ol class="toc">
                    <li><a href="#security-scope"><span class="secno">6.1</span> <span class="content">锁作用域</span></a>
                    <li><a href="#private-browsing"><span class="secno">6.2</span> <span class="content">隐私浏览</span></a>
                    <li><a href="#implementation-risks"><span class="secno">6.3</span> <span
                                class="content">实现风险</span></a>
                    <li><a href="#security-privacy-checklist"><span class="secno">6.4</span> <span
                                class="content">安全与隐私清单</span></a>
                </ol>
            <li><a href="#acknowledgements"><span class="secno">7</span> <span class="content">致谢</span></a>
            <li>
                <a href="#w3c-conformance"><span class="secno"></span> <span class="content">一致性</span></a>
                <ol class="toc">
                    <li><a href="#w3c-conventions"><span class="secno"></span> <span class="content">文档约定</span></a>
                    <li><a href="#w3c-conformant-algorithms"><span class="secno"></span> <span
                                class="content">一致性算法</span></a>
                </ol>
            <li>
                <a href="#index"><span class="secno"></span> <span class="content">索引</span></a>
                <ol class="toc">
                    <li><a href="#index-defined-here"><span class="secno"></span> <span
                                class="content">本规范定义的术语</span></a>
                    <li><a href="#index-defined-elsewhere"><span class="secno"></span> <span
                                class="content">引用规范定义的术语</span></a>
                </ol>
            <li>
                <a href="#references"><span class="secno"></span> <span class="content">参考文献</span></a>
                <ol class="toc">
                    <li><a href="#normative"><span class="secno"></span> <span class="content">规范性引用</span></a>
                    <li><a href="#informative"><span class="secno"></span> <span class="content">说明性引用</span></a>
                </ol>
            <li><a href="#idl-index"><span class="secno"></span> <span class="content">IDL 索引</span></a>
            <li><a href="#issues-index"><span class="secno"></span> <span class="content">问题索引</span></a>
        </ol>
    </nav>
    <main>
        <p><img alt="logo" height="100" id="speclogo" src="https://www.w3.org/TR/web-locks/logo-lock.svg" width="100">
        </p>
        <script>
            (function () {
                const logo = document.querySelector('.logo');
                if (logo) logo.appendChild(document.querySelector('#speclogo'));
            })();
        </script>
        <h2 class="heading settled" data-level="1" id="introduction"><span class="secno">1. </span><span
                class="content">简介</span><a class="self-link" href="#introduction"></a></h2>
        <p><em>本节为非规范性内容。</em></p>
        <p>脚本可针对特定的<a data-link-type="dfn" href="#resource-name" id="ref-for-resource-name">资源名称</a>和<a
                data-link-type="dfn" href="#mode" id="ref-for-mode">模式</a>发起<a data-link-type="dfn" href="#lock-request"
                id="ref-for-lock-request">锁请求</a>。调度算法会根据当前和先前的请求状态，最终授予锁请求。<a data-link-type="dfn" href="#lock-concept"
                id="ref-for-lock-concept">锁</a>即为已被授予的请求；它具有<a data-link-type="dfn" href="#resource-name"
                id="ref-for-resource-name①">资源名称</a>和<a data-link-type="dfn" href="#mode"
                id="ref-for-mode①">模式</a>，并以对象的形式返回给脚本。只要锁被持有，可能会阻止其他锁请求被授予（取决于名称和模式）。脚本可释放锁，此时可能允许其他锁请求被授予。</p>
        <p>该 API 提供了可选功能，按需使用，包括：</p>
        <ul>
            <li data-md>
                <p>异步任务返回值，</p>
            <li data-md>
                <p>共享与独占锁模式，</p>
            <li data-md>
                <p>条件获取，</p>
            <li data-md>
                <p>用于查询锁状态的诊断，</p>
            <li data-md>
                <p>用于防止死锁的应急机制。</p>
        </ul>
        <p>协作协调在共享<a data-link-type="dfn" href="https://tc39.github.io/ecma262/#agent" id="ref-for-agent">agent</a>的<a
                data-link-type="dfn" href="https://storage.spec.whatwg.org/#storage-bucket"
                id="ref-for-storage-bucket">存储桶</a>范围内进行；这可能跨越多个<a data-link-type="dfn"
                href="https://html.spec.whatwg.org/multipage/webappapis.html#integration-with-the-javascript-agent-cluster-formalism"
                id="ref-for-integration-with-the-javascript-agent-cluster-formalism">agent 集群</a>。</p>
        <p class="note" role="note"><span class="marker">注意：</span> <a data-link-type="dfn"
                href="https://tc39.github.io/ecma262/#agent" id="ref-for-agent①">Agent</a>大致对应于窗口（标签页）、iframe 和
            worker。<a data-link-type="dfn"
                href="https://html.spec.whatwg.org/multipage/webappapis.html#integration-with-the-javascript-agent-cluster-formalism"
                id="ref-for-integration-with-the-javascript-agent-cluster-formalism①">Agent 集群</a>在某些用户代理实现中对应于独立进程。</p>
        <h3 class="heading settled" data-level="1.1" id="usage-overview"><span class="secno">1.1. </span><span
                class="content">用法概述</span><a class="self-link" href="#usage-overview"></a></h3>
        <p>该 API 的用法如下：</p>
        <ol>
            <li data-md>
                <p>请求锁。</p>
            <li data-md>
                <p>在异步任务中持有锁进行操作。</p>
            <li data-md>
                <p>任务完成后锁自动释放。</p>
        </ol>
        <div class="example" id="example-basic-usage">
            <a class="self-link" href="#example-basic-usage"></a>


            <p>API 的基本用法如下：</p>
            <pre class="language-js highlight">navigator<c- p>.</c->locks<c- p>.</c->request<c- p>(</c-><c- t>'my_resource'</c-><c- p>,</c-> <c- k>async</c-> lock <c- p>=></c-> <c- p>{</c->
   <c- c1>// 已获取锁。</c->
   <c- k>await</c-> do_something<c- p>();</c->
   <c- k>await</c-> do_something_else<c- p>();</c->
   <c- c1>// 现在锁将被释放。</c->
<c- p>});</c->
</pre>
            <p>在异步函数中，可以使用 await 等待锁请求：</p>
            <pre class="language-js highlight"><c- c1>// 请求锁之前。</c->
<c- k>await</c-> navigator<c- p>.</c->locks<c- p>.</c->request<c- p>(</c-><c- t>'my_resource'</c-><c- p>,</c-> <c- k>async</c-> lock <c- p>=></c-> <c- p>{</c->
   <c- c1>// 已获取锁。</c->
   <c- k>await</c-> do_something<c- p>();</c->
   <c- c1>// 现在锁将被释放。</c->
<c- p>});</c->
<c- c1>// 锁释放之后</c->
</pre>
        </div>
        <h3 class="heading settled" data-level="1.2" id="motivations"><span class="secno">1.2. </span><span
                class="content">应用动机与场景</span><a class="self-link" href="#motivations"></a></h3>
        <p>一个基于 Web 的文档编辑器将状态存储在内存中以加快访问，并将更改（作为一系列记录）持久化到诸如<a data-link-type="biblio" href="#biblio-indexeddb-2"
                title="Indexed Database API 2.0">Indexed Database API</a>之类的存储
            API，以增强可靠性和离线使用，同时同步到服务器以支持跨设备使用。当同一文档在两个标签页中被打开编辑时，必须在标签之间协调操作，例如只允许一个标签进行更改或同步文档。需要协调哪个标签处于活动状态（并将内存状态与存储
            API 同步），并在活动标签离开（导航、关闭、崩溃）时让另一个标签成为活动标签。</p>
        <p>在数据同步服务中，会指定一个“主标签页”。只有该标签页应执行某些操作（如网络同步、清理队列数据等）。它持有锁且从不释放。其他标签页可以尝试获取锁，这些尝试将被排队。如果“主标签页”崩溃或关闭，则其他标签页之一将获得锁并成为新的主标签页。
        </p>
        <p><a data-link-type="biblio" href="#biblio-indexeddb-2" title="Indexed Database API 2.0">Indexed Database
                API</a>定义了一个事务模型，允许在同一源下的多个命名存储分区间进行共享读和独占写访问。将这一概念作为原语暴露出来，允许基于资源可用性调度任何 Web 平台活动，例如允许为其他存储类型（如 Caches
            <a data-link-type="biblio" href="#biblio-service-workers"
                title="Service Workers">[Service-Workers]</a>）组合事务，跨存储类型，甚至跨非存储 API（如网络请求）。
        </p>
        <h2 class="heading settled" data-level="2" id="concepts"><span class="secno">2. </span><span
                class="content">基本概念</span><a class="self-link" href="#concepts"></a></h2>
        <p>本规范中：</p>
        <ul>
            <li data-md>
                <p>浏览器中的独立用户配置文件被视为独立的用户代理。</p>
            <li data-md>
                <p>每个<a href="https://github.com/w3ctag/private-mode">隐私模式</a>浏览会话都视为一个独立的用户代理。</p>
        </ul>
        <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#user-agent"
                id="ref-for-user-agent">用户代理</a>拥有一个<dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport
                id="lock-task-queue">锁任务队列</dfn>，其结果为<a data-link-type="dfn"
                href="https://html.spec.whatwg.org/multipage/infrastructure.html#starting-a-new-parallel-queue"
                id="ref-for-starting-a-new-parallel-queue">启动新并行队列</a>。</p>
        <p>以下步骤入队所用的<a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#task-source"
                id="ref-for-task-source">任务来源</a>为<dfn class="dfn-paneled" data-dfn-type="dfn" data-export
                id="web-locks-tasks-source">Web Locks 任务来源</dfn>。</p>
        <h3 class="heading settled" data-level="2.1" id="resource-names"><span class="secno">2.1. </span><span
                class="content">资源名称</span><a class="self-link" href="#resource-names"></a></h3>
        <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="resource-name">资源名称</dfn>是由 Web 应用选择的<a
                data-link-type="dfn" href="https://infra.spec.whatwg.org/#string" id="ref-for-string">JavaScript
                字符串</a>，用于表示抽象资源。</p>
        <p>资源名称除了用于调度算法外没有外部意义，但在共享同一<a data-link-type="dfn" href="https://tc39.github.io/ecma262/#agent"
                id="ref-for-agent②">agent</a>的<a data-link-type="dfn"
                href="https://storage.spec.whatwg.org/#storage-bucket" id="ref-for-storage-bucket①">存储桶</a>之间是全局的。Web
            应用可自由选择资源命名方案。</p>
        <div class="example" id="example-indexeddb-transactions">
            <a class="self-link" href="#example-indexeddb-transactions"></a>
            为模拟 <a data-link-type="biblio" href="#biblio-indexeddb-2"
                title="Indexed Database API 2.0">[IndexedDB-2]</a>中针对命名数据库下的命名存储进行事务锁定，脚本可将资源名称组合为：

            <pre class="language-js highlight">encodeURIComponent<c- p>(</c->db_name<c- p>)</c-> <c- o>+</c-> <c- t>'/'</c-> <c- o>+</c-> encodeURIComponent<c- p>(</c->store_name<c- p>)</c->
</pre>
        </div>
        <p>以 U+002D 连字符（-）开头的资源名称为保留项；请求此类名称将导致抛出异常。</p>
        <h3 class="heading settled" data-level="2.2" id="lock-managers"><span class="secno">2.2. </span><span
                class="content">锁管理器</span><a class="self-link" href="#lock-managers"></a></h3>
        <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="lock-manager">锁管理器</dfn>封装<a
                data-link-type="dfn" href="#lock-concept" id="ref-for-lock-concept①">锁</a>和<a data-link-type="dfn"
                href="#lock-request" id="ref-for-lock-request①">锁请求</a>的状态。每个<a data-link-type="dfn"
                href="https://storage.spec.whatwg.org/#storage-bucket" id="ref-for-storage-bucket②">存储桶</a>通过与 Web Locks
            API 相关联的<a data-link-type="dfn" href="https://storage.spec.whatwg.org/#storage-bottle"
                id="ref-for-storage-bottle">存储瓶</a>包含一个<a data-link-type="dfn" href="#lock-manager"
                id="ref-for-lock-manager">锁管理器</a>。</p>
        <p class="note" role="note"><span class="marker">注意：</span> 共享同一<a data-link-type="dfn"
                href="https://storage.spec.whatwg.org/#storage-bucket" id="ref-for-storage-bucket③">存储桶</a>的页面和
            worker（<a data-link-type="dfn" href="https://tc39.github.io/ecma262/#agent"
                id="ref-for-agent③">agent</a>）在同一用户代理下即使处于不同的<a data-link-type="dfn"
                href="https://html.spec.whatwg.org/multipage/document-sequences.html#browsing-context"
                id="ref-for-browsing-context">浏览上下文</a>，也共享同一个<a data-link-type="dfn" href="#lock-manager"
                id="ref-for-lock-manager①">锁管理器</a>。</p>
        <div class="algorithm" data-algorithm="obtain a lock manager">

            要<dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="obtain-a-lock-manager">获取锁管理器</dfn>，给定一个<a
                data-link-type="dfn"
                href="https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object"
                id="ref-for-environment-settings-object">环境设置对象</a><var>environment</var>，执行以下步骤：

            <ol>
                <li data-md>
                    <p>令<var>map</var>为<a data-link-type="dfn"
                            href="https://storage.spec.whatwg.org/#obtain-a-local-storage-bottle-map"
                            id="ref-for-obtain-a-local-storage-bottle-map">获取本地存储瓶映射</a>的结果，参数为<var>environment</var>和"<code>web-locks</code>"。
                    </p>
                <li data-md>
                    <p>如果<var>map</var>为失败，则返回失败。</p>
                <li data-md>
                    <p>令<var>bottle</var>为<var>map</var>关联的<a data-link-type="dfn"
                            href="https://storage.spec.whatwg.org/#storage-bottle" id="ref-for-storage-bottle①">存储瓶</a>。
                    </p>
                <li data-md>
                    <p>返回<var>bottle</var>关联的<a data-link-type="dfn" href="#lock-manager"
                            id="ref-for-lock-manager②">锁管理器</a>。</p>
            </ol>
        </div>
        <p class="issue" id="issue-73644ca1"><a class="self-link" href="#issue-73644ca1"></a> 此处需完善与<a
                data-link-type="biblio" href="#biblio-storage"
                title="Storage Standard">[Storage]</a>的集成，包括如何从给定环境正确获取锁管理器。</p>
        <h3 class="heading settled" data-level="2.3" id="modes-scheduling"><span class="secno">2.3. </span><span
                class="content">锁模式与调度</span><a class="self-link" href="#modes-scheduling"></a></h3>
        <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="mode">模式</dfn>为"<code
                class="idl"><a data-link-type="idl" href="#dom-lockmode-exclusive" id="ref-for-dom-lockmode-exclusive">exclusive</a></code>"或"<code
                class="idl"><a data-link-type="idl" href="#dom-lockmode-shared" id="ref-for-dom-lockmode-shared">shared</a></code>"。模式可用于模拟常见的<a
                href="https://en.wikipedia.org/wiki/Readers%E2%80%93writer_lock">读者-写者锁</a>模式。如果持有"<code
                class="idl"><a data-link-type="idl" href="#dom-lockmode-exclusive" id="ref-for-dom-lockmode-exclusive①">exclusive</a></code>"锁，则不能授予同名的其他锁。如果持有"<code
                class="idl"><a data-link-type="idl" href="#dom-lockmode-shared" id="ref-for-dom-lockmode-shared①">shared</a></code>"锁，则可以授予其他同名的"<code
                class="idl"><a data-link-type="idl" href="#dom-lockmode-shared" id="ref-for-dom-lockmode-shared②">shared</a></code>"锁，但不能授予"<code
                class="idl"><a data-link-type="idl" href="#dom-lockmode-exclusive" id="ref-for-dom-lockmode-exclusive②">exclusive</a></code>"锁。API
            默认模式为"<code
                class="idl"><a data-link-type="idl" href="#dom-lockmode-exclusive" id="ref-for-dom-lockmode-exclusive③">exclusive</a></code>"。
        </p>
        <p>其他属性如超时、公平性等也可能影响调度。</p>
        <h3 class="heading settled" data-level="2.4" id="concept-lock"><span class="secno">2.4. </span><span
                class="content">锁</span><a class="self-link" href="#concept-lock"></a></h3>
        <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-lt="lock-concept" data-noexport
                id="lock-concept">锁</dfn>表示对共享资源的独占访问。</p>
        <div>
            <p><a data-link-type="dfn" href="#lock-concept" id="ref-for-lock-concept②">锁</a>具有<dfn class="dfn-paneled"
                    data-dfn-for="lock-concept" data-dfn-type="dfn" data-noexport
                    id="lock-concept-agent">agent</dfn>，即<a data-link-type="dfn"
                    href="https://tc39.github.io/ecma262/#agent" id="ref-for-agent④">agent</a>。</p>
            <p><a data-link-type="dfn" href="#lock-concept" id="ref-for-lock-concept③">锁</a>具有<dfn class="dfn-paneled"
                    data-dfn-for="lock-concept" data-dfn-type="dfn" data-noexport
                    id="lock-concept-clientid">clientId</dfn>，为不透明字符串。</p>
            <p><a data-link-type="dfn" href="#lock-concept" id="ref-for-lock-concept④">锁</a>具有<dfn class="dfn-paneled"
                    data-dfn-for="lock-concept" data-dfn-type="dfn" data-noexport
                    id="lock-concept-manager">manager</dfn>，即<a data-link-type="dfn" href="#lock-manager"
                    id="ref-for-lock-manager③">锁管理器</a>。</p>
            <p><a data-link-type="dfn" href="#lock-concept" id="ref-for-lock-concept⑤">锁</a>具有<dfn class="dfn-paneled"
                    data-dfn-for="lock-concept" data-dfn-type="dfn" data-noexport id="lock-concept-name">name</dfn>，即<a
                    data-link-type="dfn" href="#resource-name" id="ref-for-resource-name②">资源名称</a>。</p>
            <p><a data-link-type="dfn" href="#lock-concept" id="ref-for-lock-concept⑥">锁</a>具有<dfn class="dfn-paneled"
                    data-dfn-for="lock-concept" data-dfn-type="dfn" data-noexport
                    id="lock-concept-mode">mode</dfn>，为"<code
                    class="idl"><a data-link-type="idl" href="#dom-lockmode-exclusive" id="ref-for-dom-lockmode-exclusive④">exclusive</a></code>"或"<code
                    class="idl"><a data-link-type="idl" href="#dom-lockmode-shared" id="ref-for-dom-lockmode-shared③">shared</a></code>"。
            </p>
            <p><a data-link-type="dfn" href="#lock-concept" id="ref-for-lock-concept⑦">锁</a>具有<dfn class="dfn-paneled"
                    data-dfn-for="lock-concept" data-dfn-type="dfn" data-noexport
                    id="lock-concept-waiting-promise">waiting promise</dfn>，即一个 Promise。</p>
            <p><a data-link-type="dfn" href="#lock-concept" id="ref-for-lock-concept⑧">锁</a>具有<dfn class="dfn-paneled"
                    data-dfn-for="lock-concept" data-dfn-type="dfn" data-noexport
                    id="lock-concept-released-promise">released promise</dfn>，即一个 Promise。</p>
            <div class="note" role="note">

                锁生命周期相关有两个 Promise：

                <ul>
                    <li data-md>
                        <p>在授予锁时回调隐式或显式提供的 Promise，决定锁持有时长。该 Promise 结算时，锁被释放。称为锁的<a data-link-type="dfn"
                                href="#lock-concept-waiting-promise" id="ref-for-lock-concept-waiting-promise">waiting
                                promise</a>。</p>
                    <li data-md>
                        <p><code
                                class="idl"><a data-link-type="idl" href="#lockmanager" id="ref-for-lockmanager">LockManager</a></code>的<code
                                class="idl"><a data-link-type="idl" href="#dom-lockmanager-request" id="ref-for-dom-lockmanager-request">request()</a></code>方法返回的
                            Promise，在锁释放或请求中止时结算。称为锁的<a data-link-type="dfn" href="#lock-concept-released-promise"
                                id="ref-for-lock-concept-released-promise">released promise</a>。</p>
                </ul>
                <pre class="language-js highlight"><c- a>const</c-> p1 <c- o>=</c-> navigator<c- p>.</c->locks<c- p>.</c->request<c- p>(</c-><c- t>'resource'</c-><c- p>,</c-> lock <c- p>=></c-> <c- p>{</c->
  <c- a>const</c-> p2 <c- o>=</c-> <c- ow>new</c-> Promise<c- p>(</c->r <c- p>=></c-> <c- p>{</c->
    <c- c1>// 使用锁并处理 promise...</c->
  <c- p>});</c->
  <c- k>return</c-> p2<c- p>;</c->
<c- p>});</c->
</pre>
                <p>上述示例中，<code>p1</code>为<a data-link-type="dfn" href="#lock-concept-released-promise"
                        id="ref-for-lock-concept-released-promise①">released promise</a>，<code>p2</code>为<a
                        data-link-type="dfn" href="#lock-concept-waiting-promise"
                        id="ref-for-lock-concept-waiting-promise①">waiting promise</a>。
                    注意，大多数代码会将回调实现为<code>async</code>函数，返回的 Promise 为隐式，如下例所示：</p>
                <pre class="language-js highlight"><c- a>const</c-> p1 <c- o>=</c-> navigator<c- p>.</c->locks<c- p>.</c->request<c- p>(</c-><c- t>'resource'</c-><c- p>,</c-> <c- k>async</c-> lock <c- p>=></c-> <c- p>{</c->
  <c- c1>// 使用锁的逻辑...</c->
<c- p>});</c->
</pre>
                <p>上述代码中，<a data-link-type="dfn" href="#lock-concept-waiting-promise"
                        id="ref-for-lock-concept-waiting-promise②">waiting
                        promise</a>未命名，但作为匿名<code>async</code>回调的返回值依然存在。
                    进一步说明：如果回调非<code>async</code>且返回非 Promise，则返回值会被立即解析为 Promise；锁将在下一个微任务中释放，<a data-link-type="dfn"
                        href="#lock-concept-released-promise" id="ref-for-lock-concept-released-promise②">released
                        promise</a>也将在后续微任务中解析。</p>
            </div>
            <p>每个<a data-link-type="dfn" href="#lock-manager" id="ref-for-lock-manager④">锁管理器</a>有一个<dfn
                    class="dfn-paneled" data-dfn-for="lock manager" data-dfn-type="dfn" data-noexport
                    id="lock-manager-held-lock-set">持有锁集合</dfn>，即一个<a data-link-type="dfn"
                    href="https://infra.spec.whatwg.org/#ordered-set" id="ref-for-ordered-set">有序集合</a>，包含<a
                    data-link-type="dfn" href="#lock-concept" id="ref-for-lock-concept⑨">锁</a>。</p>
            <div class="algorithm" data-algorithm="waiting promise settles">
                <p>当<a data-link-type="dfn" href="#lock-concept" id="ref-for-lock-concept①⓪">锁</a>
                    <var>lock</var>的<a data-link-type="dfn" href="#lock-concept-waiting-promise"
                        id="ref-for-lock-concept-waiting-promise③">等待 promise</a>被解决（fulfilled 或 rejected）时，<a
                        data-link-type="dfn"
                        href="https://html.spec.whatwg.org/multipage/infrastructure.html#enqueue-the-following-steps"
                        id="ref-for-enqueue-the-following-steps①">将以下步骤加入</a><a data-link-type="dfn"
                        href="#lock-task-queue" id="ref-for-lock-task-queue">锁任务队列</a>：
                </p>
                <ol>
                    <li data-md>
                        <p><a data-link-type="dfn" href="#release-the-lock"
                                id="ref-for-release-the-lock">释放锁</a><var>lock</var>。</p>
                    <li data-md>
                        <p><a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#resolve"
                                id="ref-for-resolve">解析</a><var>lock</var>的<a data-link-type="dfn"
                                href="#lock-concept-released-promise"
                                id="ref-for-lock-concept-released-promise③">released promise</a>，其值为<var>lock</var>的<a
                                data-link-type="dfn" href="#lock-concept-waiting-promise"
                                id="ref-for-lock-concept-waiting-promise④">waiting promise</a>。</p>
                </ol>
            </div>
        </div>
        <h3 class="heading settled" data-level="2.5" id="concept-lock-request"><span class="secno">2.5. </span><span
                class="content">锁请求</span><a class="self-link" href="#concept-lock-request"></a></h3>
        <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="lock-request">锁请求</dfn>表示对<a
                data-link-type="dfn" href="#lock-concept" id="ref-for-lock-concept①①">锁</a>的待处理请求。</p>
        <div>
            <p><a data-link-type="dfn" href="#lock-request" id="ref-for-lock-request②">锁请求</a>是一个<a data-link-type="dfn"
                    href="https://infra.spec.whatwg.org/#struct" id="ref-for-struct">结构体</a>，包含<a data-link-type="dfn"
                    href="https://infra.spec.whatwg.org/#struct-item" id="ref-for-struct-item">成员</a> <dfn
                    class="dfn-paneled" data-dfn-for="lock request" data-dfn-type="dfn" data-noexport
                    id="lock-request-agent">agent</dfn>、<dfn class="dfn-paneled" data-dfn-for="lock request"
                    data-dfn-type="dfn" data-noexport id="lock-request-clientid">clientId</dfn>、<dfn class="dfn-paneled"
                    data-dfn-for="lock request" data-dfn-type="dfn" data-noexport
                    id="lock-request-manager">manager</dfn>、<dfn class="dfn-paneled" data-dfn-for="lock request"
                    data-dfn-type="dfn" data-noexport id="lock-request-name">name</dfn>、
                <dfn class="dfn-paneled" data-dfn-for="lock request" data-dfn-type="dfn" data-noexport
                    id="lock-request-mode">mode</dfn>、<dfn class="dfn-paneled" data-dfn-for="lock request"
                    data-dfn-type="dfn" data-noexport id="lock-request-callback">callback</dfn>、<dfn class="dfn-paneled"
                    data-dfn-for="lock request" data-dfn-type="dfn" data-noexport
                    id="lock-request-promise">promise</dfn>，以及<dfn class="dfn-paneled" data-dfn-for="lock request"
                    data-dfn-type="dfn" data-noexport id="lock-request-signal">signal</dfn>。
            </p>
        </div>
        <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="lock-request-queue">锁请求队列</dfn>是<a
                data-link-type="dfn" href="https://infra.spec.whatwg.org/#queue" id="ref-for-queue">队列</a>，包含<a
                data-link-type="dfn" href="#lock-request" id="ref-for-lock-request③">锁请求</a>。</p>
        <p>每个<a data-link-type="dfn" href="#lock-manager" id="ref-for-lock-manager⑤">锁管理器</a>都有一个<dfn
                class="dfn-paneled" data-dfn-for="lock manager" data-dfn-type="dfn" data-noexport
                id="lock-manager-lock-request-queue-map">锁请求队列映射</dfn>，它是一个<a data-link-type="dfn"
                href="https://infra.spec.whatwg.org/#ordered-map" id="ref-for-ordered-map">映射</a>，将<a
                data-link-type="dfn" href="#resource-name" id="ref-for-resource-name③">资源名</a>映射到<a data-link-type="dfn"
                href="#lock-request-queue" id="ref-for-lock-request-queue">锁请求队列</a>。
        </p>
        <div class="algorithm" data-algorithm="get the lock request queue">
            <p>要从<a data-link-type="dfn" href="#lock-manager-lock-request-queue-map"
                    id="ref-for-lock-manager-lock-request-queue-map">锁请求队列映射</a> <var>queueMap</var>中，
                根据<a data-link-type="dfn" href="#resource-name" id="ref-for-resource-name④">资源名</a>
                <var>name</var><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport
                    id="get-the-lock-request-queue">获取锁请求队列</dfn>，请执行以下步骤：
            </p>
            <ol>
                <li data-md>
                    <p>如果<var>queueMap</var>[<var>name</var>]不存在，则<a data-link-type="dfn"
                            href="https://infra.spec.whatwg.org/#map-set"
                            id="ref-for-map-set">设置</a><var>queueMap</var>[<var>name</var>]为一个新的空<a data-link-type="dfn"
                            href="#lock-request-queue" id="ref-for-lock-request-queue①">锁请求队列</a>。</p>
                <li data-md>
                    <p>返回<var>queueMap</var>[<var>name</var>]。</p>
            </ol>
        </div>
        <div class="algorithm" data-algorithm="grantable">
            <p>当以下步骤返回 true 时，<a data-link-type="dfn" href="#lock-request"
                    id="ref-for-lock-request④">锁请求</a><var>request</var>被称为<dfn class="dfn-paneled" data-dfn-type="dfn"
                    data-noexport id="grantable">可授予</dfn>：</p>
            <ol>
                <li data-md>
                    <p>令<var>manager</var>为<var>request</var>的<a data-link-type="dfn" href="#lock-request-manager"
                            id="ref-for-lock-request-manager">manager</a>。</p>
                <li data-md>
                    <p>令<var>queueMap</var>为<var>manager</var>的<a data-link-type="dfn"
                            href="#lock-manager-lock-request-queue-map"
                            id="ref-for-lock-manager-lock-request-queue-map①">锁请求队列映射</a>。</p>
                <li data-md>
                    <p>令<var>name</var>为<var>request</var>的<a data-link-type="dfn" href="#lock-request-name"
                            id="ref-for-lock-request-name">name</a>。</p>
                <li data-md>
                    <p>令<var>queue</var>为从<var>queueMap</var>获取<var>name</var>对应的<a data-link-type="dfn"
                            href="#get-the-lock-request-queue" id="ref-for-get-the-lock-request-queue">锁请求队列</a>的结果。</p>
                <li data-md>
                    <p>令<var>held</var>为<var>manager</var>的<a data-link-type="dfn" href="#lock-manager-held-lock-set"
                            id="ref-for-lock-manager-held-lock-set">已持有锁集合</a>。</p>
                <li data-md>
                    <p>令<var>mode</var>为<var>request</var>的<a data-link-type="dfn" href="#lock-request-mode"
                            id="ref-for-lock-request-mode">mode</a>。</p>
                <li data-md>
                    <p>如果<var>queue</var><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-is-empty"
                            id="ref-for-list-is-empty">非空</a>且<var>request</var>不是<var>queue</var>中的第一个<a
                            data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-item"
                            id="ref-for-list-item">成员</a>，则返回 false。</p>
                <li data-md>
                    <p>如果<var>mode</var>为"<code
                            class="idl"><a data-link-type="idl" href="#dom-lockmode-exclusive" id="ref-for-dom-lockmode-exclusive⑤">exclusive</a></code>"，则当<var>held</var>中没有<a
                            data-link-type="dfn" href="#lock-concept" id="ref-for-lock-concept①②">锁</a>的<a
                            data-link-type="dfn" href="#lock-concept-name"
                            id="ref-for-lock-concept-name">name</a>等于<var>name</var>时返回 true，否则返回 false。</p>
                <li data-md>
                    <p>否则，<var>mode</var>为"<code
                            class="idl"><a data-link-type="idl" href="#dom-lockmode-shared" id="ref-for-dom-lockmode-shared④">shared</a></code>"；当<var>held</var>中没有<a
                            data-link-type="dfn" href="#lock-concept" id="ref-for-lock-concept①③">锁</a>的<a
                            data-link-type="dfn" href="#lock-concept-mode"
                            id="ref-for-lock-concept-mode">mode</a>为"<code
                            class="idl"><a data-link-type="idl" href="#dom-lockmode-exclusive" id="ref-for-dom-lockmode-exclusive⑥">exclusive</a></code>"且<a
                            data-link-type="dfn" href="#lock-concept-name"
                            id="ref-for-lock-concept-name①">name</a>等于<var>name</var>时返回 true，否则返回 false。</p>
            </ol>
        </div>
        <h3 class="heading settled" data-level="2.6" id="termination-of-locks"><span class="secno">2.6. </span><span
                class="content">锁的终止</span><a class="self-link" href="#termination-of-locks"></a></h3>
        <p>每当<a data-link-type="dfn"
                href="https://html.spec.whatwg.org/multipage/document-lifecycle.html#unloading-document-cleanup-steps"
                id="ref-for-unloading-document-cleanup-steps">卸载文档清理步骤</a>针对某个<a data-link-type="dfn"
                href="https://dom.spec.whatwg.org/#concept-document" id="ref-for-concept-document">document</a>运行时，使用其<a
                data-link-type="dfn" href="https://tc39.github.io/ecma262/#agent" id="ref-for-agent⑤">agent</a>执行<a
                data-link-type="dfn" href="#terminate-remaining-locks-and-requests"
                id="ref-for-terminate-remaining-locks-and-requests">终止剩余锁和请求</a>。</p>
        <p>当某个<a data-link-type="dfn" href="https://tc39.github.io/ecma262/#agent" id="ref-for-agent⑥">agent</a>终止时，使用该
            agent 执行<a data-link-type="dfn" href="#terminate-remaining-locks-and-requests"
                id="ref-for-terminate-remaining-locks-and-requests①">终止剩余锁和请求</a>。</p>
        <p class="issue" id="issue-9062c3e0"><a class="self-link" href="#issue-9062c3e0"></a> 当前仅适用于
            worker，且定义较为模糊，因为没有规范的方法在 worker 终止时运行这些步骤。</p>
        <div class="algorithm" data-algorithm="terminate remaining locks and requests">
            <p>要使用<var>agent</var><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport
                    id="terminate-remaining-locks-and-requests">终止剩余锁和请求</dfn>，需在<a data-link-type="dfn"
                    href="https://html.spec.whatwg.org/multipage/infrastructure.html#enqueue-the-following-steps"
                    id="ref-for-enqueue-the-following-steps②">锁任务队列</a>上<a data-link-type="dfn" href="#lock-task-queue"
                    id="ref-for-lock-task-queue①">排队执行以下步骤</a>：</p>
            <ol>
                <li data-md>
                    <p>对于每个<a data-link-type="dfn" href="#lock-request"
                            id="ref-for-lock-request⑤">锁请求</a><var>request</var>，其<a data-link-type="dfn"
                            href="#lock-request-agent" id="ref-for-lock-request-agent">agent</a>等于<var>agent</var>：</p>
                    <ol>
                        <li data-md>
                            <p><a data-link-type="dfn" href="#abort-the-request"
                                    id="ref-for-abort-the-request">中止请求</a><var>request</var>。</p>
                    </ol>
                <li data-md>
                    <p>对于每个<a data-link-type="dfn" href="#lock-concept"
                            id="ref-for-lock-concept①④">锁</a><var>lock</var>，其<a data-link-type="dfn"
                            href="#lock-concept-agent" id="ref-for-lock-concept-agent">agent</a>等于<var>agent</var>：</p>
                    <ol>
                        <li data-md>
                            <p><a data-link-type="dfn" href="#release-the-lock"
                                    id="ref-for-release-the-lock①">释放锁</a><var>lock</var>。</p>
                    </ol>
            </ol>
        </div>
        <h2 class="heading settled" data-level="3" id="api"><span class="secno">3. </span><span
                class="content">API</span><a class="self-link" href="#api"></a></h2>
        <h3 class="heading settled" data-level="3.1" id="navigator-mixins"><span class="secno">3.1. </span><span
                class="content">Navigator 混入</span><a class="self-link" href="#navigator-mixins"></a></h3>
        <pre class="idl highlight def">[<a class="idl-code" data-link-type="extended-attribute" href="https://webidl.spec.whatwg.org/#SecureContext" id="ref-for-SecureContext"><c- g>SecureContext</c-></a>]
<c- b>interface</c-> <c- b>mixin</c-> <dfn class="dfn-paneled idl-code" data-dfn-type="interface" data-export id="navigatorlocks"><code><c- g>NavigatorLocks</c-></code></dfn> {
  <c- b>readonly</c-> <c- b>attribute</c-> <a data-link-type="idl-name" href="#lockmanager" id="ref-for-lockmanager①"><c- n>LockManager</c-></a> <a class="idl-code" data-link-type="attribute" data-readonly data-type="LockManager" href="#dom-navigatorlocks-locks" id="ref-for-dom-navigatorlocks-locks"><c- g>locks</c-></a>;
};
<a data-link-type="idl-name" href="https://html.spec.whatwg.org/multipage/system-state.html#navigator" id="ref-for-navigator"><c- n>Navigator</c-></a> <c- b>includes</c-> <a data-link-type="idl-name" href="#navigatorlocks" id="ref-for-navigatorlocks"><c- n>NavigatorLocks</c-></a>;
<a data-link-type="idl-name" href="https://html.spec.whatwg.org/multipage/workers.html#workernavigator" id="ref-for-workernavigator"><c- n>WorkerNavigator</c-></a> <c- b>includes</c-> <a data-link-type="idl-name" href="#navigatorlocks" id="ref-for-navigatorlocks①"><c- n>NavigatorLocks</c-></a>;
</pre>
        <p>每个<a data-link-type="dfn"
                href="https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object"
                id="ref-for-environment-settings-object①">环境设置对象</a>都有一个<code
                class="idl"><a data-link-type="idl" href="#lockmanager" id="ref-for-lockmanager②">LockManager</a></code>对象。
        </p>
        <p><dfn class="dfn-paneled idl-code" data-dfn-for="NavigatorLocks" data-dfn-type="attribute" data-export
                id="dom-navigatorlocks-locks"><code>locks</code></dfn> getter 的步骤是返回<a data-link-type="dfn"
                href="https://webidl.spec.whatwg.org/#this" id="ref-for-this">this</a>的<a data-link-type="dfn"
                href="https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object"
                id="ref-for-relevant-settings-object">相关设置对象</a>的<code
                class="idl"><a data-link-type="idl" href="#lockmanager" id="ref-for-lockmanager③">LockManager</a></code>对象。
        </p>
        <h3 class="heading settled" data-level="3.2" id="api-lock-manager"><span class="secno">3.2. </span><span
                class="content"><code
                    class="idl"><a data-link-type="idl" href="#lockmanager" id="ref-for-lockmanager④">LockManager</a></code>
                类</span><a class="self-link" href="#api-lock-manager"></a></h3>
        <pre class="idl highlight def">[<a class="idl-code" data-link-type="extended-attribute" href="https://webidl.spec.whatwg.org/#SecureContext" id="ref-for-SecureContext①"><c- g>SecureContext</c-></a>, <a class="idl-code" data-link-type="extended-attribute" href="https://webidl.spec.whatwg.org/#Exposed" id="ref-for-Exposed"><c- g>Exposed</c-></a>=(<c- n>Window</c->,<c- n>Worker</c->)]
<c- b>interface</c-> <dfn class="dfn-paneled idl-code" data-dfn-type="interface" data-export id="lockmanager"><code><c- g>LockManager</c-></code></dfn> {
  <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-promise" id="ref-for-idl-promise"><c- b>Promise</c-></a>&lt;<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-any" id="ref-for-idl-any"><c- b>any</c-></a>> <a class="idl-code" data-link-type="method" href="#dom-lockmanager-request" id="ref-for-dom-lockmanager-request①"><c- g>request</c-></a>(<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-DOMString" id="ref-for-idl-DOMString"><c- b>DOMString</c-></a> <dfn class="dfn-paneled idl-code" data-dfn-for="LockManager/request(name, callback)" data-dfn-type="argument" data-export id="dom-lockmanager-request-name-callback-name"><code><c- g>name</c-></code></dfn>,
                       <a data-link-type="idl-name" href="#callbackdef-lockgrantedcallback" id="ref-for-callbackdef-lockgrantedcallback"><c- n>LockGrantedCallback</c-></a> <dfn class="dfn-paneled idl-code" data-dfn-for="LockManager/request(name, callback)" data-dfn-type="argument" data-export id="dom-lockmanager-request-name-callback-callback"><code><c- g>callback</c-></code></dfn>);
  <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-promise" id="ref-for-idl-promise①"><c- b>Promise</c-></a>&lt;<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-any" id="ref-for-idl-any①"><c- b>any</c-></a>> <a class="idl-code" data-link-type="method" href="#dom-lockmanager-request-name-options-callback" id="ref-for-dom-lockmanager-request-name-options-callback"><c- g>request</c-></a>(<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-DOMString" id="ref-for-idl-DOMString①"><c- b>DOMString</c-></a> <dfn class="dfn-paneled idl-code" data-dfn-for="LockManager/request(name, options, callback)" data-dfn-type="argument" data-export id="dom-lockmanager-request-name-options-callback-name"><code><c- g>name</c-></code></dfn>,
                       <a data-link-type="idl-name" href="#dictdef-lockoptions" id="ref-for-dictdef-lockoptions"><c- n>LockOptions</c-></a> <dfn class="dfn-paneled idl-code" data-dfn-for="LockManager/request(name, options, callback)" data-dfn-type="argument" data-export id="dom-lockmanager-request-name-options-callback-options"><code><c- g>options</c-></code></dfn>,
                       <a data-link-type="idl-name" href="#callbackdef-lockgrantedcallback" id="ref-for-callbackdef-lockgrantedcallback①"><c- n>LockGrantedCallback</c-></a> <dfn class="dfn-paneled idl-code" data-dfn-for="LockManager/request(name, options, callback)" data-dfn-type="argument" data-export id="dom-lockmanager-request-name-options-callback-callback"><code><c- g>callback</c-></code></dfn>);

  <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-promise" id="ref-for-idl-promise②"><c- b>Promise</c-></a>&lt;<a data-link-type="idl-name" href="#dictdef-lockmanagersnapshot" id="ref-for-dictdef-lockmanagersnapshot"><c- n>LockManagerSnapshot</c-></a>> <a class="idl-code" data-link-type="method" href="#dom-lockmanager-query" id="ref-for-dom-lockmanager-query"><c- g>query</c-></a>();
};

<c- b>callback</c-> <dfn class="dfn-paneled idl-code" data-dfn-type="callback" data-export id="callbackdef-lockgrantedcallback"><code><c- g>LockGrantedCallback</c-></code></dfn> = <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-promise" id="ref-for-idl-promise③"><c- b>Promise</c-></a>&lt;<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-any" id="ref-for-idl-any②"><c- b>any</c-></a>> (<a data-link-type="idl-name" href="#lock" id="ref-for-lock"><c- n>Lock</c-></a>? <dfn class="dfn-paneled idl-code" data-dfn-for="LockGrantedCallback" data-dfn-type="argument" data-export id="dom-lockgrantedcallback-lock"><code><c- g>lock</c-></code></dfn>);

<c- b>enum</c-> <dfn class="dfn-paneled idl-code" data-dfn-type="enum" data-export id="enumdef-lockmode"><code><c- g>LockMode</c-></code></dfn> { <dfn class="dfn-paneled idl-code" data-dfn-for="LockMode" data-dfn-type="enum-value" data-export id="dom-lockmode-shared"><code><c- s>"shared"</c-></code></dfn>, <dfn class="dfn-paneled idl-code" data-dfn-for="LockMode" data-dfn-type="enum-value" data-export id="dom-lockmode-exclusive"><code><c- s>"exclusive"</c-></code></dfn> };

<c- b>dictionary</c-> <dfn class="dfn-paneled idl-code" data-dfn-type="dictionary" data-export id="dictdef-lockoptions"><code><c- g>LockOptions</c-></code></dfn> {
  <a data-link-type="idl-name" href="#enumdef-lockmode" id="ref-for-enumdef-lockmode"><c- n>LockMode</c-></a> <dfn class="dfn-paneled idl-code" data-default="&quot;exclusive&quot;" data-dfn-for="LockOptions" data-dfn-type="dict-member" data-export data-type="LockMode" id="dom-lockoptions-mode"><code><c- g>mode</c-></code></dfn> = "exclusive";
  <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-boolean" id="ref-for-idl-boolean"><c- b>boolean</c-></a> <dfn class="dfn-paneled idl-code" data-default="false" data-dfn-for="LockOptions" data-dfn-type="dict-member" data-export data-type="boolean" id="dom-lockoptions-ifavailable"><code><c- g>ifAvailable</c-></code></dfn> = <c- b>false</c->;
  <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-boolean" id="ref-for-idl-boolean①"><c- b>boolean</c-></a> <dfn class="dfn-paneled idl-code" data-default="false" data-dfn-for="LockOptions" data-dfn-type="dict-member" data-export data-type="boolean" id="dom-lockoptions-steal"><code><c- g>steal</c-></code></dfn> = <c- b>false</c->;
  <a data-link-type="idl-name" href="https://dom.spec.whatwg.org/#abortsignal" id="ref-for-abortsignal"><c- n>AbortSignal</c-></a> <dfn class="dfn-paneled idl-code" data-dfn-for="LockOptions" data-dfn-type="dict-member" data-export data-type="AbortSignal" id="dom-lockoptions-signal"><code><c- g>signal</c-></code></dfn>;
};

<c- b>dictionary</c-> <dfn class="dfn-paneled idl-code" data-dfn-type="dictionary" data-export id="dictdef-lockmanagersnapshot"><code><c- g>LockManagerSnapshot</c-></code></dfn> {
  <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#idl-sequence" id="ref-for-idl-sequence"><c- b>sequence</c-></a>&lt;<a data-link-type="idl-name" href="#dictdef-lockinfo" id="ref-for-dictdef-lockinfo"><c- n>LockInfo</c-></a>> <dfn class="dfn-paneled idl-code" data-dfn-for="LockManagerSnapshot" data-dfn-type="dict-member" data-export data-type="sequence<LockInfo>" id="dom-lockmanagersnapshot-held"><code><c- g>held</c-></code></dfn>;
  <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#idl-sequence" id="ref-for-idl-sequence①"><c- b>sequence</c-></a>&lt;<a data-link-type="idl-name" href="#dictdef-lockinfo" id="ref-for-dictdef-lockinfo①"><c- n>LockInfo</c-></a>> <dfn class="dfn-paneled idl-code" data-dfn-for="LockManagerSnapshot" data-dfn-type="dict-member" data-export data-type="sequence<LockInfo>" id="dom-lockmanagersnapshot-pending"><code><c- g>pending</c-></code></dfn>;
};

<c- b>dictionary</c-> <dfn class="dfn-paneled idl-code" data-dfn-type="dictionary" data-export id="dictdef-lockinfo"><code><c- g>LockInfo</c-></code></dfn> {
  <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-DOMString" id="ref-for-idl-DOMString②"><c- b>DOMString</c-></a> <dfn class="dfn-paneled idl-code" data-dfn-for="LockInfo" data-dfn-type="dict-member" data-export data-type="DOMString" id="dom-lockinfo-name"><code><c- g>name</c-></code></dfn>;
  <a data-link-type="idl-name" href="#enumdef-lockmode" id="ref-for-enumdef-lockmode①"><c- n>LockMode</c-></a> <dfn class="dfn-paneled idl-code" data-dfn-for="LockInfo" data-dfn-type="dict-member" data-export data-type="LockMode" id="dom-lockinfo-mode"><code><c- g>mode</c-></code></dfn>;
  <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-DOMString" id="ref-for-idl-DOMString③"><c- b>DOMString</c-></a> <dfn class="dfn-paneled idl-code" data-dfn-for="LockInfo" data-dfn-type="dict-member" data-export data-type="DOMString" id="dom-lockinfo-clientid"><code><c- g>clientId</c-></code></dfn>;
};
</pre>
        <p><code
                class="idl"><a data-link-type="idl" href="#lockmanager" id="ref-for-lockmanager⑤">LockManager</a></code>实例允许脚本发起<a
                data-link-type="dfn" href="#lock-request" id="ref-for-lock-request⑥">锁请求</a>并查询<a data-link-type="dfn"
                href="#lock-manager" id="ref-for-lock-manager⑥">锁管理器</a>的状态。</p>
        <h4 class="heading settled" data-level="3.2.1" id="api-lock-manager-request"><span class="secno">3.2.1.
            </span><span class="content"><code
                    class="idl"><a data-link-type="idl" href="#dom-lockmanager-request" id="ref-for-dom-lockmanager-request②">request()</a></code>
                方法</span><a class="self-link" href="#api-lock-manager-request"></a></h4>
        <div class="domintro note" role="note">
            <dl>
                <dt data-md><var>promise</var> = navigator . locks . <code
                        class="idl"><a data-link-type="idl" href="#dom-lockmanager-request" id="ref-for-dom-lockmanager-request③">request</a></code>(<var>name</var>,
                    <var>callback</var>)
                <dt data-md><var>promise</var> = navigator . locks . <code
                        class="idl"><a data-link-type="idl" href="#dom-lockmanager-request-name-options-callback" id="ref-for-dom-lockmanager-request-name-options-callback①">request</a></code>(<var>name</var>,
                    <var>options</var>, <var>callback</var>)
                <dd data-md>
                    <p><code
                            class="idl"><a data-link-type="idl" href="#dom-lockmanager-request" id="ref-for-dom-lockmanager-request④">request()</a></code>方法用于请求锁。
                    </p>
                    <p><var>name</var>（第一个参数）是<a data-link-type="dfn" href="#resource-name"
                            id="ref-for-resource-name⑤">资源名</a>字符串。</p>
                    <p><var>callback</var>（最后一个参数）是一个<a data-link-type="dfn"
                            href="https://webidl.spec.whatwg.org/#dfn-callback-function"
                            id="ref-for-dfn-callback-function">回调函数</a>，在锁被授予时调用，参数为<code
                            class="idl"><a data-link-type="idl" href="#lock" id="ref-for-lock①">Lock</a></code>。该回调由脚本指定，通常为<code>async</code>函数。锁会一直持有直到回调函数完成。如果传入的是非
                        async 回调，则会自动包装为立即 resolve 的 promise，因此锁只会在同步回调期间持有。</p>
            </dl>
            <p>返回的<var>promise</var>会在锁释放后以回调的结果 resolve（或 reject），如果请求被中止则 reject。</p>
            <p>示例：</p>
            <pre class="language-js highlight"><c- k>try</c-> <c- p>{</c->
  <c- a>const</c-> result <c- o>=</c-> <c- k>await</c-> navigator<c- p>.</c->locks<c- p>.</c->request<c- p>(</c-><c- t>'resource'</c-><c- p>,</c-> <c- k>async</c-> lock <c- p>=></c-> <c- p>{</c->
    <c- c1>// 此处持有锁。</c->
    <c- k>await</c-> do_something<c- p>();</c->
    <c- k>await</c-> do_something_else<c- p>();</c->
    <c- k>return</c-> <c- u>"ok"</c-><c- p>;</c->
    <c- c1>// 锁将在此处释放。</c->
  <c- p>});</c->
  <c- c1>// |result| 为回调的返回值。</c->
<c- p>}</c-> <c- k>catch</c-> <c- p>(</c->ex<c- p>)</c-> <c- p>{</c->
  <c- c1>// 如果回调抛出异常，会在此处捕获。</c->
<c- p>}</c->
</pre>
            <p>无论回调是正常返回还是抛出异常，锁都会被释放。</p>
            <p>可以通过第二个参数指定<var>options</var>字典，<var>callback</var>始终为最后一个参数。</p>
            <dl>
                <dt data-md><var>options</var> . mode
                <dd data-md>
                    <p><code
                            class="idl"><a data-link-type="idl" href="#dom-lockoptions-mode" id="ref-for-dom-lockoptions-mode">mode</a></code>选项可以为"<code
                            class="idl"><a data-link-type="idl" href="#dom-lockmode-exclusive" id="ref-for-dom-lockmode-exclusive⑦">exclusive</a></code>"（默认）或"<code
                            class="idl"><a data-link-type="idl" href="#dom-lockmode-shared" id="ref-for-dom-lockmode-shared⑤">shared</a></code>"。多个标签页/worker可以以"<code
                            class="idl"><a data-link-type="idl" href="#dom-lockmode-shared" id="ref-for-dom-lockmode-shared⑥">shared</a></code>"模式持有同一资源的锁，但只有一个标签页/worker可以以"<code
                            class="idl"><a data-link-type="idl" href="#dom-lockmode-exclusive" id="ref-for-dom-lockmode-exclusive⑧">exclusive</a></code>"模式持有该资源的锁。
                    </p>
                    <p>最常见的用途是允许多个读取者同时访问资源，但防止修改。所有读取锁释放后，单个独占写入者可以获取锁进行修改，之后可以再次由独占写入者或更多共享读取者持有。</p>
            </dl>
            <pre class="language-js highlight"><c- k>await</c-> navigator<c- p>.</c->locks<c- p>.</c->request<c- p>(</c-><c- t>'resource'</c-><c- p>,</c-> <c- p>{</c->mode<c- o>:</c-> <c- t>'shared'</c-><c- p>},</c-> <c- k>async</c-> lock <c- p>=></c-> <c- p>{</c->
  <c- c1>// 此处持有锁。其他上下文也可能以共享模式持有锁，</c->
  <c- c1>// 但不会有其他上下文以独占模式持有锁。</c->
<c- p>});</c->
</pre>
            <dl>
                <dt data-md><var>options</var> . ifAvailable
                <dd data-md>
                    <p>如果<code
                            class="idl"><a data-link-type="idl" href="#dom-lockoptions-ifavailable" id="ref-for-dom-lockoptions-ifavailable">ifAvailable</a></code>选项为<code>true</code>，则仅在无需等待的情况下授予锁。注意这仍然不是<em>同步</em>的；在许多用户代理中，这需要跨进程通信以判断锁是否可授予。如果无法授予锁，则回调以<code>null</code>调用。（这是预期行为，请求不会<em>被拒绝</em>。）
                    </p>
            </dl>
            <pre class="language-js highlight"><c- k>await</c-> navigator<c- p>.</c->locks<c- p>.</c->request<c- p>(</c-><c- t>'resource'</c-><c- p>,</c-> <c- p>{</c->ifAvailable<c- o>:</c-> <c- kc>true</c-><c- p>},</c-> <c- k>async</c-> lock <c- p>=></c-> <c- p>{</c->
  <c- k>if</c-> <c- p>(</c-><c- o>!</c->lock<c- p>)</c-> <c- p>{</c->
    <c- c1>// 未获取锁。可在此处做相应处理。</c->
    <c- k>return</c-><c- p>;</c->
  <c- p>}</c->
  <c- c1>// 此处持有锁。</c->
<c- p>});</c->
</pre>
            <dl>
                <dt data-md><var>options</var> . signal
                <dd data-md>
                    <p><code
                            class="idl"><a data-link-type="idl" href="#dom-lockoptions-signal" id="ref-for-dom-lockoptions-signal">signal</a></code>选项可设置为<code
                            class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#abortsignal" id="ref-for-abortsignal①">AbortSignal</a></code>。这允许中止锁请求，例如在未及时授予锁时：
                    </p>
            </dl>
            <pre class="language-js highlight"><c- a>const</c-> controller <c- o>=</c-> <c- ow>new</c-> AbortController<c- p>();</c->
setTimeout<c- p>(()</c-> <c- p>=></c-> controller<c- p>.</c->abort<c- p>(),</c-> <c- mf>200</c-><c- p>);</c-> <c- c1>// 最多等待 200ms。</c->

<c- k>try</c-> <c- p>{</c->
  <c- k>await</c-> navigator<c- p>.</c->locks<c- p>.</c->request<c- p>(</c->
    <c- t>'resource'</c-><c- p>,</c-> <c- p>{</c->signal<c- o>:</c-> controller<c- p>.</c->signal<c- p>},</c-> <c- k>async</c-> lock <c- p>=></c-> <c- p>{</c->
      <c- c1>// 此处持有锁。</c->
  <c- p>});</c->
  <c- c1>// 此处已完成锁相关操作。</c->
<c- p>}</c-> <c- k>catch</c-> <c- p>(</c->ex<c- p>)</c-> <c- p>{</c->
  <c- c1>// 如果定时器触发，|ex| 会是 error name 为 "AbortError" 的 DOMException。</c->
<c- p>}</c->
</pre>
            <p>如果在锁授予前收到中止信号，则请求 promise 会以<code
                    class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#aborterror" id="ref-for-aborterror">AbortError</a></code>拒绝。一旦锁被授予，signal
                将被忽略。</p>
            <dl>
                <dt data-md><var>options</var> . steal
                <dd data-md>
                    <p>如果<code
                            class="idl"><a data-link-type="idl" href="#dom-lockoptions-steal" id="ref-for-dom-lockoptions-steal">steal</a></code>选项为<code>true</code>，则会释放该资源的所有已持有锁（这些锁的<a
                            data-link-type="dfn" href="#lock-concept-released-promise"
                            id="ref-for-lock-concept-released-promise④">released promise</a>会以<code
                            class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#aborterror" id="ref-for-aborterror①">AbortError</a></code>resolve），并授予该请求，抢占所有排队请求。
                    </p>
                    <p>如果 web 应用检测到不可恢复的状态——例如某个协调点（如 Service Worker）发现持有锁的标签页不再响应——则可使用此选项“抢占”锁。</p>
            </dl>
        </div>
        <div class="advisement">
            谨慎使用<code
                class="idl"><a data-link-type="idl" href="#dom-lockoptions-steal" id="ref-for-dom-lockoptions-steal①">steal</a></code>选项。
            使用后，之前持有锁的代码将无法保证自己是唯一访问该资源的上下文。
            同样，使用该选项的代码也无法保证其他上下文不会继续以拥有资源的方式执行。
            该选项主要用于 web 应用在应用或用户代理出现异常时尝试恢复，此时行为本就不可预测。
        </div>
        <div class="algorithm" data-algorithm="LockManager request method">
            <p><dfn class="dfn-paneled idl-code" data-dfn-for="LockManager" data-dfn-type="method" data-export
                    id="dom-lockmanager-request"><code>request(<var>name</var>, <var>callback</var>)</code></dfn>和
                <dfn class="dfn-paneled idl-code" data-dfn-for="LockManager" data-dfn-type="method" data-export
                    id="dom-lockmanager-request-name-options-callback"><code>request(<var>name</var>, <var>options</var>, <var>callback</var>)</code></dfn>
                方法的步骤如下：
            </p>
            <ol>
                <li data-md>
                    <p>如果未传入<var>options</var>，则令<var>options</var>为一个新的<code
                            class="idl"><a data-link-type="idl" href="#dictdef-lockoptions" id="ref-for-dictdef-lockoptions①">LockOptions</a></code>字典，成员为默认值。
                    </p>
                <li data-md>
                    <p>令<var>environment</var>为<a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#this"
                            id="ref-for-this①">this</a>的<a data-link-type="dfn"
                            href="https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object"
                            id="ref-for-relevant-settings-object①">相关设置对象</a>。</p>
                <li data-md>
                    <p>如果<var>environment</var>的<a data-link-type="dfn"
                            href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global"
                            id="ref-for-concept-relevant-global">相关全局对象</a>的<a data-link-type="dfn"
                            href="https://html.spec.whatwg.org/multipage/nav-history-apis.html#concept-document-window"
                            id="ref-for-concept-document-window">关联 Document</a>不是<a data-link-type="dfn"
                            href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active"
                            id="ref-for-fully-active">完全激活</a>，则返回一个以"<code
                            class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#invalidstateerror" id="ref-for-invalidstateerror">InvalidStateError</a></code>"<code
                            class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-DOMException" id="ref-for-idl-DOMException">DOMException</a></code>拒绝的
                        promise。</p>
                <li data-md>
                    <p>令<var>manager</var>为<a data-link-type="dfn" href="#obtain-a-lock-manager"
                            id="ref-for-obtain-a-lock-manager">获取锁管理器</a>（参数为<var>environment</var>）的结果。如果返回失败，则返回一个以"<code
                            class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#securityerror" id="ref-for-securityerror">SecurityError</a></code>"<code
                            class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-DOMException" id="ref-for-idl-DOMException①">DOMException</a></code>拒绝的
                        promise。</p>
                <li data-md>
                    <p>如果<var>name</var>以 U+002D HYPHEN-MINUS (-) 开头，则返回一个以"<code
                            class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#notsupportederror" id="ref-for-notsupportederror">NotSupportedError</a></code>"<code
                            class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-DOMException" id="ref-for-idl-DOMException②">DOMException</a></code>拒绝的
                        promise。</p>
                <li data-md>
                    <p>如果<var>options</var>["<code>steal</code>"]和<var>options</var>["<code>ifAvailable</code>"]均为
                        true，则返回一个以"<code
                            class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#notsupportederror" id="ref-for-notsupportederror①">NotSupportedError</a></code>"<code
                            class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-DOMException" id="ref-for-idl-DOMException③">DOMException</a></code>拒绝的
                        promise。</p>
                <li data-md>
                    <p>如果<var>options</var>["<code>steal</code>"]为 true 且<var>options</var>["<code>mode</code>"]不是"<code
                            class="idl"><a data-link-type="idl" href="#dom-lockmode-exclusive" id="ref-for-dom-lockmode-exclusive⑨">exclusive</a></code>"，则返回一个以"<code
                            class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#notsupportederror" id="ref-for-notsupportederror②">NotSupportedError</a></code>"<code
                            class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-DOMException" id="ref-for-idl-DOMException④">DOMException</a></code>拒绝的
                        promise。</p>
                <li data-md>
                    <p>如果<var>options</var>["<code>signal</code>"]<a data-link-type="dfn"
                            href="https://infra.spec.whatwg.org/#map-exists"
                            id="ref-for-map-exists①">存在</a>，且<var>options</var>["<code>steal</code>"]或<var>options</var>["<code>ifAvailable</code>"]为
                        true，则返回一个以"<code
                            class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#notsupportederror" id="ref-for-notsupportederror③">NotSupportedError</a></code>"<code
                            class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-DOMException" id="ref-for-idl-DOMException⑤">DOMException</a></code>拒绝的
                        promise。</p>
                <li data-md>
                    <p>如果<var>options</var>["<code>signal</code>"]<a data-link-type="dfn"
                            href="https://infra.spec.whatwg.org/#map-exists" id="ref-for-map-exists②">存在</a>且已<a
                            data-link-type="dfn" href="https://dom.spec.whatwg.org/#abortsignal-aborted"
                            id="ref-for-abortsignal-aborted">中止</a>，则返回一个以<var>options</var>["<code>signal</code>"]的<a
                            data-link-type="dfn" href="https://dom.spec.whatwg.org/#abortsignal-abort-reason"
                            id="ref-for-abortsignal-abort-reason">中止原因</a>拒绝的 promise。</p>
                <li data-md>
                    <p>令<var>promise</var>为<a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#a-new-promise"
                            id="ref-for-a-new-promise">新建 promise</a>。</p>
                <li data-md>
                    <p>使用<var>promise</var>、当前<a data-link-type="dfn" href="https://tc39.github.io/ecma262/#agent"
                            id="ref-for-agent⑦">agent</a>、<var>environment</var>的<a data-link-type="dfn"
                            href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-id"
                            id="ref-for-concept-environment-id">id</a>、<var>manager</var>、<var>callback</var>、<var>name</var>、<var>options</var>["<code>mode</code>"]、<var>options</var>["<code>ifAvailable</code>"]、<var>options</var>["<code>steal</code>"]和<var>options</var>["<code>signal</code>"]<a
                            data-link-type="dfn" href="#request-a-lock" id="ref-for-request-a-lock">请求锁</a>。</p>
                <li data-md>
                    <p>返回<var>promise</var>。</p>
            </ol>
        </div>
        <h4 class="heading settled" data-level="3.2.2" id="api-lock-manager-query"><span class="secno">3.2.2.
            </span><span class="content"><code
                    class="idl"><a data-link-type="idl" href="#dom-lockmanager-query" id="ref-for-dom-lockmanager-query①">query()</a></code>
                方法</span><a class="self-link" href="#api-lock-manager-query"></a></h4>
        <div class="domintro note" role="note">
            <dl>
                <dt data-md><var>state</var> = await navigator . locks . <code
                        class="idl"><a data-link-type="idl" href="#dom-lockmanager-query" id="ref-for-dom-lockmanager-query②">query</a></code>()
                <dd data-md>
                    <p><code
                            class="idl"><a data-link-type="idl" href="#dom-lockmanager-query" id="ref-for-dom-lockmanager-query③">query()</a></code>方法可用于生成某个源的<a
                            data-link-type="dfn" href="#lock-manager" id="ref-for-lock-manager⑦">锁管理器</a>状态快照，允许 web
                        应用检查其锁使用情况，用于日志或调试。</p>
                    <p>返回的 promise resolve 为<var>state</var>，一个普通数据结构（即 JSON 格式），结构如下：</p>
            </dl>
            <pre class="language-js highlight"><c- p>{</c->
  held<c- o>:</c-> <c- p>[</c->
    <c- p>{</c-> name<c- o>:</c-> <c- u>"resource1"</c-><c- p>,</c-> mode<c- o>:</c-> <c- u>"exclusive"</c-><c- p>,</c->
      clientId<c- o>:</c-> <c- u>"8b1e730c-7405-47db-9265-6ee7c73ac153"</c-> <c- p>},</c->
    <c- p>{</c-> name<c- o>:</c-> <c- u>"resource2"</c-><c- p>,</c-> mode<c- o>:</c-> <c- u>"shared"</c-><c- p>,</c->
      clientId<c- o>:</c-> <c- u>"8b1e730c-7405-47db-9265-6ee7c73ac153"</c-> <c- p>},</c->
    <c- p>{</c-> name<c- o>:</c-> <c- u>"resource2"</c-><c- p>,</c-> mode<c- o>:</c-> <c- u>"shared"</c-><c- p>,</c->
      clientId<c- o>:</c-> <c- u>"fad203a5-1f31-472b-a7f7-a3236a1f6d3b"</c-> <c- p>},</c->
  <c- p>],</c->
  pending<c- o>:</c-> <c- p>[</c->
    <c- p>{</c-> name<c- o>:</c-> <c- u>"resource1"</c-><c- p>,</c-> mode<c- o>:</c-> <c- u>"exclusive"</c-><c- p>,</c->
      clientId<c- o>:</c-> <c- u>"fad203a5-1f31-472b-a7f7-a3236a1f6d3b"</c-> <c- p>},</c->
    <c- p>{</c-> name<c- o>:</c-> <c- u>"resource1"</c-><c- p>,</c-> mode<c- o>:</c-> <c- u>"exclusive"</c-><c- p>,</c->
      clientId<c- o>:</c-> <c- u>"d341a5d0-1d8d-4224-be10-704d1ef92a15"</c-> <c- p>},</c->
  <c- p>]</c->
<c- p>}</c->
</pre>
            <p><code>clientId</code>字段对应唯一的上下文（frame 或 worker），与<code
                    class="idl"><a data-link-type="idl" href="https://www.w3.org/TR/service-workers/#client" id="ref-for-client">Client</a></code>的<code
                    class="idl"><a data-link-type="idl" href="https://www.w3.org/TR/service-workers/#dom-client-id" id="ref-for-dom-client-id">id</a></code>属性值相同。
            </p>
        </div>
        <div class="advisement">
            此数据只是某一时刻<a data-link-type="dfn" href="#lock-manager"
                id="ref-for-lock-manager⑧">锁管理器</a>状态的<em>快照</em>。当数据返回给脚本时，实际锁状态可能已发生变化。
        </div>
        <div class="algorithm" data-algorithm="query()" data-algorithm-for="LockManager">
            <p><dfn class="dfn-paneled idl-code" data-dfn-for="LockManager" data-dfn-type="method" data-export
                    id="dom-lockmanager-query"><code>query()</code></dfn>方法的步骤如下：</p>
            <ol>
                <li data-md>
                    <p>令<var>environment</var>为<a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#this"
                            id="ref-for-this②">this</a>的<a data-link-type="dfn"
                            href="https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object"
                            id="ref-for-relevant-settings-object②">相关设置对象</a>。</p>
                <li data-md>
                    <p>如果<var>environment</var>的<a data-link-type="dfn"
                            href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global"
                            id="ref-for-concept-relevant-global①">相关全局对象</a>的<a data-link-type="dfn"
                            href="https://html.spec.whatwg.org/multipage/nav-history-apis.html#concept-document-window"
                            id="ref-for-concept-document-window①">关联 Document</a>不是<a data-link-type="dfn"
                            href="https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active"
                            id="ref-for-fully-active①">完全激活</a>，则返回一个以"<code
                            class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#invalidstateerror" id="ref-for-invalidstateerror①">InvalidStateError</a></code>"<code
                            class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-DOMException" id="ref-for-idl-DOMException⑥">DOMException</a></code>拒绝的
                        promise。</p>
                <li data-md>
                    <p>令<var>manager</var>为<a data-link-type="dfn" href="#obtain-a-lock-manager"
                            id="ref-for-obtain-a-lock-manager①">获取锁管理器</a>（参数为<var>environment</var>）的结果。如果返回失败，则返回一个以"<code
                            class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#securityerror" id="ref-for-securityerror①">SecurityError</a></code>"<code
                            class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-DOMException" id="ref-for-idl-DOMException⑦">DOMException</a></code>拒绝的
                        promise。</p>
                <li data-md>
                    <p>令<var>promise</var>为<a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#a-new-promise"
                            id="ref-for-a-new-promise①">新建 promise</a>。</p>
                <li data-md>
                    <p><a data-link-type="dfn"
                            href="https://html.spec.whatwg.org/multipage/infrastructure.html#enqueue-the-following-steps"
                            id="ref-for-enqueue-the-following-steps③">将以下步骤排队</a>到<var>manager</var>的<a
                            data-link-type="dfn" href="#lock-task-queue" id="ref-for-lock-task-queue②">锁任务队列</a>，以<a
                            data-link-type="dfn" href="#snapshot-the-lock-state"
                            id="ref-for-snapshot-the-lock-state">快照锁状态</a>并传入<var>promise</var>。</p>
                <li data-md>
                    <p>返回<var>promise</var>。</p>
            </ol>
        </div>
        <h3 class="heading settled" data-level="3.3" id="api-lock"><span class="secno">3.3. </span><span
                class="content"><code
                    class="idl"><a data-link-type="idl" href="#lock" id="ref-for-lock②">Lock</a></code>类</span><a
                class="self-link" href="#api-lock"></a></h3>
        <pre class="idl highlight def">[<a class="idl-code" data-link-type="extended-attribute" href="https://webidl.spec.whatwg.org/#SecureContext" id="ref-for-SecureContext②"><c- g>SecureContext</c-></a>, <a class="idl-code" data-link-type="extended-attribute" href="https://webidl.spec.whatwg.org/#Exposed" id="ref-for-Exposed①"><c- g>Exposed</c-></a>=(<c- n>Window</c->,<c- n>Worker</c->)]
<c- b>interface</c-> <dfn class="dfn-paneled idl-code" data-dfn-type="interface" data-export id="lock"><code><c- g>Lock</c-></code></dfn> {
  <c- b>readonly</c-> <c- b>attribute</c-> <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-DOMString" id="ref-for-idl-DOMString④"><c- b>DOMString</c-></a> <a class="idl-code" data-link-type="attribute" data-readonly data-type="DOMString" href="#dom-lock-name" id="ref-for-dom-lock-name"><c- g>name</c-></a>;
  <c- b>readonly</c-> <c- b>attribute</c-> <a data-link-type="idl-name" href="#enumdef-lockmode" id="ref-for-enumdef-lockmode②"><c- n>LockMode</c-></a> <a class="idl-code" data-link-type="attribute" data-readonly data-type="LockMode" href="#dom-lock-mode" id="ref-for-dom-lock-mode"><c- g>mode</c-></a>;
};
</pre>
        <p><code class="idl"><a data-link-type="idl" href="#lock" id="ref-for-lock③">Lock</a></code>对象关联一个<a
                data-link-type="dfn" href="#lock-concept" id="ref-for-lock-concept①⑤">锁</a>。</p>
        <p><dfn class="dfn-paneled idl-code" data-dfn-for="Lock" data-dfn-type="attribute" data-export
                id="dom-lock-name"><code>name</code></dfn> getter 的步骤是返回关联<a data-link-type="dfn" href="#lock-concept"
                id="ref-for-lock-concept①⑥">锁</a>的<a data-link-type="dfn" href="#lock-concept-name"
                id="ref-for-lock-concept-name②">name</a>。</p>
        <p><dfn class="dfn-paneled idl-code" data-dfn-for="Lock" data-dfn-type="attribute" data-export
                id="dom-lock-mode"><code>mode</code></dfn> getter 的步骤是返回关联<a data-link-type="dfn" href="#lock-concept"
                id="ref-for-lock-concept①⑦">锁</a>的<a data-link-type="dfn" href="#lock-concept-mode"
                id="ref-for-lock-concept-mode①">mode</a>。</p>
        <h2 class="heading settled" data-level="4" id="algorithms"><span class="secno">4. </span><span
                class="content">算法</span><a class="self-link" href="#algorithms"></a></h2>
        <h3 class="heading settled" data-level="4.1" id="algorithm-request-lock"><span class="secno">4.1. </span><span
                class="content">请求锁</span><a class="self-link" href="#algorithm-request-lock"></a></h3>
        <div class="algorithm" data-algorithm="request a lock">

            要<dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport
                id="request-a-lock">请求锁</dfn>，参数为<var>promise</var>、<var>agent</var>、<var>clientId</var>、<var>manager</var>、<var>callback</var>、<var>name</var>、<var>mode</var>、<var>ifAvailable</var>、<var>steal</var>和<var>signal</var>：

            <ol>
                <li data-md>
                    <p>令<var>request</var>为新建的<a data-link-type="dfn" href="#lock-request"
                            id="ref-for-lock-request⑦">锁请求</a>（<var>agent</var>、<var>clientId</var>、<var>manager</var>、<var>name</var>、<var>mode</var>、<var>callback</var>、<var>promise</var>、<var>signal</var>）。
                    </p>
                <li data-md>
                    <p>如果<var>signal</var>存在，则<a data-link-type="dfn"
                            href="https://dom.spec.whatwg.org/#abortsignal-add" id="ref-for-abortsignal-add">添加</a>算法<a
                            data-link-type="dfn" href="#signal-to-abort-the-request"
                            id="ref-for-signal-to-abort-the-request">signal to abort the request</a>
                        <var>request</var>（参数<var>signal</var>）到<var>signal</var>。
                    </p>
                <li data-md>
                    <p><a data-link-type="dfn"
                            href="https://html.spec.whatwg.org/multipage/infrastructure.html#enqueue-the-following-steps"
                            id="ref-for-enqueue-the-following-steps④">将以下步骤排队</a>到<a data-link-type="dfn"
                            href="#lock-task-queue" id="ref-for-lock-task-queue③">锁任务队列</a>：</p>
                    <ol>
                        <li data-md>
                            <p>令<var>queueMap</var>为<var>manager</var>的<a data-link-type="dfn"
                                    href="#lock-manager-lock-request-queue-map"
                                    id="ref-for-lock-manager-lock-request-queue-map②">锁请求队列映射</a>。</p>
                        <li data-md>
                            <p>令<var>queue</var>为从<var>queueMap</var>获取<var>name</var>对应的<a data-link-type="dfn"
                                    href="#get-the-lock-request-queue"
                                    id="ref-for-get-the-lock-request-queue①">锁请求队列</a>的结果。</p>
                        <li data-md>
                            <p>令<var>held</var>为<var>manager</var>的<a data-link-type="dfn"
                                    href="#lock-manager-held-lock-set"
                                    id="ref-for-lock-manager-held-lock-set①">已持有锁集合</a>。</p>
                        <li data-md>
                            <p>如果<var>steal</var>为 true，则执行以下步骤：</p>
                            <ol>
                                <li data-md>
                                    <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-iterate"
                                            id="ref-for-list-iterate">遍历</a><var>held</var>中的每个<var>lock</var>：</p>
                                    <ol>
                                        <li data-md>
                                            <p>如果<var>lock</var>的<a data-link-type="dfn" href="#lock-concept-name"
                                                    id="ref-for-lock-concept-name③">name</a>为<var>name</var>，则执行：</p>
                                            <ol>
                                                <li data-md>
                                                    <p><a data-link-type="dfn"
                                                            href="https://infra.spec.whatwg.org/#list-remove"
                                                            id="ref-for-list-remove">移除</a><a data-link-type="dfn"
                                                            href="#lock-concept"
                                                            id="ref-for-lock-concept①⑧">lock</a>从<var>held</var>。</p>
                                                <li data-md>
                                                    <p><a data-link-type="dfn"
                                                            href="https://webidl.spec.whatwg.org/#reject"
                                                            id="ref-for-reject">拒绝</a><var>lock</var>的<a
                                                            data-link-type="dfn" href="#lock-concept-released-promise"
                                                            id="ref-for-lock-concept-released-promise⑤">released
                                                            promise</a>，错误为"<code
                                                            class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#aborterror" id="ref-for-aborterror②">AbortError</a></code>"<code
                                                            class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-DOMException" id="ref-for-idl-DOMException⑧">DOMException</a></code>。
                                                    </p>
                                            </ol>
                                    </ol>
                                <li data-md>
                                    <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-prepend"
                                            id="ref-for-list-prepend">前置</a><var>request</var>到<var>queue</var>。</p>
                            </ol>
                        <li data-md>
                            <p>否则，执行以下步骤：</p>
                            <ol>
                                <li data-md>
                                    <p>如果<var>ifAvailable</var>为 true 且<var>request</var>不是<a data-link-type="dfn"
                                            href="#grantable"
                                            id="ref-for-grantable">grantable</a>，则在<var>callback</var>的<a
                                            data-link-type="dfn"
                                            href="https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object"
                                            id="ref-for-relevant-settings-object③">相关设置对象</a>的<a data-link-type="dfn"
                                            href="https://html.spec.whatwg.org/multipage/webappapis.html#responsible-event-loop"
                                            id="ref-for-responsible-event-loop">负责事件循环</a>上<a data-link-type="dfn"
                                            href="https://html.spec.whatwg.org/multipage/infrastructure.html#enqueue-the-following-steps"
                                            id="ref-for-enqueue-the-following-steps⑤">排队以下步骤</a>：</p>
                                    <ol>
                                        <li data-md>
                                            <p>令<var>r</var>为<a data-link-type="dfn"
                                                    href="https://webidl.spec.whatwg.org/#invoke-a-callback-function"
                                                    id="ref-for-invoke-a-callback-function">调用</a><var>callback</var>，参数为<code>null</code>的结果。
                                            </p>
                                        <li data-md>
                                            <p><a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#resolve"
                                                    id="ref-for-resolve①">resolve</a><var>promise</var>为<var>r</var>，并终止这些步骤。
                                            </p>
                                    </ol>
                                <li data-md>
                                    <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#queue-enqueue"
                                            id="ref-for-queue-enqueue">入队</a><var>request</var>到<var>queue</var>。</p>
                            </ol>
                        <li data-md>
                            <p><a data-link-type="dfn" href="#process-the-lock-request-queue"
                                    id="ref-for-process-the-lock-request-queue">处理锁请求队列</a><var>queue</var>。</p>
                    </ol>
                <li data-md>
                    <p>返回<var>request</var>。</p>
            </ol>
        </div>
        <h3 class="heading settled" data-level="4.2" id="algorithm-release-lock"><span class="secno">4.2. </span><span
                class="content">释放锁</span><a class="self-link" href="#algorithm-release-lock"></a></h3>
        <div class="algorithm" data-algorithm="release the lock">

            要<dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="release-the-lock">释放锁</dfn><var>lock</var>：

            <ol>
                <li data-md>
                    <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#assert"
                            id="ref-for-assert">断言</a>：这些步骤在<a data-link-type="dfn" href="#lock-task-queue"
                            id="ref-for-lock-task-queue④">锁任务队列</a>上运行。</p>
                <li data-md>
                    <p>令<var>manager</var>为<var>lock</var>的<a data-link-type="dfn" href="#lock-concept-manager"
                            id="ref-for-lock-concept-manager">manager</a>。</p>
                <li data-md>
                    <p>令<var>queueMap</var>为<var>manager</var>的<a data-link-type="dfn"
                            href="#lock-manager-lock-request-queue-map"
                            id="ref-for-lock-manager-lock-request-queue-map③">锁请求队列映射</a>。</p>
                <li data-md>
                    <p>令<var>name</var>为<var>lock</var>的<a data-link-type="dfn" href="#resource-name"
                            id="ref-for-resource-name⑥">资源名</a>。</p>
                <li data-md>
                    <p>令<var>queue</var>为从<var>queueMap</var>获取<var>name</var>对应的<a data-link-type="dfn"
                            href="#get-the-lock-request-queue" id="ref-for-get-the-lock-request-queue②">锁请求队列</a>的结果。
                    </p>
                <li data-md>
                    <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-remove"
                            id="ref-for-list-remove①">移除</a><a data-link-type="dfn" href="#lock-concept"
                            id="ref-for-lock-concept①⑨">lock</a>从<var>manager</var>的<a data-link-type="dfn"
                            href="#lock-manager-held-lock-set" id="ref-for-lock-manager-held-lock-set②">已持有锁集合</a>。</p>
                <li data-md>
                    <p><a data-link-type="dfn" href="#process-the-lock-request-queue"
                            id="ref-for-process-the-lock-request-queue①">处理锁请求队列</a><var>queue</var>。</p>
            </ol>
        </div>
        <h3 class="heading settled" data-level="4.3" id="algorithm-abort-request"><span class="secno">4.3. </span><span
                class="content">中止请求</span><a class="self-link" href="#algorithm-abort-request"></a></h3>
        <div class="algorithm" data-algorithm="abort the request">

            要<dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport
                id="abort-the-request">中止请求</dfn><var>request</var>：

            <ol>
                <li data-md>
                    <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#assert"
                            id="ref-for-assert①">断言</a>：这些步骤在<a data-link-type="dfn" href="#lock-task-queue"
                            id="ref-for-lock-task-queue⑤">锁任务队列</a>上运行。</p>
                <li data-md>
                    <p>令<var>manager</var>为<var>request</var>的<a data-link-type="dfn" href="#lock-request-manager"
                            id="ref-for-lock-request-manager①">manager</a>。</p>
                <li data-md>
                    <p>令<var>name</var>为<var>request</var>的<a data-link-type="dfn" href="#lock-request-name"
                            id="ref-for-lock-request-name①">name</a>。</p>
                <li data-md>
                    <p>令<var>queueMap</var>为<var>manager</var>的<a data-link-type="dfn"
                            href="#lock-manager-lock-request-queue-map"
                            id="ref-for-lock-manager-lock-request-queue-map④">锁请求队列映射</a>。</p>
                <li data-md>
                    <p>令<var>queue</var>为从<var>queueMap</var>获取<var>name</var>对应的<a data-link-type="dfn"
                            href="#get-the-lock-request-queue" id="ref-for-get-the-lock-request-queue③">锁请求队列</a>的结果。
                    </p>
                <li data-md>
                    <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-remove"
                            id="ref-for-list-remove②">移除</a><var>request</var>从<var>queue</var>。</p>
                <li data-md>
                    <p><a data-link-type="dfn" href="#process-the-lock-request-queue"
                            id="ref-for-process-the-lock-request-queue②">处理锁请求队列</a><var>queue</var>。</p>
            </ol>
        </div>
        <div class="algorithm" data-algorithm="signal to abort the request">

            要<dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="signal-to-abort-the-request">signal to abort
                the request</dfn><var>request</var>，参数<var>signal</var>：

            <ol>
                <li data-md>
                    <p><a data-link-type="dfn"
                            href="https://html.spec.whatwg.org/multipage/infrastructure.html#enqueue-the-following-steps"
                            id="ref-for-enqueue-the-following-steps⑥">将以下步骤排队</a>到<a data-link-type="dfn"
                            href="#abort-the-request" id="ref-for-abort-the-request①">中止请求</a><var>request</var>的<a
                            data-link-type="dfn" href="#lock-task-queue" id="ref-for-lock-task-queue⑥">锁任务队列</a>。</p>
                <li data-md>
                    <p><a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#reject"
                            id="ref-for-reject①">拒绝</a><var>request</var>的<a data-link-type="dfn"
                            href="#lock-request-promise"
                            id="ref-for-lock-request-promise">promise</a>，错误为<var>signal</var>的<a data-link-type="dfn"
                            href="https://dom.spec.whatwg.org/#abortsignal-abort-reason"
                            id="ref-for-abortsignal-abort-reason①">中止原因</a>。</p>
            </ol>
        </div>
        <h3 class="heading settled" data-level="4.4" id="algorithm-process-request"><span class="secno">4.4.
            </span><span class="content">处理指定资源名的锁请求队列</span><a class="self-link" href="#algorithm-process-request"></a>
        </h3>
        <div class="algorithm" data-algorithm="process the lock request queue">

            要<dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport
                id="process-the-lock-request-queue">处理锁请求队列</dfn><var>queue</var>：

            <ol>
                <li data-md>
                    <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#assert"
                            id="ref-for-assert②">断言</a>：这些步骤在<a data-link-type="dfn" href="#lock-task-queue"
                            id="ref-for-lock-task-queue⑦">锁任务队列</a>上运行。</p>
                <li data-md>
                    <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-iterate"
                            id="ref-for-list-iterate①">遍历</a><var>queue</var>中的每个<var>request</var>：</p>
                    <ol>
                        <li data-md>
                            <p>如果<var>request</var>不是<a data-link-type="dfn" href="#grantable"
                                    id="ref-for-grantable①">grantable</a>，则返回。</p>
                            <p class="note" role="note"><span class="marker">注意：</span>队列中只有第一个成员是
                                grantable。如果某项不可授予，则后续所有项也自动不可授予。</p>
                        <li data-md>
                            <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-remove"
                                    id="ref-for-list-remove③">移除</a><var>request</var>从<var>queue</var>。</p>
                        <li data-md>
                            <p>令<var>agent</var>为<var>request</var>的<a data-link-type="dfn" href="#lock-concept-agent"
                                    id="ref-for-lock-concept-agent①">agent</a>。</p>
                        <li data-md>
                            <p>令<var>manager</var>为<var>request</var>的<a data-link-type="dfn"
                                    href="#lock-request-manager" id="ref-for-lock-request-manager②">manager</a>。</p>
                        <li data-md>
                            <p>令<var>clientId</var>为<var>request</var>的<a data-link-type="dfn"
                                    href="#lock-request-clientid" id="ref-for-lock-request-clientid">clientId</a>。</p>
                        <li data-md>
                            <p>令<var>name</var>为<var>request</var>的<a data-link-type="dfn" href="#lock-request-name"
                                    id="ref-for-lock-request-name②">name</a>。</p>
                        <li data-md>
                            <p>令<var>mode</var>为<var>request</var>的<a data-link-type="dfn" href="#lock-request-mode"
                                    id="ref-for-lock-request-mode①">mode</a>。</p>
                        <li data-md>
                            <p>令<var>callback</var>为<var>request</var>的<a data-link-type="dfn"
                                    href="#lock-request-callback" id="ref-for-lock-request-callback">callback</a>。</p>
                        <li data-md>
                            <p>令<var>p</var>为<var>request</var>的<a data-link-type="dfn" href="#lock-request-promise"
                                    id="ref-for-lock-request-promise①">promise</a>。</p>
                        <li data-md>
                            <p>令<var>signal</var>为<var>request</var>的<a data-link-type="dfn" href="#lock-request-signal"
                                    id="ref-for-lock-request-signal">signal</a>。</p>
                        <li data-md>
                            <p>令<var>waiting</var>为<a data-link-type="dfn"
                                    href="https://webidl.spec.whatwg.org/#a-new-promise" id="ref-for-a-new-promise②">新建
                                    promise</a>。</p>
                        <li data-md>
                            <p>令<var>lock</var>为新建的<a data-link-type="dfn" href="#lock-concept"
                                    id="ref-for-lock-concept②⓪">锁</a>，参数为<a data-link-type="dfn"
                                    href="#lock-concept-agent"
                                    id="ref-for-lock-concept-agent②">agent</a><var>agent</var>、<a data-link-type="dfn"
                                    href="#lock-concept-clientid"
                                    id="ref-for-lock-concept-clientid">clientId</a><var>clientId</var>、<a
                                    data-link-type="dfn" href="#lock-concept-manager"
                                    id="ref-for-lock-concept-manager①">manager</a><var>manager</var>、<a
                                    data-link-type="dfn" href="#lock-concept-mode"
                                    id="ref-for-lock-concept-mode②">mode</a><var>mode</var>、<a data-link-type="dfn"
                                    href="#lock-concept-name" id="ref-for-lock-concept-name④">name</a><var>name</var>、<a
                                    data-link-type="dfn" href="#lock-concept-released-promise"
                                    id="ref-for-lock-concept-released-promise⑥">released promise</a><var>p</var>、<a
                                    data-link-type="dfn" href="#lock-concept-waiting-promise"
                                    id="ref-for-lock-concept-waiting-promise⑤">waiting promise</a><var>waiting</var>。
                            </p>
                        <li data-md>
                            <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#set-append"
                                    id="ref-for-set-append">追加</a><var>lock</var>到<var>manager</var>的<a
                                    data-link-type="dfn" href="#lock-manager-held-lock-set"
                                    id="ref-for-lock-manager-held-lock-set③">已持有锁集合</a>。</p>
                        <li data-md>
                            <p><a data-link-type="dfn"
                                    href="https://html.spec.whatwg.org/multipage/infrastructure.html#enqueue-the-following-steps"
                                    id="ref-for-enqueue-the-following-steps⑦">将以下步骤排队</a>到<var>callback</var>的<a
                                    data-link-type="dfn"
                                    href="https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object"
                                    id="ref-for-relevant-settings-object④">相关设置对象</a>的<a data-link-type="dfn"
                                    href="https://html.spec.whatwg.org/multipage/webappapis.html#responsible-event-loop"
                                    id="ref-for-responsible-event-loop①">负责事件循环</a>：</p>
                            <ol>
                                <li data-md>
                                    <p>如果<var>signal</var>存在，则执行：</p>
                                    <ol>
                                        <li data-md>
                                            <p>如果<var>signal</var>已<a data-link-type="dfn"
                                                    href="https://dom.spec.whatwg.org/#abortsignal-aborted"
                                                    id="ref-for-abortsignal-aborted①">中止</a>，则执行：</p>
                                            <ol>
                                                <li data-md>
                                                    <p><a data-link-type="dfn"
                                                            href="https://html.spec.whatwg.org/multipage/infrastructure.html#enqueue-the-following-steps"
                                                            id="ref-for-enqueue-the-following-steps⑧">将以下步骤排队</a>到<a
                                                            data-link-type="dfn" href="#lock-task-queue"
                                                            id="ref-for-lock-task-queue⑧">锁任务队列</a>：</p>
                                                    <ol>
                                                        <li data-md>
                                                            <p><a data-link-type="dfn" href="#release-the-lock"
                                                                    id="ref-for-release-the-lock②">释放锁</a><var>lock</var>。
                                                            </p>
                                                    </ol>
                                                <li data-md>
                                                    <p>返回。</p>
                                            </ol>
                                        <li data-md>
                                            <p><a data-link-type="dfn"
                                                    href="https://dom.spec.whatwg.org/#abortsignal-remove"
                                                    id="ref-for-abortsignal-remove">移除</a>算法<a data-link-type="dfn"
                                                    href="#signal-to-abort-the-request"
                                                    id="ref-for-signal-to-abort-the-request①">signal to abort the
                                                    request</a><var>request</var>从<var>signal</var>。</p>
                                    </ol>
                                <li data-md>
                                    <p>令<var>r</var>为<a data-link-type="dfn"
                                            href="https://webidl.spec.whatwg.org/#invoke-a-callback-function"
                                            id="ref-for-invoke-a-callback-function①">调用</a><var>callback</var>，参数为新建的、关联<var>lock</var>的<code
                                            class="idl"><a data-link-type="idl" href="#lock" id="ref-for-lock④">Lock</a></code>对象。
                                    </p>
                                <li data-md>
                                    <p><a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#resolve"
                                            id="ref-for-resolve②">resolve</a><var>waiting</var>为<var>r</var>。</p>
                            </ol>
                    </ol>
            </ol>
        </div>
        <h3 class="heading settled" data-level="4.5" id="algorithm-snapshot-state"><span class="secno">4.5. </span><span
                class="content">锁状态快照</span><a class="self-link" href="#algorithm-snapshot-state"></a>
        </h3>
        <div class="algorithm" data-algorithm="snapshot the lock state">

            要为<var>manager</var>和<var>promise</var><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport
                id="snapshot-the-lock-state">快照锁状态</dfn>：

            <ol>
                <li data-md>
                    <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#assert"
                            id="ref-for-assert③">断言</a>：这些步骤在<a data-link-type="dfn" href="#lock-task-queue"
                            id="ref-for-lock-task-queue⑨">锁任务队列</a>上运行。</p>
                <li data-md>
                    <p>令<var>pending</var>为新建的<a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list"
                            id="ref-for-list">列表</a>。</p>
                <li data-md>
                    <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#map-iterate"
                            id="ref-for-map-iterate">遍历</a><var>manager</var>的<a data-link-type="dfn"
                            href="#lock-manager-lock-request-queue-map"
                            id="ref-for-lock-manager-lock-request-queue-map⑤">锁请求队列映射</a>的<a data-link-type="dfn"
                            href="https://infra.spec.whatwg.org/#map-getting-the-values"
                            id="ref-for-map-getting-the-values">所有值</a>，即每个<var>queue</var>：</p>
                    <ol>
                        <li data-md>
                            <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-iterate"
                                    id="ref-for-list-iterate②">遍历</a><var>queue</var>中的每个<var>request</var>：</p>
                            <ol>
                                <li data-md>
                                    <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-append"
                                            id="ref-for-list-append">追加</a>«[ "name" → <var>request</var>的<a
                                            data-link-type="dfn" href="#lock-request-name"
                                            id="ref-for-lock-request-name③">name</a>, "mode" → <var>request</var>的<a
                                            data-link-type="dfn" href="#lock-request-mode"
                                            id="ref-for-lock-request-mode②">mode</a>, "clientId" → <var>request</var>的
                                        <a data-link-type="dfn" href="#lock-request-clientid"
                                            id="ref-for-lock-request-clientid①">clientId</a> ]»到<var>pending</var>。
                                    </p>
                            </ol>
                    </ol>
                <li data-md>
                    <p>令<var>held</var>为新建的<a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list"
                            id="ref-for-list①">列表</a>。</p>
                <li data-md>
                    <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-iterate"
                            id="ref-for-list-iterate③">遍历</a><var>manager</var>的<a data-link-type="dfn"
                            href="#lock-manager-held-lock-set"
                            id="ref-for-lock-manager-held-lock-set④">已持有锁集合</a>中的每个<var>lock</var>：</p>
                    <ol>
                        <li data-md>
                            <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-append"
                                    id="ref-for-list-append①">追加</a>«[ "name" → <var>lock</var>的<a data-link-type="dfn"
                                    href="#lock-concept-name" id="ref-for-lock-concept-name⑤">name</a>, "mode" →
                                <var>lock</var>的<a data-link-type="dfn" href="#lock-concept-mode"
                                    id="ref-for-lock-concept-mode③">mode</a>, "clientId" → <var>lock</var>的<a
                                    data-link-type="dfn" href="#lock-concept-clientid"
                                    id="ref-for-lock-concept-clientid①">clientId</a> ]»到<var>held</var>。
                            </p>
                    </ol>
                <li data-md>
                    <p><a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#resolve"
                            id="ref-for-resolve③">resolve</a><var>promise</var>为«[ "held" → <var>held</var>,
                        "pending" → <var>pending</var> ]»。</p>
            </ol>
        </div>
        <div class="note" role="note">

            对于任意资源，pending 锁请求的快照会按请求发起顺序返回；
            但不同资源间的请求顺序不保证。例如，若对资源 A 依次发起 A1、A2 请求，对资源 B 依次发起 B1、B2 请求，则«A1, A2, B1, B2»和«A1, B1, A2, B2»都可能作为快照的
            pending 列表顺序。

            <p>已持有锁状态的快照不保证顺序。</p>
        </div>
        <h2 class="heading settled" data-level="5" id="usage-considerations"><span class="secno">5. </span><span
                class="content">使用注意事项</span><a class="self-link" href="#usage-considerations"></a></h2>
        <p><em>本节为非规范性内容。</em></p>
        <h3 class="heading settled" data-level="5.1" id="deadlocks"><span class="secno">5.1. </span><span
                class="content">死锁</span><a class="self-link" href="#deadlocks"></a></h3>
        <p><a href="https://en.wikipedia.org/wiki/Deadlock">死锁</a>是并发计算中的一个概念，针对特定<a data-link-type="dfn"
                href="#lock-manager" id="ref-for-lock-manager⑨">锁管理器</a>的死锁可以通过本 API 引入。</p>
        <div class="example" id="example-deadlocks">
            <a class="self-link" href="#example-deadlocks"></a>
            通过本 API 可能遇到死锁的示例如下：

            <p>脚本 1：</p>
            <pre class="language-js highlight">navigator<c- p>.</c->locks<c- p>.</c->request<c- p>(</c-><c- t>'A'</c-><c- p>,</c-> <c- k>async</c-> a <c- p>=></c-> <c- p>{</c->
  <c- k>await</c-> navigator<c- p>.</c->locks<c- p>.</c->request<c- p>(</c-><c- t>'B'</c-><c- p>,</c-> <c- k>async</c-> b <c- p>=></c-> <c- p>{</c->
    <c- c1>// do stuff with A and B</c->
  <c- p>});</c->
<c- p>});</c->
</pre>
            <p>脚本 2：</p>
            <pre class="language-js highlight">navigator<c- p>.</c->locks<c- p>.</c->request<c- p>(</c-><c- t>'B'</c-><c- p>,</c-> <c- k>async</c-> b <c- p>=></c-> <c- p>{</c->
  <c- k>await</c-> navigator<c- p>.</c->locks<c- p>.</c->request<c- p>(</c-><c- t>'A'</c-><c- p>,</c-> <c- k>async</c-> a <c- p>=></c-> <c- p>{</c->
    <c- c1>// do stuff with A and B</c->
  <c- p>});</c->
<c- p>});</c->
</pre>
            <p>如果脚本 1 和脚本 2几乎同时运行，则可能出现脚本 1持有锁 A、脚本 2持有锁 B，且双方都无法继续——即死锁。这不会影响整个用户代理，不会暂停标签页，也不会影响同源的其他脚本，但此功能会被阻塞。</p>
        </div>
        <p>防止死锁需要谨慎。一个方法是始终按严格顺序获取多个锁。</p>
        <div class="example" id="example-request-multiple-locks">
            <a class="self-link" href="#example-request-multiple-locks"></a>

            <p>如下辅助函数可用于按一致顺序请求多个锁：</p>
            <pre class="language-js highlight"><c- k>async</c-> <c- a>function</c-> requestMultiple<c- p>(</c->resources<c- p>,</c-> callback<c- p>)</c-> <c- p>{</c->
  <c- a>const</c-> sortedResources <c- o>=</c-> <c- p>[...</c->resources<c- p>];</c->
  sortedResources<c- p>.</c->sort<c- p>();</c-> <c- c1>// 始终按相同顺序请求。</c->

  <c- k>async</c-> <c- a>function</c-> requestNext<c- p>(</c->locks<c- p>)</c-> <c- p>{</c->
    <c- k>return</c-> <c- k>await</c-> navigator<c- p>.</c->locks<c- p>.</c->request<c- p>(</c->sortedResources<c- p>.</c->shift<c- p>(),</c-> <c- k>async</c-> lock <c- p>=></c-> <c- p>{</c->
      <c- c1>// 当前持有此锁及之前所有已请求的锁。</c->
      locks<c- p>.</c->push<c- p>(</c->lock<c- p>);</c->

      <c- c1>// 如有需要，递归请求下一个锁。</c->
      <c- k>if</c-> <c- p>(</c->sortedResources<c- p>.</c->length <c- o>></c-> <c- mf>0</c-><c- p>)</c->
        <c- k>return</c-> <c- k>await</c-> requestNext<c- p>(</c->locks<c- p>);</c->

      <c- c1>// 否则，执行回调。</c->
      <c- k>return</c-> <c- k>await</c-> callback<c- p>(</c->locks<c- p>);</c->

      <c- c1>// 回调返回（或抛出）后，所有锁将被释放。</c->
    <c- p>});</c->
  <c- p>}</c->
  <c- k>return</c-> <c- k>await</c-> requestNext<c- p>([]);</c->
<c- p>}</c->
</pre>
            <p>实际使用中，多锁场景往往并不如此直接——库和工具常常会无意中掩盖锁的使用。</p>
        </div>
        <h2 class="heading settled" data-level="6" id="security-privacy"><span class="secno">6. </span><span
                class="content">安全与隐私注意事项</span><a class="self-link" href="#security-privacy"></a></h2>
        <h3 class="heading settled" data-level="6.1" id="security-scope"><span class="secno">6.1. </span><span
                class="content">锁作用域</span><a class="self-link" href="#security-scope"></a></h3>
        <p><a data-link-type="dfn" href="#lock-manager"
                id="ref-for-lock-manager①⓪">锁管理器</a>的作用域定义很重要，因为它决定了隐私边界。锁可作为临时状态保留机制，也可像存储 API
            一样作为通信机制，其权限不得高于存储机制。用户代理如果对某项服务施加更细粒度的隔离，也必须对其他服务施加同样的隔离；例如，用户代理因隐私原因对同一源的顶级页面（第一方）和跨域
            iframe（第三方）分别分区存储，则也必须对锁进行类似分区。</p>
        <p>这也为 Web 应用作者提供了合理预期：如果对某存储资源获取了锁，则所有同源浏览上下文都必须观察到相同状态。</p>
        <h3 class="heading settled" data-level="6.2" id="private-browsing"><span class="secno">6.2. </span><span
                class="content">隐私浏览</span><a class="self-link" href="#private-browsing"></a></h3>
        <p>每个<a href="https://github.com/w3ctag/private-mode">隐私模式</a>浏览会话在本 API
            中视为独立的用户代理。即，隐私模式外请求/持有的锁不会影响隐私模式内的锁，反之亦然。这既防止网站判断会话是否为“隐身”，也不允许不同会话间通信。</p>
        <h3 class="heading settled" data-level="6.3" id="implementation-risks"><span class="secno">6.3. </span><span
                class="content">实现风险</span><a class="self-link" href="#implementation-risks"></a></h3>
        <p>实现必须确保锁不会跨源。否则会为不同源脚本间通信提供侧信道，或允许一个源的脚本干扰另一个源的行为（如拒绝服务）。</p>
        <h3 class="heading settled" data-level="6.4" id="security-privacy-checklist"><span class="secno">6.4.
            </span><span class="content">安全与隐私清单</span><a class="self-link" href="#security-privacy-checklist"></a>
        </h3>
        <p>W3C TAG 制定了<a href="https://www.w3.org/TR/security-privacy-questionnaire/">安全与隐私自查问卷</a>，供规范编辑者参考。相关问题如下：</p>
        <ul>
            <li data-md>
                <p>本规范不涉及个人身份信息或高价值数据。</p>
            <li data-md>
                <p>未为某个源引入可跨会话持久化的新状态。</p>
            <li data-md>
                <p>未向 Web 暴露新的持久化跨源状态。</p>
            <li data-md>
                <p>未向某个源暴露其当前无法访问的新数据（如通过轮询<a data-link-type="biblio" href="#biblio-indexeddb-2"
                        title="Indexed Database API 2.0">[IndexedDB-2]</a>）。</p>
            <li data-md>
                <p>未启用新的脚本执行/加载机制。</p>
            <li data-md>
                <p>本规范不允许某个源访问以下内容：</p>
                <ul>
                    <li data-md>
                        <p>用户位置。</p>
                    <li data-md>
                        <p>用户设备上的传感器。</p>
                    <li data-md>
                        <p>用户本地计算环境的相关信息。</p>
                    <li data-md>
                        <p>访问其他设备。</p>
                    <li data-md>
                        <p>对用户代理原生 UI 的任何控制。</p>
                </ul>
            <li data-md>
                <p>未向 Web 暴露临时标识符。所有<a data-link-type="dfn" href="#resource-name" id="ref-for-resource-name⑦">资源名</a>均由
                    Web 应用自身提供。</p>
            <li data-md>
                <p>如用户代理区分第一方与第三方存储，则锁行为也区分。见<a href="#security-scope">§ 6.1 锁作用域</a>。</p>
            <li data-md>
                <p>用户代理“隐身”模式下的行为见<a href="#private-browsing">§ 6.2 隐私浏览</a>。</p>
            <li data-md>
                <p>本 API 不会将数据持久化到用户本地设备。</p>
            <li data-md>
                <p>本 API 不允许降低默认安全特性。</p>
        </ul>
        <h2 class="heading settled" data-level="7" id="acknowledgements"><span class="secno">7. </span><span
                class="content">致谢</span><a class="self-link" href="#acknowledgements"></a></h2>
        <p>特别感谢
            Alex Russell,
            Andreas Butler,
            Anne van Kesteren,
            Boris Zbarsky,
            Chris Messina,
            Darin Fisher,
            Domenic Denicola,
            Gus Caplan,
            Harald Alvestrand,
            Jake Archibald,
            Kagami Sascha Rosylight,
            L. David Baron,
            Luciano Pacheco,
            Marcos Caceres,
            Ralph Chelala,
            Raymond Toy,
            Ryan Fioravanti,
            以及
            Victor Costan
            对本提案的贡献。</p>
        <p>特别感谢 Tab Atkins, Jr. 创建和维护
            <a href="https://github.com/tabatkins/bikeshed">Bikeshed</a>，本规范所用的文档工具，以及他在文档编写方面的建议。
        </p>
    </main>
    <div data-fill-with="conformance">
        <h2 class="no-ref no-num heading settled" id="w3c-conformance"><span class="content">一致性</span><a
                class="self-link" href="#w3c-conformance"></a></h2>
        <h3 class="no-ref no-num heading settled" id="w3c-conventions"><span class="content">文档约定</span><a
                class="self-link" href="#w3c-conventions"></a></h3>
        <p>一致性要求通过描述性断言和 RFC 2119 术语结合表达。
            本规范规范性部分中的关键词 “MUST”、 “MUST NOT”、 “REQUIRED”、 “SHALL”、 “SHALL NOT”、 “SHOULD”、 “SHOULD NOT”、 “RECOMMENDED”、
            “MAY”、 “OPTIONAL”
            按 RFC 2119 的定义解释。
            但为便于阅读，这些词在本规范中不会全部大写。
        </p>
        <p>除明确标记为非规范性、示例和注释的部分外，本规范所有文本均为规范性内容。<a data-link-type="biblio" href="#biblio-rfc2119"
                title="Key words for use in RFCs to Indicate Requirement Levels">[RFC2119]</a>
        </p>
        <p>本规范中的示例以 “for example” 开头，或通过 <code>class="example"</code> 与规范性文本区分，如下所示：</p>
        <div class="example" id="w3c-example">
            <a class="self-link" href="#w3c-example"></a>
            <p>这是一个说明性示例。</p>
        </div>
        <p>说明性注释以 “Note” 开头，并通过 <code>class="note"</code> 与规范性文本区分，如下所示：</p>
        <p class="note" role="note">注意，这是一个说明性注释。</p>
        <section>
            <h3 class="no-ref no-num heading settled" id="w3c-conformant-algorithms"><span
                    class="content">一致性算法</span><a class="self-link" href="#w3c-conformant-algorithms"></a></h3>
            <p>作为算法一部分的命令式要求（如 “strip any leading space characters” 或 “return false and abort these steps”）
                应结合引入算法时所用关键词（“must”、“should”、“may”等）来解释其含义。
            </p>
            <p>以算法或具体步骤表述的一致性要求可用任何方式实现，只要最终结果等价即可。
                本规范定义的算法旨在易于理解，并非为高性能设计。鼓励实现者进行优化。
            </p>
        </section>
    </div>
    <script src="https://www.w3.org/scripts/TR/2021/fixup.js"></script>
    <h2 class="no-num no-ref heading settled" id="index"><span class="content">索引</span><a class="self-link"
            href="#index"></a></h2>
    <h3 class="no-num no-ref heading settled" id="index-defined-here"><span class="content">本规范定义的术语</span><a
            class="self-link" href="#index-defined-here"></a></h3>
    <ul class="index">
        <li><a href="#abort-the-request">中止请求</a><span>，见 § 4.3</span>
        <li>
            agent
            <ul>
                <li><a href="#lock-request-agent">锁请求的定义</a><span>，见 § 2.5</span>
                <li><a href="#lock-concept-agent">锁概念的定义</a><span>，见 § 2.4</span>
            </ul>
        <li><a href="#lock-request-callback">回调</a><span>，见 § 2.5</span>
        <li>
            clientId
            <ul>
                <li><a href="#lock-request-clientid">锁请求的定义</a><span>，见 § 2.5</span>
                <li><a href="#lock-concept-clientid">锁概念的定义</a><span>，见 § 2.4</span>
                <li><a href="#dom-lockinfo-clientid">LockInfo 字典成员</a><span>，见 § 3.2</span>
            </ul>
        <li><a href="#dom-lockmode-exclusive">"exclusive"</a><span>，见 § 3.2</span>
        <li><a href="#get-the-lock-request-queue">获取锁请求队列</a><span>，见 § 2.5</span>
        <li><a href="#grantable">可授予</a><span>，见 § 2.5</span>
        <li><a href="#dom-lockmanagersnapshot-held">held</a><span>，见 § 3.2</span>
        <li><a href="#lock-manager-held-lock-set">已持有锁集合</a><span>，见 § 2.4</span>
        <li><a href="#dom-lockoptions-ifavailable">ifAvailable</a><span>，见 § 3.2</span>
        <li><a href="#lock">Lock</a><span>，见 § 3.3</span>
        <li><a href="#lock-concept">锁概念</a><span>，见 § 2.4</span>
        <li><a href="#callbackdef-lockgrantedcallback">LockGrantedCallback</a><span>，见 § 3.2</span>
        <li><a href="#dictdef-lockinfo">LockInfo</a><span>，见 § 3.2</span>
        <li><a href="#lock-manager">锁管理器</a><span>，见 § 2.2</span>
        <li><a href="#lockmanager">LockManager</a><span>，见 § 3.2</span>
        <li><a href="#dictdef-lockmanagersnapshot">LockManagerSnapshot</a><span>，见 § 3.2</span>
        <li><a href="#enumdef-lockmode">LockMode</a><span>，见 § 3.2</span>
        <li><a href="#dictdef-lockoptions">LockOptions</a><span>，见 § 3.2</span>
        <li><a href="#lock-request">锁请求</a><span>，见 § 2.5</span>
        <li><a href="#lock-request-queue">锁请求队列</a><span>，见 § 2.5</span>
        <li><a href="#lock-manager-lock-request-queue-map">锁请求队列映射</a><span>，见 § 2.5</span>
        <li><a href="#dom-navigatorlocks-locks">locks</a><span>，见 § 3.1</span>
        <li><a href="#lock-task-queue">锁任务队列</a><span>，见 § 2</span>
        <li>
            manager
            <ul>
                <li><a href="#lock-request-manager">锁请求的定义</a><span>，见 § 2.5</span>
                <li><a href="#lock-concept-manager">锁概念的定义</a><span>，见 § 2.4</span>
            </ul>
        <li>
            mode
            <ul>
                <li><a href="#dom-lock-mode">Lock 的属性</a><span>，见 § 3.3</span>
                <li><a href="#mode">定义</a><span>，见 § 2.3</span>
                <li><a href="#lock-request-mode">锁请求的定义</a><span>，见 § 2.5</span>
                <li><a href="#lock-concept-mode">锁概念的定义</a><span>，见 § 2.4</span>
                <li><a href="#dom-lockinfo-mode">LockInfo 字典成员</a><span>，见 § 3.2</span>
                <li><a href="#dom-lockoptions-mode">LockOptions 字典成员</a><span>，见 § 3.2</span>
            </ul>
        <li>
            name
            <ul>
                <li><a href="#dom-lock-name">Lock 的属性</a><span>，见 § 3.3</span>
                <li><a href="#lock-request-name">锁请求的定义</a><span>，见 § 2.5</span>
                <li><a href="#lock-concept-name">锁概念的定义</a><span>，见 § 2.4</span>
                <li><a href="#dom-lockinfo-name">LockInfo 字典成员</a><span>，见 § 3.2</span>
            </ul>
        <li><a href="#navigatorlocks">NavigatorLocks</a><span>，见 § 3.1</span>
        <li><a href="#obtain-a-lock-manager">获取锁管理器</a><span>，见 § 2.2</span>
        <li><a href="#dom-lockmanagersnapshot-pending">pending</a><span>，见 § 3.2</span>
        <li><a href="#process-the-lock-request-queue">处理锁请求队列</a><span>，见 § 4.4</span>
        <li><a href="#lock-request-promise">promise</a><span>，见 § 2.5</span>
        <li><a href="#dom-lockmanager-query">query()</a><span>，见 § 3.2.2</span>
        <li><a href="#lock-concept-released-promise">released promise</a><span>，见 § 2.4</span>
        <li><a href="#release-the-lock">释放锁</a><span>，见 § 4.2</span>
        <li><a href="#request-a-lock">请求锁</a><span>，见 § 4.1</span>
        <li><a href="#dom-lockmanager-request">request(name, callback)</a><span>，见 § 3.2.1</span>
        <li><a href="#dom-lockmanager-request-name-options-callback">request(name, options, callback)</a><span>，见
                § 3.2.1</span>
        <li><a href="#resource-name">资源名</a><span>，见 § 2.1</span>
        <li><a href="#dom-lockmode-shared">"shared"</a><span>，见 § 3.2</span>
        <li>
            signal
            <ul>
                <li><a href="#lock-request-signal">锁请求的定义</a><span>，见 § 2.5</span>
                <li><a href="#dom-lockoptions-signal">LockOptions 字典成员</a><span>，见 § 3.2</span>
            </ul>
        <li><a href="#signal-to-abort-the-request">signal to abort the request</a><span>，见 § 4.3</span>
        <li><a href="#snapshot-the-lock-state">锁状态快照</a><span>，见 § 4.5</span>
        <li><a href="#dom-lockoptions-steal">steal</a><span>，见 § 3.2</span>
        <li><a href="#terminate-remaining-locks-and-requests">终止剩余锁和请求</a><span>，见
                § 2.6</span>
        <li><a href="#lock-concept-waiting-promise">waiting promise</a><span>，见 § 2.4</span>
        <li><a href="#web-locks-tasks-source">web locks 任务源</a><span>，见 § 2</span>
    </ul>
    <h3 class="no-num no-ref heading settled" id="index-defined-elsewhere"><span class="content">引用规范定义的术语</span><a
            class="self-link" href="#index-defined-elsewhere"></a></h3>
    <ul class="index">
        <li>
            <a data-link-type="biblio">[DOM]</a> 定义如下术语：
            <ul>
                <li><span class="dfn-paneled" id="cca3cdb2">AbortSignal</span>
                <li><span class="dfn-paneled" id="28e64574">abort reason</span>
                <li><span class="dfn-paneled" id="535dd335">aborted</span>
                <li><span class="dfn-paneled" id="87bc23a5">add</span>
                <li><span class="dfn-paneled" id="a973e0fe">document</span>
                <li><span class="dfn-paneled" id="ff87eaf9">remove</span>
            </ul>
        <li>
            <a data-link-type="biblio">[ECMA262]</a> 定义如下术语：
            <ul>
                <li><span class="dfn-paneled" id="26e4aa12">agent</span>
            </ul>
        <li>
            <a data-link-type="biblio">[HTML]</a> 定义如下术语：
            <ul>
                <li><span class="dfn-paneled" id="be0c27b2">Navigator</span>
                <li><span class="dfn-paneled" id="a4785085">WorkerNavigator</span>
                <li><span class="dfn-paneled" id="474cbfcb">agent cluster</span>
                <li><span class="dfn-paneled" id="3349d69f">associated Document</span>
                <li><span class="dfn-paneled" id="0d0390b4">browsing context</span>
                <li><span class="dfn-paneled" id="e4d92278">enqueue steps</span>
                <li><span class="dfn-paneled" id="102df61f">enqueue the following steps</span>
                <li><span class="dfn-paneled" id="3e12e042">environment settings object</span>
                <li><span class="dfn-paneled" id="0e3ba9f8">fully active</span>
                <li><span class="dfn-paneled" id="73a186aa">id</span>
                <li><span class="dfn-paneled" id="e99bd18e">relevant global object</span>
                <li><span class="dfn-paneled" id="9c4c1e66">relevant settings object</span>
                <li><span class="dfn-paneled" id="e3288657">responsible event loop</span>
                <li><span class="dfn-paneled" id="8219d486">starting a new parallel queue</span>
                <li><span class="dfn-paneled" id="c3b2d08c">task source</span>
                <li><span class="dfn-paneled" id="4411082c">unloading document cleanup steps</span>
            </ul>
        <li>
            <a data-link-type="biblio">[INFRA]</a> 定义如下术语：
            <ul>
                <li><span class="dfn-paneled" id="53275e46">append <small>(列表)</small></span>
                <li><span class="dfn-paneled" id="a3b18719">append <small>(集合)</small></span>
                <li><span class="dfn-paneled" id="77b4c09a">assert</span>
                <li><span class="dfn-paneled" id="06a6db54">enqueue</span>
                <li><span class="dfn-paneled" id="1243a891">exist</span>
                <li><span class="dfn-paneled" id="16d07e10">for each <small>(列表)</small></span>
                <li><span class="dfn-paneled" id="45209803">for each <small>(映射)</small></span>
                <li><span class="dfn-paneled" id="6b815fdd">is empty</span>
                <li><span class="dfn-paneled" id="5afbefcd">item <small>(列表)</small></span>
                <li><span class="dfn-paneled" id="c88f3887">item <small>(结构体)</small></span>
                <li><span class="dfn-paneled" id="b38d7ca1">JavaScript 字符串</span>
                <li><span class="dfn-paneled" id="649608b9">list</span>
                <li><span class="dfn-paneled" id="3fca5a9e">map</span>
                <li><span class="dfn-paneled" id="e2fc6023">prepend</span>
                <li><span class="dfn-paneled" id="47dfca75">queue</span>
                <li><span class="dfn-paneled" id="99c988d6">remove</span>
                <li><span class="dfn-paneled" id="15e48c39">set</span>
                <li><span class="dfn-paneled" id="0e6b2056">set <small>(映射)</small></span>
                <li><span class="dfn-paneled" id="984221ca">struct</span>
                <li><span class="dfn-paneled" id="6d19ac93">user agent</span>
                <li><span class="dfn-paneled" id="12d6b9a8">values</span>
            </ul>
        <li>
            <a data-link-type="biblio">[Service-Workers]</a> 定义如下术语：
            <ul>
                <li><span class="dfn-paneled" id="f58a36be">Client</span>
                <li><span class="dfn-paneled" id="7fd418b6">id</span>
            </ul>
        <li>
            <a data-link-type="biblio">[Storage]</a> 定义如下术语：
            <ul>
                <li><span class="dfn-paneled" id="6bb9d790">获取本地存储桶映射</span>
                <li><span class="dfn-paneled" id="67130339">存储瓶</span>
                <li><span class="dfn-paneled" id="6148dd37">存储桶</span>
            </ul>
        <li>
            <a data-link-type="biblio">[WEBIDL]</a> 定义如下术语：
            <ul>
                <li><span class="dfn-paneled" id="d25dfb2c">AbortError</span>
                <li><span class="dfn-paneled" id="dca2de17">DOMException</span>
                <li><span class="dfn-paneled" id="8855a9aa">DOMString</span>
                <li><span class="dfn-paneled" id="889e932f">Exposed</span>
                <li><span class="dfn-paneled" id="797018a7">InvalidStateError</span>
                <li><span class="dfn-paneled" id="3182eb71">NotSupportedError</span>
                <li><span class="dfn-paneled" id="bdbd19d1">Promise</span>
                <li><span class="dfn-paneled" id="b75bb3bd">SecureContext</span>
                <li><span class="dfn-paneled" id="c3e881ef">SecurityError</span>
                <li><span class="dfn-paneled" id="dacde8b5">a new promise</span>
                <li><span class="dfn-paneled" id="d0b4a948">a promise rejected with</span>
                <li><span class="dfn-paneled" id="6c6b1005">any</span>
                <li><span class="dfn-paneled" id="5372cca8">boolean</span>
                <li><span class="dfn-paneled" id="3ab7bf79">callback function</span>
                <li><span class="dfn-paneled" id="10ce5f6f">invoke</span>
                <li><span class="dfn-paneled" id="b262501e">reject</span>
                <li><span class="dfn-paneled" id="3b90bdcd">resolve</span>
                <li><span class="dfn-paneled" id="9cce47fd">sequence</span>
                <li><span class="dfn-paneled" id="4013a022">this</span>
            </ul>
    </ul>
    <h2 class="no-num no-ref heading settled" id="references"><span class="content">参考文献</span><a class="self-link"
            href="#references"></a></h2>
    <h3 class="no-num no-ref heading settled" id="normative"><span class="content">规范性引用</span><a class="self-link"
            href="#normative"></a></h3>
    <dl>
        <dt id="biblio-dom">[DOM]
        <dd>Anne van Kesteren. <a href="https://dom.spec.whatwg.org/"><cite>DOM 标准</cite></a>. 现行标准.
            URL: <a href="https://dom.spec.whatwg.org/">https://dom.spec.whatwg.org/</a>
        <dt id="biblio-html">[HTML]
        <dd>Anne van Kesteren; 等. <a href="https://html.spec.whatwg.org/multipage/"><cite>HTML 标准</cite></a>.
            现行标准. URL: <a href="https://html.spec.whatwg.org/multipage/">https://html.spec.whatwg.org/multipage/</a>
        <dt id="biblio-infra">[INFRA]
        <dd>Anne van Kesteren; Domenic Denicola. <a href="https://infra.spec.whatwg.org/"><cite>Infra
                    标准</cite></a>. 现行标准. URL: <a
                href="https://infra.spec.whatwg.org/">https://infra.spec.whatwg.org/</a>
        <dt id="biblio-rfc2119">[RFC2119]
        <dd>S. Bradner. <a href="https://datatracker.ietf.org/doc/html/rfc2119"><cite>RFCs 中用于指示需求级别的关键词</cite></a>.
            1997年3月. 最佳当前实践. URL: <a
                href="https://datatracker.ietf.org/doc/html/rfc2119">https://datatracker.ietf.org/doc/html/rfc2119</a>
        <dt id="biblio-storage">[Storage]
        <dd>Anne van Kesteren. <a href="https://storage.spec.whatwg.org/"><cite>存储标准</cite></a>. 现行标准. URL: <a
                href="https://storage.spec.whatwg.org/">https://storage.spec.whatwg.org/</a>
        <dt id="biblio-webidl">[WEBIDL]
        <dd>Edgar Chen; Timothy Gu. <a href="https://webidl.spec.whatwg.org/"><cite>Web IDL 标准</cite></a>. 现行标准. URL: <a
                href="https://webidl.spec.whatwg.org/">https://webidl.spec.whatwg.org/</a>
    </dl>
    <h3 class="no-num no-ref heading settled" id="informative"><span class="content">说明性引用</span><a class="self-link"
            href="#informative"></a></h3>
    <dl>
        <dt id="biblio-indexeddb-2">[IndexedDB-2]
        <dd>Ali Alabbas; Joshua Bell. <a href="https://www.w3.org/TR/IndexedDB-2/"><cite>Indexed Database API
                    2.0</cite></a>. 2018年1月30日. REC. URL: <a
                href="https://www.w3.org/TR/IndexedDB-2/">https://www.w3.org/TR/IndexedDB-2/</a>
        <dt id="biblio-service-workers">[Service-Workers]
        <dd>Yoshisato Yanagisawa; Monica CHINTALA. <a href="https://www.w3.org/TR/service-workers/"><cite>Service
                    Workers</cite></a>. 2025年3月6日. CRD. URL: <a
                href="https://www.w3.org/TR/service-workers/">https://www.w3.org/TR/service-workers/</a>
    </dl>
    <h2 class="no-num no-ref heading settled" id="idl-index"><span class="content">IDL 索引</span><a class="self-link"
            href="#idl-index"></a></h2>
    <pre class="idl highlight def">[<a class="idl-code" data-link-type="extended-attribute" href="https://webidl.spec.whatwg.org/#SecureContext"><c- g>SecureContext</c-></a>]
<c- b>interface</c-> <c- b>mixin</c-> <a href="#navigatorlocks"><code><c- g>NavigatorLocks</c-></code></a> {
  <c- b>readonly</c-> <c- b>attribute</c-> <a data-link-type="idl-name" href="#lockmanager"><c- n>LockManager</c-></a> <a class="idl-code" data-link-type="attribute" data-readonly data-type="LockManager" href="#dom-navigatorlocks-locks"><c- g>locks</c-></a>;
};
<a data-link-type="idl-name" href="https://html.spec.whatwg.org/multipage/system-state.html#navigator"><c- n>Navigator</c-></a> <c- b>includes</c-> <a data-link-type="idl-name" href="#navigatorlocks"><c- n>NavigatorLocks</c-></a>;
<a data-link-type="idl-name" href="https://html.spec.whatwg.org/multipage/workers.html#workernavigator"><c- n>WorkerNavigator</c-></a> <c- b>includes</c-> <a data-link-type="idl-name" href="#navigatorlocks"><c- n>NavigatorLocks</c-></a>;

[<a class="idl-code" data-link-type="extended-attribute" href="https://webidl.spec.whatwg.org/#SecureContext"><c- g>SecureContext</c-></a>, <a class="idl-code" data-link-type="extended-attribute" href="https://webidl.spec.whatwg.org/#Exposed"><c- g>Exposed</c-></a>=(<c- n>Window</c->,<c- n>Worker</c->)]
<c- b>interface</c-> <a href="#lockmanager"><code><c- g>LockManager</c-></code></a> {
  <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-promise"><c- b>Promise</c-></a>&lt;<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-any"><c- b>any</c-></a>> <a class="idl-code" data-link-type="method" href="#dom-lockmanager-request"><c- g>request</c-></a>(<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-DOMString"><c- b>DOMString</c-></a> <a href="#dom-lockmanager-request-name-callback-name"><code><c- g>name</c-></code></a>,
                       <a data-link-type="idl-name" href="#callbackdef-lockgrantedcallback"><c- n>LockGrantedCallback</c-></a> <a href="#dom-lockmanager-request-name-callback-callback"><code><c- g>callback</c-></code></a>);
  <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-promise"><c- b>Promise</c-></a>&lt;<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-any"><c- b>any</c-></a>> <a class="idl-code" data-link-type="method" href="#dom-lockmanager-request-name-options-callback"><c- g>request</c-></a>(<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-DOMString"><c- b>DOMString</c-></a> <a href="#dom-lockmanager-request-name-options-callback-name"><code><c- g>name</c-></code></a>,
                       <a data-link-type="idl-name" href="#dictdef-lockoptions"><c- n>LockOptions</c-></a> <a href="#dom-lockmanager-request-name-options-callback-options"><code><c- g>options</c-></code></a>,
                       <a data-link-type="idl-name" href="#callbackdef-lockgrantedcallback"><c- n>LockGrantedCallback</c-></a> <a href="#dom-lockmanager-request-name-options-callback-callback"><code><c- g>callback</c-></code></a>);

  <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-promise"><c- b>Promise</c-></a>&lt;<a data-link-type="idl-name" href="#dictdef-lockmanagersnapshot"><c- n>LockManagerSnapshot</c-></a>> <a class="idl-code" data-link-type="method" href="#dom-lockmanager-query"><c- g>query</c-></a>();
};

<c- b>callback</c-> <a href="#callbackdef-lockgrantedcallback"><code><c- g>LockGrantedCallback</c-></code></a> = <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-promise"><c- b>Promise</c-></a>&lt;<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-any"><c- b>any</c-></a>> (<a data-link-type="idl-name" href="#lock"><c- n>Lock</c-></a>? <a href="#dom-lockgrantedcallback-lock"><code><c- g>lock</c-></code></a>);

<c- b>enum</c-> <a href="#enumdef-lockmode"><code><c- g>LockMode</c-></code></a> { <a href="#dom-lockmode-shared"><code><c- s>"shared"</c-></code></a>, <a href="#dom-lockmode-exclusive"><code><c- s>"exclusive"</c-></code></a> };

<c- b>dictionary</c-> <a href="#dictdef-lockoptions"><code><c- g>LockOptions</c-></code></a> {
  <a data-link-type="idl-name" href="#enumdef-lockmode"><c- n>LockMode</c-></a> <a data-default="&quot;exclusive&quot;" data-type="LockMode" href="#dom-lockoptions-mode"><code><c- g>mode</c-></code></a> = "exclusive";
  <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-boolean"><c- b>boolean</c-></a> <a data-default="false" data-type="boolean" href="#dom-lockoptions-ifavailable"><code><c- g>ifAvailable</c-></code></a> = <c- b>false</c->;
  <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-boolean"><c- b>boolean</c-></a> <a data-default="false" data-type="boolean" href="#dom-lockoptions-steal"><code><c- g>steal</c-></code></a> = <c- b>false</c->;
  <a data-link-type="idl-name" href="https://dom.spec.whatwg.org/#abortsignal"><c- n>AbortSignal</c-></a> <a data-type="AbortSignal" href="#dom-lockoptions-signal"><code><c- g>signal</c-></code></a>;
};

<c- b>dictionary</c-> <a href="#dictdef-lockmanagersnapshot"><code><c- g>LockManagerSnapshot</c-></code></a> {
  <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#idl-sequence"><c- b>sequence</c-></a>&lt;<a data-link-type="idl-name" href="#dictdef-lockinfo"><c- n>LockInfo</c-></a>> <a data-type="sequence<LockInfo>" href="#dom-lockmanagersnapshot-held"><code><c- g>held</c-></code></a>;
  <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#idl-sequence"><c- b>sequence</c-></a>&lt;<a data-link-type="idl-name" href="#dictdef-lockinfo"><c- n>LockInfo</c-></a>> <a data-type="sequence<LockInfo>" href="#dom-lockmanagersnapshot-pending"><code><c- g>pending</c-></code></a>;
};

<c- b>dictionary</c-> <a href="#dictdef-lockinfo"><code><c- g>LockInfo</c-></code></a> {
  <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-DOMString"><c- b>DOMString</c-></a> <a data-type="DOMString" href="#dom-lockinfo-name"><code><c- g>name</c-></code></a>;
  <a data-link-type="idl-name" href="#enumdef-lockmode"><c- n>LockMode</c-></a> <a data-type="LockMode" href="#dom-lockinfo-mode"><code><c- g>mode</c-></code></a>;
  <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-DOMString"><c- b>DOMString</c-></a> <a data-type="DOMString" href="#dom-lockinfo-clientid"><code><c- g>clientId</c-></code></a>;
};

[<a class="idl-code" data-link-type="extended-attribute" href="https://webidl.spec.whatwg.org/#SecureContext"><c- g>SecureContext</c-></a>, <a class="idl-code" data-link-type="extended-attribute" href="https://webidl.spec.whatwg.org/#Exposed"><c- g>Exposed</c-></a>=(<c- n>Window</c->,<c- n>Worker</c->)]
<c- b>interface</c-> <a href="#lock"><code><c- g>Lock</c-></code></a> {
  <c- b>readonly</c-> <c- b>attribute</c-> <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-DOMString"><c- b>DOMString</c-></a> <a class="idl-code" data-link-type="attribute" data-readonly data-type="DOMString" href="#dom-lock-name"><c- g>name</c-></a>;
  <c- b>readonly</c-> <c- b>attribute</c-> <a data-link-type="idl-name" href="#enumdef-lockmode"><c- n>LockMode</c-></a> <a class="idl-code" data-link-type="attribute" data-readonly data-type="LockMode" href="#dom-lock-mode"><c- g>mode</c-></a>;
};

</pre>
    <h2 class="no-num no-ref heading settled" id="issues-index"><span class="content">问题索引</span><a class="self-link"
            href="#issues-index"></a></h2>
    <div style="counter-reset:issue">
        <div class="issue"> 需完善与 <a data-link-type="biblio" href="#biblio-storage"
                title="Storage Standard">[Storage]</a> 的集成，包括如何从给定环境正确获取锁管理器。<a class="issue-return"
                href="#issue-73644ca1" title="跳转到章节">↵</a></div>
        <div class="issue"> 当前仅适用于 worker，且定义不够明确，因为没有规范性方法在 worker 终止时运行相关步骤。<a class="issue-return"
                href="#issue-9062c3e0" title="跳转到章节">↵</a></div>
    </div>
    <details class="mdn-anno unpositioned" data-anno-for="dom-lock-mode">
        <summary><b class="all-engines-flag" title="This feature is in all current engines.">✔</b><span>MDN</span>
        </summary>
        <div class="feature">
            <p><a href="https://developer.mozilla.org/en-US/docs/Web/API/Lock/mode"
                    title="The mode read-only property of the Lock interface returns the access mode passed to LockManager.request() when the lock was requested. The mode is either &quot;exclusive&quot; (the default) or &quot;shared&quot;.">Lock/mode</a>
            </p>
            <p class="all-engines-text">In all current engines.</p>
            <div class="support">
                <span class="firefox yes"><span>Firefox</span><span>96+</span></span><span
                    class="safari yes"><span>Safari</span><span>15.4+</span></span><span
                    class="chrome yes"><span>Chrome</span><span>69+</span></span>
                <hr>
                <span class="opera no"><span>Opera</span><span>?</span></span><span
                    class="edge_blink yes"><span>Edge</span><span>79+</span></span>
                <hr>
                <span class="edge no"><span>Edge (Legacy)</span><span>?</span></span><span
                    class="ie no"><span>IE</span><span>None</span></span>
                <hr>
                <span class="firefox_android no"><span>Firefox for Android</span><span>?</span></span><span
                    class="safari_ios no"><span>iOS Safari</span><span>?</span></span><span
                    class="chrome_android no"><span>Chrome for Android</span><span>?</span></span><span
                    class="webview_android no"><span>Android WebView</span><span>?</span></span><span
                    class="samsunginternet_android no"><span>Samsung Internet</span><span>?</span></span><span
                    class="opera_android no"><span>Opera Mobile</span><span>?</span></span>
            </div>
        </div>
    </details>
    <details class="mdn-anno unpositioned" data-anno-for="dom-lock-name">
        <summary><b class="all-engines-flag" title="This feature is in all current engines.">✔</b><span>MDN</span>
        </summary>
        <div class="feature">
            <p><a href="https://developer.mozilla.org/en-US/docs/Web/API/Lock/name"
                    title="The name read-only property of the Lock interface returns the name passed to LockManager.request selected when the lock was requested.">Lock/name</a>
            </p>
            <p class="all-engines-text">In all current engines.</p>
            <div class="support">
                <span class="firefox yes"><span>Firefox</span><span>96+</span></span><span
                    class="safari yes"><span>Safari</span><span>15.4+</span></span><span
                    class="chrome yes"><span>Chrome</span><span>69+</span></span>
                <hr>
                <span class="opera no"><span>Opera</span><span>?</span></span><span
                    class="edge_blink yes"><span>Edge</span><span>79+</span></span>
                <hr>
                <span class="edge no"><span>Edge (Legacy)</span><span>?</span></span><span
                    class="ie no"><span>IE</span><span>None</span></span>
                <hr>
                <span class="firefox_android no"><span>Firefox for Android</span><span>?</span></span><span
                    class="safari_ios no"><span>iOS Safari</span><span>?</span></span><span
                    class="chrome_android no"><span>Chrome for Android</span><span>?</span></span><span
                    class="webview_android no"><span>Android WebView</span><span>?</span></span><span
                    class="samsunginternet_android no"><span>Samsung Internet</span><span>?</span></span><span
                    class="opera_android no"><span>Opera Mobile</span><span>?</span></span>
            </div>
        </div>
    </details>
    <details class="mdn-anno unpositioned" data-anno-for="api-lock">
        <summary><b class="all-engines-flag" title="This feature is in all current engines.">✔</b><span>MDN</span>
        </summary>
        <div class="feature">
            <p><a href="https://developer.mozilla.org/en-US/docs/Web/API/Lock"
                    title="The Lock interface of the Web Locks API provides the name and mode of a lock. This may be a newly requested lock that is received in the callback to LockManager.request(), or a record of an active or queued lock returned by LockManager.query().">Lock</a>
            </p>
            <p class="all-engines-text">In all current engines.</p>
            <div class="support">
                <span class="firefox yes"><span>Firefox</span><span>96+</span></span><span
                    class="safari yes"><span>Safari</span><span>15.4+</span></span><span
                    class="chrome yes"><span>Chrome</span><span>69+</span></span>
                <hr>
                <span class="opera no"><span>Opera</span><span>?</span></span><span
                    class="edge_blink yes"><span>Edge</span><span>79+</span></span>
                <hr>
                <span class="edge no"><span>Edge (Legacy)</span><span>?</span></span><span
                    class="ie no"><span>IE</span><span>None</span></span>
                <hr>
                <span class="firefox_android no"><span>Firefox for Android</span><span>?</span></span><span
                    class="safari_ios no"><span>iOS Safari</span><span>?</span></span><span
                    class="chrome_android no"><span>Chrome for Android</span><span>?</span></span><span
                    class="webview_android no"><span>Android WebView</span><span>?</span></span><span
                    class="samsunginternet_android no"><span>Samsung Internet</span><span>?</span></span><span
                    class="opera_android no"><span>Opera Mobile</span><span>?</span></span>
            </div>
        </div>
    </details>
    <details class="mdn-anno unpositioned" data-anno-for="api-lock-manager-query">
        <summary><b class="all-engines-flag" title="This feature is in all current engines.">✔</b><span>MDN</span>
        </summary>
        <div class="feature">
            <p><a href="https://developer.mozilla.org/en-US/docs/Web/API/LockManager/query"
                    title="The query() method of the LockManager interface returns a Promise that resolves with an object containing information about held and pending locks.">LockManager/query</a>
            </p>
            <p class="all-engines-text">In all current engines.</p>
            <div class="support">
                <span class="firefox yes"><span>Firefox</span><span>96+</span></span><span
                    class="safari yes"><span>Safari</span><span>15.4+</span></span><span
                    class="chrome yes"><span>Chrome</span><span>69+</span></span>
                <hr>
                <span class="opera no"><span>Opera</span><span>?</span></span><span
                    class="edge_blink yes"><span>Edge</span><span>79+</span></span>
                <hr>
                <span class="edge no"><span>Edge (Legacy)</span><span>?</span></span><span
                    class="ie no"><span>IE</span><span>None</span></span>
                <hr>
                <span class="firefox_android no"><span>Firefox for Android</span><span>?</span></span><span
                    class="safari_ios no"><span>iOS Safari</span><span>?</span></span><span
                    class="chrome_android no"><span>Chrome for Android</span><span>?</span></span><span
                    class="webview_android no"><span>Android WebView</span><span>?</span></span><span
                    class="samsunginternet_android no"><span>Samsung Internet</span><span>?</span></span><span
                    class="opera_android no"><span>Opera Mobile</span><span>?</span></span>
            </div>
        </div>
    </details>
    <details class="mdn-anno unpositioned" data-anno-for="api-lock-manager-request">
        <summary><b class="all-engines-flag" title="This feature is in all current engines.">✔</b><span>MDN</span>
        </summary>
        <div class="feature">
            <p><a href="https://developer.mozilla.org/en-US/docs/Web/API/LockManager/request"
                    title="The request() method of the LockManager interface requests a Lock object with parameters specifying its name and characteristics. The requested Lock is passed to a callback, while the function itself returns a Promise that resolves with undefined.">LockManager/request</a>
            </p>
            <p class="all-engines-text">In all current engines.</p>
            <div class="support">
                <span class="firefox yes"><span>Firefox</span><span>96+</span></span><span
                    class="safari yes"><span>Safari</span><span>15.4+</span></span><span
                    class="chrome yes"><span>Chrome</span><span>69+</span></span>
                <hr>
                <span class="opera no"><span>Opera</span><span>?</span></span><span
                    class="edge_blink yes"><span>Edge</span><span>79+</span></span>
                <hr>
                <span class="edge no"><span>Edge (Legacy)</span><span>?</span></span><span
                    class="ie no"><span>IE</span><span>None</span></span>
                <hr>
                <span class="firefox_android no"><span>Firefox for Android</span><span>?</span></span><span
                    class="safari_ios no"><span>iOS Safari</span><span>?</span></span><span
                    class="chrome_android no"><span>Chrome for Android</span><span>?</span></span><span
                    class="webview_android no"><span>Android WebView</span><span>?</span></span><span
                    class="samsunginternet_android no"><span>Samsung Internet</span><span>?</span></span><span
                    class="opera_android no"><span>Opera Mobile</span><span>?</span></span>
            </div>
        </div>
    </details>
    <details class="mdn-anno unpositioned" data-anno-for="api-lock-manager">
        <summary><b class="all-engines-flag" title="This feature is in all current engines.">✔</b><span>MDN</span>
        </summary>
        <div class="feature">
            <p><a href="https://developer.mozilla.org/en-US/docs/Web/API/LockManager"
                    title="The LockManager interface of the Web Locks API provides methods for requesting a new Lock object and querying for an existing Lock object. To get an instance of LockManager, call navigator.locks.">LockManager</a>
            </p>
            <p class="all-engines-text">In all current engines.</p>
            <div class="support">
                <span class="firefox yes"><span>Firefox</span><span>96+</span></span><span
                    class="safari yes"><span>Safari</span><span>15.4+</span></span><span
                    class="chrome yes"><span>Chrome</span><span>69+</span></span>
                <hr>
                <span class="opera no"><span>Opera</span><span>?</span></span><span
                    class="edge_blink yes"><span>Edge</span><span>79+</span></span>
                <hr>
                <span class="edge no"><span>Edge (Legacy)</span><span>?</span></span><span
                    class="ie no"><span>IE</span><span>None</span></span>
                <hr>
                <span class="firefox_android no"><span>Firefox for Android</span><span>?</span></span><span
                    class="safari_ios no"><span>iOS Safari</span><span>?</span></span><span
                    class="chrome_android no"><span>Chrome for Android</span><span>?</span></span><span
                    class="webview_android no"><span>Android WebView</span><span>?</span></span><span
                    class="samsunginternet_android no"><span>Samsung Internet</span><span>?</span></span><span
                    class="opera_android no"><span>Opera Mobile</span><span>?</span></span>
            </div>
        </div>
    </details>
    <details class="mdn-anno unpositioned" data-anno-for="dom-navigatorlocks-locks">
        <summary><b class="all-engines-flag" title="This feature is in all current engines.">✔</b><span>MDN</span>
        </summary>
        <div class="feature">
            <p><a href="https://developer.mozilla.org/en-US/docs/Web/API/Navigator/locks"
                    title="The locks read-only property of the Navigator interface returns a LockManager object which provides methods for requesting a new Lock object and querying for an existing Lock object.">Navigator/locks</a>
            </p>
            <p class="all-engines-text">In all current engines.</p>
            <div class="support">
                <span class="firefox yes"><span>Firefox</span><span>96+</span></span><span
                    class="safari yes"><span>Safari</span><span>15.4+</span></span><span
                    class="chrome yes"><span>Chrome</span><span>69+</span></span>
                <hr>
                <span class="opera no"><span>Opera</span><span>?</span></span><span
                    class="edge_blink yes"><span>Edge</span><span>79+</span></span>
                <hr>
                <span class="edge no"><span>Edge (Legacy)</span><span>?</span></span><span
                    class="ie no"><span>IE</span><span>None</span></span>
                <hr>
                <span class="firefox_android no"><span>Firefox for Android</span><span>?</span></span><span
                    class="safari_ios no"><span>iOS Safari</span><span>?</span></span><span
                    class="chrome_android no"><span>Chrome for Android</span><span>?</span></span><span
                    class="webview_android no"><span>Android WebView</span><span>?</span></span><span
                    class="samsunginternet_android no"><span>Samsung Internet</span><span>?</span></span><span
                    class="opera_android no"><span>Opera Mobile</span><span>?</span></span>
            </div>
        </div>
        <div class="feature">
            <p><a href="https://developer.mozilla.org/en-US/docs/Web/API/WorkerNavigator/locks"
                    title="The locks read-only property of the WorkerNavigator interface returns a LockManager object which provides methods for requesting a new Lock object and querying for an existing Lock object.">WorkerNavigator/locks</a>
            </p>
            <p class="all-engines-text">In all current engines.</p>
            <div class="support">
                <span class="firefox yes"><span>Firefox</span><span>96+</span></span><span
                    class="safari yes"><span>Safari</span><span>15.4+</span></span><span
                    class="chrome yes"><span>Chrome</span><span>69+</span></span>
                <hr>
                <span class="opera no"><span>Opera</span><span>?</span></span><span
                    class="edge_blink yes"><span>Edge</span><span>79+</span></span>
                <hr>
                <span class="edge no"><span>Edge (Legacy)</span><span>?</span></span><span
                    class="ie no"><span>IE</span><span>None</span></span>
                <hr>
                <span class="firefox_android no"><span>Firefox for Android</span><span>?</span></span><span
                    class="safari_ios no"><span>iOS Safari</span><span>?</span></span><span
                    class="chrome_android no"><span>Chrome for Android</span><span>?</span></span><span
                    class="webview_android no"><span>Android WebView</span><span>?</span></span><span
                    class="samsunginternet_android no"><span>Samsung Internet</span><span>?</span></span><span
                    class="opera_android no"><span>Opera Mobile</span><span>?</span></span>
            </div>
        </div>
    </details>
    <script>/* Boilerplate: script-dom-helper */
        "use strict";
        function query(sel) { return document.querySelector(sel); }

        function queryAll(sel) { return [...document.querySelectorAll(sel)]; }

        function iter(obj) {
            if (!obj) return [];
            var it = obj[Symbol.iterator];
            if (it) return it;
            return Object.entries(obj);
        }

        function mk(tagname, attrs, ...children) {
            const el = document.createElement(tagname);
            for (const [k, v] of iter(attrs)) {
                if (k.slice(0, 3) == "_on") {
                    const eventName = k.slice(3);
                    el.addEventListener(eventName, v);
                } else if (k[0] == "_") {
                    // property, not attribute
                    el[k.slice(1)] = v;
                } else {
                    if (v === false || v == null) {
                        continue;
                    } else if (v === true) {
                        el.setAttribute(k, "");
                        continue;
                    } else {
                        el.setAttribute(k, v);
                    }
                }
            }
            append(el, children);
            return el;
        }

        /* Create shortcuts for every known HTML element */
        [
            "a",
            "abbr",
            "acronym",
            "address",
            "applet",
            "area",
            "article",
            "aside",
            "audio",
            "b",
            "base",
            "basefont",
            "bdo",
            "big",
            "blockquote",
            "body",
            "br",
            "button",
            "canvas",
            "caption",
            "center",
            "cite",
            "code",
            "col",
            "colgroup",
            "datalist",
            "dd",
            "del",
            "details",
            "dfn",
            "dialog",
            "div",
            "dl",
            "dt",
            "em",
            "embed",
            "fieldset",
            "figcaption",
            "figure",
            "font",
            "footer",
            "form",
            "frame",
            "frameset",
            "head",
            "header",
            "h1",
            "h2",
            "h3",
            "h4",
            "h5",
            "h6",
            "hr",
            "html",
            "i",
            "iframe",
            "img",
            "input",
            "ins",
            "kbd",
            "label",
            "legend",
            "li",
            "link",
            "main",
            "map",
            "mark",
            "meta",
            "meter",
            "nav",
            "nobr",
            "noscript",
            "object",
            "ol",
            "optgroup",
            "option",
            "output",
            "p",
            "param",
            "pre",
            "progress",
            "q",
            "s",
            "samp",
            "script",
            "section",
            "select",
            "small",
            "source",
            "span",
            "strike",
            "strong",
            "style",
            "sub",
            "summary",
            "sup",
            "table",
            "tbody",
            "td",
            "template",
            "textarea",
            "tfoot",
            "th",
            "thead",
            "time",
            "title",
            "tr",
            "u",
            "ul",
            "var",
            "video",
            "wbr",
            "xmp",
        ].forEach(tagname => {
            mk[tagname] = (...args) => mk(tagname, ...args);
        });

        function* nodesFromChildList(children) {
            for (const child of children.flat(Infinity)) {
                if (child instanceof Node) {
                    yield child;
                } else {
                    yield new Text(child);
                }
            }
        }
        function append(el, ...children) {
            for (const child of nodesFromChildList(children)) {
                if (el instanceof Node) el.appendChild(child);
                else el.push(child);
            }
            return el;
        }

        function insertAfter(el, ...children) {
            for (const child of nodesFromChildList(children)) {
                el.parentNode.insertBefore(child, el.nextSibling);
            }
            return el;
        }

        function clearContents(el) {
            el.innerHTML = "";
            return el;
        }

        function parseHTML(markup) {
            if (markup.toLowerCase().trim().indexOf('<!doctype') === 0) {
                const doc = document.implementation.createHTMLDocument("");
                doc.documentElement.innerHTML = markup;
                return doc;
            } else {
                const el = mk.template({});
                el.innerHTML = markup;
                return el.content;
            }
        }</script>
    <script>/* Boilerplate: script-dfn-panel */
        "use strict";
        {
            let dfnPanelData = {
                "06a6db54": { "dfnID": "06a6db54", "dfnText": "enqueue", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-queue-enqueue" }], "title": "4.1. Request a lock" }], "url": "https://infra.spec.whatwg.org/#queue-enqueue" },
                "0d0390b4": { "dfnID": "0d0390b4", "dfnText": "browsing context", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-browsing-context" }], "title": "2.2. Lock Managers" }], "url": "https://html.spec.whatwg.org/multipage/document-sequences.html#browsing-context" },
                "0e3ba9f8": { "dfnID": "0e3ba9f8", "dfnText": "fully active", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-fully-active" }], "title": "3.2.1. The request() method" }, { "refs": [{ "id": "ref-for-fully-active\u2460" }], "title": "3.2.2. The query() method" }], "url": "https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" },
                "0e6b2056": { "dfnID": "0e6b2056", "dfnText": "set (for map)", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-map-set" }], "title": "2.5. Lock Requests" }], "url": "https://infra.spec.whatwg.org/#map-set" },
                "102df61f": { "dfnID": "102df61f", "dfnText": "enqueue the following steps", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-enqueue-the-following-steps" }], "title": "2. Concepts" }, { "refs": [{ "id": "ref-for-enqueue-the-following-steps\u2460" }], "title": "2.4. Locks" }, { "refs": [{ "id": "ref-for-enqueue-the-following-steps\u2461" }], "title": "2.6. Termination of Locks" }, { "refs": [{ "id": "ref-for-enqueue-the-following-steps\u2462" }], "title": "3.2.2. The query() method" }, { "refs": [{ "id": "ref-for-enqueue-the-following-steps\u2463" }, { "id": "ref-for-enqueue-the-following-steps\u2464" }], "title": "4.1. Request a lock" }, { "refs": [{ "id": "ref-for-enqueue-the-following-steps\u2465" }], "title": "4.3. Abort a request" }, { "refs": [{ "id": "ref-for-enqueue-the-following-steps\u2466" }, { "id": "ref-for-enqueue-the-following-steps\u2467" }], "title": "4.4. Process a lock request queue for a given resource name" }], "url": "https://html.spec.whatwg.org/multipage/infrastructure.html#enqueue-the-following-steps" },
                "10ce5f6f": { "dfnID": "10ce5f6f", "dfnText": "invoke", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-invoke-a-callback-function" }], "title": "4.1. Request a lock" }, { "refs": [{ "id": "ref-for-invoke-a-callback-function\u2460" }], "title": "4.4. Process a lock request queue for a given resource name" }], "url": "https://webidl.spec.whatwg.org/#invoke-a-callback-function" },
                "1243a891": { "dfnID": "1243a891", "dfnText": "exist", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-map-exists" }], "title": "2.5. Lock Requests" }, { "refs": [{ "id": "ref-for-map-exists\u2460" }, { "id": "ref-for-map-exists\u2461" }], "title": "3.2.1. The request() method" }], "url": "https://infra.spec.whatwg.org/#map-exists" },
                "12d6b9a8": { "dfnID": "12d6b9a8", "dfnText": "values", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-map-getting-the-values" }], "title": "4.5. Snapshot the lock state" }], "url": "https://infra.spec.whatwg.org/#map-getting-the-values" },
                "15e48c39": { "dfnID": "15e48c39", "dfnText": "set", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-ordered-set" }], "title": "2.4. Locks" }], "url": "https://infra.spec.whatwg.org/#ordered-set" },
                "16d07e10": { "dfnID": "16d07e10", "dfnText": "for each (for list)", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-list-iterate" }], "title": "4.1. Request a lock" }, { "refs": [{ "id": "ref-for-list-iterate\u2460" }], "title": "4.4. Process a lock request queue for a given resource name" }, { "refs": [{ "id": "ref-for-list-iterate\u2461" }, { "id": "ref-for-list-iterate\u2462" }], "title": "4.5. Snapshot the lock state" }], "url": "https://infra.spec.whatwg.org/#list-iterate" },
                "26e4aa12": { "dfnID": "26e4aa12", "dfnText": "agent", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-agent" }, { "id": "ref-for-agent\u2460" }], "title": "1. Introduction" }, { "refs": [{ "id": "ref-for-agent\u2461" }], "title": "2.1. Resources Names" }, { "refs": [{ "id": "ref-for-agent\u2462" }], "title": "2.2. Lock Managers" }, { "refs": [{ "id": "ref-for-agent\u2463" }], "title": "2.4. Locks" }, { "refs": [{ "id": "ref-for-agent\u2464" }, { "id": "ref-for-agent\u2465" }], "title": "2.6. Termination of Locks" }, { "refs": [{ "id": "ref-for-agent\u2466" }], "title": "3.2.1. The request() method" }], "url": "https://tc39.github.io/ecma262/#agent" },
                "28e64574": { "dfnID": "28e64574", "dfnText": "abort reason", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-abortsignal-abort-reason" }], "title": "3.2.1. The request() method" }, { "refs": [{ "id": "ref-for-abortsignal-abort-reason\u2460" }], "title": "4.3. Abort a request" }], "url": "https://dom.spec.whatwg.org/#abortsignal-abort-reason" },
                "3182eb71": { "dfnID": "3182eb71", "dfnText": "NotSupportedError", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-notsupportederror" }, { "id": "ref-for-notsupportederror\u2460" }, { "id": "ref-for-notsupportederror\u2461" }, { "id": "ref-for-notsupportederror\u2462" }], "title": "3.2.1. The request() method" }], "url": "https://webidl.spec.whatwg.org/#notsupportederror" },
                "3349d69f": { "dfnID": "3349d69f", "dfnText": "associated Document", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-concept-document-window" }], "title": "3.2.1. The request() method" }, { "refs": [{ "id": "ref-for-concept-document-window\u2460" }], "title": "3.2.2. The query() method" }], "url": "https://html.spec.whatwg.org/multipage/nav-history-apis.html#concept-document-window" },
                "3ab7bf79": { "dfnID": "3ab7bf79", "dfnText": "callback function", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-dfn-callback-function" }], "title": "3.2.1. The request() method" }], "url": "https://webidl.spec.whatwg.org/#dfn-callback-function" },
                "3b90bdcd": { "dfnID": "3b90bdcd", "dfnText": "resolve", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-resolve" }], "title": "2.4. Locks" }, { "refs": [{ "id": "ref-for-resolve\u2460" }], "title": "4.1. Request a lock" }, { "refs": [{ "id": "ref-for-resolve\u2461" }], "title": "4.4. Process a lock request queue for a given resource name" }, { "refs": [{ "id": "ref-for-resolve\u2462" }], "title": "4.5. Snapshot the lock state" }], "url": "https://webidl.spec.whatwg.org/#resolve" },
                "3e12e042": { "dfnID": "3e12e042", "dfnText": "environment settings object", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-environment-settings-object" }], "title": "2.2. Lock Managers" }, { "refs": [{ "id": "ref-for-environment-settings-object\u2460" }], "title": "3.1. Navigator Mixins" }], "url": "https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object" },
                "3fca5a9e": { "dfnID": "3fca5a9e", "dfnText": "map", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-ordered-map" }], "title": "2.5. Lock Requests" }], "url": "https://infra.spec.whatwg.org/#ordered-map" },
                "4013a022": { "dfnID": "4013a022", "dfnText": "this", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-this" }], "title": "3.1. Navigator Mixins" }, { "refs": [{ "id": "ref-for-this\u2460" }], "title": "3.2.1. The request() method" }, { "refs": [{ "id": "ref-for-this\u2461" }], "title": "3.2.2. The query() method" }], "url": "https://webidl.spec.whatwg.org/#this" },
                "4411082c": { "dfnID": "4411082c", "dfnText": "unloading document cleanup steps", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-unloading-document-cleanup-steps" }], "title": "2.6. Termination of Locks" }], "url": "https://html.spec.whatwg.org/multipage/document-lifecycle.html#unloading-document-cleanup-steps" },
                "45209803": { "dfnID": "45209803", "dfnText": "for each (for map)", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-map-iterate" }], "title": "4.5. Snapshot the lock state" }], "url": "https://infra.spec.whatwg.org/#map-iterate" },
                "474cbfcb": { "dfnID": "474cbfcb", "dfnText": "agent cluster", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-integration-with-the-javascript-agent-cluster-formalism" }, { "id": "ref-for-integration-with-the-javascript-agent-cluster-formalism\u2460" }], "title": "1. Introduction" }], "url": "https://html.spec.whatwg.org/multipage/webappapis.html#integration-with-the-javascript-agent-cluster-formalism" },
                "47dfca75": { "dfnID": "47dfca75", "dfnText": "queue", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-queue" }], "title": "2.5. Lock Requests" }], "url": "https://infra.spec.whatwg.org/#queue" },
                "53275e46": { "dfnID": "53275e46", "dfnText": "append (for list)", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-list-append" }, { "id": "ref-for-list-append\u2460" }], "title": "4.5. Snapshot the lock state" }], "url": "https://infra.spec.whatwg.org/#list-append" },
                "535dd335": { "dfnID": "535dd335", "dfnText": "aborted", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-abortsignal-aborted" }], "title": "3.2.1. The request() method" }, { "refs": [{ "id": "ref-for-abortsignal-aborted\u2460" }], "title": "4.4. Process a lock request queue for a given resource name" }], "url": "https://dom.spec.whatwg.org/#abortsignal-aborted" },
                "5372cca8": { "dfnID": "5372cca8", "dfnText": "boolean", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-idl-boolean" }, { "id": "ref-for-idl-boolean\u2460" }], "title": "3.2. LockManager class" }], "url": "https://webidl.spec.whatwg.org/#idl-boolean" },
                "5afbefcd": { "dfnID": "5afbefcd", "dfnText": "item (for list)", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-list-item" }], "title": "2.5. Lock Requests" }], "url": "https://infra.spec.whatwg.org/#list-item" },
                "6148dd37": { "dfnID": "6148dd37", "dfnText": "storage bucket", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-storage-bucket" }], "title": "1. Introduction" }, { "refs": [{ "id": "ref-for-storage-bucket\u2460" }], "title": "2.1. Resources Names" }, { "refs": [{ "id": "ref-for-storage-bucket\u2461" }, { "id": "ref-for-storage-bucket\u2462" }], "title": "2.2. Lock Managers" }], "url": "https://storage.spec.whatwg.org/#storage-bucket" },
                "649608b9": { "dfnID": "649608b9", "dfnText": "list", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-list" }, { "id": "ref-for-list\u2460" }], "title": "4.5. Snapshot the lock state" }], "url": "https://infra.spec.whatwg.org/#list" },
                "67130339": { "dfnID": "67130339", "dfnText": "storage bottle", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-storage-bottle" }, { "id": "ref-for-storage-bottle\u2460" }], "title": "2.2. Lock Managers" }], "url": "https://storage.spec.whatwg.org/#storage-bottle" },
                "6b815fdd": { "dfnID": "6b815fdd", "dfnText": "is empty", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-list-is-empty" }], "title": "2.5. Lock Requests" }], "url": "https://infra.spec.whatwg.org/#list-is-empty" },
                "6bb9d790": { "dfnID": "6bb9d790", "dfnText": "obtain a local storage bottle map", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-obtain-a-local-storage-bottle-map" }], "title": "2.2. Lock Managers" }], "url": "https://storage.spec.whatwg.org/#obtain-a-local-storage-bottle-map" },
                "6c6b1005": { "dfnID": "6c6b1005", "dfnText": "any", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-idl-any" }, { "id": "ref-for-idl-any\u2460" }, { "id": "ref-for-idl-any\u2461" }], "title": "3.2. LockManager class" }], "url": "https://webidl.spec.whatwg.org/#idl-any" },
                "6d19ac93": { "dfnID": "6d19ac93", "dfnText": "user agent", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-user-agent" }], "title": "2. Concepts" }], "url": "https://infra.spec.whatwg.org/#user-agent" },
                "73a186aa": { "dfnID": "73a186aa", "dfnText": "id", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-concept-environment-id" }], "title": "3.2.1. The request() method" }], "url": "https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-id" },
                "77b4c09a": { "dfnID": "77b4c09a", "dfnText": "assert", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-assert" }], "title": "4.2. Release a lock" }, { "refs": [{ "id": "ref-for-assert\u2460" }], "title": "4.3. Abort a request" }, { "refs": [{ "id": "ref-for-assert\u2461" }], "title": "4.4. Process a lock request queue for a given resource name" }, { "refs": [{ "id": "ref-for-assert\u2462" }], "title": "4.5. Snapshot the lock state" }], "url": "https://infra.spec.whatwg.org/#assert" },
                "797018a7": { "dfnID": "797018a7", "dfnText": "InvalidStateError", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-invalidstateerror" }], "title": "3.2.1. The request() method" }, { "refs": [{ "id": "ref-for-invalidstateerror\u2460" }], "title": "3.2.2. The query() method" }], "url": "https://webidl.spec.whatwg.org/#invalidstateerror" },
                "7fd418b6": { "dfnID": "7fd418b6", "dfnText": "id", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-dom-client-id" }], "title": "3.2.2. The query() method" }], "url": "https://www.w3.org/TR/service-workers/#dom-client-id" },
                "8219d486": { "dfnID": "8219d486", "dfnText": "starting a new parallel queue", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-starting-a-new-parallel-queue" }], "title": "2. Concepts" }], "url": "https://html.spec.whatwg.org/multipage/infrastructure.html#starting-a-new-parallel-queue" },
                "87bc23a5": { "dfnID": "87bc23a5", "dfnText": "add", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-abortsignal-add" }], "title": "4.1. Request a lock" }], "url": "https://dom.spec.whatwg.org/#abortsignal-add" },
                "8855a9aa": { "dfnID": "8855a9aa", "dfnText": "DOMString", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-idl-DOMString" }, { "id": "ref-for-idl-DOMString\u2460" }, { "id": "ref-for-idl-DOMString\u2461" }, { "id": "ref-for-idl-DOMString\u2462" }], "title": "3.2. LockManager class" }, { "refs": [{ "id": "ref-for-idl-DOMString\u2463" }], "title": "3.3. Lock class" }], "url": "https://webidl.spec.whatwg.org/#idl-DOMString" },
                "889e932f": { "dfnID": "889e932f", "dfnText": "Exposed", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-Exposed" }], "title": "3.2. LockManager class" }, { "refs": [{ "id": "ref-for-Exposed\u2460" }], "title": "3.3. Lock class" }], "url": "https://webidl.spec.whatwg.org/#Exposed" },
                "984221ca": { "dfnID": "984221ca", "dfnText": "struct", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-struct" }], "title": "2.5. Lock Requests" }], "url": "https://infra.spec.whatwg.org/#struct" },
                "99c988d6": { "dfnID": "99c988d6", "dfnText": "remove", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-list-remove" }], "title": "4.1. Request a lock" }, { "refs": [{ "id": "ref-for-list-remove\u2460" }], "title": "4.2. Release a lock" }, { "refs": [{ "id": "ref-for-list-remove\u2461" }], "title": "4.3. Abort a request" }, { "refs": [{ "id": "ref-for-list-remove\u2462" }], "title": "4.4. Process a lock request queue for a given resource name" }], "url": "https://infra.spec.whatwg.org/#list-remove" },
                "9c4c1e66": { "dfnID": "9c4c1e66", "dfnText": "relevant settings object", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-relevant-settings-object" }], "title": "3.1. Navigator Mixins" }, { "refs": [{ "id": "ref-for-relevant-settings-object\u2460" }], "title": "3.2.1. The request() method" }, { "refs": [{ "id": "ref-for-relevant-settings-object\u2461" }], "title": "3.2.2. The query() method" }, { "refs": [{ "id": "ref-for-relevant-settings-object\u2462" }], "title": "4.1. Request a lock" }, { "refs": [{ "id": "ref-for-relevant-settings-object\u2463" }], "title": "4.4. Process a lock request queue for a given resource name" }], "url": "https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object" },
                "9cce47fd": { "dfnID": "9cce47fd", "dfnText": "sequence", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-idl-sequence" }, { "id": "ref-for-idl-sequence\u2460" }], "title": "3.2. LockManager class" }], "url": "https://webidl.spec.whatwg.org/#idl-sequence" },
                "a3b18719": { "dfnID": "a3b18719", "dfnText": "append (for set)", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-set-append" }], "title": "4.4. Process a lock request queue for a given resource name" }], "url": "https://infra.spec.whatwg.org/#set-append" },
                "a4785085": { "dfnID": "a4785085", "dfnText": "WorkerNavigator", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-workernavigator" }], "title": "3.1. Navigator Mixins" }], "url": "https://html.spec.whatwg.org/multipage/workers.html#workernavigator" },
                "a973e0fe": { "dfnID": "a973e0fe", "dfnText": "document", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-concept-document" }], "title": "2.6. Termination of Locks" }], "url": "https://dom.spec.whatwg.org/#concept-document" },
                "abort-the-request": { "dfnID": "abort-the-request", "dfnText": "abort the request", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-abort-the-request" }], "title": "2.6. Termination of Locks" }, { "refs": [{ "id": "ref-for-abort-the-request\u2460" }], "title": "4.3. Abort a request" }], "url": "#abort-the-request" },
                "b262501e": { "dfnID": "b262501e", "dfnText": "reject", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-reject" }], "title": "4.1. Request a lock" }, { "refs": [{ "id": "ref-for-reject\u2460" }], "title": "4.3. Abort a request" }], "url": "https://webidl.spec.whatwg.org/#reject" },
                "b38d7ca1": { "dfnID": "b38d7ca1", "dfnText": "JavaScript string", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-string" }], "title": "2.1. Resources Names" }], "url": "https://infra.spec.whatwg.org/#string" },
                "b75bb3bd": { "dfnID": "b75bb3bd", "dfnText": "SecureContext", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-SecureContext" }], "title": "3.1. Navigator Mixins" }, { "refs": [{ "id": "ref-for-SecureContext\u2460" }], "title": "3.2. LockManager class" }, { "refs": [{ "id": "ref-for-SecureContext\u2461" }], "title": "3.3. Lock class" }], "url": "https://webidl.spec.whatwg.org/#SecureContext" },
                "bdbd19d1": { "dfnID": "bdbd19d1", "dfnText": "Promise", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-idl-promise" }, { "id": "ref-for-idl-promise\u2460" }, { "id": "ref-for-idl-promise\u2461" }, { "id": "ref-for-idl-promise\u2462" }], "title": "3.2. LockManager class" }], "url": "https://webidl.spec.whatwg.org/#idl-promise" },
                "be0c27b2": { "dfnID": "be0c27b2", "dfnText": "Navigator", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-navigator" }], "title": "3.1. Navigator Mixins" }], "url": "https://html.spec.whatwg.org/multipage/system-state.html#navigator" },
                "c3b2d08c": { "dfnID": "c3b2d08c", "dfnText": "task source", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-task-source" }], "title": "2. Concepts" }], "url": "https://html.spec.whatwg.org/multipage/webappapis.html#task-source" },
                "c3e881ef": { "dfnID": "c3e881ef", "dfnText": "SecurityError", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-securityerror" }], "title": "3.2.1. The request() method" }, { "refs": [{ "id": "ref-for-securityerror\u2460" }], "title": "3.2.2. The query() method" }], "url": "https://webidl.spec.whatwg.org/#securityerror" },
                "c88f3887": { "dfnID": "c88f3887", "dfnText": "item (for struct)", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-struct-item" }], "title": "2.5. Lock Requests" }], "url": "https://infra.spec.whatwg.org/#struct-item" },
                "callbackdef-lockgrantedcallback": { "dfnID": "callbackdef-lockgrantedcallback", "dfnText": "LockGrantedCallback", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-callbackdef-lockgrantedcallback" }, { "id": "ref-for-callbackdef-lockgrantedcallback\u2460" }], "title": "3.2. LockManager class" }], "url": "#callbackdef-lockgrantedcallback" },
                "cca3cdb2": { "dfnID": "cca3cdb2", "dfnText": "AbortSignal", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-abortsignal" }], "title": "3.2. LockManager class" }, { "refs": [{ "id": "ref-for-abortsignal\u2460" }], "title": "3.2.1. The request() method" }], "url": "https://dom.spec.whatwg.org/#abortsignal" },
                "d0b4a948": { "dfnID": "d0b4a948", "dfnText": "a promise rejected with", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-a-promise-rejected-with" }, { "id": "ref-for-a-promise-rejected-with\u2460" }, { "id": "ref-for-a-promise-rejected-with\u2461" }, { "id": "ref-for-a-promise-rejected-with\u2462" }, { "id": "ref-for-a-promise-rejected-with\u2463" }, { "id": "ref-for-a-promise-rejected-with\u2464" }, { "id": "ref-for-a-promise-rejected-with\u2465" }], "title": "3.2.1. The request() method" }, { "refs": [{ "id": "ref-for-a-promise-rejected-with\u2466" }, { "id": "ref-for-a-promise-rejected-with\u2467" }], "title": "3.2.2. The query() method" }], "url": "https://webidl.spec.whatwg.org/#a-promise-rejected-with" },
                "d25dfb2c": { "dfnID": "d25dfb2c", "dfnText": "AbortError", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-aborterror" }, { "id": "ref-for-aborterror\u2460" }], "title": "3.2.1. The request() method" }, { "refs": [{ "id": "ref-for-aborterror\u2461" }], "title": "4.1. Request a lock" }], "url": "https://webidl.spec.whatwg.org/#aborterror" },
                "dacde8b5": { "dfnID": "dacde8b5", "dfnText": "a new promise", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-a-new-promise" }], "title": "3.2.1. The request() method" }, { "refs": [{ "id": "ref-for-a-new-promise\u2460" }], "title": "3.2.2. The query() method" }, { "refs": [{ "id": "ref-for-a-new-promise\u2461" }], "title": "4.4. Process a lock request queue for a given resource name" }], "url": "https://webidl.spec.whatwg.org/#a-new-promise" },
                "dca2de17": { "dfnID": "dca2de17", "dfnText": "DOMException", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-idl-DOMException" }, { "id": "ref-for-idl-DOMException\u2460" }, { "id": "ref-for-idl-DOMException\u2461" }, { "id": "ref-for-idl-DOMException\u2462" }, { "id": "ref-for-idl-DOMException\u2463" }, { "id": "ref-for-idl-DOMException\u2464" }], "title": "3.2.1. The request() method" }, { "refs": [{ "id": "ref-for-idl-DOMException\u2465" }, { "id": "ref-for-idl-DOMException\u2466" }], "title": "3.2.2. The query() method" }, { "refs": [{ "id": "ref-for-idl-DOMException\u2467" }], "title": "4.1. Request a lock" }], "url": "https://webidl.spec.whatwg.org/#idl-DOMException" },
                "dictdef-lockinfo": { "dfnID": "dictdef-lockinfo", "dfnText": "LockInfo", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-dictdef-lockinfo" }, { "id": "ref-for-dictdef-lockinfo\u2460" }], "title": "3.2. LockManager class" }], "url": "#dictdef-lockinfo" },
                "dictdef-lockmanagersnapshot": { "dfnID": "dictdef-lockmanagersnapshot", "dfnText": "LockManagerSnapshot", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-dictdef-lockmanagersnapshot" }], "title": "3.2. LockManager class" }], "url": "#dictdef-lockmanagersnapshot" },
                "dictdef-lockoptions": { "dfnID": "dictdef-lockoptions", "dfnText": "LockOptions", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-dictdef-lockoptions" }], "title": "3.2. LockManager class" }, { "refs": [{ "id": "ref-for-dictdef-lockoptions\u2460" }], "title": "3.2.1. The request() method" }], "url": "#dictdef-lockoptions" },
                "dom-lock-mode": { "dfnID": "dom-lock-mode", "dfnText": "mode", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-dom-lock-mode" }], "title": "3.3. Lock class" }], "url": "#dom-lock-mode" },
                "dom-lock-name": { "dfnID": "dom-lock-name", "dfnText": "name", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-dom-lock-name" }], "title": "3.3. Lock class" }], "url": "#dom-lock-name" },
                "dom-lockgrantedcallback-lock": { "dfnID": "dom-lockgrantedcallback-lock", "dfnText": "lock", "external": false, "refSections": [], "url": "#dom-lockgrantedcallback-lock" },
                "dom-lockinfo-clientid": { "dfnID": "dom-lockinfo-clientid", "dfnText": "clientId", "external": false, "refSections": [], "url": "#dom-lockinfo-clientid" },
                "dom-lockinfo-mode": { "dfnID": "dom-lockinfo-mode", "dfnText": "mode", "external": false, "refSections": [], "url": "#dom-lockinfo-mode" },
                "dom-lockinfo-name": { "dfnID": "dom-lockinfo-name", "dfnText": "name", "external": false, "refSections": [], "url": "#dom-lockinfo-name" },
                "dom-lockmanager-query": { "dfnID": "dom-lockmanager-query", "dfnText": "query()", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-dom-lockmanager-query" }], "title": "3.2. LockManager class" }, { "refs": [{ "id": "ref-for-dom-lockmanager-query\u2460" }, { "id": "ref-for-dom-lockmanager-query\u2461" }, { "id": "ref-for-dom-lockmanager-query\u2462" }], "title": "3.2.2. The query() method" }], "url": "#dom-lockmanager-query" },
                "dom-lockmanager-request": { "dfnID": "dom-lockmanager-request", "dfnText": "request(name, callback)", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-dom-lockmanager-request" }], "title": "2.4. Locks" }, { "refs": [{ "id": "ref-for-dom-lockmanager-request\u2460" }], "title": "3.2. LockManager class" }, { "refs": [{ "id": "ref-for-dom-lockmanager-request\u2461" }, { "id": "ref-for-dom-lockmanager-request\u2462" }, { "id": "ref-for-dom-lockmanager-request\u2463" }], "title": "3.2.1. The request() method" }], "url": "#dom-lockmanager-request" },
                "dom-lockmanager-request-name-callback-callback": { "dfnID": "dom-lockmanager-request-name-callback-callback", "dfnText": "callback", "external": false, "refSections": [], "url": "#dom-lockmanager-request-name-callback-callback" },
                "dom-lockmanager-request-name-callback-name": { "dfnID": "dom-lockmanager-request-name-callback-name", "dfnText": "name", "external": false, "refSections": [], "url": "#dom-lockmanager-request-name-callback-name" },
                "dom-lockmanager-request-name-options-callback": { "dfnID": "dom-lockmanager-request-name-options-callback", "dfnText": "request(name, options, callback)", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-dom-lockmanager-request-name-options-callback" }], "title": "3.2. LockManager class" }, { "refs": [{ "id": "ref-for-dom-lockmanager-request-name-options-callback\u2460" }], "title": "3.2.1. The request() method" }], "url": "#dom-lockmanager-request-name-options-callback" },
                "dom-lockmanager-request-name-options-callback-callback": { "dfnID": "dom-lockmanager-request-name-options-callback-callback", "dfnText": "callback", "external": false, "refSections": [], "url": "#dom-lockmanager-request-name-options-callback-callback" },
                "dom-lockmanager-request-name-options-callback-name": { "dfnID": "dom-lockmanager-request-name-options-callback-name", "dfnText": "name", "external": false, "refSections": [], "url": "#dom-lockmanager-request-name-options-callback-name" },
                "dom-lockmanager-request-name-options-callback-options": { "dfnID": "dom-lockmanager-request-name-options-callback-options", "dfnText": "options", "external": false, "refSections": [], "url": "#dom-lockmanager-request-name-options-callback-options" },
                "dom-lockmanagersnapshot-held": { "dfnID": "dom-lockmanagersnapshot-held", "dfnText": "held", "external": false, "refSections": [], "url": "#dom-lockmanagersnapshot-held" },
                "dom-lockmanagersnapshot-pending": { "dfnID": "dom-lockmanagersnapshot-pending", "dfnText": "pending", "external": false, "refSections": [], "url": "#dom-lockmanagersnapshot-pending" },
                "dom-lockmode-exclusive": { "dfnID": "dom-lockmode-exclusive", "dfnText": "\"exclusive\"", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-dom-lockmode-exclusive" }, { "id": "ref-for-dom-lockmode-exclusive\u2460" }, { "id": "ref-for-dom-lockmode-exclusive\u2461" }, { "id": "ref-for-dom-lockmode-exclusive\u2462" }], "title": "2.3. Modes and Scheduling" }, { "refs": [{ "id": "ref-for-dom-lockmode-exclusive\u2463" }], "title": "2.4. Locks" }, { "refs": [{ "id": "ref-for-dom-lockmode-exclusive\u2464" }, { "id": "ref-for-dom-lockmode-exclusive\u2465" }], "title": "2.5. Lock Requests" }, { "refs": [{ "id": "ref-for-dom-lockmode-exclusive\u2466" }, { "id": "ref-for-dom-lockmode-exclusive\u2467" }, { "id": "ref-for-dom-lockmode-exclusive\u2468" }], "title": "3.2.1. The request() method" }], "url": "#dom-lockmode-exclusive" },
                "dom-lockmode-shared": { "dfnID": "dom-lockmode-shared", "dfnText": "\"shared\"", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-dom-lockmode-shared" }, { "id": "ref-for-dom-lockmode-shared\u2460" }, { "id": "ref-for-dom-lockmode-shared\u2461" }], "title": "2.3. Modes and Scheduling" }, { "refs": [{ "id": "ref-for-dom-lockmode-shared\u2462" }], "title": "2.4. Locks" }, { "refs": [{ "id": "ref-for-dom-lockmode-shared\u2463" }], "title": "2.5. Lock Requests" }, { "refs": [{ "id": "ref-for-dom-lockmode-shared\u2464" }, { "id": "ref-for-dom-lockmode-shared\u2465" }], "title": "3.2.1. The request() method" }], "url": "#dom-lockmode-shared" },
                "dom-lockoptions-ifavailable": { "dfnID": "dom-lockoptions-ifavailable", "dfnText": "ifAvailable", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-dom-lockoptions-ifavailable" }], "title": "3.2.1. The request() method" }], "url": "#dom-lockoptions-ifavailable" },
                "dom-lockoptions-mode": { "dfnID": "dom-lockoptions-mode", "dfnText": "mode", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-dom-lockoptions-mode" }], "title": "3.2.1. The request() method" }], "url": "#dom-lockoptions-mode" },
                "dom-lockoptions-signal": { "dfnID": "dom-lockoptions-signal", "dfnText": "signal", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-dom-lockoptions-signal" }], "title": "3.2.1. The request() method" }], "url": "#dom-lockoptions-signal" },
                "dom-lockoptions-steal": { "dfnID": "dom-lockoptions-steal", "dfnText": "steal", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-dom-lockoptions-steal" }, { "id": "ref-for-dom-lockoptions-steal\u2460" }], "title": "3.2.1. The request() method" }], "url": "#dom-lockoptions-steal" },
                "dom-navigatorlocks-locks": { "dfnID": "dom-navigatorlocks-locks", "dfnText": "locks", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-dom-navigatorlocks-locks" }], "title": "3.1. Navigator Mixins" }], "url": "#dom-navigatorlocks-locks" },
                "e2fc6023": { "dfnID": "e2fc6023", "dfnText": "prepend", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-list-prepend" }], "title": "4.1. Request a lock" }], "url": "https://infra.spec.whatwg.org/#list-prepend" },
                "e3288657": { "dfnID": "e3288657", "dfnText": "responsible event loop", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-responsible-event-loop" }], "title": "4.1. Request a lock" }, { "refs": [{ "id": "ref-for-responsible-event-loop\u2460" }], "title": "4.4. Process a lock request queue for a given resource name" }], "url": "https://html.spec.whatwg.org/multipage/webappapis.html#responsible-event-loop" },
                "e4d92278": { "dfnID": "e4d92278", "dfnText": "enqueue steps", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-enqueue-the-following-steps" }], "title": "2. Concepts" }, { "refs": [{ "id": "ref-for-enqueue-the-following-steps\u2460" }], "title": "2.4. Locks" }, { "refs": [{ "id": "ref-for-enqueue-the-following-steps\u2461" }], "title": "2.6. Termination of Locks" }, { "refs": [{ "id": "ref-for-enqueue-the-following-steps\u2462" }], "title": "3.2.2. The query() method" }, { "refs": [{ "id": "ref-for-enqueue-the-following-steps\u2463" }, { "id": "ref-for-enqueue-the-following-steps\u2464" }], "title": "4.1. Request a lock" }, { "refs": [{ "id": "ref-for-enqueue-the-following-steps\u2465" }], "title": "4.3. Abort a request" }, { "refs": [{ "id": "ref-for-enqueue-the-following-steps\u2466" }, { "id": "ref-for-enqueue-the-following-steps\u2467" }], "title": "4.4. Process a lock request queue for a given resource name" }], "url": "https://html.spec.whatwg.org/multipage/infrastructure.html#enqueue-the-following-steps" },
                "e99bd18e": { "dfnID": "e99bd18e", "dfnText": "relevant global object", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-concept-relevant-global" }], "title": "3.2.1. The request() method" }, { "refs": [{ "id": "ref-for-concept-relevant-global\u2460" }], "title": "3.2.2. The query() method" }], "url": "https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global" },
                "enumdef-lockmode": { "dfnID": "enumdef-lockmode", "dfnText": "LockMode", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-enumdef-lockmode" }, { "id": "ref-for-enumdef-lockmode\u2460" }], "title": "3.2. LockManager class" }, { "refs": [{ "id": "ref-for-enumdef-lockmode\u2461" }], "title": "3.3. Lock class" }], "url": "#enumdef-lockmode" },
                "f58a36be": { "dfnID": "f58a36be", "dfnText": "Client", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-client" }], "title": "3.2.2. The query() method" }], "url": "https://www.w3.org/TR/service-workers/#client" },
                "ff87eaf9": { "dfnID": "ff87eaf9", "dfnText": "remove", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-abortsignal-remove" }], "title": "4.4. Process a lock request queue for a given resource name" }], "url": "https://dom.spec.whatwg.org/#abortsignal-remove" },
                "get-the-lock-request-queue": { "dfnID": "get-the-lock-request-queue", "dfnText": "get the lock request queue", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-get-the-lock-request-queue" }], "title": "2.5. Lock Requests" }, { "refs": [{ "id": "ref-for-get-the-lock-request-queue\u2460" }], "title": "4.1. Request a lock" }, { "refs": [{ "id": "ref-for-get-the-lock-request-queue\u2461" }], "title": "4.2. Release a lock" }, { "refs": [{ "id": "ref-for-get-the-lock-request-queue\u2462" }], "title": "4.3. Abort a request" }], "url": "#get-the-lock-request-queue" },
                "grantable": { "dfnID": "grantable", "dfnText": "grantable", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-grantable" }], "title": "4.1. Request a lock" }, { "refs": [{ "id": "ref-for-grantable\u2460" }], "title": "4.4. Process a lock request queue for a given resource name" }], "url": "#grantable" },
                "lock": { "dfnID": "lock", "dfnText": "Lock", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-lock" }], "title": "3.2. LockManager class" }, { "refs": [{ "id": "ref-for-lock\u2460" }], "title": "3.2.1. The request() method" }, { "refs": [{ "id": "ref-for-lock\u2461" }, { "id": "ref-for-lock\u2462" }], "title": "3.3. Lock class" }, { "refs": [{ "id": "ref-for-lock\u2463" }], "title": "4.4. Process a lock request queue for a given resource name" }], "url": "#lock" },
                "lock-concept": { "dfnID": "lock-concept", "dfnText": "lock", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-lock-concept" }], "title": "1. Introduction" }, { "refs": [{ "id": "ref-for-lock-concept\u2460" }], "title": "2.2. Lock Managers" }, { "refs": [{ "id": "ref-for-lock-concept\u2461" }, { "id": "ref-for-lock-concept\u2462" }, { "id": "ref-for-lock-concept\u2463" }, { "id": "ref-for-lock-concept\u2464" }, { "id": "ref-for-lock-concept\u2465" }, { "id": "ref-for-lock-concept\u2466" }, { "id": "ref-for-lock-concept\u2467" }, { "id": "ref-for-lock-concept\u2468" }, { "id": "ref-for-lock-concept\u2460\u24ea" }], "title": "2.4. Locks" }, { "refs": [{ "id": "ref-for-lock-concept\u2460\u2460" }, { "id": "ref-for-lock-concept\u2460\u2461" }, { "id": "ref-for-lock-concept\u2460\u2462" }], "title": "2.5. Lock Requests" }, { "refs": [{ "id": "ref-for-lock-concept\u2460\u2463" }], "title": "2.6. Termination of Locks" }, { "refs": [{ "id": "ref-for-lock-concept\u2460\u2464" }, { "id": "ref-for-lock-concept\u2460\u2465" }, { "id": "ref-for-lock-concept\u2460\u2466" }], "title": "3.3. Lock class" }, { "refs": [{ "id": "ref-for-lock-concept\u2460\u2467" }], "title": "4.1. Request a lock" }, { "refs": [{ "id": "ref-for-lock-concept\u2460\u2468" }], "title": "4.2. Release a lock" }, { "refs": [{ "id": "ref-for-lock-concept\u2461\u24ea" }], "title": "4.4. Process a lock request queue for a given resource name" }], "url": "#lock-concept" },
                "lock-concept-agent": { "dfnID": "lock-concept-agent", "dfnText": "agent", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-lock-concept-agent" }], "title": "2.6. Termination of Locks" }, { "refs": [{ "id": "ref-for-lock-concept-agent\u2460" }, { "id": "ref-for-lock-concept-agent\u2461" }], "title": "4.4. Process a lock request queue for a given resource name" }], "url": "#lock-concept-agent" },
                "lock-concept-clientid": { "dfnID": "lock-concept-clientid", "dfnText": "clientId", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-lock-concept-clientid" }], "title": "4.4. Process a lock request queue for a given resource name" }, { "refs": [{ "id": "ref-for-lock-concept-clientid\u2460" }], "title": "4.5. Snapshot the lock state" }], "url": "#lock-concept-clientid" },
                "lock-concept-manager": { "dfnID": "lock-concept-manager", "dfnText": "manager", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-lock-concept-manager" }], "title": "4.2. Release a lock" }, { "refs": [{ "id": "ref-for-lock-concept-manager\u2460" }], "title": "4.4. Process a lock request queue for a given resource name" }], "url": "#lock-concept-manager" },
                "lock-concept-mode": { "dfnID": "lock-concept-mode", "dfnText": "mode", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-lock-concept-mode" }], "title": "2.5. Lock Requests" }, { "refs": [{ "id": "ref-for-lock-concept-mode\u2460" }], "title": "3.3. Lock class" }, { "refs": [{ "id": "ref-for-lock-concept-mode\u2461" }], "title": "4.4. Process a lock request queue for a given resource name" }, { "refs": [{ "id": "ref-for-lock-concept-mode\u2462" }], "title": "4.5. Snapshot the lock state" }], "url": "#lock-concept-mode" },
                "lock-concept-name": { "dfnID": "lock-concept-name", "dfnText": "name", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-lock-concept-name" }, { "id": "ref-for-lock-concept-name\u2460" }], "title": "2.5. Lock Requests" }, { "refs": [{ "id": "ref-for-lock-concept-name\u2461" }], "title": "3.3. Lock class" }, { "refs": [{ "id": "ref-for-lock-concept-name\u2462" }], "title": "4.1. Request a lock" }, { "refs": [{ "id": "ref-for-lock-concept-name\u2463" }], "title": "4.4. Process a lock request queue for a given resource name" }, { "refs": [{ "id": "ref-for-lock-concept-name\u2464" }], "title": "4.5. Snapshot the lock state" }], "url": "#lock-concept-name" },
                "lock-concept-released-promise": { "dfnID": "lock-concept-released-promise", "dfnText": "released promise", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-lock-concept-released-promise" }, { "id": "ref-for-lock-concept-released-promise\u2460" }, { "id": "ref-for-lock-concept-released-promise\u2461" }, { "id": "ref-for-lock-concept-released-promise\u2462" }], "title": "2.4. Locks" }, { "refs": [{ "id": "ref-for-lock-concept-released-promise\u2463" }], "title": "3.2.1. The request() method" }, { "refs": [{ "id": "ref-for-lock-concept-released-promise\u2464" }], "title": "4.1. Request a lock" }, { "refs": [{ "id": "ref-for-lock-concept-released-promise\u2465" }], "title": "4.4. Process a lock request queue for a given resource name" }], "url": "#lock-concept-released-promise" },
                "lock-concept-waiting-promise": { "dfnID": "lock-concept-waiting-promise", "dfnText": "waiting promise", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-lock-concept-waiting-promise" }, { "id": "ref-for-lock-concept-waiting-promise\u2460" }, { "id": "ref-for-lock-concept-waiting-promise\u2461" }, { "id": "ref-for-lock-concept-waiting-promise\u2462" }, { "id": "ref-for-lock-concept-waiting-promise\u2463" }], "title": "2.4. Locks" }, { "refs": [{ "id": "ref-for-lock-concept-waiting-promise\u2464" }], "title": "4.4. Process a lock request queue for a given resource name" }], "url": "#lock-concept-waiting-promise" },
                "lock-manager": { "dfnID": "lock-manager", "dfnText": "lock manager", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-lock-manager" }, { "id": "ref-for-lock-manager\u2460" }, { "id": "ref-for-lock-manager\u2461" }], "title": "2.2. Lock Managers" }, { "refs": [{ "id": "ref-for-lock-manager\u2462" }, { "id": "ref-for-lock-manager\u2463" }], "title": "2.4. Locks" }, { "refs": [{ "id": "ref-for-lock-manager\u2464" }], "title": "2.5. Lock Requests" }, { "refs": [{ "id": "ref-for-lock-manager\u2465" }], "title": "3.2. LockManager class" }, { "refs": [{ "id": "ref-for-lock-manager\u2466" }, { "id": "ref-for-lock-manager\u2467" }], "title": "3.2.2. The query() method" }, { "refs": [{ "id": "ref-for-lock-manager\u2468" }], "title": "5.1. Deadlocks" }, { "refs": [{ "id": "ref-for-lock-manager\u2460\u24ea" }], "title": "6.1. Lock Scope" }], "url": "#lock-manager" },
                "lock-manager-held-lock-set": { "dfnID": "lock-manager-held-lock-set", "dfnText": "held lock set", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-lock-manager-held-lock-set" }], "title": "2.5. Lock Requests" }, { "refs": [{ "id": "ref-for-lock-manager-held-lock-set\u2460" }], "title": "4.1. Request a lock" }, { "refs": [{ "id": "ref-for-lock-manager-held-lock-set\u2461" }], "title": "4.2. Release a lock" }, { "refs": [{ "id": "ref-for-lock-manager-held-lock-set\u2462" }], "title": "4.4. Process a lock request queue for a given resource name" }, { "refs": [{ "id": "ref-for-lock-manager-held-lock-set\u2463" }], "title": "4.5. Snapshot the lock state" }], "url": "#lock-manager-held-lock-set" },
                "lock-manager-lock-request-queue-map": { "dfnID": "lock-manager-lock-request-queue-map", "dfnText": "lock request queue map", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-lock-manager-lock-request-queue-map" }, { "id": "ref-for-lock-manager-lock-request-queue-map\u2460" }], "title": "2.5. Lock Requests" }, { "refs": [{ "id": "ref-for-lock-manager-lock-request-queue-map\u2461" }], "title": "4.1. Request a lock" }, { "refs": [{ "id": "ref-for-lock-manager-lock-request-queue-map\u2462" }], "title": "4.2. Release a lock" }, { "refs": [{ "id": "ref-for-lock-manager-lock-request-queue-map\u2463" }], "title": "4.3. Abort a request" }, { "refs": [{ "id": "ref-for-lock-manager-lock-request-queue-map\u2464" }], "title": "4.5. Snapshot the lock state" }], "url": "#lock-manager-lock-request-queue-map" },
                "lock-request": { "dfnID": "lock-request", "dfnText": "lock request", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-lock-request" }], "title": "1. Introduction" }, { "refs": [{ "id": "ref-for-lock-request\u2460" }], "title": "2.2. Lock Managers" }, { "refs": [{ "id": "ref-for-lock-request\u2461" }, { "id": "ref-for-lock-request\u2462" }, { "id": "ref-for-lock-request\u2463" }], "title": "2.5. Lock Requests" }, { "refs": [{ "id": "ref-for-lock-request\u2464" }], "title": "2.6. Termination of Locks" }, { "refs": [{ "id": "ref-for-lock-request\u2465" }], "title": "3.2. LockManager class" }, { "refs": [{ "id": "ref-for-lock-request\u2466" }], "title": "4.1. Request a lock" }], "url": "#lock-request" },
                "lock-request-agent": { "dfnID": "lock-request-agent", "dfnText": "agent", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-lock-request-agent" }], "title": "2.6. Termination of Locks" }], "url": "#lock-request-agent" },
                "lock-request-callback": { "dfnID": "lock-request-callback", "dfnText": "callback", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-lock-request-callback" }], "title": "4.4. Process a lock request queue for a given resource name" }], "url": "#lock-request-callback" },
                "lock-request-clientid": { "dfnID": "lock-request-clientid", "dfnText": "clientId", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-lock-request-clientid" }], "title": "4.4. Process a lock request queue for a given resource name" }, { "refs": [{ "id": "ref-for-lock-request-clientid\u2460" }], "title": "4.5. Snapshot the lock state" }], "url": "#lock-request-clientid" },
                "lock-request-manager": { "dfnID": "lock-request-manager", "dfnText": "manager", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-lock-request-manager" }], "title": "2.5. Lock Requests" }, { "refs": [{ "id": "ref-for-lock-request-manager\u2460" }], "title": "4.3. Abort a request" }, { "refs": [{ "id": "ref-for-lock-request-manager\u2461" }], "title": "4.4. Process a lock request queue for a given resource name" }], "url": "#lock-request-manager" },
                "lock-request-mode": { "dfnID": "lock-request-mode", "dfnText": "mode", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-lock-request-mode" }], "title": "2.5. Lock Requests" }, { "refs": [{ "id": "ref-for-lock-request-mode\u2460" }], "title": "4.4. Process a lock request queue for a given resource name" }, { "refs": [{ "id": "ref-for-lock-request-mode\u2461" }], "title": "4.5. Snapshot the lock state" }], "url": "#lock-request-mode" },
                "lock-request-name": { "dfnID": "lock-request-name", "dfnText": "name", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-lock-request-name" }], "title": "2.5. Lock Requests" }, { "refs": [{ "id": "ref-for-lock-request-name\u2460" }], "title": "4.3. Abort a request" }, { "refs": [{ "id": "ref-for-lock-request-name\u2461" }], "title": "4.4. Process a lock request queue for a given resource name" }, { "refs": [{ "id": "ref-for-lock-request-name\u2462" }], "title": "4.5. Snapshot the lock state" }], "url": "#lock-request-name" },
                "lock-request-promise": { "dfnID": "lock-request-promise", "dfnText": "promise", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-lock-request-promise" }], "title": "4.3. Abort a request" }, { "refs": [{ "id": "ref-for-lock-request-promise\u2460" }], "title": "4.4. Process a lock request queue for a given resource name" }], "url": "#lock-request-promise" },
                "lock-request-queue": { "dfnID": "lock-request-queue", "dfnText": "lock request queue", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-lock-request-queue" }, { "id": "ref-for-lock-request-queue\u2460" }], "title": "2.5. Lock Requests" }], "url": "#lock-request-queue" },
                "lock-request-signal": { "dfnID": "lock-request-signal", "dfnText": "signal", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-lock-request-signal" }], "title": "4.4. Process a lock request queue for a given resource name" }], "url": "#lock-request-signal" },
                "lock-task-queue": { "dfnID": "lock-task-queue", "dfnText": "lock task queue", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-lock-task-queue" }], "title": "2.4. Locks" }, { "refs": [{ "id": "ref-for-lock-task-queue\u2460" }], "title": "2.6. Termination of Locks" }, { "refs": [{ "id": "ref-for-lock-task-queue\u2461" }], "title": "3.2.2. The query() method" }, { "refs": [{ "id": "ref-for-lock-task-queue\u2462" }], "title": "4.1. Request a lock" }, { "refs": [{ "id": "ref-for-lock-task-queue\u2463" }], "title": "4.2. Release a lock" }, { "refs": [{ "id": "ref-for-lock-task-queue\u2464" }, { "id": "ref-for-lock-task-queue\u2465" }], "title": "4.3. Abort a request" }, { "refs": [{ "id": "ref-for-lock-task-queue\u2466" }, { "id": "ref-for-lock-task-queue\u2467" }], "title": "4.4. Process a lock request queue for a given resource name" }, { "refs": [{ "id": "ref-for-lock-task-queue\u2468" }], "title": "4.5. Snapshot the lock state" }], "url": "#lock-task-queue" },
                "lockmanager": { "dfnID": "lockmanager", "dfnText": "LockManager", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-lockmanager" }], "title": "2.4. Locks" }, { "refs": [{ "id": "ref-for-lockmanager\u2460" }, { "id": "ref-for-lockmanager\u2461" }, { "id": "ref-for-lockmanager\u2462" }], "title": "3.1. Navigator Mixins" }, { "refs": [{ "id": "ref-for-lockmanager\u2463" }, { "id": "ref-for-lockmanager\u2464" }], "title": "3.2. LockManager class" }], "url": "#lockmanager" },
                "mode": { "dfnID": "mode", "dfnText": "mode", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-mode" }, { "id": "ref-for-mode\u2460" }], "title": "1. Introduction" }], "url": "#mode" },
                "navigatorlocks": { "dfnID": "navigatorlocks", "dfnText": "NavigatorLocks", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-navigatorlocks" }, { "id": "ref-for-navigatorlocks\u2460" }], "title": "3.1. Navigator Mixins" }], "url": "#navigatorlocks" },
                "obtain-a-lock-manager": { "dfnID": "obtain-a-lock-manager", "dfnText": "obtain a lock manager", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-obtain-a-lock-manager" }], "title": "3.2.1. The request() method" }, { "refs": [{ "id": "ref-for-obtain-a-lock-manager\u2460" }], "title": "3.2.2. The query() method" }], "url": "#obtain-a-lock-manager" },
                "process-the-lock-request-queue": { "dfnID": "process-the-lock-request-queue", "dfnText": "process the lock request queue", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-process-the-lock-request-queue" }], "title": "4.1. Request a lock" }, { "refs": [{ "id": "ref-for-process-the-lock-request-queue\u2460" }], "title": "4.2. Release a lock" }, { "refs": [{ "id": "ref-for-process-the-lock-request-queue\u2461" }], "title": "4.3. Abort a request" }], "url": "#process-the-lock-request-queue" },
                "release-the-lock": { "dfnID": "release-the-lock", "dfnText": "release the lock", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-release-the-lock" }], "title": "2.4. Locks" }, { "refs": [{ "id": "ref-for-release-the-lock\u2460" }], "title": "2.6. Termination of Locks" }, { "refs": [{ "id": "ref-for-release-the-lock\u2461" }], "title": "4.4. Process a lock request queue for a given resource name" }], "url": "#release-the-lock" },
                "request-a-lock": { "dfnID": "request-a-lock", "dfnText": "request a lock", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-request-a-lock" }], "title": "3.2.1. The request() method" }], "url": "#request-a-lock" },
                "resource-name": { "dfnID": "resource-name", "dfnText": "resource name", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-resource-name" }, { "id": "ref-for-resource-name\u2460" }], "title": "1. Introduction" }, { "refs": [{ "id": "ref-for-resource-name\u2461" }], "title": "2.4. Locks" }, { "refs": [{ "id": "ref-for-resource-name\u2462" }, { "id": "ref-for-resource-name\u2463" }], "title": "2.5. Lock Requests" }, { "refs": [{ "id": "ref-for-resource-name\u2464" }], "title": "3.2.1. The request() method" }, { "refs": [{ "id": "ref-for-resource-name\u2465" }], "title": "4.2. Release a lock" }, { "refs": [{ "id": "ref-for-resource-name\u2466" }], "title": "6.4. Checklist" }], "url": "#resource-name" },
                "signal-to-abort-the-request": { "dfnID": "signal-to-abort-the-request", "dfnText": "signal to abort the request", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-signal-to-abort-the-request" }], "title": "4.1. Request a lock" }, { "refs": [{ "id": "ref-for-signal-to-abort-the-request\u2460" }], "title": "4.4. Process a lock request queue for a given resource name" }], "url": "#signal-to-abort-the-request" },
                "snapshot-the-lock-state": { "dfnID": "snapshot-the-lock-state", "dfnText": "snapshot the lock state", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-snapshot-the-lock-state" }], "title": "3.2.2. The query() method" }], "url": "#snapshot-the-lock-state" },
                "terminate-remaining-locks-and-requests": { "dfnID": "terminate-remaining-locks-and-requests", "dfnText": "terminate remaining locks and requests", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-terminate-remaining-locks-and-requests" }, { "id": "ref-for-terminate-remaining-locks-and-requests\u2460" }], "title": "2.6. Termination of Locks" }], "url": "#terminate-remaining-locks-and-requests" },
                "web-locks-tasks-source": { "dfnID": "web-locks-tasks-source", "dfnText": "web locks tasks source", "external": false, "refSections": [], "url": "#web-locks-tasks-source" },
            };

            document.addEventListener("DOMContentLoaded", () => {
                genAllDfnPanels();

                document.body.addEventListener("click", (e) => {
                    // If not handled already, just hide all dfn panels.
                    hideAllDfnPanels();
                });
            });

            window.addEventListener("resize", () => {
                // Pin any visible dfn panel
                queryAll(".dfn-panel.on, .dfn-panel.activated").forEach(el => positionDfnPanel(el));
            });

            function genAllDfnPanels() {
                for (const panelData of Object.values(dfnPanelData)) {
                    const dfnID = panelData.dfnID;
                    const dfn = document.getElementById(dfnID);
                    if (!dfn) {
                        console.log(`Can't find dfn#${dfnID}.`, panelData);
                        continue;
                    }
                    dfn.panelData = panelData;
                    insertDfnPopupAction(dfn);
                }
            }

            function genDfnPanel(dfn, { dfnID, url, dfnText, refSections, external }) {
                const dfnPanel = mk.aside({
                    class: "dfn-panel on",
                    id: `infopanel-for-${dfnID}`,
                    "data-for": dfnID,
                    "aria-labelled-by": `infopaneltitle-for-${dfnID}`,
                },
                    mk.span({ id: `infopaneltitle-for-${dfnID}`, style: "display:none" },
                        `Info about the '${dfnText}' ${external ? "external" : ""} reference.`),
                    mk.a({ href: url, class: "dfn-link" }, url),
                    refSections.length == 0 ? [] :
                        mk.b({}, "Referenced in:"),
                    mk.ul({},
                        ...refSections.map(section =>
                            mk.li({},
                                ...section.refs.map((ref, refI) =>
                                    [
                                        mk.a({ href: `#${ref.id}` },
                                            (refI == 0) ? section.title : `(${refI + 1})`
                                        ),
                                        " ",
                                    ]
                                ),
                            ),
                        ),
                    ),
                    genLinkingSyntaxes(dfn),
                );

                dfnPanel.addEventListener('click', (event) => {
                    if (event.target.nodeName == 'A') {
                        scrollToTargetAndHighlight(event);
                        pinDfnPanel(dfnPanel);
                    }
                    event.stopPropagation();
                    refocusOnTarget(event);
                });
                dfnPanel.addEventListener('keydown', (event) => {
                    if (event.keyCode == 27) { // Escape key
                        hideDfnPanel({ dfnPanel });
                        event.stopPropagation();
                        event.preventDefault();
                    }
                });

                dfnPanel.dfn = dfn;
                dfn.dfnPanel = dfnPanel;
                return dfnPanel;
            }



            function hideAllDfnPanels() {
                // Delete the currently-active dfn panel.
                queryAll(".dfn-panel").forEach(dfnPanel => hideDfnPanel({ dfnPanel }));
            }

            function showDfnPanel(dfn) {
                hideAllDfnPanels(); // Only display one at a time.

                dfn.setAttribute("aria-expanded", "true");

                const dfnPanel = genDfnPanel(dfn, dfn.panelData);

                // Give the dfn a unique tabindex, and then
                // give all the tabbable panel bits successive indexes.
                let tabIndex = 100;
                dfn.tabIndex = tabIndex++;
                const tabbable = dfnPanel.querySelectorAll(":is(a, button)");
                for (const el of tabbable) {
                    el.tabIndex = tabIndex++;
                }

                append(document.body, dfnPanel);
                positionDfnPanel(dfnPanel);
            }

            function positionDfnPanel(dfnPanel) {
                const dfn = dfnPanel.dfn;
                const dfnPos = getBounds(dfn);
                dfnPanel.style.top = dfnPos.bottom + "px";
                dfnPanel.style.left = dfnPos.left + "px";

                const panelPos = dfnPanel.getBoundingClientRect();
                const panelMargin = 8;
                const maxRight = document.body.parentNode.clientWidth - panelMargin;
                if (panelPos.right > maxRight) {
                    const overflowAmount = panelPos.right - maxRight;
                    const newLeft = Math.max(panelMargin, dfnPos.left - overflowAmount);
                    dfnPanel.style.left = newLeft + "px";
                }
            }

            function pinDfnPanel(dfnPanel) {
                // Switch it to "activated" state, which pins it.
                dfnPanel.classList.add("activated");
                dfnPanel.style.position = "fixed";
                dfnPanel.style.left = null;
                dfnPanel.style.top = null;
            }

            function hideDfnPanel({ dfn, dfnPanel }) {
                if (!dfnPanel) dfnPanel = dfn.dfnPanel;
                if (!dfn) dfn = dfnPanel.dfn;
                dfn.dfnPanel = undefined;
                dfnPanel.dfn = undefined;
                dfn.setAttribute("aria-expanded", "false");
                dfn.tabIndex = undefined;
                dfnPanel.remove()
            }

            function toggleDfnPanel(dfn) {
                if (dfn.dfnPanel) {
                    hideDfnPanel(dfn);
                } else {
                    showDfnPanel(dfn);
                }
            }

            function insertDfnPopupAction(dfn) {
                dfn.setAttribute('role', 'button');
                dfn.setAttribute('aria-expanded', 'false')
                dfn.tabIndex = 0;
                dfn.classList.add('has-dfn-panel');
                dfn.addEventListener('click', (event) => {
                    toggleDfnPanel(dfn);
                    event.stopPropagation();
                });
                dfn.addEventListener('keypress', (event) => {
                    const kc = event.keyCode;
                    // 32->Space, 13->Enter
                    if (kc == 32 || kc == 13) {
                        toggleDfnPanel(dfn);
                        event.stopPropagation();
                        event.preventDefault();
                    }
                });
            }

            function refocusOnTarget(event) {
                const target = event.target;
                setTimeout(() => {
                    // Refocus on the event.target element.
                    // This is needed after browser scrolls to the destination.
                    target.focus();
                });
            }

            // TODO: shared util
            // Returns the root-level absolute position {left and top} of element.
            function getBounds(el, relativeTo = document.body) {
                const relativeRect = relativeTo.getBoundingClientRect();
                const elRect = el.getBoundingClientRect();
                const top = elRect.top - relativeRect.top;
                const left = elRect.left - relativeRect.left;
                return {
                    top,
                    left,
                    bottom: top + elRect.height,
                    right: left + elRect.width,
                }
            }

            function scrollToTargetAndHighlight(event) {
                let hash = event.target.hash;
                if (hash) {
                    hash = decodeURIComponent(hash.substring(1));
                    const dest = document.getElementById(hash);
                    if (dest) {
                        dest.classList.add('highlighted');
                        setTimeout(() => dest.classList.remove('highlighted'), 1000);
                    }
                }
            }

            // Functions, divided by link type, that wrap an autolink's
            // contents with the appropriate outer syntax.
            // Alternately, a string naming another type they format
            // the same as.
            function needsFor(type) {
                switch (type) {
                    case "descriptor":
                    case "value":
                    case "element-attr":
                    case "attr-value":
                    case "element-state":
                    case "method":
                    case "constructor":
                    case "argument":
                    case "attribute":
                    case "const":
                    case "dict-member":
                    case "event":
                    case "enum-value":
                    case "stringifier":
                    case "serializer":
                    case "iterator":
                    case "maplike":
                    case "setlike":
                    case "state":
                    case "mode":
                    case "context":
                    case "facet": return true;

                    default: return false;
                }
            }
            function refusesFor(type) {
                switch (type) {
                    case "property":
                    case "element":
                    case "interface":
                    case "namespace":
                    case "callback":
                    case "dictionary":
                    case "enum":
                    case "exception":
                    case "typedef":
                    case "http-header":
                    case "permission": return true;

                    default: return false;
                }
            }
            function linkFormatterFromType(type) {
                switch (type) {
                    case 'scheme':
                    case 'permission':
                    case 'dfn': return (text) => `[=${text}=]`;

                    case 'abstract-op': return (text) => `[\$${text}\$]`;

                    case 'function':
                    case 'at-rule':
                    case 'selector':
                    case 'value': return (text) => `''${text}''`;

                    case 'http-header': return (text) => `[:${text}:]`;

                    case 'interface':
                    case 'constructor':
                    case 'method':
                    case 'argument':
                    case 'attribute':
                    case 'callback':
                    case 'dictionary':
                    case 'dict-member':
                    case 'enum':
                    case 'enum-value':
                    case 'exception':
                    case 'const':
                    case 'typedef':
                    case 'stringifier':
                    case 'serializer':
                    case 'iterator':
                    case 'maplike':
                    case 'setlike':
                    case 'extended-attribute':
                    case 'event':
                    case 'idl': return (text) => `{{${text}}}`;

                    case 'element-state':
                    case 'element-attr':
                    case 'attr-value':
                    case 'element': return (element) => `<{${element}}>`;

                    case 'grammar': return (text) => `${text} (within a <pre class=prod>)`;

                    case 'type': return (text) => `<<${text}>>`;

                    case 'descriptor':
                    case 'property': return (text) => `'${text}'`;

                    default: return;
                };
            };

            function genLinkingSyntaxes(dfn) {
                if (dfn.tagName != "DFN") return;

                const type = dfn.getAttribute('data-dfn-type');
                if (!type) {
                    console.log(`<dfn> doesn't have a data-dfn-type:`, dfn);
                    return [];
                }

                // Return a function that wraps link text based on the type
                const linkFormatter = linkFormatterFromType(type);
                if (!linkFormatter) {
                    console.log(`<dfn> has an unknown data-dfn-type:`, dfn);
                    return [];
                }

                let ltAlts;
                if (dfn.hasAttribute('data-lt')) {
                    ltAlts = dfn.getAttribute('data-lt')
                        .split("|")
                        .map(x => x.trim());
                } else {
                    ltAlts = [dfn.textContent.trim()];
                }
                if (type == "type") {
                    // lt of "<foo>", but "foo" is the interior;
                    // <<foo/bar>> is how you write it with a for,
                    // not <foo/<bar>> or whatever.
                    for (var i = 0; i < ltAlts.length; i++) {
                        const lt = ltAlts[i];
                        const match = /<(.*)>/.exec(lt);
                        if (match) { ltAlts[i] = match[1]; }
                    }
                }

                let forAlts;
                if (dfn.hasAttribute('data-dfn-for')) {
                    forAlts = dfn.getAttribute('data-dfn-for')
                        .split(",")
                        .map(x => x.trim());
                } else {
                    forAlts = [''];
                }

                let linkingSyntaxes = [];
                if (!needsFor(type)) {
                    for (const lt of ltAlts) {
                        linkingSyntaxes.push(linkFormatter(lt));
                    }
                }
                if (!refusesFor(type)) {
                    for (const f of forAlts) {
                        linkingSyntaxes.push(linkFormatter(`${f}/${ltAlts[0]}`))
                    }
                }
                return [
                    mk.b({}, 'Possible linking syntaxes:'),
                    mk.ul({},
                        ...linkingSyntaxes.map(link => {
                            const copyLink = async () =>
                                await navigator.clipboard.writeText(link);
                            return mk.li({},
                                mk.div({ class: 'link-item' },
                                    mk.button({
                                        class: 'copy-icon', title: 'Copy',
                                        type: 'button',
                                        _onclick: copyLink,
                                        tabindex: 0,
                                    }, mk.span({ class: 'icon' })),
                                    mk.span({}, link)
                                )
                            );
                        })
                    )
                ];
            }
        }
    </script>
    <script>/* Boilerplate: script-position-annos */
        "use strict";
        {
            function repositionAnnoPanels() {
                const panels = [...document.querySelectorAll("[data-anno-for]")];
                hydratePanels(panels);
                let vSoFar = 0;
                for (const panel of panels.sort(cmpTops)) {
                    if (panel.top < vSoFar) {
                        panel.top = vSoFar;
                        panel.style.top = vSoFar + "px";
                    }
                    vSoFar = panel.top + panel.height + 15;
                }
            }
            function hydratePanels(panels) {
                const main = document.querySelector("main");
                let mainRect;
                if (main) mainRect = main.getBoundingClientRect();
                // First display them all, if they're not already visible.
                for (const panel of panels) {
                    panel.classList.remove("unpositioned");
                }
                // Measure them all
                for (const panel of panels) {
                    const dfn = document.getElementById(panel.getAttribute("data-anno-for"));
                    if (!dfn) {
                        console.log("Can't find the annotation panel target:", panel);
                        continue;
                    }
                    panel.dfn = dfn;
                    panel.top = window.scrollY + dfn.getBoundingClientRect().top;
                    let panelRect = panel.getBoundingClientRect();
                    panel.height = panelRect.height;
                    if (main) {
                        panel.overlappingMain = panelRect.left < mainRect.right;
                    } else {
                        panel.overlappingMain = false;
                    }
                }
                // And finally position them
                for (const panel of panels) {
                    const dfn = panel.dfn;
                    if (!dfn) continue;
                    panel.style.top = panel.top + "px";
                    panel.classList.toggle("overlapping-main", panel.overlappingMain);
                }
            }

            function cmpTops(a, b) {
                return a.top - b.top;
            }

            window.addEventListener("load", repositionAnnoPanels);
            window.addEventListener("resize", repositionAnnoPanels);
        }
    </script>
    <script>/* Boilerplate: script-ref-hints */
        "use strict";
        {
            let refsData = {
                "#abort-the-request": { "displayText": "abort the request", "export": true, "for_": [], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "abort the request", "type": "dfn", "url": "#abort-the-request" },
                "#callbackdef-lockgrantedcallback": { "displayText": "LockGrantedCallback", "export": true, "for_": [], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "LockGrantedCallback", "type": "callback", "url": "#callbackdef-lockgrantedcallback" },
                "#dictdef-lockinfo": { "displayText": "LockInfo", "export": true, "for_": [], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "LockInfo", "type": "dictionary", "url": "#dictdef-lockinfo" },
                "#dictdef-lockmanagersnapshot": { "displayText": "LockManagerSnapshot", "export": true, "for_": [], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "LockManagerSnapshot", "type": "dictionary", "url": "#dictdef-lockmanagersnapshot" },
                "#dictdef-lockoptions": { "displayText": "LockOptions", "export": true, "for_": [], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "LockOptions", "type": "dictionary", "url": "#dictdef-lockoptions" },
                "#dom-lock-mode": { "displayText": "mode", "export": true, "for_": ["Lock"], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "mode", "type": "attribute", "url": "#dom-lock-mode" },
                "#dom-lock-name": { "displayText": "name", "export": true, "for_": ["Lock"], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "name", "type": "attribute", "url": "#dom-lock-name" },
                "#dom-lockmanager-query": { "displayText": "query()", "export": true, "for_": ["LockManager"], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "query()", "type": "method", "url": "#dom-lockmanager-query" },
                "#dom-lockmanager-request": { "displayText": "request(name, callback)", "export": true, "for_": ["LockManager"], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "request(name, callback)", "type": "method", "url": "#dom-lockmanager-request" },
                "#dom-lockmanager-request-name-options-callback": { "displayText": "request(name, options, callback)", "export": true, "for_": ["LockManager"], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "request(name, options, callback)", "type": "method", "url": "#dom-lockmanager-request-name-options-callback" },
                "#dom-lockmode-exclusive": { "displayText": "\"exclusive\"", "export": true, "for_": ["LockMode"], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "\"exclusive\"", "type": "enum-value", "url": "#dom-lockmode-exclusive" },
                "#dom-lockmode-shared": { "displayText": "\"shared\"", "export": true, "for_": ["LockMode"], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "\"shared\"", "type": "enum-value", "url": "#dom-lockmode-shared" },
                "#dom-lockoptions-ifavailable": { "displayText": "ifAvailable", "export": true, "for_": ["LockOptions"], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "ifAvailable", "type": "dict-member", "url": "#dom-lockoptions-ifavailable" },
                "#dom-lockoptions-mode": { "displayText": "mode", "export": true, "for_": ["LockOptions"], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "mode", "type": "dict-member", "url": "#dom-lockoptions-mode" },
                "#dom-lockoptions-signal": { "displayText": "signal", "export": true, "for_": ["LockOptions"], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "signal", "type": "dict-member", "url": "#dom-lockoptions-signal" },
                "#dom-lockoptions-steal": { "displayText": "steal", "export": true, "for_": ["LockOptions"], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "steal", "type": "dict-member", "url": "#dom-lockoptions-steal" },
                "#dom-navigatorlocks-locks": { "displayText": "locks", "export": true, "for_": ["NavigatorLocks"], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "locks", "type": "attribute", "url": "#dom-navigatorlocks-locks" },
                "#enumdef-lockmode": { "displayText": "LockMode", "export": true, "for_": [], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "LockMode", "type": "enum", "url": "#enumdef-lockmode" },
                "#get-the-lock-request-queue": { "displayText": "get the lock request queue", "export": true, "for_": [], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "get the lock request queue", "type": "dfn", "url": "#get-the-lock-request-queue" },
                "#grantable": { "displayText": "grantable", "export": true, "for_": [], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "grantable", "type": "dfn", "url": "#grantable" },
                "#lock": { "displayText": "Lock", "export": true, "for_": [], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "Lock", "type": "interface", "url": "#lock" },
                "#lock-concept": { "displayText": "lock-concept", "export": true, "for_": [], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "lock-concept", "type": "dfn", "url": "#lock-concept" },
                "#lock-concept-agent": { "displayText": "agent", "export": true, "for_": ["lock-concept"], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "agent", "type": "dfn", "url": "#lock-concept-agent" },
                "#lock-concept-clientid": { "displayText": "clientid", "export": true, "for_": ["lock-concept"], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "clientid", "type": "dfn", "url": "#lock-concept-clientid" },
                "#lock-concept-manager": { "displayText": "manager", "export": true, "for_": ["lock-concept"], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "manager", "type": "dfn", "url": "#lock-concept-manager" },
                "#lock-concept-mode": { "displayText": "mode", "export": true, "for_": ["lock-concept"], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "mode", "type": "dfn", "url": "#lock-concept-mode" },
                "#lock-concept-name": { "displayText": "name", "export": true, "for_": ["lock-concept"], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "name", "type": "dfn", "url": "#lock-concept-name" },
                "#lock-concept-released-promise": { "displayText": "released promise", "export": true, "for_": ["lock-concept"], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "released promise", "type": "dfn", "url": "#lock-concept-released-promise" },
                "#lock-concept-waiting-promise": { "displayText": "waiting promise", "export": true, "for_": ["lock-concept"], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "waiting promise", "type": "dfn", "url": "#lock-concept-waiting-promise" },
                "#lock-manager": { "displayText": "lock manager", "export": true, "for_": [], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "lock manager", "type": "dfn", "url": "#lock-manager" },
                "#lock-manager-held-lock-set": { "displayText": "held lock set", "export": true, "for_": ["lock manager"], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "held lock set", "type": "dfn", "url": "#lock-manager-held-lock-set" },
                "#lock-manager-lock-request-queue-map": { "displayText": "lock request queue map", "export": true, "for_": ["lock manager"], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "lock request queue map", "type": "dfn", "url": "#lock-manager-lock-request-queue-map" },
                "#lock-request": { "displayText": "lock request", "export": true, "for_": [], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "lock request", "type": "dfn", "url": "#lock-request" },
                "#lock-request-agent": { "displayText": "agent", "export": true, "for_": ["lock request"], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "agent", "type": "dfn", "url": "#lock-request-agent" },
                "#lock-request-callback": { "displayText": "callback", "export": true, "for_": ["lock request"], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "callback", "type": "dfn", "url": "#lock-request-callback" },
                "#lock-request-clientid": { "displayText": "clientid", "export": true, "for_": ["lock request"], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "clientid", "type": "dfn", "url": "#lock-request-clientid" },
                "#lock-request-manager": { "displayText": "manager", "export": true, "for_": ["lock request"], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "manager", "type": "dfn", "url": "#lock-request-manager" },
                "#lock-request-mode": { "displayText": "mode", "export": true, "for_": ["lock request"], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "mode", "type": "dfn", "url": "#lock-request-mode" },
                "#lock-request-name": { "displayText": "name", "export": true, "for_": ["lock request"], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "name", "type": "dfn", "url": "#lock-request-name" },
                "#lock-request-promise": { "displayText": "promise", "export": true, "for_": ["lock request"], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "promise", "type": "dfn", "url": "#lock-request-promise" },
                "#lock-request-queue": { "displayText": "lock request queue", "export": true, "for_": [], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "lock request queue", "type": "dfn", "url": "#lock-request-queue" },
                "#lock-request-signal": { "displayText": "signal", "export": true, "for_": ["lock request"], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "signal", "type": "dfn", "url": "#lock-request-signal" },
                "#lock-task-queue": { "displayText": "lock task queue", "export": true, "for_": [], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "lock task queue", "type": "dfn", "url": "#lock-task-queue" },
                "#lockmanager": { "displayText": "LockManager", "export": true, "for_": [], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "LockManager", "type": "interface", "url": "#lockmanager" },
                "#mode": { "displayText": "mode", "export": true, "for_": [], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "mode", "type": "dfn", "url": "#mode" },
                "#navigatorlocks": { "displayText": "NavigatorLocks", "export": true, "for_": [], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "NavigatorLocks", "type": "interface", "url": "#navigatorlocks" },
                "#obtain-a-lock-manager": { "displayText": "obtain a lock manager", "export": true, "for_": [], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "obtain a lock manager", "type": "dfn", "url": "#obtain-a-lock-manager" },
                "#process-the-lock-request-queue": { "displayText": "process the lock request queue", "export": true, "for_": [], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "process the lock request queue", "type": "dfn", "url": "#process-the-lock-request-queue" },
                "#release-the-lock": { "displayText": "release the lock", "export": true, "for_": [], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "release the lock", "type": "dfn", "url": "#release-the-lock" },
                "#request-a-lock": { "displayText": "request a lock", "export": true, "for_": [], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "request a lock", "type": "dfn", "url": "#request-a-lock" },
                "#resource-name": { "displayText": "resource name", "export": true, "for_": [], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "resource name", "type": "dfn", "url": "#resource-name" },
                "#signal-to-abort-the-request": { "displayText": "signal to abort the request", "export": true, "for_": [], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "signal to abort the request", "type": "dfn", "url": "#signal-to-abort-the-request" },
                "#snapshot-the-lock-state": { "displayText": "snapshot the lock state", "export": true, "for_": [], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "snapshot the lock state", "type": "dfn", "url": "#snapshot-the-lock-state" },
                "#terminate-remaining-locks-and-requests": { "displayText": "terminate remaining locks and requests", "export": true, "for_": [], "level": "", "normative": true, "shortname": "web-locks", "spec": "web-locks", "status": "local", "text": "terminate remaining locks and requests", "type": "dfn", "url": "#terminate-remaining-locks-and-requests" },
                "https://dom.spec.whatwg.org/#abortsignal": { "displayText": "AbortSignal", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "dom", "spec": "dom", "status": "current", "text": "AbortSignal", "type": "interface", "url": "https://dom.spec.whatwg.org/#abortsignal" },
                "https://dom.spec.whatwg.org/#abortsignal-abort-reason": { "displayText": "abort reason", "export": true, "for_": ["AbortSignal"], "level": "1", "normative": true, "shortname": "dom", "spec": "dom", "status": "current", "text": "abort reason", "type": "dfn", "url": "https://dom.spec.whatwg.org/#abortsignal-abort-reason" },
                "https://dom.spec.whatwg.org/#abortsignal-aborted": { "displayText": "aborted", "export": true, "for_": ["AbortSignal"], "level": "1", "normative": true, "shortname": "dom", "spec": "dom", "status": "current", "text": "aborted", "type": "dfn", "url": "https://dom.spec.whatwg.org/#abortsignal-aborted" },
                "https://dom.spec.whatwg.org/#abortsignal-add": { "displayText": "add", "export": true, "for_": ["AbortSignal"], "level": "1", "normative": true, "shortname": "dom", "spec": "dom", "status": "current", "text": "add", "type": "dfn", "url": "https://dom.spec.whatwg.org/#abortsignal-add" },
                "https://dom.spec.whatwg.org/#abortsignal-remove": { "displayText": "remove", "export": true, "for_": ["AbortSignal"], "level": "1", "normative": true, "shortname": "dom", "spec": "dom", "status": "current", "text": "remove", "type": "dfn", "url": "https://dom.spec.whatwg.org/#abortsignal-remove" },
                "https://dom.spec.whatwg.org/#concept-document": { "displayText": "document", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "dom", "spec": "dom", "status": "current", "text": "document", "type": "dfn", "url": "https://dom.spec.whatwg.org/#concept-document" },
                "https://html.spec.whatwg.org/multipage/document-lifecycle.html#unloading-document-cleanup-steps": { "displayText": "unloading document cleanup steps", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "html", "spec": "html", "status": "current", "text": "unloading document cleanup steps", "type": "dfn", "url": "https://html.spec.whatwg.org/multipage/document-lifecycle.html#unloading-document-cleanup-steps" },
                "https://html.spec.whatwg.org/multipage/document-sequences.html#browsing-context": { "displayText": "browsing context", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "html", "spec": "html", "status": "current", "text": "browsing context", "type": "dfn", "url": "https://html.spec.whatwg.org/multipage/document-sequences.html#browsing-context" },
                "https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active": { "displayText": "fully active", "export": true, "for_": ["Document"], "level": "1", "normative": true, "shortname": "html", "spec": "html", "status": "current", "text": "fully active", "type": "dfn", "url": "https://html.spec.whatwg.org/multipage/document-sequences.html#fully-active" },
                "https://html.spec.whatwg.org/multipage/infrastructure.html#enqueue-the-following-steps": { "displayText": "enqueue steps", "export": true, "for_": ["parallel queue"], "level": "1", "normative": true, "shortname": "html", "spec": "html", "status": "current", "text": "enqueue steps", "type": "dfn", "url": "https://html.spec.whatwg.org/multipage/infrastructure.html#enqueue-the-following-steps" },
                "https://html.spec.whatwg.org/multipage/infrastructure.html#starting-a-new-parallel-queue": { "displayText": "starting a new parallel queue", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "html", "spec": "html", "status": "current", "text": "starting a new parallel queue", "type": "dfn", "url": "https://html.spec.whatwg.org/multipage/infrastructure.html#starting-a-new-parallel-queue" },
                "https://html.spec.whatwg.org/multipage/nav-history-apis.html#concept-document-window": { "displayText": "associated Document", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "html", "spec": "html", "status": "current", "text": "associated document", "type": "dfn", "url": "https://html.spec.whatwg.org/multipage/nav-history-apis.html#concept-document-window" },
                "https://html.spec.whatwg.org/multipage/system-state.html#navigator": { "displayText": "Navigator", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "html", "spec": "html", "status": "current", "text": "Navigator", "type": "interface", "url": "https://html.spec.whatwg.org/multipage/system-state.html#navigator" },
                "https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-id": { "displayText": "id", "export": true, "for_": ["environment"], "level": "1", "normative": true, "shortname": "html", "spec": "html", "status": "current", "text": "id", "type": "dfn", "url": "https://html.spec.whatwg.org/multipage/webappapis.html#concept-environment-id" },
                "https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global": { "displayText": "relevant global object", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "html", "spec": "html", "status": "current", "text": "relevant global object", "type": "dfn", "url": "https://html.spec.whatwg.org/multipage/webappapis.html#concept-relevant-global" },
                "https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object": { "displayText": "environment settings object", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "html", "spec": "html", "status": "current", "text": "environment settings object", "type": "dfn", "url": "https://html.spec.whatwg.org/multipage/webappapis.html#environment-settings-object" },
                "https://html.spec.whatwg.org/multipage/webappapis.html#integration-with-the-javascript-agent-cluster-formalism": { "displayText": "agent cluster", "export": true, "for_": [], "level": "", "normative": true, "shortname": "html", "spec": "html", "status": "anchor-block", "text": "agent cluster", "type": "dfn", "url": "https://html.spec.whatwg.org/multipage/webappapis.html#integration-with-the-javascript-agent-cluster-formalism" },
                "https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object": { "displayText": "relevant settings object", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "html", "spec": "html", "status": "current", "text": "relevant settings object", "type": "dfn", "url": "https://html.spec.whatwg.org/multipage/webappapis.html#relevant-settings-object" },
                "https://html.spec.whatwg.org/multipage/webappapis.html#responsible-event-loop": { "displayText": "responsible event loop", "export": true, "for_": ["environment settings object"], "level": "1", "normative": true, "shortname": "html", "spec": "html", "status": "current", "text": "responsible event loop", "type": "dfn", "url": "https://html.spec.whatwg.org/multipage/webappapis.html#responsible-event-loop" },
                "https://html.spec.whatwg.org/multipage/webappapis.html#task-source": { "displayText": "task source", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "html", "spec": "html", "status": "current", "text": "task source", "type": "dfn", "url": "https://html.spec.whatwg.org/multipage/webappapis.html#task-source" },
                "https://html.spec.whatwg.org/multipage/workers.html#workernavigator": { "displayText": "WorkerNavigator", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "html", "spec": "html", "status": "current", "text": "WorkerNavigator", "type": "interface", "url": "https://html.spec.whatwg.org/multipage/workers.html#workernavigator" },
                "https://infra.spec.whatwg.org/#assert": { "displayText": "assert", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "infra", "spec": "infra", "status": "current", "text": "assert", "type": "dfn", "url": "https://infra.spec.whatwg.org/#assert" },
                "https://infra.spec.whatwg.org/#list": { "displayText": "list", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "infra", "spec": "infra", "status": "current", "text": "list", "type": "dfn", "url": "https://infra.spec.whatwg.org/#list" },
                "https://infra.spec.whatwg.org/#list-append": { "displayText": "append", "export": true, "for_": ["list"], "level": "1", "normative": true, "shortname": "infra", "spec": "infra", "status": "current", "text": "append", "type": "dfn", "url": "https://infra.spec.whatwg.org/#list-append" },
                "https://infra.spec.whatwg.org/#list-is-empty": { "displayText": "is empty", "export": true, "for_": ["list", "stack", "queue", "set"], "level": "1", "normative": true, "shortname": "infra", "spec": "infra", "status": "current", "text": "is empty", "type": "dfn", "url": "https://infra.spec.whatwg.org/#list-is-empty" },
                "https://infra.spec.whatwg.org/#list-item": { "displayText": "item", "export": true, "for_": ["list", "stack", "queue", "set"], "level": "1", "normative": true, "shortname": "infra", "spec": "infra", "status": "current", "text": "item", "type": "dfn", "url": "https://infra.spec.whatwg.org/#list-item" },
                "https://infra.spec.whatwg.org/#list-iterate": { "displayText": "for each", "export": true, "for_": ["list", "set"], "level": "1", "normative": true, "shortname": "infra", "spec": "infra", "status": "current", "text": "for each", "type": "dfn", "url": "https://infra.spec.whatwg.org/#list-iterate" },
                "https://infra.spec.whatwg.org/#list-prepend": { "displayText": "prepend", "export": true, "for_": ["list"], "level": "1", "normative": true, "shortname": "infra", "spec": "infra", "status": "current", "text": "prepend", "type": "dfn", "url": "https://infra.spec.whatwg.org/#list-prepend" },
                "https://infra.spec.whatwg.org/#list-remove": { "displayText": "remove", "export": true, "for_": ["list", "set"], "level": "1", "normative": true, "shortname": "infra", "spec": "infra", "status": "current", "text": "remove", "type": "dfn", "url": "https://infra.spec.whatwg.org/#list-remove" },
                "https://infra.spec.whatwg.org/#map-exists": { "displayText": "exist", "export": true, "for_": ["map"], "level": "1", "normative": true, "shortname": "infra", "spec": "infra", "status": "current", "text": "exist", "type": "dfn", "url": "https://infra.spec.whatwg.org/#map-exists" },
                "https://infra.spec.whatwg.org/#map-getting-the-values": { "displayText": "values", "export": true, "for_": ["map"], "level": "1", "normative": true, "shortname": "infra", "spec": "infra", "status": "current", "text": "values", "type": "dfn", "url": "https://infra.spec.whatwg.org/#map-getting-the-values" },
                "https://infra.spec.whatwg.org/#map-iterate": { "displayText": "for each", "export": true, "for_": ["map"], "level": "1", "normative": true, "shortname": "infra", "spec": "infra", "status": "current", "text": "for each", "type": "dfn", "url": "https://infra.spec.whatwg.org/#map-iterate" },
                "https://infra.spec.whatwg.org/#map-set": { "displayText": "set", "export": true, "for_": ["map"], "level": "1", "normative": true, "shortname": "infra", "spec": "infra", "status": "current", "text": "set", "type": "dfn", "url": "https://infra.spec.whatwg.org/#map-set" },
                "https://infra.spec.whatwg.org/#ordered-map": { "displayText": "map", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "infra", "spec": "infra", "status": "current", "text": "map", "type": "dfn", "url": "https://infra.spec.whatwg.org/#ordered-map" },
                "https://infra.spec.whatwg.org/#ordered-set": { "displayText": "set", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "infra", "spec": "infra", "status": "current", "text": "set", "type": "dfn", "url": "https://infra.spec.whatwg.org/#ordered-set" },
                "https://infra.spec.whatwg.org/#queue": { "displayText": "queue", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "infra", "spec": "infra", "status": "current", "text": "queue", "type": "dfn", "url": "https://infra.spec.whatwg.org/#queue" },
                "https://infra.spec.whatwg.org/#queue-enqueue": { "displayText": "enqueue", "export": true, "for_": ["queue"], "level": "1", "normative": true, "shortname": "infra", "spec": "infra", "status": "current", "text": "enqueue", "type": "dfn", "url": "https://infra.spec.whatwg.org/#queue-enqueue" },
                "https://infra.spec.whatwg.org/#set-append": { "displayText": "append", "export": true, "for_": ["set"], "level": "1", "normative": true, "shortname": "infra", "spec": "infra", "status": "current", "text": "append", "type": "dfn", "url": "https://infra.spec.whatwg.org/#set-append" },
                "https://infra.spec.whatwg.org/#string": { "displayText": "JavaScript string", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "infra", "spec": "infra", "status": "current", "text": "javascript string", "type": "dfn", "url": "https://infra.spec.whatwg.org/#string" },
                "https://infra.spec.whatwg.org/#struct": { "displayText": "struct", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "infra", "spec": "infra", "status": "current", "text": "struct", "type": "dfn", "url": "https://infra.spec.whatwg.org/#struct" },
                "https://infra.spec.whatwg.org/#struct-item": { "displayText": "item", "export": true, "for_": ["struct", "tuple"], "level": "1", "normative": true, "shortname": "infra", "spec": "infra", "status": "current", "text": "item", "type": "dfn", "url": "https://infra.spec.whatwg.org/#struct-item" },
                "https://infra.spec.whatwg.org/#user-agent": { "displayText": "user agent", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "infra", "spec": "infra", "status": "current", "text": "user agent", "type": "dfn", "url": "https://infra.spec.whatwg.org/#user-agent" },
                "https://storage.spec.whatwg.org/#obtain-a-local-storage-bottle-map": { "displayText": "obtain a local storage bottle map", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "storage", "spec": "storage", "status": "current", "text": "obtain a local storage bottle map", "type": "dfn", "url": "https://storage.spec.whatwg.org/#obtain-a-local-storage-bottle-map" },
                "https://storage.spec.whatwg.org/#storage-bottle": { "displayText": "storage bottle", "export": true, "for_": [], "level": "", "normative": true, "shortname": "storage", "spec": "storage", "status": "anchor-block", "text": "storage bottle", "type": "dfn", "url": "https://storage.spec.whatwg.org/#storage-bottle" },
                "https://storage.spec.whatwg.org/#storage-bucket": { "displayText": "storage bucket", "export": true, "for_": [], "level": "", "normative": true, "shortname": "storage", "spec": "storage", "status": "anchor-block", "text": "storage bucket", "type": "dfn", "url": "https://storage.spec.whatwg.org/#storage-bucket" },
                "https://tc39.github.io/ecma262/#agent": { "displayText": "agent", "export": true, "for_": [], "level": "", "normative": true, "shortname": "ecma262", "spec": "ecma262", "status": "anchor-block", "text": "agent", "type": "dfn", "url": "https://tc39.github.io/ecma262/#agent" },
                "https://webidl.spec.whatwg.org/#Exposed": { "displayText": "Exposed", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "webidl", "spec": "webidl", "status": "current", "text": "Exposed", "type": "extended-attribute", "url": "https://webidl.spec.whatwg.org/#Exposed" },
                "https://webidl.spec.whatwg.org/#SecureContext": { "displayText": "SecureContext", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "webidl", "spec": "webidl", "status": "current", "text": "SecureContext", "type": "extended-attribute", "url": "https://webidl.spec.whatwg.org/#SecureContext" },
                "https://webidl.spec.whatwg.org/#a-new-promise": { "displayText": "a new promise", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "webidl", "spec": "webidl", "status": "current", "text": "a new promise", "type": "dfn", "url": "https://webidl.spec.whatwg.org/#a-new-promise" },
                "https://webidl.spec.whatwg.org/#a-promise-rejected-with": { "displayText": "a promise rejected with", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "webidl", "spec": "webidl", "status": "current", "text": "a promise rejected with", "type": "dfn", "url": "https://webidl.spec.whatwg.org/#a-promise-rejected-with" },
                "https://webidl.spec.whatwg.org/#aborterror": { "displayText": "AbortError", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "webidl", "spec": "webidl", "status": "current", "text": "AbortError", "type": "exception", "url": "https://webidl.spec.whatwg.org/#aborterror" },
                "https://webidl.spec.whatwg.org/#dfn-callback-function": { "displayText": "callback function", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "webidl", "spec": "webidl", "status": "current", "text": "callback function", "type": "dfn", "url": "https://webidl.spec.whatwg.org/#dfn-callback-function" },
                "https://webidl.spec.whatwg.org/#idl-DOMException": { "displayText": "DOMException", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "webidl", "spec": "webidl", "status": "current", "text": "DOMException", "type": "interface", "url": "https://webidl.spec.whatwg.org/#idl-DOMException" },
                "https://webidl.spec.whatwg.org/#idl-DOMString": { "displayText": "DOMString", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "webidl", "spec": "webidl", "status": "current", "text": "DOMString", "type": "interface", "url": "https://webidl.spec.whatwg.org/#idl-DOMString" },
                "https://webidl.spec.whatwg.org/#idl-any": { "displayText": "any", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "webidl", "spec": "webidl", "status": "current", "text": "any", "type": "interface", "url": "https://webidl.spec.whatwg.org/#idl-any" },
                "https://webidl.spec.whatwg.org/#idl-boolean": { "displayText": "boolean", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "webidl", "spec": "webidl", "status": "current", "text": "boolean", "type": "interface", "url": "https://webidl.spec.whatwg.org/#idl-boolean" },
                "https://webidl.spec.whatwg.org/#idl-promise": { "displayText": "Promise", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "webidl", "spec": "webidl", "status": "current", "text": "Promise", "type": "interface", "url": "https://webidl.spec.whatwg.org/#idl-promise" },
                "https://webidl.spec.whatwg.org/#idl-sequence": { "displayText": "sequence", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "webidl", "spec": "webidl", "status": "current", "text": "sequence", "type": "dfn", "url": "https://webidl.spec.whatwg.org/#idl-sequence" },
                "https://webidl.spec.whatwg.org/#invalidstateerror": { "displayText": "InvalidStateError", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "webidl", "spec": "webidl", "status": "current", "text": "InvalidStateError", "type": "exception", "url": "https://webidl.spec.whatwg.org/#invalidstateerror" },
                "https://webidl.spec.whatwg.org/#invoke-a-callback-function": { "displayText": "invoke", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "webidl", "spec": "webidl", "status": "current", "text": "invoke", "type": "dfn", "url": "https://webidl.spec.whatwg.org/#invoke-a-callback-function" },
                "https://webidl.spec.whatwg.org/#notsupportederror": { "displayText": "NotSupportedError", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "webidl", "spec": "webidl", "status": "current", "text": "NotSupportedError", "type": "exception", "url": "https://webidl.spec.whatwg.org/#notsupportederror" },
                "https://webidl.spec.whatwg.org/#reject": { "displayText": "reject", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "webidl", "spec": "webidl", "status": "current", "text": "reject", "type": "dfn", "url": "https://webidl.spec.whatwg.org/#reject" },
                "https://webidl.spec.whatwg.org/#resolve": { "displayText": "resolve", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "webidl", "spec": "webidl", "status": "current", "text": "resolve", "type": "dfn", "url": "https://webidl.spec.whatwg.org/#resolve" },
                "https://webidl.spec.whatwg.org/#securityerror": { "displayText": "SecurityError", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "webidl", "spec": "webidl", "status": "current", "text": "SecurityError", "type": "exception", "url": "https://webidl.spec.whatwg.org/#securityerror" },
                "https://webidl.spec.whatwg.org/#this": { "displayText": "this", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "webidl", "spec": "webidl", "status": "current", "text": "this", "type": "dfn", "url": "https://webidl.spec.whatwg.org/#this" },
                "https://www.w3.org/TR/service-workers/#client": { "displayText": "Client", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "service-workers", "spec": "service-workers", "status": "snapshot", "text": "Client", "type": "interface", "url": "https://www.w3.org/TR/service-workers/#client" },
                "https://www.w3.org/TR/service-workers/#dom-client-id": { "displayText": "id", "export": true, "for_": ["Client"], "level": "1", "normative": true, "shortname": "service-workers", "spec": "service-workers", "status": "snapshot", "text": "id", "type": "attribute", "url": "https://www.w3.org/TR/service-workers/#dom-client-id" },
            };

            function mkRefHint(link, ref) {
                const linkText = link.textContent;
                let dfnTextElements = '';
                if (ref.displayText.toLowerCase() != linkText.toLowerCase()) {
                    // Give the original term if it's being displayed in a different way.
                    // But allow casing differences, they're insignificant.
                    dfnTextElements =
                        mk.li({},
                            mk.b({}, "Term: "),
                            mk.span({}, ref.displayText)
                        );
                }
                const forList = ref.for_;
                let forListElements;
                if (forList.length == 0) {
                    forListElements = [];
                } else if (forList.length == 1) {
                    forListElements = mk.li({},
                        mk.b({}, "For: "),
                        mk.span({}, forList[0]),
                    );
                } else {
                    forListElements = mk.li({},
                        mk.b({}, "For: "),
                        mk.ul({},
                            ...forList.map(forItem =>
                                mk.li({},
                                    mk.span({}, forItem)
                                ),
                            ),
                        ),
                    );
                }
                const url = ref.url;
                const safeUrl = encodeURIComponent(url);
                const hintPanel = mk.aside({
                    class: "ref-hint",
                    id: `ref-hint-for-${safeUrl}`,
                    "data-for": url,
                    "aria-labelled-by": `ref-hint-for-${safeUrl}`,
                },
                    mk.ul({},
                        dfnTextElements,
                        mk.li({},
                            mk.b({}, "URL: "),
                            mk.a({ href: url, class: "ref" }, url),
                        ),
                        mk.li({},
                            mk.b({}, "Type: "),
                            mk.span({}, `${ref.type}`),
                        ),
                        mk.li({},
                            mk.b({}, "Spec: "),
                            mk.span({}, `${ref.spec ? ref.spec : ''}`),
                        ),
                        forListElements
                    ),
                );
                hintPanel.forLink = link;
                setupRefHintEventListeners(link, hintPanel);
                return hintPanel;
            }

            function hideAllRefHints() {
                queryAll(".ref-hint").forEach(el => hideRefHint(el));
            }

            function hideRefHint(refHint) {
                const link = refHint.forLink;
                link.setAttribute("aria-expanded", "false");
                if (refHint.teardownEventListeners) {
                    refHint.teardownEventListeners();
                }
                refHint.remove();
            }

            function showRefHint(link) {
                if (link.classList.contains("dfn-link")) return;
                const url = link.getAttribute("href");
                const refHintKey = link.getAttribute("data-refhint-key");
                let key = url;
                if (refHintKey) {
                    key = refHintKey + "_" + url;
                }
                const ref = refsData[key];
                if (!ref) return;

                hideAllRefHints(); // Only display one at this time.

                const refHint = mkRefHint(link, ref);
                append(document.body, refHint);
                link.setAttribute("aria-expanded", "true");
                positionRefHint(refHint);
            }

            function setupRefHintEventListeners(link, refHint) {
                if (refHint.teardownEventListeners) return;
                // Add event handlers to hide the refHint after the user moves away
                // from both the link and refHint, if not hovering either within one second.
                let timeout = null;
                const startHidingRefHint = (event) => {
                    if (timeout) {
                        clearTimeout(timeout);
                    }
                    timeout = setTimeout(() => {
                        hideRefHint(refHint);
                    }, 1000);
                }
                const resetHidingRefHint = (event) => {
                    if (timeout) clearTimeout(timeout);
                    timeout = null;
                };
                link.addEventListener("mouseleave", startHidingRefHint);
                link.addEventListener("mouseenter", resetHidingRefHint);
                link.addEventListener("blur", startHidingRefHint);
                link.addEventListener("focus", resetHidingRefHint);
                refHint.addEventListener("mouseleave", startHidingRefHint);
                refHint.addEventListener("mouseenter", resetHidingRefHint);
                refHint.addEventListener("blur", startHidingRefHint);
                refHint.addEventListener("focus", resetHidingRefHint);

                refHint.teardownEventListeners = () => {
                    // remove event listeners
                    resetHidingRefHint();
                    link.removeEventListener("mouseleave", startHidingRefHint);
                    link.removeEventListener("mouseenter", resetHidingRefHint);
                    link.removeEventListener("blur", startHidingRefHint);
                    link.removeEventListener("focus", resetHidingRefHint);
                    refHint.removeEventListener("mouseleave", startHidingRefHint);
                    refHint.removeEventListener("mouseenter", resetHidingRefHint);
                    refHint.removeEventListener("blur", startHidingRefHint);
                    refHint.removeEventListener("focus", resetHidingRefHint);
                };
            }

            function positionRefHint(refHint) {
                const link = refHint.forLink;
                const linkPos = getBounds(link);
                refHint.style.top = linkPos.bottom + "px";
                refHint.style.left = linkPos.left + "px";

                const panelPos = refHint.getBoundingClientRect();
                const panelMargin = 8;
                const maxRight = document.body.parentNode.clientWidth - panelMargin;
                if (panelPos.right > maxRight) {
                    const overflowAmount = panelPos.right - maxRight;
                    const newLeft = Math.max(panelMargin, linkPos.left - overflowAmount);
                    refHint.style.left = newLeft + "px";
                }
            }

            // TODO: shared util
            // Returns the root-level absolute position {left and top} of element.
            function getBounds(el, relativeTo = document.body) {
                const relativeRect = relativeTo.getBoundingClientRect();
                const elRect = el.getBoundingClientRect();
                const top = elRect.top - relativeRect.top;
                const left = elRect.left - relativeRect.left;
                return {
                    top,
                    left,
                    bottom: top + elRect.height,
                    right: left + elRect.width,
                }
            }

            function showRefHintListener(e) {
                // If the target isn't in a link (or is a link),
                // just ignore it.
                let link = e.target.closest("a");
                if (!link) return;

                // If the target is in a ref-hint panel
                // (aka a link in the already-open one),
                // also just ignore it.
                if (link.closest(".ref-hint")) return;

                // Otherwise, show the panel for the link.
                showRefHint(link);
            }

            function hideAllHintsListener(e) {
                // If the click is inside a ref-hint panel, ignore it.
                if (e.target.closest(".ref-hint")) return;
                // Otherwise, close all the current panels.
                hideAllRefHints();
            }

            document.addEventListener("DOMContentLoaded", () => {
                document.body.addEventListener("mousedown", showRefHintListener);
                document.body.addEventListener("focus", showRefHintListener);

                document.body.addEventListener("click", hideAllHintsListener);
            });

            window.addEventListener("resize", () => {
                // Hide any open ref hint.
                hideAllRefHints();
            });
        }
    </script>
    <script>/* Boilerplate: script-var-click-highlighting */
        "use strict";
        {
            /*
            Color-choosing design:
            
            * Colors are ordered by goodness.
            * On clicking a var, give it the earliest color
                with the lowest usage in the algorithm.
            * On re-clicking, re-use the var's most recent color
                if that's not currently being used elsewhere.
            */

            const COLOR_COUNT = 7;

            document.addEventListener("click", e => {
                if (e.target.nodeName == "VAR") {
                    highlightSameAlgoVars(e.target);
                }
            });

            function highlightSameAlgoVars(v) {
                // Find the algorithm container.
                let algoContainer = findAlgoContainer(v);

                // Not highlighting document-global vars,
                // too likely to be unrelated.
                if (algoContainer == null) return;

                const varName = nameFromVar(v);
                if (!v.hasAttribute("data-var-color")) {
                    const newColor = chooseHighlightColor(algoContainer, v);
                    for (const el of algoContainer.querySelectorAll("var")) {
                        if (nameFromVar(el) == varName) {
                            el.setAttribute("data-var-color", newColor);
                            el.setAttribute("data-var-last-color", newColor);
                        }
                    }
                } else {
                    for (const el of algoContainer.querySelectorAll("var")) {
                        if (nameFromVar(el) == varName) {
                            el.removeAttribute("data-var-color");
                        }
                    }
                }
            }
            function findAlgoContainer(el) {
                while (el != document.body) {
                    if (el.hasAttribute("data-algorithm")) return el;
                    el = el.parentNode;
                }
                return null;
            }
            function nameFromVar(el) {
                return el.textContent.replace(/(\s|\xa0)+/g, " ").trim();
            }
            function colorCountsFromContainer(container) {
                const namesFromColor = Array.from({ length: COLOR_COUNT }, x => new Set());
                for (let v of container.querySelectorAll("var[data-var-color]")) {
                    let color = +v.getAttribute("data-var-color");
                    namesFromColor[color].add(nameFromVar(v));
                }

                return namesFromColor.map(x => x.size);
            }
            function leastUsedColor(colors) {
                // Find the earliest color with the lowest count.
                let minCount = Infinity;
                let minColor = null;
                for (var i = 0; i < colors.length; i++) {
                    if (colors[i] < minCount) {
                        minColor = i;
                        minCount = colors[i];
                    }
                }
                return minColor;
            }
            function chooseHighlightColor(container, v) {
                const colorCounts = colorCountsFromContainer(container);
                if (v.hasAttribute("data-var-last-color")) {
                    let color = +v.getAttribute("data-var-last-color");
                    if (colorCounts[color] == 0) return color;
                }
                return leastUsedColor(colorCounts);
            }
        }
    </script>