<!DOCTYPE html SYSTEM "about:legacy-compat">
<html lang="zh-hans">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>RFC 8441 - 使用 HTTP/2 引导 WebSockets</title>
    <script>
        function getMeta(rfcno, container) {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", "https://www.rfc-editor.org/rfc/rfc" + rfcno + ".json", true);
            xhr.onload = function (e) {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        var data = JSON.parse(xhr.response);

                        var cont = document.getElementById(container);
                        // empty the container
                        while (cont.firstChild) {
                            cont.removeChild(myNode.firstChild);
                        }

                        var c = data.status;
                        if (c) {
                            var bld = newElementWithText("b", c);
                            cont.appendChild(bld);
                        } else {
                            cont.appendChild(newElementWithText("i", "(document status unknown)"));
                        }

                        c = data.updated_by;
                        if (c && c.length > 0 && c[0] !== null && c[0].length > 0) {
                            cont.appendChild(newElement("br"));
                            cont.appendChild(newText("Updated by: "));
                            appendRfcLinks(cont, c);
                        }

                        c = data.obsoleted_by;
                        if (c && c.length > 0 && c[0] !== null && c[0].length > 0) {
                            cont.appendChild(newElement("br"));
                            cont.appendChild(newText("Obsoleted by: "));
                            appendRfcLinks(cont, c);
                        }

                        c = data.errata_url;
                        if (c) {
                            cont.appendChild(newElement("br"));
                            var link = newElementWithText("a", "errata");
                            link.setAttribute("href", c);
                            var errata = newElementWithText("i", "This document has ");
                            errata.appendChild(link);
                            errata.appendChild(newText("."));
                            cont.appendChild(errata);
                        }

                        cont.style.display = "block";
                    } else {
                        console.error(xhr.statusText);
                    }
                }
            };
            xhr.onerror = function (e) {
                console.error(xhr.status + " " + xhr.statusText);
            };
            xhr.send(null);
        }
        function appendRfcLinks(parent, updates) {
            var template = "https://www.rfc-editor.org/rfc/rfc{rfc}.html";
            for (var i = 0; i < updates.length; i++) {
                var rfc = updates[i].trim().toLowerCase();
                if (rfc.substring(0, 3) == "rfc") {
                    var no = parseInt(rfc.substring(3), 10);

                    var link = newElement("a");
                    link.setAttribute("href", template.replace("{rfc}", no));
                    link.appendChild(newText(no));
                    parent.appendChild(link);
                } else {
                    parent.appendChild(newText(rfc));
                }
                if (i != updates.length - 1) {
                    parent.appendChild(newText(", "));
                }
            }
        }

        // DOM helpers
        function newElement(name) {
            return document.createElement(name);
        }
        function newElementWithText(name, txt) {
            var e = document.createElement(name);
            e.appendChild(newText(txt));
            return e;
        }
        function newText(text) {
            return document.createTextNode(text);
        }
    </script>
    <script>
        function anchorRewrite() {
            map = {};
            if (window.location.hash.length >= 1) {
                var fragid = window.location.hash.substr(1);
                if (fragid) {
                    if (!document.getElementById(fragid)) {
                        var prefix = "rfc.";
                        var mapped = map[fragid];
                        if (mapped) {
                            window.location.hash = mapped;
                        } else if (fragid.indexOf("section-") == 0) {
                            window.location.hash = prefix + "section." + fragid.substring(8).replace("-", ".p.");
                        } else if (fragid.indexOf("appendix-") == 0) {
                            window.location.hash = prefix + "section." + fragid.substring(9).replace("-", ".p.");
                        } else if (fragid.indexOf("s-") == 0) {
                            var postfix = fragid.substring(2);
                            if (postfix.startsWith("abstract")) {
                                window.location.hash = prefix + postfix;
                            } else if (postfix.startsWith("note-")) {
                                window.location.hash = prefix + "note." + postfix.substring(5).replace("-", ".p.");
                            } else {
                                window.location.hash = prefix + "section." + postfix.replace("-", ".p.");
                            }
                        } else if (fragid.indexOf("p-") == 0) {
                            var r = fragid.substring(2);
                            var p = r.indexOf("-");
                            if (p >= 0) {
                                window.location.hash = prefix + "section." + r.substring(0, p) + ".p." + r.substring(p + 1);
                            }
                        }
                    }
                }
            }
        }
        window.addEventListener('hashchange', anchorRewrite);
        window.addEventListener('DOMContentLoaded', anchorRewrite);
    </script>
    <script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:type" content="article">
    <meta property="og:title" content="RFC8441">
    <meta property="og:description" content="Bootstrapping WebSockets with HTTP/2">
    <meta property="og:url" content="https://httpwg.org/specs/rfc8441.html">
    <meta property="og:site_name" content="IETF HTTP Working Group Specifications">
    <meta property="og:image" content="https://httpwg.org/assets/favicon/apple-icon-180x180.png">
    <link rel="stylesheet" type="text/css"
        href="https://httpwg.org/assets/node_modules/bootstrap/dist/css/bootstrap.min.css">
    <style type="text/css">
        body {
            padding-top: 80px;
            padding-bottom: 80px;
            position: relative;
        }

        .table.header th,
        .table.header td {
            border-top: none;
            padding: 0;
        }

        #sidebar {
            margin-top: -10px;
            height: 90%;
            overflow-y: auto;
            font-size: 90%;
        }

        #rfc\.meta {
            width: 40%;
            float: right
        }

        .toc ul {
            list-style: none;
        }

        .filename {
            color: rgb(119, 119, 119);
            font-size: 23px;
            font-weight: normal;
            height: auto;
            line-height: 23px;
        }

        dl {
            margin-left: 1em;
        }

        dl.dl-horizontal {
            margin-left: 0;
        }

        dl>dt {
            float: left;
            margin-right: 1em;
        }

        dl.nohang>dt {
            float: none;
        }

        dl>dd {
            margin-bottom: .5em;
        }

        dl.compact>dd {
            margin-bottom: 0em;
        }

        dl>dd>dl {
            margin-top: 0.5em;
            margin-bottom: 0em;
        }

        ul.empty {
            list-style-type: none;
        }

        ul.empty li {
            margin-top: .5em;
        }

        td.reference {
            padding-right: 1em;
            vertical-align: top;
        }

        .feedback {
            position: fixed;
            bottom: 5px;
            right: 5px;
        }

        .fbbutton {
            margin-left: 5px;
        }

        h1 a,
        h2 a,
        h3 a,
        h4 a,
        h5 a,
        h6 a {
            color: rgb(51, 51, 51);
        }

        span.tt {
            font: 11pt consolas, monospace;
            font-size-adjust: none;
        }
    </style>
    <link rel="stylesheet" type="text/css" href="https://httpwg.org/assets/site.css">
    <link rel="Contents" href="#rfc.toc">
    <link rel="Author" href="#rfc.authors">
    <link rel="License" href="#rfc.copyrightnotice">
    <link rel="Chapter" title="1 Introduction" href="#rfc.section.1">
    <link rel="Chapter" title="2 Terminology" href="#rfc.section.2">
    <link rel="Chapter" title="3 The SETTINGS_ENABLE_CONNECT_PROTOCOL SETTINGS Parameter" href="#rfc.section.3">
    <link rel="Chapter" title="4 The Extended CONNECT Method" href="#rfc.section.4">
    <link rel="Chapter" title="5 Using Extended CONNECT to Bootstrap the WebSocket Protocol" href="#rfc.section.5">
    <link rel="Chapter" title="6 Design Considerations" href="#rfc.section.6">
    <link rel="Chapter" title="7 About Intermediaries" href="#rfc.section.7">
    <link rel="Chapter" title="8 Security Considerations" href="#rfc.section.8">
    <link rel="Chapter" title="9 IANA Considerations" href="#rfc.section.9">
    <link rel="Chapter" title="10 Normative References" href="#rfc.section.10">
    <link rel="Appendix" title="Acknowledgments" href="#rfc.section.unnumbered-1">
    <link rel="Alternate" title="Plain Text Version" href="http://www.ietf.org/rfc/rfc8441.txt">
    <link rel="Help" title="RFC-Editor's Status Page" href="https://www.rfc-editor.org/info/rfc8441">
    <meta name="viewport" content="initial-scale=1">
    <meta name="generator"
        content="https://github.com/mnot/RFCBootstrap XSLT vendor: Saxonica http://www.saxonica.com/">
    <meta name="keywords" content="Internet-Draft">
    <link rel="schema.dcterms" href="http://purl.org/dc/terms/">
    <meta name="dcterms.creator" content="McManus, P.">
    <meta name="dcterms.identifier" content="urn:ietf:rfc:8441">
    <meta name="dcterms.issued" content="2018-09">
    <meta name="dcterms.abstract"
        content="This document defines a mechanism for running the WebSocket Protocol (RFC 6455) over a single stream of an HTTP/2 connection.">
    <meta name="dcterms.isPartOf" content="urn:issn:2070-1721">
    <meta name="description"
        content="This document defines a mechanism for running the WebSocket Protocol (RFC 6455) over a single stream of an HTTP/2 connection.">
</head>

<body onload="getMeta(8441,'rfc.meta');">
    <nav class="navbar navbar-dark bg-dark d-print-none navbar-expand-lg fixed-top ps-3 pe-3" role="navigation">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapse"
                aria-controls="navbarToggler" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <a class="navbar-brand" href="https://httpwg.org/"><img src="https://httpwg.org/assets/http.svg"
                    height="23"></a>
        </div>

        <div class="collapse navbar-collapse" id="navbar-collapse">

            <div class="navbar-nav me-auto">

                <a class="nav-item ms-1 text-white" href="https://httpwg.org/specs/">📄 Documentation</a>

                <div class="dropdown ms-4">
                    <a href="#" class="nav-item dropdown-toggle text-white" data-bs-toggle="dropdown">Work in
                        Progress</a>
                    <ul class="dropdown-menu">
                        <li class="dropdown-item"><a href="https://httpwg.org/http-extensions/">HTTP Extensions</a></li>
                        <li class="dropdown-item"><a
                                href="https://github.com/httpwg/admin/issues?q=is%3Aissue+is%3Aopen+label%3Aadoption">Future
                                Work</a></li>
                    </ul>
                </div>

                <div class="dropdown ms-4">
                    <a href="#" class="nav-item dropdown-toggle text-white" data-bs-toggle="dropdown">Participate</a>
                    <ul class="dropdown-menu">
                        <li class="dropdown-item"><a href="https://httpwg.org/about/">About the HTTP Working Group</a>
                        </li>
                        <li class="divider"></li>
                        <li class="dropdown-item"><a href="https://httpwg.org/CONTRIBUTING.html">Contribution Policy</a>
                        </li>
                        <li class="dropdown-item"><a href="http://datatracker.ietf.org/wg/httpbis/charter/">WG
                                Charter</a></li>
                        <li class="dropdown-item"><a href="http://lists.w3.org/Archives/Public/ietf-http-wg/">Group
                                Mailing List 📨</a></li>
                        <li class="dropdown-item"><a href="https://httpwg.org/wg-materials/">Meeting Materials</a></li>
                        <li class="dropdown-item"><a href="https://httpwg.org/admin/editors/">Document Editor
                                Resources</a></li>
                    </ul>
                </div>
            </div>

        </div>
    </nav>
    <div class="container" id="top">
        <div class="row">
            <div class="col-lg-4 order-last d-none d-lg-block" id="sidebar" role="navigation">
                <div class="navbar">
                    <div class="navbar-brand"><a href="#top"><strong>RFC </strong>8441</a></div><br clear="all">
                    <div class="">
                        <div class="toc ">
                            <ul>
                                <li><a href="#rfc.section.1">1.</a>&nbsp;&nbsp;&nbsp;<a href="#introduction">介绍</a></li>
                                <li><a href="#rfc.section.2">2.</a>&nbsp;&nbsp;&nbsp;<a href="#terminology">术语</a></li>
                                <li><a href="#rfc.section.3">3.</a>&nbsp;&nbsp;&nbsp;<a
                                        href="#the-settingsenableconnectprotocol-settings-parameter">The
                                        SETTINGS_ENABLE_CONNECT_PROTOCOL SETTINGS 参数</a></li>
                                <li><a href="#rfc.section.4">4.</a>&nbsp;&nbsp;&nbsp;<a href="#method">扩展 CONNECT 方法</a>
                                </li>
                                <li><a href="#rfc.section.5">5.</a>&nbsp;&nbsp;&nbsp;<a href="#usingExtended">使用扩展
                                        CONNECT 引导 WebSocket 协议</a>
                                    <ul>
                                        <li><a href="#rfc.section.5.1">5.1.</a>&nbsp;&nbsp;&nbsp;<a
                                                href="#example">示例</a></li>
                                    </ul>
                                </li>
                                <li><a href="#rfc.section.6">6.</a>&nbsp;&nbsp;&nbsp;<a
                                        href="#design-considerations">设计注意事项</a></li>
                                <li><a href="#rfc.section.7">7.</a>&nbsp;&nbsp;&nbsp;<a
                                        href="#about-intermediaries">关于中间节点</a></li>
                                <li><a href="#rfc.section.8">8.</a>&nbsp;&nbsp;&nbsp;<a
                                        href="#security-considerations">安全注意事项</a></li>
                                <li><a href="#rfc.section.9">9.</a>&nbsp;&nbsp;&nbsp;<a href="#iana-considerations">IANA
                                        注意事项</a>
                                    <ul>
                                        <li><a href="#rfc.section.9.1">9.1.</a>&nbsp;&nbsp;&nbsp;<a
                                                href="#a-new-http2-setting">新的 HTTP/2 设置</a></li>
                                        <li><a href="#rfc.section.9.2">9.2.</a>&nbsp;&nbsp;&nbsp;<a
                                                href="#a-new-http-upgrade-token">新的 HTTP Upgrade 令牌</a></li>
                                    </ul>
                                </li>
                                <li><a href="#rfc.section.10">10.</a>&nbsp;&nbsp;&nbsp;<a
                                        href="#rfc.references">规范性参考文献</a></li>
                                <li><a href="#acknowledgments">致谢</a></li>
                                <li><a href="#rfc.authors">作者地址</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-8 order-first main" role="main">
                <header>
                    <table class="table table-condensed header" id="rfc.headerblock">
                        <tbody>
                            <tr>
                                <td class="text-left">Internet Engineering Task Force (IETF)</td>
                                <td class="text-right">P. McManus</td>
                            </tr>
                            <tr>
                                <td class="text-left">请求评注: 8441</td>
                                <td class="text-right">Mozilla</td>
                            </tr>
                            <tr>
                                <td class="text-left">更新: <a href="#RFC6455">6455</a></td>
                                <td class="text-right">2018年9月</td>
                            </tr>
                            <tr>
                                <td class="text-left">类别: Standards Track</td>
                                <td class="text-right"></td>
                            </tr>
                            <tr>
                                <td class="text-left">ISSN: 2070-1721</td>
                                <td class="text-right"></td>
                            </tr>
                        </tbody>
                    </table>
                    <div id="rfc.title">
                        <h1>使用 HTTP/2 引导 WebSockets</h1>
                    </div>
                </header>
                <hr>
                <h2 id="rfc.abstract"><a href="#rfc.abstract">摘要</a></h2>
                <div class="lead">
                    <div id="rfc.abstract.p.1">
                        <p>本文档定义了一种机制，用以在单个 HTTP/2 连接的流上运行 WebSocket 协议（RFC 6455）。</p>
                    </div>
                </div>
                <aside id="rfc.meta" class="alert alert-info"></aside>
                <section id="rfc.status">
                    <h2><a href="#rfc.status">本备忘录的状态</a></h2>
                    <div id="rfc.boilerplate.1.p.1">
                        <p>这是一个互联网标准轨道文档。</p>
                    </div>
                    <div id="rfc.boilerplate.1.p.2">
                        <p>本文档是互联网工程任务组 (IETF) 的产物，代表 IETF 社区的共识。它已接受公开审查并已获得互联网工程指导组 (IESG) 批准发布。有关互联网标准的更多信息，请参阅 <a
                                href="https://www.rfc-editor.org/rfc/rfc7841.html#section-2">RFC 7841 的第 2 节</a>。
                        </p>
                    </div>
                    <div id="rfc.boilerplate.1.p.3">
                        <p>有关本文档当前状态、任何勘误以及如何提供反馈的信息，可在 <a
                                href="https://www.rfc-editor.org/info/rfc8441">https://www.rfc-editor.org/info/rfc8441</a>
                            获取。
                        </p>
                    </div>
                </section>
                <section id="rfc.copyrightnotice">
                    <h2><a href="#rfc.copyrightnotice">Copyright Notice</a></h2>
                    <div id="rfc.boilerplate.2.p.1">
                        <p>Copyright (c) 2018 IETF Trust and the persons identified as the document authors. All rights
                            reserved.</p>
                    </div>
                    <div id="rfc.boilerplate.2.p.2">
                        <p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF
                            Documents (<a
                                href="https://trustee.ietf.org/license-info">https://trustee.ietf.org/license-info</a>)
                            in effect on the date of publication of this document. Please review these documents
                            carefully, as they describe your rights and restrictions with respect to this document. Code
                            Components extracted from this document must include Simplified BSD License text as
                            described in Section 4.e of the Trust Legal Provisions and are provided without warranty as
                            described in the Simplified BSD License.</p>
                    </div>
                </section>
                <div class="toc d-lg-none">
                    <ul>
                        <li><a href="#rfc.section.1">1.</a>&nbsp;&nbsp;&nbsp;<a href="#introduction">介绍</a>
                        </li>
                        <li><a href="#rfc.section.2">2.</a>&nbsp;&nbsp;&nbsp;<a href="#terminology">术语</a></li>
                        <li><a href="#rfc.section.3">3.</a>&nbsp;&nbsp;&nbsp;<a
                                href="#the-settingsenableconnectprotocol-settings-parameter">SETTINGS_ENABLE_CONNECT_PROTOCOL
                                SETTINGS 参数</a></li>
                        <li><a href="#rfc.section.4">4.</a>&nbsp;&nbsp;&nbsp;<a href="#method">扩展的 CONNECT 方法</a></li>
                        <li><a href="#rfc.section.5">5.</a>&nbsp;&nbsp;&nbsp;<a href="#usingExtended">使用扩展的 CONNECT 引导
                                WebSocket 协议</a>
                            <ul>
                                <li><a href="#rfc.section.5.1">5.1.</a>&nbsp;&nbsp;&nbsp;<a href="#example">示例</a>
                                </li>
                            </ul>
                        </li>
                        <li><a href="#rfc.section.6">6.</a>&nbsp;&nbsp;&nbsp;<a href="#design-considerations">设计注意事项</a>
                        </li>
                        <li><a href="#rfc.section.7">7.</a>&nbsp;&nbsp;&nbsp;<a href="#about-intermediaries">关于中间节点</a>
                        </li>
                        <li><a href="#rfc.section.8">8.</a>&nbsp;&nbsp;&nbsp;<a
                                href="#security-considerations">安全注意事项</a></li>
                        <li><a href="#rfc.section.9">9.</a>&nbsp;&nbsp;&nbsp;<a href="#iana-considerations">IANA
                                注意事项</a>
                            <ul>
                                <li><a href="#rfc.section.9.1">9.1.</a>&nbsp;&nbsp;&nbsp;<a
                                        href="#a-new-http2-setting">新的 HTTP/2 设置</a></li>
                                <li><a href="#rfc.section.9.2">9.2.</a>&nbsp;&nbsp;&nbsp;<a
                                        href="#a-new-http-upgrade-token">新的 HTTP Upgrade 令牌</a></li>
                            </ul>
                        </li>
                        <li><a href="#rfc.section.10">10.</a>&nbsp;&nbsp;&nbsp;<a href="#rfc.references">规范性参考文献</a>
                        </li>
                        <li><a href="#acknowledgments">致谢</a></li>
                        <li><a href="#rfc.authors">作者地址</a></li>
                    </ul>
                </div>
                <section id="introduction">
                    <h2 id="rfc.section.1" class="np"><a href="#rfc.section.1">1.</a>&nbsp;<a
                            href="#introduction">介绍</a></h2>
                    <div id="rfc.section.1.p.1">
                        <p>The Hypertext Transfer Protocol (HTTP) <a href="#RFC7230"><cite
                                    title="Hypertext Transfer Protocol (HTTP/1.1): Message Syntax and Routing">[RFC7230]</cite></a>
                            在不同版本之间提供了兼容的资源级语义，但在连接管理层面并不提供兼容性。依赖于 HTTP 连接管理细节的其他协议（例如 WebSockets）必须针对 HTTP 的新版本进行更新。
                        </p>
                    </div>
                    <div id="rfc.section.1.p.2">
                        <p>The WebSocket Protocol <a href="#RFC6455"><cite
                                    title="The WebSocket Protocol">[RFC6455]</cite></a> 使用 HTTP/1.1 的 Upgrade 机制（<a
                                href="https://www.rfc-editor.org/rfc/rfc7230.html#section-6.7">RFC7230 第 6.7 节</a>）
                            将 TCP 连接从 HTTP 切换为 WebSocket 连接。对于 HTTP/2 <a href="#RFC7540"><cite
                                    title="Hypertext Transfer Protocol Version 2 (HTTP/2)">[RFC7540]</cite></a>
                            必须采取不同的方法。由于其多路复用特性，HTTP/2 不允许连接范围的头字段或状态码（例如 Upgrade 和 Connection 请求头字段或 101 (Switching
                            Protocols) 响应码）。这些在 <a href="#RFC6455"><cite
                                    title="The WebSocket Protocol">[RFC6455]</cite></a> 握手中都是必需的。</p>
                    </div>
                    <div id="rfc.section.1.p.3">
                        <p>能够从 HTTP/2 引导 WebSockets 允许两个协议共享同一个 TCP 连接，并将 HTTP/2 更高效的网络利用扩展到 WebSockets。</p>
                    </div>
                    <div id="rfc.section.1.p.4">
                        <p>本文档扩展了 HTTP/2 中为 CONNECT 方法规定的用法（参见 <a
                                href="https://www.rfc-editor.org/rfc/rfc7540.html#section-8.3">RFC7540 第 8.3
                                节</a>）。该扩展允许替代 CONNECT 通常用于连接外部主机的目标，而改为使用一个新的协议名称。其结果是在单个 HTTP/2 流上创建隧道，该隧道可以承载
                            WebSockets（或任何其他协议）的数据。连接上的其他流可以承载更多扩展的 CONNECT 隧道、传统的 HTTP/2 数据，或两者的混合。</p>
                    </div>
                    <div id="rfc.section.1.p.5">
                        <p>该隧道化流将与连接上的其他常规流一起被多路复用，并享有 HTTP/2 的常规优先级、取消和流量控制特性。</p>
                    </div>
                    <div id="rfc.section.1.p.6">
                        <p>成功使用隧道流并按照本文档对打开握手所做的修改建立 WebSocket 连接的流，随后使用传统的 WebSocket 协议，将该流视为本规范中所指的 TCP 连接。</p>
                    </div>
                </section>
                <section id="terminology">
                    <h2 id="rfc.section.2"><a href="#rfc.section.2">2.</a>&nbsp;<a href="#terminology">术语</a>
                    </h2>
                    <div id="rfc.section.2.p.1">
                        <p>本文档中的关键词 “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”,
                            “RECOMMENDED”, “NOT RECOMMENDED”, “MAY”, 和 “OPTIONAL” 在全部大写出现时，应按 BCP 14 的描述解释（参见 <a
                                href="#RFC2119"><cite
                                    title="Key words for use in RFCs to Indicate Requirement Levels">[RFC2119]</cite></a>
                            和 <a href="#RFC8174"><cite
                                    title="Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words">[RFC8174]</cite></a>）。
                        </p>
                    </div>
                </section>
                <section id="the-settingsenableconnectprotocol-settings-parameter">
                    <h2 id="rfc.section.3"><a href="#rfc.section.3">3.</a>&nbsp;<a
                            href="#the-settingsenableconnectprotocol-settings-parameter">SETTINGS_ENABLE_CONNECT_PROTOCOL
                            SETTINGS 参数</a></h2>
                    <div id="rfc.section.3.p.1">
                        <p>本文档向 <a href="#RFC7540"><cite
                                    title="Hypertext Transfer Protocol Version 2 (HTTP/2)">[RFC7540]</cite></a> 定义的
                            SETTINGS 参数集合（参见 <a href="https://www.rfc-editor.org/rfc/rfc7540.html#section-6.5.2">RFC7540
                                第 6.5.2 节</a>）添加了一个新的 SETTINGS 参数。</p>
                    </div>
                    <div id="rfc.section.3.p.2">
                        <p>新参数名为 SETTINGS_ENABLE_CONNECT_PROTOCOL。该参数的值 MUST 为 0 或 1。</p>
                    </div>
                    <div id="rfc.section.3.p.3">
                        <p>在接收到值为 1 的 SETTINGS_ENABLE_CONNECT_PROTOCOL 后，客户端 MAY 在创建新流时使用本文档定义的扩展
                            CONNECT。服务器接收到此参数不会产生影响。</p>
                    </div>
                    <div id="rfc.section.3.p.4">
                        <p>发送者 MUST NOT 在先前发送过值为 1 之后再次发送值为 0 的 SETTINGS_ENABLE_CONNECT_PROTOCOL 参数。</p>
                    </div>
                    <div id="rfc.section.3.p.5">
                        <p>使用 SETTINGS 参数来选择加入本来不兼容的协议更改属于 <a
                                href="https://www.rfc-editor.org/rfc/rfc7540.html#section-5.5">RFC7540 第 5.5 节</a> 定义的
                            “扩展 HTTP/2” 的用法。具体来说，本规范中新伪头字段 “:protocol” 的添加，以及在第 <a href="#method"
                                title="The Extended CONNECT Method">4 节</a> 中对 :authority
                            伪头字段含义的更改，都需要通过可选协商来启用。如果客户端在未先接收到 SETTINGS_ENABLE_CONNECT_PROTOCOL 参数的情况下使用本文档定义的扩展 CONNECT
                            的条款，则不支持的对端会检测到格式错误的请求并生成流错误（参见 <a
                                href="https://www.rfc-editor.org/rfc/rfc7540.html#section-8.1.2.6">RFC7540 第 8.1.2.6
                                节</a>）。</p>
                    </div>
                </section>
                <section id="method">
                    <h2 id="rfc.section.4"><a href="#rfc.section.4">4.</a>&nbsp;<a href="#method">扩展的 CONNECT 方法</a>
                    </h2>
                    <div id="rfc.section.4.p.1" class="avoidbreakafter">
                        <p>HTTP/2 中 CONNECT 方法的使用由 <a
                                href="https://www.rfc-editor.org/rfc/rfc7540.html#section-8.3">RFC7540 第 8.3 节</a>
                            定义。本扩展对该方法作如下修改：</p>
                    </div>
                    <div id="rfc.section.4.p.2">
                        <ul>
                            <li>请求 HEADERS 中可以包含一个新的伪头字段 :protocol，用来指示希望在由 CONNECT 创建的隧道上使用的协议。该伪头字段为单值，包含来自 “Hypertext
                                Transfer Protocol (HTTP) Upgrade Token Registry” 的值，注册表地址为 &lt;<a
                                    href="https://www.iana.org/assignments/http-upgrade-tokens/">https://www.iana.org/assignments/http-upgrade-tokens/</a>&gt;。
                            </li>
                            <li>在包含 :protocol 伪头字段的请求上，目标 URI 的 :scheme 和 :path 伪头字段（参见第 <a href="#usingExtended"
                                    title="Using Extended CONNECT to Bootstrap the WebSocket Protocol">5 节</a>）也 MUST
                                一并包含。</li>
                            <li>在带有 :protocol 伪头字段的请求中，:authority 伪头字段的解释依照 <a
                                    href="https://www.rfc-editor.org/rfc/rfc7540.html#section-8.1.2.3">RFC7540 第 8.1.2.3
                                    节</a> 而非该文档的 <a href="https://www.rfc-editor.org/rfc/rfc7540.html#section-8.3">第 8.3
                                    节</a>。特别地，服务器在此扩展下不得像处理未被扩展修改的 CONNECT 请求那样，基于 :authority 指示的主机创建到该主机的隧道。</li>
                        </ul>
                    </div>
                    <div id="rfc.section.4.p.3">
                        <p>在接收到包含 :protocol 伪头字段的 CONNECT 请求后，服务器建立到伪头字段所指示协议类型的另一项服务的隧道。该服务可以与服务器同址，也可以不在同一位置。</p>
                    </div>
                </section>
                <section id="usingExtended">
                    <h2 id="rfc.section.5"><a href="#rfc.section.5">5.</a>&nbsp;<a href="#usingExtended">使用扩展的 CONNECT
                            引导 WebSocket 协议</a></h2>
                    <div id="rfc.section.5.p.1">
                        <p>CONNECT 请求 MUST 包含 :protocol 伪头字段，其值 MUST 为 <span class="tt">websocket</span>，以便在 HTTP/2 流上启动
                            WebSocket 连接。其他用于操作 cookie 的 HTTP 请求和响应头字段可以像往常一样随 CONNECT 方法一起包含在 HEADERS 中。该请求取代了 <a
                                href="#RFC6455"><cite title="The WebSocket Protocol">[RFC6455]</cite></a> 中基于 GET
                            的请求，并用于处理 WebSockets 的打开握手。</p>
                    </div>
                    <div id="rfc.section.5.p.2">
                        <p>目标 URI 的 scheme（参见 <a href="https://www.rfc-editor.org/rfc/rfc7230.html#section-5.1">RFC7230
                                第 5.1 节</a>）在用于 “wss” 的 WebSockets 时 MUST 为 “https”，在用于 “ws” 的 WebSockets 时 MUST 为
                            “http”。目标 URI 的其余部分与 WebSocket URI 相同。WebSocket URI 仍用于代理自动配置。本文档所用的 HTTP/2 连接的安全要求由 <a
                                href="#RFC7540"><cite
                                    title="Hypertext Transfer Protocol Version 2 (HTTP/2)">[RFC7540]</cite></a> 为 https
                            请求规定，并由 <a href="#RFC8164"><cite
                                    title="Opportunistic Security for HTTP/2">[RFC8164]</cite></a> 为 http 请求规定。</p>
                    </div>
                    <div id="rfc.section.5.p.3">
                        <p><a href="#RFC6455"><cite title="The WebSocket Protocol">[RFC6455]</cite></a> 要求使用 Connection
                            和 Upgrade 头字段，这些头字段不属于 HTTP/2。它们 MUST NOT 被包含在此处定义的 CONNECT 请求中。</p>
                    </div>
                    <div id="rfc.section.5.p.4">
                        <p><a href="#RFC6455"><cite title="The WebSocket Protocol">[RFC6455]</cite></a> 要求使用 Host
                            头字段，而该头字段也不属于 HTTP/2。Host 信息由 :authority 伪头字段传递，该伪头字段在每次 HTTP/2 事务中都是必需的。</p>
                    </div>
                    <div id="rfc.section.5.p.5">
                        <p>使用此扩展的 CONNECT 来引导 WebSockets 的实现不再处理 <a href="#RFC6455"><cite
                                    title="The WebSocket Protocol">[RFC6455]</cite></a> 中的 Sec-WebSocket-Key 和
                            Sec-WebSocket-Accept 头字段，因为这些功能已被 :protocol 伪头字段取代。</p>
                    </div>
                    <div id="rfc.section.5.p.6">
                        <p>Origin (<a href="#RFC6454"><cite title="The Web Origin Concept">[RFC6454]</cite></a>),
                            Sec-WebSocket-Version, Sec-WebSocket-Protocol, 和 Sec-WebSocket-Extensions 头字段在 CONNECT
                            请求和响应头字段中按 <a href="#RFC6455"><cite title="The WebSocket Protocol">[RFC6455]</cite></a>
                            的定义使用。注意 HTTP/1 的头字段名不区分大小写，而 HTTP/2 要求它们以小写编码。</p>
                    </div>
                    <div id="rfc.section.5.p.7">
                        <p>在成功处理打开握手后，对等方应继续使用 WebSocket 协议 <a href="#RFC6455"><cite
                                    title="The WebSocket Protocol">[RFC6455]</cite></a>，并将 CONNECT 事务使用的 HTTP/2
                            流视为该规范中所指的 TCP 连接。此时 WebSocket 连接的状态为 OPEN（参见 <a href="#RFC6455"><cite
                                    title="The WebSocket Protocol">[RFC6455]</cite></a> 第 4.1 节）。</p>
                    </div>
                    <div id="rfc.section.5.p.8">
                        <p>HTTP/2 流的关闭也类似于 <a href="#RFC6455"><cite title="The WebSocket Protocol">[RFC6455]</cite></a>
                            中的 TCP 连接关闭。有序的 TCP 级关闭由 END_STREAM 标志表示（参见 <a href="#RFC7540"><cite
                                    title="Hypertext Transfer Protocol Version 2 (HTTP/2)">[RFC7540]</cite></a> 第 6.1
                            节）。RST 异常由 RST_STREAM 帧表示（参见 <a href="#RFC7540"><cite
                                    title="Hypertext Transfer Protocol Version 2 (HTTP/2)">[RFC7540]</cite></a> 第 6.4
                            节），错误码使用 CANCEL（参见 <a href="#RFC7540"><cite
                                    title="Hypertext Transfer Protocol Version 2 (HTTP/2)">[RFC7540]</cite></a> 第 7 节）。
                        </p>
                    </div>
                    <section id="example">
                        <h3 id="rfc.section.5.1"><a href="#rfc.section.5.1">5.1.</a>&nbsp;<a href="#example">示例</a>
                        </h3>
                        <div id="rfc.figure.u.1">
                            <div>
                                <pre class="text">
[[ From Client ]]                       [[ From Server ]]

                                        SETTINGS
                                        SETTINGS_ENABLE_CONNECT_[..] = 1

HEADERS + END_HEADERS
:method = CONNECT
:protocol = websocket
:scheme = https
:path = /chat
:authority = server.example.com
sec-websocket-protocol = chat, superchat
sec-websocket-extensions = permessage-deflate
sec-websocket-version = 13
origin = http://www.example.com

                                        HEADERS + END_HEADERS
                                        :status = 200
                                        sec-websocket-protocol = chat

DATA
WebSocket Data

                                        DATA + END_STREAM
                                        WebSocket Data

DATA + END_STREAM
WebSocket Data
</pre>
                            </div>
                        </div>
                    </section>
                </section>
                <section id="design-considerations">
                    <h2 id="rfc.section.6"><a href="#rfc.section.6">6.</a>&nbsp;<a
                            href="#design-considerations">设计注意事项</a></h2>
                    <div id="rfc.section.6.p.1">
                        <p>通过对 HTTP/2 做更大改动实现与之更原生的集成当然是可行的。本设计的选择旨在在最小化解决方案复杂性的同时，仍然解决在同一连接上同时运行 HTTP/2 与 WebSockets
                            的主要问题。</p>
                    </div>
                </section>
                <section id="about-intermediaries">
                    <h2 id="rfc.section.7"><a href="#rfc.section.7">7.</a>&nbsp;<a
                            href="#about-intermediaries">关于中间节点</a></h2>
                    <div id="rfc.section.7.p.1">
                        <p>本文档并未改变 WebSockets 与 HTTP 正向代理的交互方式。如果希望通过 HTTP/2 与 HTTP 代理建立 WebSockets 的客户端，应继续使用传统的
                            CONNECT（即不带 :protocol 伪头字段）通过该代理将隧道建立到 WebSocket 服务器。</p>
                    </div>
                    <div id="rfc.section.7.p.2">
                        <p>隧道上使用的 HTTP 版本决定了 WebSockets 是直接启动还是通过本文档描述的修改后的 CONNECT 请求启动。</p>
                    </div>
                </section>
                <section id="security-considerations">
                    <h2 id="rfc.section.8"><a href="#rfc.section.8">8.</a>&nbsp;<a
                            href="#security-considerations">安全注意事项</a></h2>
                    <div id="rfc.section.8.p.1" class="avoidbreakafter">
                        <p><a href="#RFC6455"><cite title="The WebSocket Protocol">[RFC6455]</cite></a> 确保非 WebSockets
                            客户端，特别是基于 XMLHttpRequest 的客户端，无法建立 WebSocket 连接。其主要机制是使用以 Sec- 前缀的请求头字段，这些字段不能由基于
                            XMLHttpRequest 的客户端创建。本文档通过两种方式处理该问题：</p>
                    </div>
                    <div id="rfc.section.8.p.2">
                        <ul>
                            <li>XMLHttpRequest 还禁止使用 CONNECT 方法，除了禁止 Sec- 前缀的请求头字段外。</li>
                            <li>伪头字段的使用属于连接专属，且 HTTP/2 不允许在协议栈之外创建伪头字段。</li>
                        </ul>
                    </div>
                    <div id="rfc.section.8.p.3">
                        <p>当使用本文档时，<a href="#RFC6455"><cite title="The WebSocket Protocol">[RFC6455]</cite></a> 第 10
                            节中关于安全的注意事项仍然适用，但第 10.8 节除外。第 10.8 节与本文件所改变的引导握手特定相关，因此在此处不适用。</p>
                    </div>
                </section>
                <section id="iana-considerations">
                    <h2 id="rfc.section.9"><a href="#rfc.section.9">9.</a>&nbsp;<a href="#iana-considerations">IANA
                            注意事项</a></h2>
                    <section id="a-new-http2-setting">
                        <h3 id="rfc.section.9.1"><a href="#rfc.section.9.1">9.1.</a>&nbsp;<a
                                href="#a-new-http2-setting">新的 HTTP/2 设置</a></h3>
                        <div id="rfc.section.9.1.p.1">
                            <p>本文档在由 <a href="https://www.rfc-editor.org/rfc/rfc7540.html#section-11.3">RFC7540 第 11.3
                                    节</a> 建立的 “HTTP/2 Settings” 注册表中注册了一项条目。</p>
                        </div>
                        <div id="rfc.section.9.1.p.2">
                            <dl>
                                <dt>Code:</dt>
                                <dd>0x8</dd>
                                <dt>Name:</dt>
                                <dd>SETTINGS_ENABLE_CONNECT_PROTOCOL</dd>
                                <dt>Initial Value:</dt>
                                <dd>0</dd>
                                <dt>Specification:</dt>
                                <dd>This document</dd>
                            </dl>
                        </div>
                    </section>
                    <section id="a-new-http-upgrade-token">
                        <h3 id="rfc.section.9.2"><a href="#rfc.section.9.2">9.2.</a>&nbsp;<a
                                href="#a-new-http-upgrade-token">新的 HTTP Upgrade 令牌</a></h3>
                        <div id="rfc.section.9.2.p.1">
                            <p>本文档在由 <a href="#RFC7230"><cite
                                        title="Hypertext Transfer Protocol (HTTP/1.1): Message Syntax and Routing">[RFC7230]</cite></a>
                                建立的 “HTTP Upgrade Tokens” 注册表中注册了一项条目。</p>
                        </div>
                        <div id="rfc.section.9.2.p.2">
                            <dl>
                                <dt>Value:</dt>
                                <dd>websocket</dd>
                                <dt>Description:</dt>
                                <dd>Web Socket 协议</dd>
                                <dt>Expected Version Tokens:</dt>
                                <dd>&nbsp;</dd>
                                <dt>References:</dt>
                                <dd><a href="#RFC6455"><cite title="The WebSocket Protocol">[RFC6455]</cite></a>
                                    [RFC8441]</dd>
                            </dl>
                        </div>
                    </section>
                </section>
                <section>
                    <div id="rfc.references">
                        <h2 id="rfc.section.10"><a href="#rfc.section.10">10.</a> 规范性参考文献</h2>
                        <dl class="dl-horizontal">
                            <dt id="RFC2119">[<a href="#RFC2119" class="smpl">RFC2119</a>]</dt>
                            <dd>Bradner, S., “<a href="https://www.rfc-editor.org/rfc/rfc2119.html">Key words for use in
                                    RFCs to Indicate Requirement Levels</a>”, <a
                                    href="https://www.rfc-editor.org/info/bcp14">BCP 14</a>, RFC 2119, <a
                                    href="https://dx.doi.org/10.17487/RFC2119">DOI 10.17487/RFC2119</a>, March 1997,
                                &lt;<a
                                    href="https://www.rfc-editor.org/info/rfc2119">https://www.rfc-editor.org/info/rfc2119</a>&gt;.
                            </dd>
                            <dt id="RFC6454">[<a href="#RFC6454" class="smpl">RFC6454</a>]</dt>
                            <dd>Barth, A., “<a href="https://www.rfc-editor.org/rfc/rfc6454.html">The Web Origin
                                    Concept</a>”, RFC 6454, <a href="https://dx.doi.org/10.17487/RFC6454">DOI
                                    10.17487/RFC6454</a>, December 2011, &lt;<a
                                    href="https://www.rfc-editor.org/info/rfc6454">https://www.rfc-editor.org/info/rfc6454</a>&gt;.
                            </dd>
                            <dt id="RFC6455">[<a href="#RFC6455" class="smpl">RFC6455</a>]</dt>
                            <dd>Fette, I. and A. Melnikov, “<a href="https://www.rfc-editor.org/rfc/rfc6455.html">The
                                    WebSocket Protocol</a>”, RFC 6455, <a href="https://dx.doi.org/10.17487/RFC6455">DOI
                                    10.17487/RFC6455</a>, December 2011, &lt;<a
                                    href="https://www.rfc-editor.org/info/rfc6455">https://www.rfc-editor.org/info/rfc6455</a>&gt;.
                            </dd>
                            <dt id="RFC7230">[<a href="#RFC7230" class="smpl">RFC7230</a>]</dt>
                            <dd>Fielding, R., Ed. and J. Reschke, Ed., “<a
                                    href="https://www.rfc-editor.org/rfc/rfc7230.html">Hypertext Transfer Protocol
                                    (HTTP/1.1): Message Syntax and Routing</a>”, RFC 7230, <a
                                    href="https://dx.doi.org/10.17487/RFC7230">DOI 10.17487/RFC7230</a>, June 2014,
                                &lt;<a
                                    href="https://www.rfc-editor.org/info/rfc7230">https://www.rfc-editor.org/info/rfc7230</a>&gt;.
                            </dd>
                            <dt id="RFC7540">[<a href="#RFC7540" class="smpl">RFC7540</a>]</dt>
                            <dd>Belshe, M., Peon, R., and M. Thomson, Ed., “<a
                                    href="https://www.rfc-editor.org/rfc/rfc7540.html">Hypertext Transfer Protocol
                                    Version 2 (HTTP/2)</a>”, RFC 7540, <a href="https://dx.doi.org/10.17487/RFC7540">DOI
                                    10.17487/RFC7540</a>, May 2015, &lt;<a
                                    href="https://www.rfc-editor.org/info/rfc7540">https://www.rfc-editor.org/info/rfc7540</a>&gt;.
                            </dd>
                            <dt id="RFC8164">[<a href="#RFC8164" class="smpl">RFC8164</a>]</dt>
                            <dd>Nottingham, M. and M. Thomson, “<a
                                    href="https://www.rfc-editor.org/rfc/rfc8164.html">Opportunistic Security for
                                    HTTP/2</a>”, RFC 8164, <a href="https://dx.doi.org/10.17487/RFC8164">DOI
                                    10.17487/RFC8164</a>, May 2017, &lt;<a
                                    href="https://www.rfc-editor.org/info/rfc8164">https://www.rfc-editor.org/info/rfc8164</a>&gt;.
                            </dd>
                            <dt id="RFC8174">[<a href="#RFC8174" class="smpl">RFC8174</a>]</dt>
                            <dd>Leiba, B., “<a href="https://www.rfc-editor.org/rfc/rfc8174.html">Ambiguity of Uppercase
                                    vs Lowercase in RFC 2119 Key Words</a>”, <a
                                    href="https://www.rfc-editor.org/info/bcp14">BCP 14</a>, RFC 8174, <a
                                    href="https://dx.doi.org/10.17487/RFC8174">DOI 10.17487/RFC8174</a>, May 2017,
                                &lt;<a
                                    href="https://www.rfc-editor.org/info/rfc8174">https://www.rfc-editor.org/info/rfc8174</a>&gt;.
                            </dd>
                        </dl>
                    </div>
                </section>
                <section id="acknowledgments">
                    <h2 id="rfc.section.unnumbered-1"><a href="#acknowledgments">致谢</a></h2>
                    <div id="rfc.section.unnumbered-1.p.1">
                        <p>2017 年 HTTP 研讨会中进行了一次富有成效的讨论，帮助确定了关键问题和可接受的解决方案复杂度。</p>
                    </div>
                </section>
                <section id="rfc.authors" class="avoidbreakinside">
                    <h2><a href="#rfc.authors">作者地址</a></h2>
                    <address><b>Patrick McManus</b><br>Mozilla<br>EMail: <a
                            href="mailto:mcmanus@ducksong.com">mcmanus@ducksong.com</a></address>
                </section>
            </div>
        </div>
    </div>
    <script src="https://httpwg.org/assets/node_modules/jquery/dist/jquery.min.js"></script>
    <script src="https://httpwg.org/assets/node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="https://htmlspecs.com/dropdown.js"></script>
</body>

</html>