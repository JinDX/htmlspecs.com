<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
    <meta content="#3c790a" name="theme-color">
    <meta content="light dark" name="color-scheme">
    <title>Test Utils Standard</title>
    <link crossorigin href="https://resources.whatwg.org/standard-shared-with-dev.css" rel="stylesheet">
    <link crossorigin href="https://resources.whatwg.org/standard.css" rel="stylesheet">
    <link crossorigin href="https://resources.whatwg.org/spec.css" rel="stylesheet">
    <link crossorigin href="https://resources.whatwg.org/logo-testutils.svg" rel="icon">
    <script crossorigin defer src="https://resources.whatwg.org/commit-snapshot-shortcut-key.js"></script>
    <meta content="Bikeshed version 7a96e07ec, updated Mon Jul 14 11:12:36 2025 -0700" name="generator">
    <meta content="039634c101ce2e7593968ce47c3e6eed9c1d61a8" name="revision">
    <style>
        /* Boilerplate: style-dfn-panel */
        :root {
            --dfnpanel-bg: #ddd;
            --dfnpanel-text: var(--text);
            --dfnpanel-target-bg: #ffc;
            --dfnpanel-target-outline: orange;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --dfnpanel-bg: #222;
                --dfnpanel-text: var(--text);
                --dfnpanel-target-bg: #333;
                --dfnpanel-target-outline: silver;
            }
        }

        .dfn-panel {
            position: absolute;
            z-index: 35;
            width: 20em;
            width: 300px;
            height: auto;
            max-height: 500px;
            overflow: auto;
            padding: 0.5em 0.75em;
            font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
            background: var(--dfnpanel-bg);
            color: var(--dfnpanel-text);
            border: outset 0.2em;
            white-space: normal;
            /* in case it's moved into a pre */
        }

        .dfn-panel:not(.on) {
            display: none;
        }

        .dfn-panel * {
            margin: 0;
            padding: 0;
            text-indent: 0;
        }

        .dfn-panel>b {
            display: block;
        }

        .dfn-panel a {
            color: var(--dfnpanel-text);
        }

        .dfn-panel a:not(:hover) {
            text-decoration: none !important;
            border-bottom: none !important;
        }

        .dfn-panel a:focus {
            outline: 5px auto Highlight;
            outline: 5px auto -webkit-focus-ring-color;
        }

        .dfn-panel>b+b {
            margin-top: 0.25em;
        }

        .dfn-panel ul {
            padding: 0 0 0 1em;
            list-style: none;
        }

        .dfn-panel li a {
            max-width: calc(300px - 1.5em - 1em);
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .dfn-panel.activated {
            display: inline-block;
            position: fixed;
            left: 8px;
            bottom: 2em;
            margin: 0 auto;
            max-width: calc(100vw - 1.5em - .4em - .5em);
            max-height: 30vh;
            transition: left 1s ease-out, bottom 1s ease-out;
        }

        .dfn-panel .link-item:hover {
            text-decoration: underline;
        }

        .dfn-panel .link-item .copy-icon {
            opacity: 0;
        }

        .dfn-panel .link-item:hover .copy-icon,
        .dfn-panel .link-item .copy-icon:focus {
            opacity: 1;
        }

        .dfn-panel .copy-icon {
            display: inline-block;
            margin-right: 0.5em;
            width: 0.85em;
            height: 1em;
            border-radius: 3px;
            background-color: #ccc;
            cursor: pointer;
        }

        .dfn-panel .copy-icon .icon {
            width: 100%;
            height: 100%;
            background-color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .dfn-panel .copy-icon .icon::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 1px solid black;
            background-color: #ccc;
            opacity: 0.25;
            transform: translate(3px, -3px);
        }

        .dfn-panel .copy-icon:active .icon::before {
            opacity: 1;
        }

        .dfn-paneled[role="button"] {
            cursor: help;
        }

        .highlighted {
            animation: target-fade 3s;
        }

        @keyframes target-fade {
            from {
                background-color: var(--dfnpanel-target-bg);
                outline: 5px solid var(--dfnpanel-target-outline);
            }

            to {
                color: var(--a-normal-text);
                background-color: transparent;
                outline: transparent;
            }
        }
    </style>
    <style>
        /* Boilerplate: style-ref-hints */
        :root {
            --ref-hint-bg: #ddd;
            --ref-hint-text: var(--text);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --ref-hint-bg: #222;
                --ref-hint-text: var(--text);
            }
        }

        .ref-hint {
            display: inline-block;
            position: absolute;
            z-index: 35;
            width: 20em;
            width: 300px;
            height: auto;
            max-height: 500px;
            overflow: auto;
            padding: 0.5em 0.5em;
            font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
            background: var(--ref-hint-bg);
            color: var(--ref-hint-text);
            border: outset 0.2em;
            white-space: normal;
            /* in case it's moved into a pre */
        }

        .ref-hint * {
            margin: 0;
            padding: 0;
            text-indent: 0;
        }

        .ref-hint ul {
            padding: 0 0 0 1em;
            list-style: none;
        }
    </style>

<body class="h-entry status-LS">
    <div class="head">

        <a class="logo" href="https://whatwg.org/">
            <img alt="WHATWG" class="darkmode-aware" crossorigin height="100"
                src="https://resources.whatwg.org/logo-testutils.svg">
        </a>

        <hgroup>
            <h1 class="p-name no-ref" id="title">Test Utils</h1>
            <p id="subtitle">Living Standard — Last Updated <time class="dt-updated" datetime="2025-07-18">18 July
                    2025</time>
            </p>
        </hgroup>
        <div data-fill-with="spec-metadata">
            <dl>
                <dt>Participate:
                <dd><a href="https://github.com/whatwg/testutils">GitHub whatwg/testutils</a> (<a
                        href="https://github.com/whatwg/testutils/issues/new/choose">new issue</a>, <a
                        href="https://github.com/whatwg/testutils/issues">open issues</a>)
                <dd><a href="https://whatwg.org/chat">Chat on Matrix</a>
                <dt>Commits:
                <dd><a href="https://github.com/whatwg/testutils/commits">GitHub whatwg/testutils/commits</a>
                <dd><a href="/commit-snapshots/039634c101ce2e7593968ce47c3e6eed9c1d61a8/"
                        id="commit-snapshot-link">Snapshot as of this commit</a>
                <dd><a href="https://twitter.com/testutils">@testutils</a>
                <dt>Tests:
                <dd><a href="https://github.com/web-platform-tests/wpt/tree/master/testutils">web-platform-tests
                        testutils/</a> (<a href="https://github.com/web-platform-tests/wpt/labels/testutils">ongoing
                        work</a>)
                <dt>Translations <small>(non-normative)</small>:
                <dd><span title="Simplified Chinese"><a href="https://htmlspecs.com/testutils/" hreflang="zh-hans"
                            lang="zh-hans" rel="alternate">简体中文</a></span>
            </dl>
        </div>
        <div data-fill-with="warning"></div>
    </div>
    <div class="p-summary" data-fill-with="abstract">
        <h2 class="no-num no-toc no-ref heading settled" id="abstract"><span class="content">Abstract</span></h2>
        <p>This document defines APIs that provide additional testing functionality in browsers</p>
    </div>
    <nav data-fill-with="table-of-contents" id="toc">
        <h2 class="no-num no-toc no-ref" id="contents">Table of Contents</h2>
        <ol class="toc" role="directory">
            <li><a href="#intro"><span class="secno">1</span> <span class="content">Introduction</span></a>
            <li><a href="#infrastructure"><span class="secno">2</span> <span class="content">Infrastructure</span></a>
            <li><a href="#availability"><span class="secno">3</span> <span class="content">Availability</span></a>
            <li><a href="#the-testutils-namespace"><span class="secno">4</span> <span class="content">The TestUtils
                        Namespace</span></a>
            <li><a href="#acknowledgements"><span class="secno"></span> <span class="content">Acknowledgments</span></a>
            <li><a href="#ipr"><span class="secno"></span> <span class="content">Intellectual property rights</span></a>
            <li>
                <a href="#index"><span class="secno"></span> <span class="content">Index</span></a>
                <ol class="toc">
                    <li><a href="#index-defined-here"><span class="secno"></span> <span class="content">Terms defined by
                                this specification</span></a>
                    <li><a href="#index-defined-elsewhere"><span class="secno"></span> <span class="content">Terms
                                defined by reference</span></a>
                </ol>
            <li>
                <a href="#references"><span class="secno"></span> <span class="content">References</span></a>
                <ol class="toc">
                    <li><a href="#normative"><span class="secno"></span> <span class="content">Normative
                                References</span></a>
                </ol>
            <li><a href="#idl-index"><span class="secno"></span> <span class="content">IDL Index</span></a>
        </ol>
    </nav>
    <main>
        <h2 class="heading settled" data-level="1" id="intro"><span class="secno">1. </span><span
                class="content">Introduction</span><a class="self-link" href="#intro"></a></h2>
        <p>Testing browsers often requires use of specialised API surface that is
            not suitable for exposing to web authors, for example because it could
            undermine platform invariants, or allow behavior that could put users
            at risk. This can make writing cross-browser tests difficult because
            each implementation of the web platform will have its own approach to
            defining such test APIs. The <a data-link-type="biblio" href="#biblio-webdriver"
                title="WebDriver">WebDriver</a> standard
            provides some of these APIs, with a focus on automated testing of web
            applications. However for testing of browser implementations
            themselves, there are some additional APIs that don’t fit into the
            WebDriver framework, but are nevertheless important to testing.</p>
        <p>This specification defines additional in-browser APIs for use in
            tests, but which are not suitable to enable for end users. The primary
            client of these APIs is the web-platform-tests
            testsuite.</p>
        <h2 class="heading settled" data-level="2" id="infrastructure"><span class="secno">2. </span><span
                class="content">Infrastructure</span><a class="self-link" href="#infrastructure"></a></h2>
        <p>This specification depends on the Infra Standard. <a data-link-type="biblio" href="#biblio-infra"
                title="Infra Standard">[INFRA]</a>

        </p>
        <p>This specification uses terminology from the Web IDL standard. <a data-link-type="biblio"
                href="#biblio-webidl" title="Web IDL Standard">[WEBIDL]</a>

        </p>
        <h2 class="heading settled" data-level="3" id="availability"><span class="secno">3. </span><span
                class="content">Availability</span><a class="self-link" href="#availability"></a></h2>
        <p>The interfaces defined in this specification must not be enabled in
            the default shipping configuration of user agents. They must only be
            enabled in testing configurations for example with special build
            flags, or when a specific non-default preference is set.</p>
        <h2 class="heading settled" data-level="4" id="the-testutils-namespace"><span class="secno">4. </span><span
                class="content">The TestUtils Namespace</span><a class="self-link" href="#the-testutils-namespace"></a>
        </h2>
        <pre class="idl highlight def">[<a class="idl-code" data-link-type="extended-attribute" href="https://webidl.spec.whatwg.org/#Exposed" id="ref-for-Exposed"><c- g>Exposed</c-></a>=(<c- n>Window</c->,<c- n>Worker</c->)]
<c- b>namespace</c-> <dfn class="dfn-paneled idl-code" data-dfn-type="namespace" data-export id="namespacedef-testutils"><code><c- g>TestUtils</c-></code></dfn> {
  [<a class="idl-code" data-link-type="extended-attribute" href="https://webidl.spec.whatwg.org/#NewObject" id="ref-for-NewObject"><c- g>NewObject</c-></a>] <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-promise" id="ref-for-idl-promise"><c- b>Promise</c-></a>&lt;<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-undefined" id="ref-for-idl-undefined"><c- b>undefined</c-></a>> <dfn class="dfn-paneled idl-code" data-dfn-for="TestUtils" data-dfn-type="method" data-export data-lt="gc()" id="dom-testutils-gc"><code><c- g>gc</c-></code></dfn>();
};
</pre>
        <p>The <code
                class="idl"><a data-link-type="idl" href="#dom-testutils-gc" id="ref-for-dom-testutils-gc">gc()</a></code>
            method must run these steps:</p>
        <ol>
            <li data-md>
                <p>Let <var>p</var> be a new promise.</p>
            <li data-md>
                <p>Run the following <a data-link-type="dfn"
                        href="https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel"
                        id="ref-for-in-parallel">in parallel</a>:</p>
                <p>2.1 Run <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#implementation-defined"
                        id="ref-for-implementation-defined">implementation-defined</a> steps to perform a garbage
                    collection
                    covering at least the <a data-link-type="dfn"
                        href="https://html.spec.whatwg.org/multipage/webappapis.html#concept-entry-realm"
                        id="ref-for-concept-entry-realm">entry Realm</a>.</p>
                <p>2.2 Resolve <var>p</var>.</p>
        </ol>
        <h2 class="no-num heading settled" id="acknowledgements"><span class="content">Acknowledgments</span><a
                class="self-link" href="#acknowledgements"></a></h2>
        <p>Thanks to the following people who have contributed to the
            Test Utils standard:</p>
        <p>Kagami Sascha Rosylight</p>
        <p>You are awesome!</p>
        <p>This standard is written by <a href="https://hoppipolla.co.uk">James Graham</a>
            (<a href="https://www.mozilla.org/">Mozilla</a>,
            <a href="mailto:james@hoppipolla.co.uk">james@hoppipolla.co.uk</a>).
        </p>
        <h2 class="no-num heading settled" id="ipr"><span class="content">Intellectual property rights</span><a
                class="self-link" href="#ipr"></a></h2>
        <p>Copyright © WHATWG (Apple, Google, Mozilla, Microsoft). This work is licensed under a <a
                href="https://creativecommons.org/licenses/by/4.0/" rel="license">Creative Commons Attribution 4.0
                International License</a>. To the extent portions of it are incorporated into source code, such
            portions in the source code are licensed under the <a href="https://opensource.org/licenses/BSD-3-Clause"
                rel="license">BSD 3-Clause License</a> instead.</p>
        <p>This is the Living Standard. Those
            interested in the patent-review version should view the
            <a href="/review-drafts/2022-03/">Living Standard Review Draft</a>.
        </p>
    </main>
    <script>
        "use strict";
        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("/service-worker.js");
        }
    </script>
    <h2 class="no-num no-ref heading settled" id="index"><span class="content">Index</span><a class="self-link"
            href="#index"></a></h2>
    <h3 class="no-num no-ref heading settled" id="index-defined-here"><span class="content">Terms defined by this
            specification</span><a class="self-link" href="#index-defined-here"></a></h3>
    <ul class="index">
        <li><a href="#dom-testutils-gc">gc()</a><span>, in § 4</span>
        <li><a href="#namespacedef-testutils">TestUtils</a><span>, in § 4</span>
    </ul>
    <h3 class="no-num no-ref heading settled" id="index-defined-elsewhere"><span class="content">Terms defined by
            reference</span><a class="self-link" href="#index-defined-elsewhere"></a></h3>
    <ul class="index">
        <li>
            <a data-link-type="biblio">[HTML]</a> defines the following terms:
            <ul>
                <li><span class="dfn-paneled" id="6339a85f">entry realm</span>
                <li><span class="dfn-paneled" id="a72449dd">in parallel</span>
            </ul>
        <li>
            <a data-link-type="biblio">[INFRA]</a> defines the following terms:
            <ul>
                <li><span class="dfn-paneled" id="860300d4">implementation-defined</span>
            </ul>
        <li>
            <a data-link-type="biblio">[WEBIDL]</a> defines the following terms:
            <ul>
                <li><span class="dfn-paneled" id="889e932f">Exposed</span>
                <li><span class="dfn-paneled" id="c807e273">NewObject</span>
                <li><span class="dfn-paneled" id="bdbd19d1">Promise</span>
                <li><span class="dfn-paneled" id="5f90bbfb">undefined</span>
            </ul>
    </ul>
    <h2 class="no-num no-ref heading settled" id="references"><span class="content">References</span><a
            class="self-link" href="#references"></a></h2>
    <h3 class="no-num no-ref heading settled" id="normative"><span class="content">Normative References</span><a
            class="self-link" href="#normative"></a></h3>
    <dl>
        <dt id="biblio-html">[HTML]
        <dd>Anne van Kesteren; et al. <a href="https://html.spec.whatwg.org/multipage/"><cite>HTML Standard</cite></a>.
            Living Standard. URL: <a
                href="https://html.spec.whatwg.org/multipage/">https://html.spec.whatwg.org/multipage/</a>
        <dt id="biblio-infra">[INFRA]
        <dd>Anne van Kesteren; Domenic Denicola. <a href="https://infra.spec.whatwg.org/"><cite>Infra
                    Standard</cite></a>. Living Standard. URL: <a
                href="https://infra.spec.whatwg.org/">https://infra.spec.whatwg.org/</a>
        <dt id="biblio-webdriver">[WEBDRIVER]
        <dd>Simon Stewart; David Burns. <a href="https://w3c.github.io/webdriver/"><cite>WebDriver</cite></a>. URL: <a
                href="https://w3c.github.io/webdriver/">https://w3c.github.io/webdriver/</a>
        <dt id="biblio-webidl">[WEBIDL]
        <dd>Edgar Chen; Timothy Gu. <a href="https://webidl.spec.whatwg.org/"><cite>Web IDL Standard</cite></a>. Living
            Standard. URL: <a href="https://webidl.spec.whatwg.org/">https://webidl.spec.whatwg.org/</a>
    </dl>
    <h2 class="no-num no-ref heading settled" id="idl-index"><span class="content">IDL Index</span><a class="self-link"
            href="#idl-index"></a></h2>
    <pre class="idl highlight def">[<a class="idl-code" data-link-type="extended-attribute" href="https://webidl.spec.whatwg.org/#Exposed"><c- g>Exposed</c-></a>=(<c- n>Window</c->,<c- n>Worker</c->)]
<c- b>namespace</c-> <a href="#namespacedef-testutils"><code><c- g>TestUtils</c-></code></a> {
  [<a class="idl-code" data-link-type="extended-attribute" href="https://webidl.spec.whatwg.org/#NewObject"><c- g>NewObject</c-></a>] <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-promise"><c- b>Promise</c-></a>&lt;<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-undefined"><c- b>undefined</c-></a>> <a href="#dom-testutils-gc"><code><c- g>gc</c-></code></a>();
};

</pre>
    <script>/* Boilerplate: script-dom-helper */
        "use strict";
        function query(sel) { return document.querySelector(sel); }

        function queryAll(sel) { return [...document.querySelectorAll(sel)]; }

        function iter(obj) {
            if (!obj) return [];
            var it = obj[Symbol.iterator];
            if (it) return it;
            return Object.entries(obj);
        }

        function mk(tagname, attrs, ...children) {
            const el = document.createElement(tagname);
            for (const [k, v] of iter(attrs)) {
                if (k.slice(0, 3) == "_on") {
                    const eventName = k.slice(3);
                    el.addEventListener(eventName, v);
                } else if (k[0] == "_") {
                    // property, not attribute
                    el[k.slice(1)] = v;
                } else {
                    if (v === false || v == null) {
                        continue;
                    } else if (v === true) {
                        el.setAttribute(k, "");
                        continue;
                    } else {
                        el.setAttribute(k, v);
                    }
                }
            }
            append(el, children);
            return el;
        }

        /* Create shortcuts for every known HTML element */
        [
            "a",
            "abbr",
            "acronym",
            "address",
            "applet",
            "area",
            "article",
            "aside",
            "audio",
            "b",
            "base",
            "basefont",
            "bdo",
            "big",
            "blockquote",
            "body",
            "br",
            "button",
            "canvas",
            "caption",
            "center",
            "cite",
            "code",
            "col",
            "colgroup",
            "datalist",
            "dd",
            "del",
            "details",
            "dfn",
            "dialog",
            "div",
            "dl",
            "dt",
            "em",
            "embed",
            "fieldset",
            "figcaption",
            "figure",
            "font",
            "footer",
            "form",
            "frame",
            "frameset",
            "head",
            "header",
            "h1",
            "h2",
            "h3",
            "h4",
            "h5",
            "h6",
            "hr",
            "html",
            "i",
            "iframe",
            "img",
            "input",
            "ins",
            "kbd",
            "label",
            "legend",
            "li",
            "link",
            "main",
            "map",
            "mark",
            "meta",
            "meter",
            "nav",
            "nobr",
            "noscript",
            "object",
            "ol",
            "optgroup",
            "option",
            "output",
            "p",
            "param",
            "pre",
            "progress",
            "q",
            "s",
            "samp",
            "script",
            "section",
            "select",
            "small",
            "source",
            "span",
            "strike",
            "strong",
            "style",
            "sub",
            "summary",
            "sup",
            "table",
            "tbody",
            "td",
            "template",
            "textarea",
            "tfoot",
            "th",
            "thead",
            "time",
            "title",
            "tr",
            "u",
            "ul",
            "var",
            "video",
            "wbr",
            "xmp",
        ].forEach(tagname => {
            mk[tagname] = (...args) => mk(tagname, ...args);
        });

        function* nodesFromChildList(children) {
            for (const child of children.flat(Infinity)) {
                if (child instanceof Node) {
                    yield child;
                } else {
                    yield new Text(child);
                }
            }
        }
        function append(el, ...children) {
            for (const child of nodesFromChildList(children)) {
                if (el instanceof Node) el.appendChild(child);
                else el.push(child);
            }
            return el;
        }

        function insertAfter(el, ...children) {
            for (const child of nodesFromChildList(children)) {
                el.parentNode.insertBefore(child, el.nextSibling);
            }
            return el;
        }

        function clearContents(el) {
            el.innerHTML = "";
            return el;
        }

        function parseHTML(markup) {
            if (markup.toLowerCase().trim().indexOf('<!doctype') === 0) {
                const doc = document.implementation.createHTMLDocument("");
                doc.documentElement.innerHTML = markup;
                return doc;
            } else {
                const el = mk.template({});
                el.innerHTML = markup;
                return el.content;
            }
        }</script>
    <script>/* Boilerplate: script-dfn-panel */
        "use strict";
        {
            let dfnPanelData = {
                "5f90bbfb": { "dfnID": "5f90bbfb", "dfnText": "undefined", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-idl-undefined" }], "title": "4. The TestUtils Namespace" }], "url": "https://webidl.spec.whatwg.org/#idl-undefined" },
                "6339a85f": { "dfnID": "6339a85f", "dfnText": "entry realm", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-concept-entry-realm" }], "title": "4. The TestUtils Namespace" }], "url": "https://html.spec.whatwg.org/multipage/webappapis.html#concept-entry-realm" },
                "860300d4": { "dfnID": "860300d4", "dfnText": "implementation-defined", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-implementation-defined" }], "title": "4. The TestUtils Namespace" }], "url": "https://infra.spec.whatwg.org/#implementation-defined" },
                "889e932f": { "dfnID": "889e932f", "dfnText": "Exposed", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-Exposed" }], "title": "4. The TestUtils Namespace" }], "url": "https://webidl.spec.whatwg.org/#Exposed" },
                "a72449dd": { "dfnID": "a72449dd", "dfnText": "in parallel", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-in-parallel" }], "title": "4. The TestUtils Namespace" }], "url": "https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel" },
                "bdbd19d1": { "dfnID": "bdbd19d1", "dfnText": "Promise", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-idl-promise" }], "title": "4. The TestUtils Namespace" }], "url": "https://webidl.spec.whatwg.org/#idl-promise" },
                "c807e273": { "dfnID": "c807e273", "dfnText": "NewObject", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-NewObject" }], "title": "4. The TestUtils Namespace" }], "url": "https://webidl.spec.whatwg.org/#NewObject" },
                "dom-testutils-gc": { "dfnID": "dom-testutils-gc", "dfnText": "gc", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-dom-testutils-gc" }], "title": "4. The TestUtils Namespace" }], "url": "#dom-testutils-gc" },
                "namespacedef-testutils": { "dfnID": "namespacedef-testutils", "dfnText": "TestUtils", "external": false, "refSections": [], "url": "#namespacedef-testutils" },
            };

            document.addEventListener("DOMContentLoaded", () => {
                genAllDfnPanels();

                document.body.addEventListener("click", (e) => {
                    // If not handled already, just hide all dfn panels.
                    hideAllDfnPanels();
                });
            });

            window.addEventListener("resize", () => {
                // Pin any visible dfn panel
                queryAll(".dfn-panel.on, .dfn-panel.activated").forEach(el => positionDfnPanel(el));
            });

            function genAllDfnPanels() {
                for (const panelData of Object.values(dfnPanelData)) {
                    const dfnID = panelData.dfnID;
                    const dfn = document.getElementById(dfnID);
                    if (!dfn) {
                        console.log(`Can't find dfn#${dfnID}.`, panelData);
                        continue;
                    }
                    dfn.panelData = panelData;
                    insertDfnPopupAction(dfn);
                }
            }

            function genDfnPanel(dfn, { dfnID, url, dfnText, refSections, external }) {
                const dfnPanel = mk.aside({
                    class: "dfn-panel on",
                    id: `infopanel-for-${dfnID}`,
                    "data-for": dfnID,
                    "aria-labelled-by": `infopaneltitle-for-${dfnID}`,
                },
                    mk.span({ id: `infopaneltitle-for-${dfnID}`, style: "display:none" },
                        `Info about the '${dfnText}' ${external ? "external" : ""} reference.`),
                    mk.a({ href: url, class: "dfn-link" }, url),
                    refSections.length == 0 ? [] :
                        mk.b({}, "Referenced in:"),
                    mk.ul({},
                        ...refSections.map(section =>
                            mk.li({},
                                ...section.refs.map((ref, refI) =>
                                    [
                                        mk.a({ href: `#${ref.id}` },
                                            (refI == 0) ? section.title : `(${refI + 1})`
                                        ),
                                        " ",
                                    ]
                                ),
                            ),
                        ),
                    ),
                    genLinkingSyntaxes(dfn),
                );

                dfnPanel.addEventListener('click', (event) => {
                    if (event.target.nodeName == 'A') {
                        scrollToTargetAndHighlight(event);
                        pinDfnPanel(dfnPanel);
                    }
                    event.stopPropagation();
                    refocusOnTarget(event);
                });
                dfnPanel.addEventListener('keydown', (event) => {
                    if (event.keyCode == 27) { // Escape key
                        hideDfnPanel({ dfnPanel });
                        event.stopPropagation();
                        event.preventDefault();
                    }
                });

                dfnPanel.dfn = dfn;
                dfn.dfnPanel = dfnPanel;
                return dfnPanel;
            }



            function hideAllDfnPanels() {
                // Delete the currently-active dfn panel.
                queryAll(".dfn-panel").forEach(dfnPanel => hideDfnPanel({ dfnPanel }));
            }

            function showDfnPanel(dfn) {
                hideAllDfnPanels(); // Only display one at a time.

                dfn.setAttribute("aria-expanded", "true");

                const dfnPanel = genDfnPanel(dfn, dfn.panelData);

                // Give the dfn a unique tabindex, and then
                // give all the tabbable panel bits successive indexes.
                let tabIndex = 100;
                dfn.tabIndex = tabIndex++;
                const tabbable = dfnPanel.querySelectorAll(":is(a, button)");
                for (const el of tabbable) {
                    el.tabIndex = tabIndex++;
                }

                append(document.body, dfnPanel);
                positionDfnPanel(dfnPanel);
            }

            function positionDfnPanel(dfnPanel) {
                const dfn = dfnPanel.dfn;
                const dfnPos = getBounds(dfn);
                dfnPanel.style.top = dfnPos.bottom + "px";
                dfnPanel.style.left = dfnPos.left + "px";

                const panelPos = dfnPanel.getBoundingClientRect();
                const panelMargin = 8;
                const maxRight = document.body.parentNode.clientWidth - panelMargin;
                if (panelPos.right > maxRight) {
                    const overflowAmount = panelPos.right - maxRight;
                    const newLeft = Math.max(panelMargin, dfnPos.left - overflowAmount);
                    dfnPanel.style.left = newLeft + "px";
                }
            }

            function pinDfnPanel(dfnPanel) {
                // Switch it to "activated" state, which pins it.
                dfnPanel.classList.add("activated");
                dfnPanel.style.position = "fixed";
                dfnPanel.style.left = null;
                dfnPanel.style.top = null;
            }

            function hideDfnPanel({ dfn, dfnPanel }) {
                if (!dfnPanel) dfnPanel = dfn.dfnPanel;
                if (!dfn) dfn = dfnPanel.dfn;
                dfn.dfnPanel = undefined;
                dfnPanel.dfn = undefined;
                dfn.setAttribute("aria-expanded", "false");
                dfn.tabIndex = undefined;
                dfnPanel.remove()
            }

            function toggleDfnPanel(dfn) {
                if (dfn.dfnPanel) {
                    hideDfnPanel(dfn);
                } else {
                    showDfnPanel(dfn);
                }
            }

            function insertDfnPopupAction(dfn) {
                dfn.setAttribute('role', 'button');
                dfn.setAttribute('aria-expanded', 'false')
                dfn.tabIndex = 0;
                dfn.classList.add('has-dfn-panel');
                dfn.addEventListener('click', (event) => {
                    toggleDfnPanel(dfn);
                    event.stopPropagation();
                });
                dfn.addEventListener('keypress', (event) => {
                    const kc = event.keyCode;
                    // 32->Space, 13->Enter
                    if (kc == 32 || kc == 13) {
                        toggleDfnPanel(dfn);
                        event.stopPropagation();
                        event.preventDefault();
                    }
                });
            }

            function refocusOnTarget(event) {
                const target = event.target;
                setTimeout(() => {
                    // Refocus on the event.target element.
                    // This is needed after browser scrolls to the destination.
                    target.focus();
                });
            }

            // TODO: shared util
            // Returns the root-level absolute position {left and top} of element.
            function getBounds(el, relativeTo = document.body) {
                const relativeRect = relativeTo.getBoundingClientRect();
                const elRect = el.getBoundingClientRect();
                const top = elRect.top - relativeRect.top;
                const left = elRect.left - relativeRect.left;
                return {
                    top,
                    left,
                    bottom: top + elRect.height,
                    right: left + elRect.width,
                }
            }

            function scrollToTargetAndHighlight(event) {
                let hash = event.target.hash;
                if (hash) {
                    hash = decodeURIComponent(hash.substring(1));
                    const dest = document.getElementById(hash);
                    if (dest) {
                        dest.classList.add('highlighted');
                        setTimeout(() => dest.classList.remove('highlighted'), 1000);
                    }
                }
            }

            // Functions, divided by link type, that wrap an autolink's
            // contents with the appropriate outer syntax.
            // Alternately, a string naming another type they format
            // the same as.
            function needsFor(type) {
                switch (type) {
                    case "descriptor":
                    case "value":
                    case "element-attr":
                    case "attr-value":
                    case "element-state":
                    case "method":
                    case "constructor":
                    case "argument":
                    case "attribute":
                    case "const":
                    case "dict-member":
                    case "event":
                    case "enum-value":
                    case "stringifier":
                    case "serializer":
                    case "iterator":
                    case "maplike":
                    case "setlike":
                    case "state":
                    case "mode":
                    case "context":
                    case "facet": return true;

                    default: return false;
                }
            }
            function refusesFor(type) {
                switch (type) {
                    case "property":
                    case "element":
                    case "interface":
                    case "namespace":
                    case "callback":
                    case "dictionary":
                    case "enum":
                    case "exception":
                    case "typedef":
                    case "http-header":
                    case "permission": return true;

                    default: return false;
                }
            }
            function linkFormatterFromType(type) {
                switch (type) {
                    case 'scheme':
                    case 'permission':
                    case 'dfn': return (text) => `[=${text}=]`;

                    case 'abstract-op': return (text) => `[\$${text}\$]`;

                    case 'function':
                    case 'at-rule':
                    case 'selector':
                    case 'value': return (text) => `''${text}''`;

                    case 'http-header': return (text) => `[:${text}:]`;

                    case 'interface':
                    case 'constructor':
                    case 'method':
                    case 'argument':
                    case 'attribute':
                    case 'callback':
                    case 'dictionary':
                    case 'dict-member':
                    case 'enum':
                    case 'enum-value':
                    case 'exception':
                    case 'const':
                    case 'typedef':
                    case 'stringifier':
                    case 'serializer':
                    case 'iterator':
                    case 'maplike':
                    case 'setlike':
                    case 'extended-attribute':
                    case 'event':
                    case 'idl': return (text) => `{{${text}}}`;

                    case 'element-state':
                    case 'element-attr':
                    case 'attr-value':
                    case 'element': return (element) => `<{${element}}>`;

                    case 'grammar': return (text) => `${text} (within a <pre class=prod>)`;

                    case 'type': return (text) => `<<${text}>>`;

                    case 'descriptor':
                    case 'property': return (text) => `'${text}'`;

                    default: return;
                };
            };

            function genLinkingSyntaxes(dfn) {
                if (dfn.tagName != "DFN") return;

                const type = dfn.getAttribute('data-dfn-type');
                if (!type) {
                    console.log(`<dfn> doesn't have a data-dfn-type:`, dfn);
                    return [];
                }

                // Return a function that wraps link text based on the type
                const linkFormatter = linkFormatterFromType(type);
                if (!linkFormatter) {
                    console.log(`<dfn> has an unknown data-dfn-type:`, dfn);
                    return [];
                }

                let ltAlts;
                if (dfn.hasAttribute('data-lt')) {
                    ltAlts = dfn.getAttribute('data-lt')
                        .split("|")
                        .map(x => x.trim());
                } else {
                    ltAlts = [dfn.textContent.trim()];
                }
                if (type == "type") {
                    // lt of "<foo>", but "foo" is the interior;
                    // <<foo/bar>> is how you write it with a for,
                    // not <foo/<bar>> or whatever.
                    for (var i = 0; i < ltAlts.length; i++) {
                        const lt = ltAlts[i];
                        const match = /<(.*)>/.exec(lt);
                        if (match) { ltAlts[i] = match[1]; }
                    }
                }

                let forAlts;
                if (dfn.hasAttribute('data-dfn-for')) {
                    forAlts = dfn.getAttribute('data-dfn-for')
                        .split(",")
                        .map(x => x.trim());
                } else {
                    forAlts = [''];
                }

                let linkingSyntaxes = [];
                if (!needsFor(type)) {
                    for (const lt of ltAlts) {
                        linkingSyntaxes.push(linkFormatter(lt));
                    }
                }
                if (!refusesFor(type)) {
                    for (const f of forAlts) {
                        linkingSyntaxes.push(linkFormatter(`${f}/${ltAlts[0]}`))
                    }
                }
                return [
                    mk.b({}, 'Possible linking syntaxes:'),
                    mk.ul({},
                        ...linkingSyntaxes.map(link => {
                            const copyLink = async () =>
                                await navigator.clipboard.writeText(link);
                            return mk.li({},
                                mk.div({ class: 'link-item' },
                                    mk.button({
                                        class: 'copy-icon', title: 'Copy',
                                        type: 'button',
                                        _onclick: copyLink,
                                        tabindex: 0,
                                    }, mk.span({ class: 'icon' })),
                                    mk.span({}, link)
                                )
                            );
                        })
                    )
                ];
            }
        }
    </script>
    <script>/* Boilerplate: script-ref-hints */
        "use strict";
        {
            let refsData = {
                "#dom-testutils-gc": { "displayText": "gc()", "export": true, "for_": ["TestUtils"], "level": "", "normative": true, "shortname": "testutils", "spec": "testutils", "status": "local", "text": "gc()", "type": "method", "url": "#dom-testutils-gc" },
                "https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel": { "displayText": "in parallel", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "html", "spec": "html", "status": "current", "text": "in parallel", "type": "dfn", "url": "https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel" },
                "https://html.spec.whatwg.org/multipage/webappapis.html#concept-entry-realm": { "displayText": "entry realm", "export": false, "for_": [], "level": "1", "normative": true, "shortname": "html", "spec": "html", "status": "current", "text": "entry realm", "type": "dfn", "url": "https://html.spec.whatwg.org/multipage/webappapis.html#concept-entry-realm" },
                "https://infra.spec.whatwg.org/#implementation-defined": { "displayText": "implementation-defined", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "infra", "spec": "infra", "status": "current", "text": "implementation-defined", "type": "dfn", "url": "https://infra.spec.whatwg.org/#implementation-defined" },
                "https://webidl.spec.whatwg.org/#Exposed": { "displayText": "Exposed", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "webidl", "spec": "webidl", "status": "current", "text": "Exposed", "type": "extended-attribute", "url": "https://webidl.spec.whatwg.org/#Exposed" },
                "https://webidl.spec.whatwg.org/#NewObject": { "displayText": "NewObject", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "webidl", "spec": "webidl", "status": "current", "text": "NewObject", "type": "extended-attribute", "url": "https://webidl.spec.whatwg.org/#NewObject" },
                "https://webidl.spec.whatwg.org/#idl-promise": { "displayText": "Promise", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "webidl", "spec": "webidl", "status": "current", "text": "Promise", "type": "interface", "url": "https://webidl.spec.whatwg.org/#idl-promise" },
                "https://webidl.spec.whatwg.org/#idl-undefined": { "displayText": "undefined", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "webidl", "spec": "webidl", "status": "current", "text": "undefined", "type": "interface", "url": "https://webidl.spec.whatwg.org/#idl-undefined" },
            };

            function mkRefHint(link, ref) {
                const linkText = link.textContent;
                let dfnTextElements = '';
                if (ref.displayText.toLowerCase() != linkText.toLowerCase()) {
                    // Give the original term if it's being displayed in a different way.
                    // But allow casing differences, they're insignificant.
                    dfnTextElements =
                        mk.li({},
                            mk.b({}, "Term: "),
                            mk.span({}, ref.displayText)
                        );
                }
                const forList = ref.for_;
                let forListElements;
                if (forList.length == 0) {
                    forListElements = [];
                } else if (forList.length == 1) {
                    forListElements = mk.li({},
                        mk.b({}, "For: "),
                        mk.span({}, forList[0]),
                    );
                } else {
                    forListElements = mk.li({},
                        mk.b({}, "For: "),
                        mk.ul({},
                            ...forList.map(forItem =>
                                mk.li({},
                                    mk.span({}, forItem)
                                ),
                            ),
                        ),
                    );
                }
                const url = ref.url;
                const safeUrl = encodeURIComponent(url);
                const hintPanel = mk.aside({
                    class: "ref-hint",
                    id: `ref-hint-for-${safeUrl}`,
                    "data-for": url,
                    "aria-labelled-by": `ref-hint-for-${safeUrl}`,
                },
                    mk.ul({},
                        dfnTextElements,
                        mk.li({},
                            mk.b({}, "URL: "),
                            mk.a({ href: url, class: "ref" }, url),
                        ),
                        mk.li({},
                            mk.b({}, "Type: "),
                            mk.span({}, `${ref.type}`),
                        ),
                        mk.li({},
                            mk.b({}, "Spec: "),
                            mk.span({}, `${ref.spec ? ref.spec : ''}`),
                        ),
                        forListElements
                    ),
                );
                hintPanel.forLink = link;
                setupRefHintEventListeners(link, hintPanel);
                return hintPanel;
            }

            function hideAllRefHints() {
                queryAll(".ref-hint").forEach(el => hideRefHint(el));
            }

            function hideRefHint(refHint) {
                const link = refHint.forLink;
                link.setAttribute("aria-expanded", "false");
                if (refHint.teardownEventListeners) {
                    refHint.teardownEventListeners();
                }
                refHint.remove();
            }

            function showRefHint(link) {
                if (link.classList.contains("dfn-link")) return;
                const url = link.getAttribute("href");
                const refHintKey = link.getAttribute("data-refhint-key");
                let key = url;
                if (refHintKey) {
                    key = refHintKey + "_" + url;
                }
                const ref = refsData[key];
                if (!ref) return;

                hideAllRefHints(); // Only display one at this time.

                const refHint = mkRefHint(link, ref);
                append(document.body, refHint);
                link.setAttribute("aria-expanded", "true");
                positionRefHint(refHint);
            }

            function setupRefHintEventListeners(link, refHint) {
                if (refHint.teardownEventListeners) return;
                // Add event handlers to hide the refHint after the user moves away
                // from both the link and refHint, if not hovering either within one second.
                let timeout = null;
                const startHidingRefHint = (event) => {
                    if (timeout) {
                        clearTimeout(timeout);
                    }
                    timeout = setTimeout(() => {
                        hideRefHint(refHint);
                    }, 1000);
                }
                const resetHidingRefHint = (event) => {
                    if (timeout) clearTimeout(timeout);
                    timeout = null;
                };
                link.addEventListener("mouseleave", startHidingRefHint);
                link.addEventListener("mouseenter", resetHidingRefHint);
                link.addEventListener("blur", startHidingRefHint);
                link.addEventListener("focus", resetHidingRefHint);
                refHint.addEventListener("mouseleave", startHidingRefHint);
                refHint.addEventListener("mouseenter", resetHidingRefHint);
                refHint.addEventListener("blur", startHidingRefHint);
                refHint.addEventListener("focus", resetHidingRefHint);

                refHint.teardownEventListeners = () => {
                    // remove event listeners
                    resetHidingRefHint();
                    link.removeEventListener("mouseleave", startHidingRefHint);
                    link.removeEventListener("mouseenter", resetHidingRefHint);
                    link.removeEventListener("blur", startHidingRefHint);
                    link.removeEventListener("focus", resetHidingRefHint);
                    refHint.removeEventListener("mouseleave", startHidingRefHint);
                    refHint.removeEventListener("mouseenter", resetHidingRefHint);
                    refHint.removeEventListener("blur", startHidingRefHint);
                    refHint.removeEventListener("focus", resetHidingRefHint);
                };
            }

            function positionRefHint(refHint) {
                const link = refHint.forLink;
                const linkPos = getBounds(link);
                refHint.style.top = linkPos.bottom + "px";
                refHint.style.left = linkPos.left + "px";

                const panelPos = refHint.getBoundingClientRect();
                const panelMargin = 8;
                const maxRight = document.body.parentNode.clientWidth - panelMargin;
                if (panelPos.right > maxRight) {
                    const overflowAmount = panelPos.right - maxRight;
                    const newLeft = Math.max(panelMargin, linkPos.left - overflowAmount);
                    refHint.style.left = newLeft + "px";
                }
            }

            // TODO: shared util
            // Returns the root-level absolute position {left and top} of element.
            function getBounds(el, relativeTo = document.body) {
                const relativeRect = relativeTo.getBoundingClientRect();
                const elRect = el.getBoundingClientRect();
                const top = elRect.top - relativeRect.top;
                const left = elRect.left - relativeRect.left;
                return {
                    top,
                    left,
                    bottom: top + elRect.height,
                    right: left + elRect.width,
                }
            }

            function showRefHintListener(e) {
                // If the target isn't in a link (or is a link),
                // just ignore it.
                let link = e.target.closest("a");
                if (!link) return;

                // If the target is in a ref-hint panel
                // (aka a link in the already-open one),
                // also just ignore it.
                if (link.closest(".ref-hint")) return;

                // Otherwise, show the panel for the link.
                showRefHint(link);
            }

            function hideAllHintsListener(e) {
                // If the click is inside a ref-hint panel, ignore it.
                if (e.target.closest(".ref-hint")) return;
                // Otherwise, close all the current panels.
                hideAllRefHints();
            }

            document.addEventListener("DOMContentLoaded", () => {
                document.body.addEventListener("mousedown", showRefHintListener);
                document.body.addEventListener("focus", showRefHintListener);

                document.body.addEventListener("click", hideAllHintsListener);
            });

            window.addEventListener("resize", () => {
                // Hide any open ref hint.
                hideAllRefHints();
            });
        }
    </script>