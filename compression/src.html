<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
    <meta content="#3c790a" name="theme-color">
    <meta content="light dark" name="color-scheme">
    <title>Compression Standard</title>
    <link crossorigin href="https://resources.whatwg.org/standard-shared-with-dev.css" rel="stylesheet">
    <link crossorigin href="https://resources.whatwg.org/standard.css" rel="stylesheet">
    <link crossorigin href="https://resources.whatwg.org/spec.css" rel="stylesheet">
    <link crossorigin href="https://resources.whatwg.org/logo-compression.svg" rel="icon">
    <script crossorigin defer src="https://resources.whatwg.org/commit-snapshot-shortcut-key.js"></script>
    <meta content="Bikeshed version cca139221, updated Tue Nov 4 20:24:37 2025 +0000" name="generator">
    <meta content="a4979583b8673bbc2fcf30a86767abf61e50ee26" name="revision">
    <style>
        /* Boilerplate: style-dfn-panel */
        :root {
            --dfnpanel-bg: #ddd;
            --dfnpanel-text: var(--text);
            --dfnpanel-target-bg: #ffc;
            --dfnpanel-target-outline: orange;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --dfnpanel-bg: #222;
                --dfnpanel-text: var(--text);
                --dfnpanel-target-bg: #333;
                --dfnpanel-target-outline: silver;
            }
        }

        .dfn-panel {
            position: absolute;
            z-index: 35;
            width: 20em;
            width: 300px;
            height: auto;
            max-height: 500px;
            overflow: auto;
            padding: 0.5em 0.75em;
            font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
            background: var(--dfnpanel-bg);
            color: var(--dfnpanel-text);
            border: outset 0.2em;
            white-space: normal;
            /* in case it's moved into a pre */
        }

        .dfn-panel:not(.on) {
            display: none;
        }

        .dfn-panel * {
            margin: 0;
            padding: 0;
            text-indent: 0;
        }

        .dfn-panel>b {
            display: block;
        }

        .dfn-panel a {
            color: var(--dfnpanel-text);
        }

        .dfn-panel a:not(:hover) {
            text-decoration: none !important;
            border-bottom: none !important;
        }

        .dfn-panel a:focus {
            outline: 5px auto Highlight;
            outline: 5px auto -webkit-focus-ring-color;
        }

        .dfn-panel>b+b {
            margin-top: 0.25em;
        }

        .dfn-panel ul {
            padding: 0 0 0 1em;
            list-style: none;
        }

        .dfn-panel li a {
            max-width: calc(300px - 1.5em - 1em);
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .dfn-panel.activated {
            display: inline-block;
            position: fixed;
            left: 8px;
            bottom: 2em;
            margin: 0 auto;
            max-width: calc(100vw - 1.5em - .4em - .5em);
            max-height: 30vh;
            transition: left 1s ease-out, bottom 1s ease-out;
        }

        .dfn-panel .link-item:hover {
            text-decoration: underline;
        }

        .dfn-panel .link-item .copy-icon {
            opacity: 0;
        }

        .dfn-panel .link-item:hover .copy-icon,
        .dfn-panel .link-item .copy-icon:focus {
            opacity: 1;
        }

        .dfn-panel .copy-icon {
            display: inline-block;
            margin-right: 0.5em;
            width: 0.85em;
            height: 1em;
            border-radius: 3px;
            background-color: #ccc;
            cursor: pointer;
        }

        .dfn-panel .copy-icon .icon {
            width: 100%;
            height: 100%;
            background-color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .dfn-panel .copy-icon .icon::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 1px solid black;
            background-color: #ccc;
            opacity: 0.25;
            transform: translate(3px, -3px);
        }

        .dfn-panel .copy-icon:active .icon::before {
            opacity: 1;
        }

        .dfn-paneled[role="button"] {
            cursor: help;
        }

        .highlighted {
            animation: target-fade 3s;
        }

        @keyframes target-fade {
            from {
                background-color: var(--dfnpanel-target-bg);
                outline: 5px solid var(--dfnpanel-target-outline);
            }

            to {
                color: var(--a-normal-text);
                background-color: transparent;
                outline: transparent;
            }
        }
    </style>
    <style>
        /* Boilerplate: style-mdn-anno */
        :root {
            --mdn-bg: #EEE;
            --mdn-shadow: #999;
            --mdn-nosupport-text: #ccc;
            --mdn-pass: green;
            --mdn-fail: red;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --mdn-bg: #222;
                --mdn-shadow: #444;
                --mdn-nosupport-text: #666;
                --mdn-pass: #690;
                --mdn-fail: #d22;
            }
        }

        .mdn-anno {
            background: var(--mdn-bg, #EEE);
            border-radius: .25em;
            box-shadow: 0 0 3px var(--mdn-shadow, #999);
            color: var(--text, black);
            font: 1em sans-serif;
            hyphens: none;
            max-width: min-content;
            overflow: hidden;
            padding: 0.2em;
            position: absolute;
            right: 0.3em;
            top: auto;
            white-space: nowrap;
            word-wrap: normal;
            z-index: 8;
        }

        .mdn-anno.unpositioned {
            display: none;
        }

        .mdn-anno.overlapping-main {
            opacity: .2;
            transition: opacity .1s;
        }

        .mdn-anno[open] {
            opacity: 1;
            z-index: 9;
            min-width: 9em;
        }

        .mdn-anno:hover {
            opacity: 1;
            outline: var(--text, black) 1px solid;
        }

        .mdn-anno>summary {
            font-weight: normal;
            text-align: right;
            cursor: pointer;
            display: block;
        }

        .mdn-anno>summary>.less-than-two-engines-flag {
            color: var(--mdn-fail);
            padding-right: 2px;
        }

        .mdn-anno>summary>.all-engines-flag {
            color: var(--mdn-pass);
            padding-right: 2px;
        }

        .mdn-anno>summary>span {
            color: #fff;
            background-color: #000;
            font-weight: normal;
            font-family: zillaslab, Palatino, "Palatino Linotype", serif;
            padding: 2px 3px 0px 3px;
            line-height: 1.3em;
            vertical-align: top;
        }

        .mdn-anno>.feature {
            margin-top: 20px;
        }

        .mdn-anno>.feature:not(:first-of-type) {
            border-top: 1px solid #999;
            margin-top: 6px;
            padding-top: 2px;
        }

        .mdn-anno>.feature>.less-than-two-engines-text {
            color: var(--mdn-fail);
        }

        .mdn-anno>.feature>.all-engines-text {
            color: var(--mdn-pass);
        }

        .mdn-anno>.feature>p {
            font-size: .75em;
            margin-top: 6px;
            margin-bottom: 0;
        }

        .mdn-anno>.feature>p+p {
            margin-top: 3px;
        }

        .mdn-anno>.feature>.support {
            display: block;
            font-size: 0.6em;
            margin: 0;
            padding: 0;
            margin-top: 2px;
        }

        .mdn-anno>.feature>.support+div {
            padding-top: 0.5em;
        }

        .mdn-anno>.feature>.support>hr {
            display: block;
            border: none;
            border-top: 1px dotted #999;
            padding: 3px 0px 0px 0px;
            margin: 2px 3px 0px 3px;
        }

        .mdn-anno>.feature>.support>hr::before {
            content: "";
        }

        .mdn-anno>.feature>.support>span {
            padding: 0.2em 0;
            display: block;
            display: table;
        }

        .mdn-anno>.feature>.support>span.no {
            color: var(--mdn-nosupport-text);
            filter: grayscale(100%);
        }

        .mdn-anno>.feature>.support>span.no::before {
            opacity: 0.5;
        }

        .mdn-anno>.feature>.support>span:first-of-type {
            padding-top: 0.5em;
        }

        .mdn-anno>.feature>.support>span>span {
            padding: 0 0.5em;
            display: table-cell;
        }

        .mdn-anno>.feature>.support>span>span:first-child {
            width: 100%;
        }

        .mdn-anno>.feature>.support>span>span:last-child {
            width: 100%;
            white-space: pre;
            padding: 0;
        }

        .mdn-anno>.feature>.support>span::before {
            content: ' ';
            display: table-cell;
            min-width: 1.5em;
            height: 1.5em;
            background: no-repeat center center;
            background-size: contain;
            text-align: right;
            font-size: 0.75em;
            font-weight: bold;
        }

        .mdn-anno>.feature>.support>.chrome_android::before {
            background-image: url(https://resources.whatwg.org/browser-logos/chrome.svg);
        }

        .mdn-anno>.feature>.support>.firefox_android::before {
            background-image: url(https://resources.whatwg.org/browser-logos/firefox.png);
        }

        .mdn-anno>.feature>.support>.chrome::before {
            background-image: url(https://resources.whatwg.org/browser-logos/chrome.svg);
        }

        .mdn-anno>.feature>.support>.edge_blink::before {
            background-image: url(https://resources.whatwg.org/browser-logos/edge.svg);
        }

        .mdn-anno>.feature>.support>.edge::before {
            background-image: url(https://resources.whatwg.org/browser-logos/edge_legacy.svg);
        }

        .mdn-anno>.feature>.support>.firefox::before {
            background-image: url(https://resources.whatwg.org/browser-logos/firefox.png);
        }

        .mdn-anno>.feature>.support>.ie::before {
            background-image: url(https://resources.whatwg.org/browser-logos/ie.png);
        }

        .mdn-anno>.feature>.support>.safari_ios::before {
            background-image: url(https://resources.whatwg.org/browser-logos/safari-ios.svg);
        }

        .mdn-anno>.feature>.support>.nodejs::before {
            background-image: url(https://nodejs.org/favicon.ico);
        }

        .mdn-anno>.feature>.support>.opera_android::before {
            background-image: url(https://resources.whatwg.org/browser-logos/opera.svg);
        }

        .mdn-anno>.feature>.support>.opera::before {
            background-image: url(https://resources.whatwg.org/browser-logos/opera.svg);
        }

        .mdn-anno>.feature>.support>.safari::before {
            background-image: url(https://resources.whatwg.org/browser-logos/safari.png);
        }

        .mdn-anno>.feature>.support>.samsunginternet_android::before {
            background-image: url(https://resources.whatwg.org/browser-logos/samsung.svg);
        }

        .mdn-anno>.feature>.support>.webview_android::before {
            background-image: url(https://resources.whatwg.org/browser-logos/android-webview.png);
        }

        .name-slug-mismatch {
            color: red;
        }

        .caniuse-status:hover {
            z-index: 9;
        }

        /* dt, li, .issue, .note, and .example are "position: relative", so to put annotation at right margin, must move to right of containing block */
        ;

        .h-entry:not(.status-LS) dt>.mdn-anno,
        .h-entry:not(.status-LS) li>.mdn-anno,
        .h-entry:not(.status-LS) .issue>.mdn-anno,
        .h-entry:not(.status-LS) .note>.mdn-anno,
        .h-entry:not(.status-LS) .example>.mdn-anno {
            right: -6.7em;
        }

        .h-entry p+.mdn-anno {
            margin-top: 0;
        }

        h2+.mdn-anno.after {
            margin: -48px 0 0 0;
        }

        h3+.mdn-anno.after {
            margin: -46px 0 0 0;
        }

        h4+.mdn-anno.after {
            margin: -42px 0 0 0;
        }

        h5+.mdn-anno.after {
            margin: -40px 0 0 0;
        }

        h6+.mdn-anno.after {
            margin: -40px 0 0 0;
        }
    </style>
    <style>
        /* Boilerplate: style-ref-hints */
        :root {
            --ref-hint-bg: #ddd;
            --ref-hint-text: var(--text);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --ref-hint-bg: #222;
                --ref-hint-text: var(--text);
            }
        }

        .ref-hint {
            display: inline-block;
            position: absolute;
            z-index: 35;
            width: 20em;
            width: 300px;
            height: auto;
            max-height: 500px;
            overflow: auto;
            padding: 0.5em 0.5em;
            font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
            background: var(--ref-hint-bg);
            color: var(--ref-hint-text);
            border: outset 0.2em;
            white-space: normal;
            /* in case it's moved into a pre */
        }

        .ref-hint * {
            margin: 0;
            padding: 0;
            text-indent: 0;
        }

        .ref-hint ul {
            padding: 0 0 0 1em;
            list-style: none;
        }
    </style>

<body class="h-entry status-LS">
    <div class="head">

        <a class="logo" href="https://whatwg.org/">
            <img alt="WHATWG" class="darkmode-aware" crossorigin height="100"
                src="https://resources.whatwg.org/logo-compression.svg">
        </a>

        <hgroup>
            <h1 class="no-ref p-name" id="title">Compression</h1>
            <p id="subtitle">Living Standard — Last Updated <time class="dt-updated" datetime="2025-11-05">5 November
                    2025</time>
            </p>
        </hgroup>
        <div data-fill-with="spec-metadata">
            <dl>
                <dt>Participate:
                <dd><a href="https://github.com/whatwg/compression">GitHub whatwg/compression</a> (<a
                        href="https://github.com/whatwg/compression/issues/new/choose">new issue</a>, <a
                        href="https://github.com/whatwg/compression/issues">open issues</a>)
                <dd><a href="https://whatwg.org/chat">Chat on Matrix</a>
                <dt>Commits:
                <dd><a href="https://github.com/whatwg/compression/commits">GitHub whatwg/compression/commits</a>
                <dd><a href="/commit-snapshots/a4979583b8673bbc2fcf30a86767abf61e50ee26/"
                        id="commit-snapshot-link">Snapshot as of this commit</a>
                <dd><a href="https://twitter.com/compressionapi">@compressionapi</a>
                <dt>Tests:
                <dd><a href="https://github.com/web-platform-tests/wpt/tree/master/compression">web-platform-tests
                        compression/</a> (<a href="https://github.com/web-platform-tests/wpt/labels/compression">ongoing
                        work</a>)
                <dt>Translations <small>(non-normative)</small>:
                <dd><span title="Simplified Chinese"><a href="https://htmlspecs.com/compression/" hreflang="zh-hans"
                            lang="zh-hans" rel="alternate">简体中文</a></span>
                <dd><span title="Japanese"><a href="https://jp.htmlspecs.com/compression/" hreflang="ja" lang="ja"
                            rel="alternate">日本語</a></span>
                <dd><span title="Korean"><a href="https://ko.htmlspecs.com/compression/" hreflang="ko" lang="ko"
                            rel="alternate">한국어</a></span>
            </dl>
        </div>
        <div data-fill-with="warning"></div>
    </div>
    <div class="p-summary" data-fill-with="abstract">
        <h2 class="heading no-num no-ref no-toc settled" id="abstract"><span class="content">Abstract</span></h2>
        <p>This document defines a set of JavaScript APIs to compress and decompress streams of binary data.</p>
    </div>
    <nav data-fill-with="table-of-contents" id="toc">
        <h2 class="no-num no-ref no-toc" id="contents">Table of Contents</h2>
        <ol class="toc" role="directory">
            <li><a href="#introduction"><span class="secno">1</span> <span class="content">Introduction</span></a>
            <li><a href="#infrastructure"><span class="secno">2</span> <span class="content">Infrastructure</span></a>
            <li><a href="#supported-formats"><span class="secno">3</span> <span class="content">Supported
                        formats</span></a>
            <li><a href="#compression-stream"><span class="secno">4</span> <span class="content">Interface
                        <code>CompressionStream</code></span></a>
            <li><a href="#decompression-stream"><span class="secno">5</span> <span class="content">Interface
                        <code>DecompressionStream</code></span></a>
            <li><a href="#privacy-security"><span class="secno">6</span> <span class="content">Privacy and security
                        considerations</span></a>
            <li>
                <a href="#examples"><span class="secno">7</span> <span class="content">Examples</span></a>
                <ol class="toc">
                    <li><a href="#example-gzip-compress-stream"><span class="secno">7.1</span> <span
                                class="content">Gzip-compress a stream</span></a>
                    <li><a href="#example-deflate-compress"><span class="secno">7.2</span> <span
                                class="content">Deflate-compress an ArrayBuffer to a Uint8Array</span></a>
                    <li><a href="#example-gzip-decompress"><span class="secno">7.3</span> <span
                                class="content">Gzip-decompress a Blob to Blob</span></a>
                </ol>
            <li><a href="#acknowledgments"><span class="secno"></span> <span class="content">Acknowledgments</span></a>
            <li><a href="#ipr"><span class="secno"></span> <span class="content">Intellectual property rights</span></a>
            <li>
                <a href="#index"><span class="secno"></span> <span class="content">Index</span></a>
                <ol class="toc">
                    <li><a href="#index-defined-here"><span class="secno"></span> <span class="content">Terms defined by
                                this specification</span></a>
                    <li><a href="#index-defined-elsewhere"><span class="secno"></span> <span class="content">Terms
                                defined by reference</span></a>
                </ol>
            <li>
                <a href="#references"><span class="secno"></span> <span class="content">References</span></a>
                <ol class="toc">
                    <li><a href="#normative"><span class="secno"></span> <span class="content">Normative
                                References</span></a>
                    <li><a href="#informative"><span class="secno"></span> <span class="content">Informative
                                References</span></a>
                </ol>
            <li><a href="#idl-index"><span class="secno"></span> <span class="content">IDL Index</span></a>
        </ol>
    </nav>
    <main>
        <h2 class="heading settled" data-level="1" id="introduction"><span class="secno">1. </span><span
                class="content">Introduction</span><a class="self-link" href="#introduction"></a></h2>
        <p><em>This section is non-normative.</em></p>
        <p>The APIs specified in this specification are used to compress and decompress streams of data. They support
            "deflate", "deflate-raw" and "gzip" as compression algorithms. They are widely used by web developers.</p>
        <h2 class="heading settled" data-level="2" id="infrastructure"><span class="secno">2. </span><span
                class="content">Infrastructure</span><a class="self-link" href="#infrastructure"></a></h2>
        <p>This specification depends on <cite>Infra</cite>. <a data-link-type="biblio" href="#biblio-infra"
                title="Infra Standard">[INFRA]</a></p>
        <p>A chunk is a piece of data. In the case of CompressionStream and DecompressionStream, the output chunk type
            is Uint8Array. They accept any <code
                class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#BufferSource" id="ref-for-BufferSource">BufferSource</a></code>
            type as input.</p>
        <p>A stream represents an ordered sequence of chunks. The terms <code
                class="idl"><a data-link-type="idl" href="https://streams.spec.whatwg.org/#readablestream" id="ref-for-readablestream">ReadableStream</a></code>
            and <code
                class="idl"><a data-link-type="idl" href="https://streams.spec.whatwg.org/#writablestream" id="ref-for-writablestream">WritableStream</a></code>
            are defined in <cite>Streams</cite>. <a data-link-type="biblio" href="#biblio-streams"
                title="Streams Standard">[STREAMS]</a></p>
        <p>A <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="compression-context">compression
                context</dfn> is the internal state maintained by a compression or decompression algorithm. The contents
            of a <a data-link-type="dfn" href="#compression-context" id="ref-for-compression-context">compression
                context</a> depend on the format, algorithm and implementation in use. From the point of view of this
            specification, it is an opaque object. A <a data-link-type="dfn" href="#compression-context"
                id="ref-for-compression-context①">compression context</a> is initially in a start state such that it
            anticipates the first byte of input.</p>
        <h2 class="heading settled" data-level="3" id="supported-formats"><span class="secno">3. </span><span
                class="content">Supported formats</span><a class="self-link" href="#supported-formats"></a></h2>
        <dl>
            <dt data-md><code
                    class="idl"><a data-link-type="idl" href="#dom-compressionformat-deflate" id="ref-for-dom-compressionformat-deflate">deflate</a></code>
            <dd data-md>
                <p>"ZLIB Compressed Data Format" <a data-link-type="biblio" href="#biblio-rfc1950"
                        title="ZLIB Compressed Data Format Specification version 3.3">[RFC1950]</a></p>
                <p class="note" role="note"><span class="marker">Note:</span> This format is referred to as "deflate"
                    for consistency with HTTP Content-Encodings. See <a data-biblio-obsolete data-link-type="biblio"
                        href="#biblio-rfc7230"
                        title="Hypertext Transfer Protocol (HTTP/1.1): Message Syntax and Routing">[RFC7230]</a> section
                    4.2.2.</p>
                <ul>
                    <li data-md>
                        <p>Implementations must be "compliant" as described in <a data-link-type="biblio"
                                href="#biblio-rfc1950"
                                title="ZLIB Compressed Data Format Specification version 3.3">[RFC1950]</a> section 2.3.
                        </p>
                    <li data-md>
                        <p>Field values described as invalid in <a data-link-type="biblio" href="#biblio-rfc1950"
                                title="ZLIB Compressed Data Format Specification version 3.3">[RFC1950]</a> must not be
                            created by CompressionStream, and are errors for DecompressionStream.</p>
                    <li data-md>
                        <p>The only valid value of the <code>CM</code> (Compression method) part of the <code>CMF</code>
                            field is 8.</p>
                    <li data-md>
                        <p>The <code>FDICT</code> flag is not supported by these APIs, and will error the stream if set.
                        </p>
                    <li data-md>
                        <p>The <code>FLEVEL</code> flag is ignored by DecompressionStream.</p>
                    <li data-md>
                        <p>It is an error for DecompressionStream if the <code>ADLER32</code> checksum is not correct.
                        </p>
                    <li data-md>
                        <p>It is an error if there is additional input data after the <code>ADLER32</code> checksum.</p>
                </ul>
            <dt data-md><code
                    class="idl"><a data-link-type="idl" href="#dom-compressionformat-deflate-raw" id="ref-for-dom-compressionformat-deflate-raw">deflate-raw</a></code>
            <dd data-md>
                <p>"The DEFLATE algorithm" <a data-link-type="biblio" href="#biblio-rfc1951"
                        title="DEFLATE Compressed Data Format Specification version 1.3">[RFC1951]</a></p>
                <ul>
                    <li data-md>
                        <p>Implementations must be "compliant" as described in <a data-link-type="biblio"
                                href="#biblio-rfc1951"
                                title="DEFLATE Compressed Data Format Specification version 1.3">[RFC1951]</a> section
                            1.4.</p>
                    <li data-md>
                        <p>Non-<a data-link-type="biblio" href="#biblio-rfc1951"
                                title="DEFLATE Compressed Data Format Specification version 1.3">[RFC1951]</a>-conforming
                            blocks must not be created by CompressionStream, and are errors for DecompressionStream.</p>
                    <li data-md>
                        <p>It is an error if there is additional input data after the final block indicated by the
                            <code>BFINAL</code> flag.
                        </p>
                </ul>
            <dt data-md><code
                    class="idl"><a data-link-type="idl" href="#dom-compressionformat-gzip" id="ref-for-dom-compressionformat-gzip">gzip</a></code>
            <dd data-md>
                <p>"GZIP file format" <a data-link-type="biblio" href="#biblio-rfc1952"
                        title="GZIP file format specification version 4.3">[RFC1952]</a></p>
                <ul>
                    <li data-md>
                        <p>Implementations must be "compliant" as described in <a data-link-type="biblio"
                                href="#biblio-rfc1952" title="GZIP file format specification version 4.3">[RFC1952]</a>
                            section 2.3.1.2.</p>
                    <li data-md>
                        <p>Field values described as invalid in <a data-link-type="biblio" href="#biblio-rfc1952"
                                title="GZIP file format specification version 4.3">[RFC1952]</a> must not be created by
                            CompressionStream, and are errors for DecompressionStream.</p>
                    <li data-md>
                        <p>The only valid value of the <code>CM</code> (Compression Method) field is 8.</p>
                    <li data-md>
                        <p>The <code>FTEXT</code> flag must be ignored by DecompressionStream.</p>
                    <li data-md>
                        <p>If the <code>FHCRC</code> field is present, it is an error for it to be incorrect.</p>
                    <li data-md>
                        <p>The contents of any <code>FEXTRA</code>, <code>FNAME</code> and <code>FCOMMENT</code> fields
                            must be ignored by DecompressionStream, except to verify that they are terminated correctly.
                        </p>
                    <li data-md>
                        <p>The contents of the <code>MTIME</code>, <code>XFL</code> and <code>OS</code> fields must be
                            ignored by DecompressionStream.</p>
                    <li data-md>
                        <p>It is an error if <code>CRC32</code> or <code>ISIZE</code> do not match the decompressed
                            data.</p>
                    <li data-md>
                        <p>A <code>gzip</code> stream may only contain one "member".</p>
                    <li data-md>
                        <p>It is an error if there is additional input data after the end of the "member".</p>
                </ul>
        </dl>
        <h2 class="heading settled" data-level="4" id="compression-stream"><span class="secno">4. </span><span
                class="content">Interface <code>CompressionStream</code></span><a class="self-link"
                href="#compression-stream"></a></h2>
        <pre class="def highlight idl"><c- b>enum</c-> <dfn class="dfn-paneled idl-code" data-dfn-type="enum" data-export id="enumdef-compressionformat"><code><c- g>CompressionFormat</c-></code></dfn> {
  <dfn class="dfn-paneled idl-code" data-dfn-for="CompressionFormat" data-dfn-type="enum-value" data-export id="dom-compressionformat-deflate"><code><c- s>"deflate"</c-></code></dfn>,
  <dfn class="dfn-paneled idl-code" data-dfn-for="CompressionFormat" data-dfn-type="enum-value" data-export id="dom-compressionformat-deflate-raw"><code><c- s>"deflate-raw"</c-></code></dfn>,
  <dfn class="dfn-paneled idl-code" data-dfn-for="CompressionFormat" data-dfn-type="enum-value" data-export id="dom-compressionformat-gzip"><code><c- s>"gzip"</c-></code></dfn>,
};

[Exposed=*]
<c- b>interface</c-> <dfn class="dfn-paneled idl-code" data-dfn-type="interface" data-export id="compressionstream"><code><c- g>CompressionStream</c-></code></dfn> {
  <a class="idl-code" data-link-type="constructor" href="#dom-compressionstream-compressionstream" id="ref-for-dom-compressionstream-compressionstream"><c- g>constructor</c-></a>(<a data-link-type="idl-name" href="#enumdef-compressionformat" id="ref-for-enumdef-compressionformat"><c- n>CompressionFormat</c-></a> <dfn class="dfn-paneled idl-code" data-dfn-for="CompressionStream/CompressionStream(format), CompressionStream/constructor(format)" data-dfn-type="argument" data-export id="dom-compressionstream-compressionstream-format-format"><code><c- g>format</c-></code></dfn>);
};
<a data-link-type="idl-name" href="#compressionstream" id="ref-for-compressionstream"><c- n>CompressionStream</c-></a> <c- b>includes</c-> <a data-link-type="idl-name" href="https://streams.spec.whatwg.org/#generictransformstream" id="ref-for-generictransformstream"><c- n>GenericTransformStream</c-></a>;
</pre>
        <p>A <code
                class="idl"><a data-link-type="idl" href="#compressionstream" id="ref-for-compressionstream①">CompressionStream</a></code>
            has an associated <dfn class="dfn-paneled" data-dfn-for="CompressionStream" data-dfn-type="dfn"
                data-noexport id="compressionstream-format">format</dfn> and <a data-link-type="dfn"
                href="#compression-context" id="ref-for-compression-context②">compression context</a> <dfn
                class="dfn-paneled" data-dfn-for="CompressionStream" data-dfn-type="dfn" data-noexport
                id="compressionstream-context">context</dfn>.</p>
        <div class="algorithm" data-algorithm="CompressionStream(format)" data-algorithm-for="CompressionStream">

            The <dfn class="dfn-paneled idl-code" data-dfn-for="CompressionStream" data-dfn-type="constructor"
                data-export data-lt="CompressionStream(format)|constructor(format)"
                id="dom-compressionstream-compressionstream"><code>new CompressionStream(<var>format</var>)</code></dfn>
            steps are:

            <ol>
                <li data-md>
                    <p>If <var>format</var> is unsupported in <code
                            class="idl"><a data-link-type="idl" href="#compressionstream" id="ref-for-compressionstream②">CompressionStream</a></code>,
                        then throw a <code
                            class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#exceptiondef-typeerror" id="ref-for-exceptiondef-typeerror">TypeError</a></code>.
                    </p>
                <li data-md>
                    <p>Set <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#this"
                            id="ref-for-this">this</a>’s <a data-link-type="dfn" href="#compressionstream-format"
                            id="ref-for-compressionstream-format">format</a> to <var>format</var>.</p>
                <li data-md>
                    <p>Let <var>transformAlgorithm</var> be an algorithm which takes a <var>chunk</var> argument and
                        runs the <a data-link-type="dfn" href="#compress-and-enqueue-a-chunk"
                            id="ref-for-compress-and-enqueue-a-chunk">compress and enqueue a chunk</a> algorithm with <a
                            data-link-type="dfn" href="https://webidl.spec.whatwg.org/#this" id="ref-for-this①">this</a>
                        and <var>chunk</var>.</p>
                <li data-md>
                    <p>Let <var>flushAlgorithm</var> be an algorithm which takes no argument and runs the <a
                            data-link-type="dfn" href="#compress-flush-and-enqueue"
                            id="ref-for-compress-flush-and-enqueue">compress flush and enqueue</a> algorithm with <a
                            data-link-type="dfn" href="https://webidl.spec.whatwg.org/#this"
                            id="ref-for-this②">this</a>.</p>
                <li data-md>
                    <p>Set <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#this"
                            id="ref-for-this③">this</a>’s <a data-link-type="dfn"
                            href="https://streams.spec.whatwg.org/#generictransformstream-transform"
                            id="ref-for-generictransformstream-transform">transform</a> to a <a data-link-type="dfn"
                            href="https://webidl.spec.whatwg.org/#new" id="ref-for-new">new</a> <code
                            class="idl"><a data-link-type="idl" href="https://streams.spec.whatwg.org/#transformstream" id="ref-for-transformstream">TransformStream</a></code>.
                    </p>
                <li data-md>
                    <p><a data-link-type="dfn" href="https://streams.spec.whatwg.org/#transformstream-set-up"
                            id="ref-for-transformstream-set-up">Set up</a> <a data-link-type="dfn"
                            href="https://webidl.spec.whatwg.org/#this" id="ref-for-this④">this</a>’s <a
                            data-link-type="dfn"
                            href="https://streams.spec.whatwg.org/#generictransformstream-transform"
                            id="ref-for-generictransformstream-transform①">transform</a> with <i><a data-link-type="dfn"
                                href="https://streams.spec.whatwg.org/#transformstream-set-up-transformalgorithm"
                                id="ref-for-transformstream-set-up-transformalgorithm">transformAlgorithm</a></i> set to
                        <var>transformAlgorithm</var> and <i><a data-link-type="dfn"
                                href="https://streams.spec.whatwg.org/#transformstream-set-up-flushalgorithm"
                                id="ref-for-transformstream-set-up-flushalgorithm">flushAlgorithm</a></i> set to
                        <var>flushAlgorithm</var>.
                    </p>
            </ol>
        </div>
        <div class="algorithm" data-algorithm="compress and enqueue a chunk">

            The <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="compress-and-enqueue-a-chunk">compress
                and enqueue a chunk</dfn> algorithm, given a <code
                class="idl"><a data-link-type="idl" href="#compressionstream" id="ref-for-compressionstream③">CompressionStream</a></code>
            object <var>cs</var> and a <var>chunk</var>, runs these steps:

            <ol>
                <li data-md>
                    <p>If <var>chunk</var> is not a <code
                            class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#BufferSource" id="ref-for-BufferSource①">BufferSource</a></code>
                        type, then throw a <code
                            class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#exceptiondef-typeerror" id="ref-for-exceptiondef-typeerror①">TypeError</a></code>.
                    </p>
                <li data-md>
                    <p>Let <var>buffer</var> be the result of compressing <var>chunk</var> with <var>cs</var>’s <a
                            data-link-type="dfn" href="#compressionstream-format"
                            id="ref-for-compressionstream-format①">format</a> and <a data-link-type="dfn"
                            href="#compressionstream-context" id="ref-for-compressionstream-context">context</a>.</p>
                <li data-md>
                    <p>If <var>buffer</var> is empty, return.</p>
                <li data-md>
                    <p>Let <var>arrays</var> be the result of splitting <var>buffer</var> into one or more non-empty
                        pieces and converting them into <code
                            class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-Uint8Array" id="ref-for-idl-Uint8Array">Uint8Array</a></code>s.
                    </p>
                <li data-md>
                    <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-iterate"
                            id="ref-for-list-iterate">For each</a> <code
                            class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-Uint8Array" id="ref-for-idl-Uint8Array①">Uint8Array</a></code>
                        <var>array</var> of <var>arrays</var>, <a data-link-type="dfn"
                            href="https://streams.spec.whatwg.org/#transformstream-enqueue"
                            id="ref-for-transformstream-enqueue">enqueue</a> <var>array</var> in <var>cs</var>’s <a
                            data-link-type="dfn"
                            href="https://streams.spec.whatwg.org/#generictransformstream-transform"
                            id="ref-for-generictransformstream-transform②">transform</a>.
                    </p>
            </ol>
        </div>
        <div class="algorithm" data-algorithm="compress flush and enqueue">

            The <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="compress-flush-and-enqueue">compress
                flush and enqueue</dfn> algorithm, which handles the end of data from the input <code
                class="idl"><a data-link-type="idl" href="https://streams.spec.whatwg.org/#readablestream" id="ref-for-readablestream①">ReadableStream</a></code>
            object, given a <code
                class="idl"><a data-link-type="idl" href="#compressionstream" id="ref-for-compressionstream④">CompressionStream</a></code>
            object <var>cs</var>, runs these steps:

            <ol>
                <li data-md>
                    <p>Let <var>buffer</var> be the result of compressing an empty input with <var>cs</var>’s <a
                            data-link-type="dfn" href="#compressionstream-format"
                            id="ref-for-compressionstream-format②">format</a> and <a data-link-type="dfn"
                            href="#compressionstream-context" id="ref-for-compressionstream-context①">context</a>, with
                        the finish flag.</p>
                <li data-md>
                    <p>If <var>buffer</var> is empty, return.</p>
                <li data-md>
                    <p>Let <var>arrays</var> be the result of splitting <var>buffer</var> into one or more non-empty
                        pieces and converting them into <code
                            class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-Uint8Array" id="ref-for-idl-Uint8Array②">Uint8Array</a></code>s.
                    </p>
                <li data-md>
                    <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-iterate"
                            id="ref-for-list-iterate①">For each</a> <code
                            class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-Uint8Array" id="ref-for-idl-Uint8Array③">Uint8Array</a></code>
                        <var>array</var> of <var>arrays</var>, <a data-link-type="dfn"
                            href="https://streams.spec.whatwg.org/#transformstream-enqueue"
                            id="ref-for-transformstream-enqueue①">enqueue</a> <var>array</var> in <var>cs</var>’s <a
                            data-link-type="dfn"
                            href="https://streams.spec.whatwg.org/#generictransformstream-transform"
                            id="ref-for-generictransformstream-transform③">transform</a>.
                    </p>
            </ol>
        </div>
        <h2 class="heading settled" data-level="5" id="decompression-stream"><span class="secno">5. </span><span
                class="content">Interface <code>DecompressionStream</code></span><a class="self-link"
                href="#decompression-stream"></a></h2>
        <pre class="def highlight idl">[Exposed=*]
<c- b>interface</c-> <dfn class="dfn-paneled idl-code" data-dfn-type="interface" data-export id="decompressionstream"><code><c- g>DecompressionStream</c-></code></dfn> {
  <a class="idl-code" data-link-type="constructor" href="#dom-decompressionstream-decompressionstream" id="ref-for-dom-decompressionstream-decompressionstream"><c- g>constructor</c-></a>(<a data-link-type="idl-name" href="#enumdef-compressionformat" id="ref-for-enumdef-compressionformat①"><c- n>CompressionFormat</c-></a> <dfn class="dfn-paneled idl-code" data-dfn-for="DecompressionStream/DecompressionStream(format), DecompressionStream/constructor(format)" data-dfn-type="argument" data-export id="dom-decompressionstream-decompressionstream-format-format"><code><c- g>format</c-></code></dfn>);
};
<a data-link-type="idl-name" href="#decompressionstream" id="ref-for-decompressionstream"><c- n>DecompressionStream</c-></a> <c- b>includes</c-> <a data-link-type="idl-name" href="https://streams.spec.whatwg.org/#generictransformstream" id="ref-for-generictransformstream①"><c- n>GenericTransformStream</c-></a>;
</pre>
        <p>A <code
                class="idl"><a data-link-type="idl" href="#decompressionstream" id="ref-for-decompressionstream①">DecompressionStream</a></code>
            has an associated <dfn class="dfn-paneled" data-dfn-for="DecompressionStream" data-dfn-type="dfn"
                data-noexport id="decompressionstream-format">format</dfn> and <a data-link-type="dfn"
                href="#compression-context" id="ref-for-compression-context③">compression context</a> <dfn
                class="dfn-paneled" data-dfn-for="DecompressionStream" data-dfn-type="dfn" data-noexport
                id="decompressionstream-context">context</dfn>.</p>
        <div class="algorithm" data-algorithm="DecompressionStream(format)" data-algorithm-for="DecompressionStream">

            The <dfn class="dfn-paneled idl-code" data-dfn-for="DecompressionStream" data-dfn-type="constructor"
                data-export data-lt="DecompressionStream(format)|constructor(format)"
                id="dom-decompressionstream-decompressionstream"><code>new DecompressionStream(<var>format</var>)</code></dfn>
            steps are:

            <ol>
                <li data-md>
                    <p>If <var>format</var> is unsupported in <code
                            class="idl"><a data-link-type="idl" href="#decompressionstream" id="ref-for-decompressionstream②">DecompressionStream</a></code>,
                        then throw a <code
                            class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#exceptiondef-typeerror" id="ref-for-exceptiondef-typeerror②">TypeError</a></code>.
                    </p>
                <li data-md>
                    <p>Set <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#this"
                            id="ref-for-this⑤">this</a>’s <a data-link-type="dfn" href="#decompressionstream-format"
                            id="ref-for-decompressionstream-format">format</a> to <var>format</var>.</p>
                <li data-md>
                    <p>Let <var>transformAlgorithm</var> be an algorithm which takes a <var>chunk</var> argument and
                        runs the <a data-link-type="dfn" href="#decompress-and-enqueue-a-chunk"
                            id="ref-for-decompress-and-enqueue-a-chunk">decompress and enqueue a chunk</a> algorithm
                        with <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#this"
                            id="ref-for-this⑥">this</a> and <var>chunk</var>.</p>
                <li data-md>
                    <p>Let <var>flushAlgorithm</var> be an algorithm which takes no argument and runs the <a
                            data-link-type="dfn" href="#decompress-flush-and-enqueue"
                            id="ref-for-decompress-flush-and-enqueue">decompress flush and enqueue</a> algorithm with <a
                            data-link-type="dfn" href="https://webidl.spec.whatwg.org/#this"
                            id="ref-for-this⑦">this</a>.</p>
                <li data-md>
                    <p>Set <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#this"
                            id="ref-for-this⑧">this</a>’s <a data-link-type="dfn"
                            href="https://streams.spec.whatwg.org/#generictransformstream-transform"
                            id="ref-for-generictransformstream-transform④">transform</a> to a <a data-link-type="dfn"
                            href="https://webidl.spec.whatwg.org/#new" id="ref-for-new①">new</a> <code
                            class="idl"><a data-link-type="idl" href="https://streams.spec.whatwg.org/#transformstream" id="ref-for-transformstream①">TransformStream</a></code>.
                    </p>
                <li data-md>
                    <p><a data-link-type="dfn" href="https://streams.spec.whatwg.org/#transformstream-set-up"
                            id="ref-for-transformstream-set-up①">Set up</a> <a data-link-type="dfn"
                            href="https://webidl.spec.whatwg.org/#this" id="ref-for-this⑨">this</a>’s <a
                            data-link-type="dfn"
                            href="https://streams.spec.whatwg.org/#generictransformstream-transform"
                            id="ref-for-generictransformstream-transform⑤">transform</a> with <i><a data-link-type="dfn"
                                href="https://streams.spec.whatwg.org/#transformstream-set-up-transformalgorithm"
                                id="ref-for-transformstream-set-up-transformalgorithm①">transformAlgorithm</a></i> set
                        to <var>transformAlgorithm</var> and <i><a data-link-type="dfn"
                                href="https://streams.spec.whatwg.org/#transformstream-set-up-flushalgorithm"
                                id="ref-for-transformstream-set-up-flushalgorithm①">flushAlgorithm</a></i> set to
                        <var>flushAlgorithm</var>.
                    </p>
            </ol>
        </div>
        <div class="algorithm" data-algorithm="decompress and enqueue a chunk">

            The <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport
                id="decompress-and-enqueue-a-chunk">decompress and enqueue a chunk</dfn> algorithm, given a <code
                class="idl"><a data-link-type="idl" href="#decompressionstream" id="ref-for-decompressionstream③">DecompressionStream</a></code>
            object <var>ds</var> and a <var>chunk</var>, runs these steps:

            <ol>
                <li data-md>
                    <p>If <var>chunk</var> is not a <code
                            class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#BufferSource" id="ref-for-BufferSource②">BufferSource</a></code>
                        type, then throw a <code
                            class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#exceptiondef-typeerror" id="ref-for-exceptiondef-typeerror③">TypeError</a></code>.
                    </p>
                <li data-md>
                    <p>Let <var>buffer</var> be the result of decompressing <var>chunk</var> with <var>ds</var>’s <a
                            data-link-type="dfn" href="#decompressionstream-format"
                            id="ref-for-decompressionstream-format①">format</a> and <a data-link-type="dfn"
                            href="#decompressionstream-context" id="ref-for-decompressionstream-context">context</a>. If
                        this results in an error, then throw a <code
                            class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#exceptiondef-typeerror" id="ref-for-exceptiondef-typeerror④">TypeError</a></code>.
                    </p>
                <li data-md>
                    <p>If <var>buffer</var> is empty, return.</p>
                <li data-md>
                    <p>Let <var>arrays</var> be the result of splitting <var>buffer</var> into one or more non-empty
                        pieces and converting them into <code
                            class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-Uint8Array" id="ref-for-idl-Uint8Array④">Uint8Array</a></code>s.
                    </p>
                <li data-md>
                    <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-iterate"
                            id="ref-for-list-iterate②">For each</a> <code
                            class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-Uint8Array" id="ref-for-idl-Uint8Array⑤">Uint8Array</a></code>
                        <var>array</var> of <var>arrays</var>, <a data-link-type="dfn"
                            href="https://streams.spec.whatwg.org/#transformstream-enqueue"
                            id="ref-for-transformstream-enqueue②">enqueue</a> <var>array</var> in <var>ds</var>’s <a
                            data-link-type="dfn"
                            href="https://streams.spec.whatwg.org/#generictransformstream-transform"
                            id="ref-for-generictransformstream-transform⑥">transform</a>.
                    </p>
                <li data-md>
                    <p>If the end of the compressed input has been reached, and <var>ds</var>’s <a data-link-type="dfn"
                            href="#decompressionstream-context" id="ref-for-decompressionstream-context①">context</a>
                        has not fully consumed <var>chunk</var>, then throw a <code
                            class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#exceptiondef-typeerror" id="ref-for-exceptiondef-typeerror⑤">TypeError</a></code>.
                    </p>
            </ol>
        </div>
        <div class="algorithm" data-algorithm="decompress flush and enqueue">

            The <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="decompress-flush-and-enqueue">decompress
                flush and enqueue</dfn> algorithm, which handles the end of data from the input <code
                class="idl"><a data-link-type="idl" href="https://streams.spec.whatwg.org/#readablestream" id="ref-for-readablestream②">ReadableStream</a></code>
            object, given a <code
                class="idl"><a data-link-type="idl" href="#decompressionstream" id="ref-for-decompressionstream④">DecompressionStream</a></code>
            object <var>ds</var>, runs these steps:

            <ol>
                <li data-md>
                    <p>Let <var>buffer</var> be the result of decompressing an empty input with <var>ds</var>’s <a
                            data-link-type="dfn" href="#decompressionstream-format"
                            id="ref-for-decompressionstream-format②">format</a> and <a data-link-type="dfn"
                            href="#decompressionstream-context" id="ref-for-decompressionstream-context②">context</a>,
                        with the finish flag.</p>
                <li data-md>
                    <p>If <var>buffer</var> is not empty:</p>
                    <ol>
                        <li data-md>
                            <p>Let <var>arrays</var> be the result of splitting <var>buffer</var> into one or more
                                non-empty pieces and converting them into <code
                                    class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-Uint8Array" id="ref-for-idl-Uint8Array⑥">Uint8Array</a></code>s.
                            </p>
                        <li data-md>
                            <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-iterate"
                                    id="ref-for-list-iterate③">For each</a> <code
                                    class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#idl-Uint8Array" id="ref-for-idl-Uint8Array⑦">Uint8Array</a></code>
                                <var>array</var> of <var>arrays</var>, <a data-link-type="dfn"
                                    href="https://streams.spec.whatwg.org/#transformstream-enqueue"
                                    id="ref-for-transformstream-enqueue③">enqueue</a> <var>array</var> in
                                <var>ds</var>’s <a data-link-type="dfn"
                                    href="https://streams.spec.whatwg.org/#generictransformstream-transform"
                                    id="ref-for-generictransformstream-transform⑦">transform</a>.
                            </p>
                    </ol>
                <li data-md>
                    <p>If the end of the compressed input has not been reached, then throw a <code
                            class="idl"><a data-link-type="idl" href="https://webidl.spec.whatwg.org/#exceptiondef-typeerror" id="ref-for-exceptiondef-typeerror⑥">TypeError</a></code>.
                    </p>
            </ol>
        </div>
        <h2 class="heading settled" data-level="6" id="privacy-security"><span class="secno">6. </span><span
                class="content">Privacy and security considerations</span><a class="self-link"
                href="#privacy-security"></a></h2>
        <p>The API doesn’t add any new privileges to the web platform.</p>
        <p>However, web developers have to pay attention to the situation when attackers can get the length of the data.
            If so, they may be able to guess the contents of the data.</p>
        <h2 class="heading settled" data-level="7" id="examples"><span class="secno">7. </span><span
                class="content">Examples</span><a class="self-link" href="#examples"></a></h2>
        <h3 class="heading settled" data-level="7.1" id="example-gzip-compress-stream"><span class="secno">7.1.
            </span><span class="content">Gzip-compress a stream</span><a class="self-link"
                href="#example-gzip-compress-stream"></a></h3>
        <div class="example" id="example-gzip-compress-stream-code">
            <a class="self-link" href="#example-gzip-compress-stream-code"></a>

            <pre class="highlight"><c- a>const</c-> compressedReadableStream
    <c- o>=</c-> inputReadableStream<c- p>.</c->pipeThrough<c- p>(</c-><c- ow>new</c-> CompressionStream<c- p>(</c-><c- t>'gzip'</c-><c- p>));</c->
</pre>
        </div>
        <h3 class="heading settled" data-level="7.2" id="example-deflate-compress"><span class="secno">7.2. </span><span
                class="content">Deflate-compress an ArrayBuffer to a Uint8Array</span><a class="self-link"
                href="#example-deflate-compress"></a></h3>
        <div class="example" id="example-deflate-compress-code">
            <a class="self-link" href="#example-deflate-compress-code"></a>

            <pre class="highlight"><c- k>async</c-> <c- a>function</c-> compressArrayBuffer<c- p>(</c->input<c- p>)</c-> <c- p>{</c->
  <c- a>const</c-> cs <c- o>=</c-> <c- ow>new</c-> CompressionStream<c- p>(</c-><c- t>'deflate'</c-><c- p>);</c->

  <c- a>const</c-> writer <c- o>=</c-> cs<c- p>.</c->writable<c- p>.</c->getWriter<c- p>();</c->
  writer<c- p>.</c->write<c- p>(</c->input<c- p>);</c->
  writer<c- p>.</c->close<c- p>();</c->

  <c- a>const</c-> output <c- o>=</c-> <c- p>[];</c->
  <c- a>let</c-> totalSize <c- o>=</c-> <c- mf>0</c-><c- p>;</c->
  <c- k>for</c-> <c- p>(</c-><c- a>const</c-> chunk <c- k>of</c-> cs<c- p>.</c->readable<c- p>)</c-> <c- p>{</c->
    output<c- p>.</c->push<c- p>(</c->value<c- p>);</c->
    totalSize <c- o>+=</c-> value<c- p>.</c->byteLength<c- p>;</c->
  <c- p>}</c->

  <c- a>const</c-> concatenated <c- o>=</c-> <c- ow>new</c-> Uint8Array<c- p>(</c->totalSize<c- p>);</c->
  <c- a>let</c-> offset <c- o>=</c-> <c- mf>0</c-><c- p>;</c->
  <c- k>for</c-> <c- p>(</c-><c- a>const</c-> array <c- k>of</c-> output<c- p>)</c-> <c- p>{</c->
    concatenated<c- p>.</c->set<c- p>(</c->array<c- p>,</c-> offset<c- p>);</c->
    offset <c- o>+=</c-> array<c- p>.</c->byteLength<c- p>;</c->
  <c- p>}</c->

  <c- k>return</c-> concatenated<c- p>;</c->
<c- p>}</c->
</pre>
        </div>
        <h3 class="heading settled" data-level="7.3" id="example-gzip-decompress"><span class="secno">7.3. </span><span
                class="content">Gzip-decompress a Blob to Blob</span><a class="self-link"
                href="#example-gzip-decompress"></a></h3>
        <div class="example" id="example-gzip-decompress-code">
            <a class="self-link" href="#example-gzip-decompress-code"></a>

            <pre class="highlight"><c- a>function</c-> decompressBlob<c- p>(</c->blob<c- p>)</c-> <c- p>{</c->
  <c- a>const</c-> ds <c- o>=</c-> <c- ow>new</c-> DecompressionStream<c- p>(</c-><c- t>'gzip'</c-><c- p>);</c->
  <c- a>const</c-> decompressionStream <c- o>=</c-> blob<c- p>.</c->stream<c- p>().</c->pipeThrough<c- p>(</c->ds<c- p>);</c->
  <c- k>return</c-> <c- ow>new</c-> Response<c- p>(</c->decompressionStream<c- p>).</c->blob<c- p>();</c->
<c- p>}</c->
</pre>
        </div>
        <h2 class="heading no-num settled" id="acknowledgments"><span class="content">Acknowledgments</span><a
                class="self-link" href="#acknowledgments"></a></h2>

        Thanks to Canon Mukai, Domenic Denicola, and Yutaka Hirano, for their support.


        <p>This standard is written by Adam Rice (<a href="https://google.com">Google</a>, <a
                href="mailto:ricea@chromium.org">ricea@chromium.org</a>).</p>
        <h2 class="heading no-num settled" id="ipr"><span class="content">Intellectual property rights</span><a
                class="self-link" href="#ipr"></a></h2>
        <div data-fill-with="ipr">This Living Standard was originally developed in the W3C WICG, where it was available
            under the <a href="https://www.w3.org/Consortium/Legal/2015/copyright-software-and-document">W3C Software
                and Document License</a>.


        </div>
        <p>Copyright © WHATWG (Apple, Google, Mozilla, Microsoft). This work is licensed under a <a
                href="https://creativecommons.org/licenses/by/4.0/" rel="license">Creative Commons Attribution 4.0
                International License</a>. To the extent portions of it are incorporated into source code, such
            portions in the source code are licensed under the <a href="https://opensource.org/licenses/BSD-3-Clause"
                rel="license">BSD 3-Clause License</a> instead.</p>
        <p>This is the Living Standard. Those
            interested in the patent-review version should view the
            <a href="/review-drafts/2025-11/">Living Standard Review Draft</a>.
        </p>
    </main>
    <script>
        "use strict";
        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("/service-worker.js");
        }
    </script>
    <h2 class="heading no-num no-ref settled" id="index"><span class="content">Index</span><a class="self-link"
            href="#index"></a></h2>
    <h3 class="heading no-num no-ref settled" id="index-defined-here"><span class="content">Terms defined by this
            specification</span><a class="self-link" href="#index-defined-here"></a></h3>
    <ul class="index">
        <li><a href="#compress-and-enqueue-a-chunk">compress and enqueue a chunk</a><span>, in § 4</span>
        <li><a href="#compress-flush-and-enqueue">compress flush and enqueue</a><span>, in § 4</span>
        <li><a href="#compression-context">compression context</a><span>, in § 2</span>
        <li><a href="#enumdef-compressionformat">CompressionFormat</a><span>, in § 4</span>
        <li><a href="#compressionstream">CompressionStream</a><span>, in § 4</span>
        <li><a href="#dom-compressionstream-compressionstream">CompressionStream(format)</a><span>, in § 4</span>
        <li>
            constructor(format)
            <ul>
                <li><a href="#dom-compressionstream-compressionstream">constructor for CompressionStream</a><span>, in
                        § 4</span>
                <li><a href="#dom-decompressionstream-decompressionstream">constructor for
                        DecompressionStream</a><span>, in § 5</span>
            </ul>
        <li>
            context
            <ul>
                <li><a href="#compressionstream-context">dfn for CompressionStream</a><span>, in § 4</span>
                <li><a href="#decompressionstream-context">dfn for DecompressionStream</a><span>, in § 5</span>
            </ul>
        <li><a href="#decompress-and-enqueue-a-chunk">decompress and enqueue a chunk</a><span>, in § 5</span>
        <li><a href="#decompress-flush-and-enqueue">decompress flush and enqueue</a><span>, in § 5</span>
        <li><a href="#decompressionstream">DecompressionStream</a><span>, in § 5</span>
        <li><a href="#dom-decompressionstream-decompressionstream">DecompressionStream(format)</a><span>, in § 5</span>
        <li><a href="#dom-compressionformat-deflate">"deflate"</a><span>, in § 4</span>
        <li><a href="#dom-compressionformat-deflate-raw">"deflate-raw"</a><span>, in § 4</span>
        <li>
            format
            <ul>
                <li><a href="#compressionstream-format">dfn for CompressionStream</a><span>, in § 4</span>
                <li><a href="#decompressionstream-format">dfn for DecompressionStream</a><span>, in § 5</span>
            </ul>
        <li><a href="#dom-compressionformat-gzip">"gzip"</a><span>, in § 4</span>
    </ul>
    <h3 class="heading no-num no-ref settled" id="index-defined-elsewhere"><span class="content">Terms defined by
            reference</span><a class="self-link" href="#index-defined-elsewhere"></a></h3>
    <ul class="index">
        <li>
            <a data-link-type="biblio">[INFRA]</a> defines the following terms:
            <ul>
                <li><span class="dfn-paneled" id="16d07e10">for each</span>
            </ul>
        <li>
            <a data-link-type="biblio">[STREAMS]</a> defines the following terms:
            <ul>
                <li><span class="dfn-paneled" id="d61c5cab">GenericTransformStream</span>
                <li><span class="dfn-paneled" id="59ed4e57">ReadableStream</span>
                <li><span class="dfn-paneled" id="47e93e3e">TransformStream</span>
                <li><span class="dfn-paneled" id="59dc45b5">WritableStream</span>
                <li><span class="dfn-paneled" id="593deb55">enqueue</span>
                <li><span class="dfn-paneled" id="3af29886">flushAlgorithm</span>
                <li><span class="dfn-paneled" id="2a7798d8">set up</span>
                <li><span class="dfn-paneled" id="eade7401">transform</span>
                <li><span class="dfn-paneled" id="c7574ff1">transformAlgorithm</span>
            </ul>
        <li>
            <a data-link-type="biblio">[WEBIDL]</a> defines the following terms:
            <ul>
                <li><span class="dfn-paneled" id="3aff2fb3">BufferSource</span>
                <li><span class="dfn-paneled" id="82ca3efc">TypeError</span>
                <li><span class="dfn-paneled" id="95d7775a">Uint8Array</span>
                <li><span class="dfn-paneled" id="56f81a8e">new</span>
                <li><span class="dfn-paneled" id="4013a022">this</span>
            </ul>
    </ul>
    <h2 class="heading no-num no-ref settled" id="references"><span class="content">References</span><a
            class="self-link" href="#references"></a></h2>
    <h3 class="heading no-num no-ref settled" id="normative"><span class="content">Normative References</span><a
            class="self-link" href="#normative"></a></h3>
    <dl>
        <dt id="biblio-infra">[INFRA]
        <dd>Anne van Kesteren; Domenic Denicola. <a href="https://infra.spec.whatwg.org/"><cite>Infra
                    Standard</cite></a>. Living Standard. URL: <a
                href="https://infra.spec.whatwg.org/">https://infra.spec.whatwg.org/</a>
        <dt id="biblio-rfc1950">[RFC1950]
        <dd>P. Deutsch; J-L. Gailly. <a href="https://www.rfc-editor.org/rfc/rfc1950"><cite>ZLIB Compressed Data Format
                    Specification version 3.3</cite></a>. May 1996. Informational. URL: <a
                href="https://www.rfc-editor.org/rfc/rfc1950">https://www.rfc-editor.org/rfc/rfc1950</a>
        <dt id="biblio-rfc1951">[RFC1951]
        <dd>P. Deutsch. <a href="https://www.rfc-editor.org/rfc/rfc1951"><cite>DEFLATE Compressed Data Format
                    Specification version 1.3</cite></a>. May 1996. Informational. URL: <a
                href="https://www.rfc-editor.org/rfc/rfc1951">https://www.rfc-editor.org/rfc/rfc1951</a>
        <dt id="biblio-rfc1952">[RFC1952]
        <dd>P. Deutsch. <a href="https://www.rfc-editor.org/rfc/rfc1952"><cite>GZIP file format specification version
                    4.3</cite></a>. May 1996. Informational. URL: <a
                href="https://www.rfc-editor.org/rfc/rfc1952">https://www.rfc-editor.org/rfc/rfc1952</a>
        <dt id="biblio-streams">[STREAMS]
        <dd>Adam Rice; et al. <a href="https://streams.spec.whatwg.org/"><cite>Streams Standard</cite></a>. Living
            Standard. URL: <a href="https://streams.spec.whatwg.org/">https://streams.spec.whatwg.org/</a>
        <dt id="biblio-webidl">[WEBIDL]
        <dd>Edgar Chen; Timothy Gu. <a href="https://webidl.spec.whatwg.org/"><cite>Web IDL Standard</cite></a>. Living
            Standard. URL: <a href="https://webidl.spec.whatwg.org/">https://webidl.spec.whatwg.org/</a>
    </dl>
    <h3 class="heading no-num no-ref settled" id="informative"><span class="content">Informative References</span><a
            class="self-link" href="#informative"></a></h3>
    <dl>
        <dt id="biblio-rfc7230">[RFC7230]
        <dd>R. Fielding, Ed.; J. Reschke, Ed.. <a href="https://httpwg.org/specs/rfc7230.html"><cite>Hypertext Transfer
                    Protocol (HTTP/1.1): Message Syntax and Routing</cite></a>. June 2014. Proposed Standard. URL: <a
                href="https://httpwg.org/specs/rfc7230.html">https://httpwg.org/specs/rfc7230.html</a>
    </dl>
    <h2 class="heading no-num no-ref settled" id="idl-index"><span class="content">IDL Index</span><a class="self-link"
            href="#idl-index"></a></h2>
    <pre class="def highlight idl"><c- b>enum</c-> <a href="#enumdef-compressionformat"><code><c- g>CompressionFormat</c-></code></a> {
  <a href="#dom-compressionformat-deflate"><code><c- s>"deflate"</c-></code></a>,
  <a href="#dom-compressionformat-deflate-raw"><code><c- s>"deflate-raw"</c-></code></a>,
  <a href="#dom-compressionformat-gzip"><code><c- s>"gzip"</c-></code></a>,
};

[Exposed=*]
<c- b>interface</c-> <a href="#compressionstream"><code><c- g>CompressionStream</c-></code></a> {
  <a class="idl-code" data-link-type="constructor" href="#dom-compressionstream-compressionstream"><c- g>constructor</c-></a>(<a data-link-type="idl-name" href="#enumdef-compressionformat"><c- n>CompressionFormat</c-></a> <a href="#dom-compressionstream-compressionstream-format-format"><code><c- g>format</c-></code></a>);
};
<a data-link-type="idl-name" href="#compressionstream"><c- n>CompressionStream</c-></a> <c- b>includes</c-> <a data-link-type="idl-name" href="https://streams.spec.whatwg.org/#generictransformstream"><c- n>GenericTransformStream</c-></a>;

[Exposed=*]
<c- b>interface</c-> <a href="#decompressionstream"><code><c- g>DecompressionStream</c-></code></a> {
  <a class="idl-code" data-link-type="constructor" href="#dom-decompressionstream-decompressionstream"><c- g>constructor</c-></a>(<a data-link-type="idl-name" href="#enumdef-compressionformat"><c- n>CompressionFormat</c-></a> <a href="#dom-decompressionstream-decompressionstream-format-format"><code><c- g>format</c-></code></a>);
};
<a data-link-type="idl-name" href="#decompressionstream"><c- n>DecompressionStream</c-></a> <c- b>includes</c-> <a data-link-type="idl-name" href="https://streams.spec.whatwg.org/#generictransformstream"><c- n>GenericTransformStream</c-></a>;

</pre>
    <details class="mdn-anno unpositioned" data-anno-for="dom-compressionstream-compressionstream">
        <summary><b class="all-engines-flag" title="This feature is in all current engines.">✔</b><span>MDN</span>
        </summary>
        <div class="feature">
            <p><a href="https://developer.mozilla.org/en-US/docs/Web/API/CompressionStream/CompressionStream"
                    title="The CompressionStream() constructor creates a new CompressionStream object which compresses a stream of data.">CompressionStream/CompressionStream</a>
            </p>
            <p class="all-engines-text">In all current engines.</p>
            <div class="support">
                <span class="firefox yes"><span>Firefox</span><span>113+</span></span><span
                    class="safari yes"><span>Safari</span><span>16.4+</span></span><span
                    class="chrome yes"><span>Chrome</span><span>80+</span></span>
                <hr>
                <span class="no opera"><span>Opera</span><span>?</span></span><span
                    class="edge_blink yes"><span>Edge</span><span>80+</span></span>
                <hr>
                <span class="edge no"><span>Edge (Legacy)</span><span>?</span></span><span
                    class="ie no"><span>IE</span><span>None</span></span>
                <hr>
                <span class="firefox_android no"><span>Firefox for Android</span><span>?</span></span><span
                    class="no safari_ios"><span>iOS Safari</span><span>?</span></span><span
                    class="chrome_android no"><span>Chrome for Android</span><span>?</span></span><span
                    class="no webview_android"><span>Android WebView</span><span>?</span></span><span
                    class="no samsunginternet_android"><span>Samsung Internet</span><span>?</span></span><span
                    class="no opera_android"><span>Opera Mobile</span><span>?</span></span>
                <hr>
                <span class="nodejs yes"><span>Node.js</span><span>17.0.0+</span></span>
            </div>
        </div>
    </details>
    <details class="mdn-anno unpositioned" data-anno-for="compression-stream">
        <summary><b class="all-engines-flag" title="This feature is in all current engines.">✔</b><span>MDN</span>
        </summary>
        <div class="feature">
            <p><a href="https://developer.mozilla.org/en-US/docs/Web/API/CompressionStream"
                    title="The CompressionStream interface of the Compression Streams API is an API for compressing a stream of data.">CompressionStream</a>
            </p>
            <p class="all-engines-text">In all current engines.</p>
            <div class="support">
                <span class="firefox yes"><span>Firefox</span><span>113+</span></span><span
                    class="safari yes"><span>Safari</span><span>16.4+</span></span><span
                    class="chrome yes"><span>Chrome</span><span>80+</span></span>
                <hr>
                <span class="no opera"><span>Opera</span><span>?</span></span><span
                    class="edge_blink yes"><span>Edge</span><span>80+</span></span>
                <hr>
                <span class="edge no"><span>Edge (Legacy)</span><span>?</span></span><span
                    class="ie no"><span>IE</span><span>None</span></span>
                <hr>
                <span class="firefox_android no"><span>Firefox for Android</span><span>?</span></span><span
                    class="no safari_ios"><span>iOS Safari</span><span>?</span></span><span
                    class="chrome_android no"><span>Chrome for Android</span><span>?</span></span><span
                    class="no webview_android"><span>Android WebView</span><span>?</span></span><span
                    class="no samsunginternet_android"><span>Samsung Internet</span><span>?</span></span><span
                    class="no opera_android"><span>Opera Mobile</span><span>?</span></span>
                <hr>
                <span class="nodejs yes"><span>Node.js</span><span>18.0.0+</span></span>
            </div>
        </div>
    </details>
    <details class="mdn-anno unpositioned" data-anno-for="dom-decompressionstream-decompressionstream">
        <summary><b class="all-engines-flag" title="This feature is in all current engines.">✔</b><span>MDN</span>
        </summary>
        <div class="feature">
            <p><a href="https://developer.mozilla.org/en-US/docs/Web/API/DecompressionStream/DecompressionStream"
                    title="The DecompressionStream() constructor creates a new DecompressionStream object which decompresses a stream of data.">DecompressionStream/DecompressionStream</a>
            </p>
            <p class="all-engines-text">In all current engines.</p>
            <div class="support">
                <span class="firefox yes"><span>Firefox</span><span>113+</span></span><span
                    class="safari yes"><span>Safari</span><span>16.4+</span></span><span
                    class="chrome yes"><span>Chrome</span><span>80+</span></span>
                <hr>
                <span class="no opera"><span>Opera</span><span>?</span></span><span
                    class="edge_blink yes"><span>Edge</span><span>80+</span></span>
                <hr>
                <span class="edge no"><span>Edge (Legacy)</span><span>?</span></span><span
                    class="ie no"><span>IE</span><span>None</span></span>
                <hr>
                <span class="firefox_android no"><span>Firefox for Android</span><span>?</span></span><span
                    class="no safari_ios"><span>iOS Safari</span><span>?</span></span><span
                    class="chrome_android no"><span>Chrome for Android</span><span>?</span></span><span
                    class="no webview_android"><span>Android WebView</span><span>?</span></span><span
                    class="no samsunginternet_android"><span>Samsung Internet</span><span>?</span></span><span
                    class="no opera_android"><span>Opera Mobile</span><span>?</span></span>
                <hr>
                <span class="nodejs yes"><span>Node.js</span><span>17.0.0+</span></span>
            </div>
        </div>
    </details>
    <details class="mdn-anno unpositioned" data-anno-for="decompression-stream">
        <summary><b class="all-engines-flag" title="This feature is in all current engines.">✔</b><span>MDN</span>
        </summary>
        <div class="feature">
            <p><a href="https://developer.mozilla.org/en-US/docs/Web/API/DecompressionStream"
                    title="The DecompressionStream interface of the Compression Streams API is an API for decompressing a stream of data.">DecompressionStream</a>
            </p>
            <p class="all-engines-text">In all current engines.</p>
            <div class="support">
                <span class="firefox yes"><span>Firefox</span><span>113+</span></span><span
                    class="safari yes"><span>Safari</span><span>16.4+</span></span><span
                    class="chrome yes"><span>Chrome</span><span>80+</span></span>
                <hr>
                <span class="no opera"><span>Opera</span><span>?</span></span><span
                    class="edge_blink yes"><span>Edge</span><span>80+</span></span>
                <hr>
                <span class="edge no"><span>Edge (Legacy)</span><span>?</span></span><span
                    class="ie no"><span>IE</span><span>None</span></span>
                <hr>
                <span class="firefox_android no"><span>Firefox for Android</span><span>?</span></span><span
                    class="no safari_ios"><span>iOS Safari</span><span>?</span></span><span
                    class="chrome_android no"><span>Chrome for Android</span><span>?</span></span><span
                    class="no webview_android"><span>Android WebView</span><span>?</span></span><span
                    class="no samsunginternet_android"><span>Samsung Internet</span><span>?</span></span><span
                    class="no opera_android"><span>Opera Mobile</span><span>?</span></span>
                <hr>
                <span class="nodejs yes"><span>Node.js</span><span>18.0.0+</span></span>
            </div>
        </div>
    </details>
    <script>/* Boilerplate: script-dom-helper */
        "use strict";
        function query(sel) { return document.querySelector(sel); }

        function queryAll(sel) { return [...document.querySelectorAll(sel)]; }

        function iter(obj) {
            if (!obj) return [];
            var it = obj[Symbol.iterator];
            if (it) return it;
            return Object.entries(obj);
        }

        function mk(tagname, attrs, ...children) {
            const el = document.createElement(tagname);
            for (const [k, v] of iter(attrs)) {
                if (k.slice(0, 3) == "_on") {
                    const eventName = k.slice(3);
                    el.addEventListener(eventName, v);
                } else if (k[0] == "_") {
                    // property, not attribute
                    el[k.slice(1)] = v;
                } else {
                    if (v === false || v == null) {
                        continue;
                    } else if (v === true) {
                        el.setAttribute(k, "");
                        continue;
                    } else {
                        el.setAttribute(k, v);
                    }
                }
            }
            append(el, children);
            return el;
        }

        /* Create shortcuts for every known HTML element */
        [
            "a",
            "abbr",
            "acronym",
            "address",
            "applet",
            "area",
            "article",
            "aside",
            "audio",
            "b",
            "base",
            "basefont",
            "bdo",
            "big",
            "blockquote",
            "body",
            "br",
            "button",
            "canvas",
            "caption",
            "center",
            "cite",
            "code",
            "col",
            "colgroup",
            "datalist",
            "dd",
            "del",
            "details",
            "dfn",
            "dialog",
            "div",
            "dl",
            "dt",
            "em",
            "embed",
            "fieldset",
            "figcaption",
            "figure",
            "font",
            "footer",
            "form",
            "frame",
            "frameset",
            "head",
            "header",
            "h1",
            "h2",
            "h3",
            "h4",
            "h5",
            "h6",
            "hr",
            "html",
            "i",
            "iframe",
            "img",
            "input",
            "ins",
            "kbd",
            "label",
            "legend",
            "li",
            "link",
            "main",
            "map",
            "mark",
            "meta",
            "meter",
            "nav",
            "nobr",
            "noscript",
            "object",
            "ol",
            "optgroup",
            "option",
            "output",
            "p",
            "param",
            "pre",
            "progress",
            "q",
            "s",
            "samp",
            "script",
            "section",
            "select",
            "small",
            "source",
            "span",
            "strike",
            "strong",
            "style",
            "sub",
            "summary",
            "sup",
            "table",
            "tbody",
            "td",
            "template",
            "textarea",
            "tfoot",
            "th",
            "thead",
            "time",
            "title",
            "tr",
            "u",
            "ul",
            "var",
            "video",
            "wbr",
            "xmp",
        ].forEach(tagname => {
            mk[tagname] = (...args) => mk(tagname, ...args);
        });

        function* nodesFromChildList(children) {
            for (const child of children.flat(Infinity)) {
                if (child instanceof Node) {
                    yield child;
                } else {
                    yield new Text(child);
                }
            }
        }
        function append(el, ...children) {
            for (const child of nodesFromChildList(children)) {
                if (el instanceof Node) el.appendChild(child);
                else el.push(child);
            }
            return el;
        }

        function insertAfter(el, ...children) {
            for (const child of nodesFromChildList(children)) {
                el.parentNode.insertBefore(child, el.nextSibling);
            }
            return el;
        }

        function clearContents(el) {
            el.innerHTML = "";
            return el;
        }

        function parseHTML(markup) {
            if (markup.toLowerCase().trim().indexOf('<!doctype') === 0) {
                const doc = document.implementation.createHTMLDocument("");
                doc.documentElement.innerHTML = markup;
                return doc;
            } else {
                const el = mk.template({});
                el.innerHTML = markup;
                return el.content;
            }
        }</script>
    <script>/* Boilerplate: script-dfn-panel */
        "use strict";
        {
            let dfnPanelData = {
                "16d07e10": { "dfnID": "16d07e10", "dfnText": "for each", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-list-iterate" }, { "id": "ref-for-list-iterate\u2460" }], "title": "4. Interface CompressionStream" }, { "refs": [{ "id": "ref-for-list-iterate\u2461" }, { "id": "ref-for-list-iterate\u2462" }], "title": "5. Interface DecompressionStream" }], "url": "https://infra.spec.whatwg.org/#list-iterate" },
                "2a7798d8": { "dfnID": "2a7798d8", "dfnText": "set up", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-transformstream-set-up" }], "title": "4. Interface CompressionStream" }, { "refs": [{ "id": "ref-for-transformstream-set-up\u2460" }], "title": "5. Interface DecompressionStream" }], "url": "https://streams.spec.whatwg.org/#transformstream-set-up" },
                "3af29886": { "dfnID": "3af29886", "dfnText": "flushAlgorithm", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-transformstream-set-up-flushalgorithm" }], "title": "4. Interface CompressionStream" }, { "refs": [{ "id": "ref-for-transformstream-set-up-flushalgorithm\u2460" }], "title": "5. Interface DecompressionStream" }], "url": "https://streams.spec.whatwg.org/#transformstream-set-up-flushalgorithm" },
                "3aff2fb3": { "dfnID": "3aff2fb3", "dfnText": "BufferSource", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-BufferSource" }], "title": "2. Infrastructure" }, { "refs": [{ "id": "ref-for-BufferSource\u2460" }], "title": "4. Interface CompressionStream" }, { "refs": [{ "id": "ref-for-BufferSource\u2461" }], "title": "5. Interface DecompressionStream" }], "url": "https://webidl.spec.whatwg.org/#BufferSource" },
                "4013a022": { "dfnID": "4013a022", "dfnText": "this", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-this" }, { "id": "ref-for-this\u2460" }, { "id": "ref-for-this\u2461" }, { "id": "ref-for-this\u2462" }, { "id": "ref-for-this\u2463" }], "title": "4. Interface CompressionStream" }, { "refs": [{ "id": "ref-for-this\u2464" }, { "id": "ref-for-this\u2465" }, { "id": "ref-for-this\u2466" }, { "id": "ref-for-this\u2467" }, { "id": "ref-for-this\u2468" }], "title": "5. Interface DecompressionStream" }], "url": "https://webidl.spec.whatwg.org/#this" },
                "47e93e3e": { "dfnID": "47e93e3e", "dfnText": "TransformStream", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-transformstream" }], "title": "4. Interface CompressionStream" }, { "refs": [{ "id": "ref-for-transformstream\u2460" }], "title": "5. Interface DecompressionStream" }], "url": "https://streams.spec.whatwg.org/#transformstream" },
                "56f81a8e": { "dfnID": "56f81a8e", "dfnText": "new", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-new" }], "title": "4. Interface CompressionStream" }, { "refs": [{ "id": "ref-for-new\u2460" }], "title": "5. Interface DecompressionStream" }], "url": "https://webidl.spec.whatwg.org/#new" },
                "593deb55": { "dfnID": "593deb55", "dfnText": "enqueue", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-transformstream-enqueue" }, { "id": "ref-for-transformstream-enqueue\u2460" }], "title": "4. Interface CompressionStream" }, { "refs": [{ "id": "ref-for-transformstream-enqueue\u2461" }, { "id": "ref-for-transformstream-enqueue\u2462" }], "title": "5. Interface DecompressionStream" }], "url": "https://streams.spec.whatwg.org/#transformstream-enqueue" },
                "59dc45b5": { "dfnID": "59dc45b5", "dfnText": "WritableStream", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-writablestream" }], "title": "2. Infrastructure" }], "url": "https://streams.spec.whatwg.org/#writablestream" },
                "59ed4e57": { "dfnID": "59ed4e57", "dfnText": "ReadableStream", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-readablestream" }], "title": "2. Infrastructure" }, { "refs": [{ "id": "ref-for-readablestream\u2460" }], "title": "4. Interface CompressionStream" }, { "refs": [{ "id": "ref-for-readablestream\u2461" }], "title": "5. Interface DecompressionStream" }], "url": "https://streams.spec.whatwg.org/#readablestream" },
                "82ca3efc": { "dfnID": "82ca3efc", "dfnText": "TypeError", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-exceptiondef-typeerror" }, { "id": "ref-for-exceptiondef-typeerror\u2460" }], "title": "4. Interface CompressionStream" }, { "refs": [{ "id": "ref-for-exceptiondef-typeerror\u2461" }, { "id": "ref-for-exceptiondef-typeerror\u2462" }, { "id": "ref-for-exceptiondef-typeerror\u2463" }, { "id": "ref-for-exceptiondef-typeerror\u2464" }, { "id": "ref-for-exceptiondef-typeerror\u2465" }], "title": "5. Interface DecompressionStream" }], "url": "https://webidl.spec.whatwg.org/#exceptiondef-typeerror" },
                "95d7775a": { "dfnID": "95d7775a", "dfnText": "Uint8Array", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-idl-Uint8Array" }, { "id": "ref-for-idl-Uint8Array\u2460" }, { "id": "ref-for-idl-Uint8Array\u2461" }, { "id": "ref-for-idl-Uint8Array\u2462" }], "title": "4. Interface CompressionStream" }, { "refs": [{ "id": "ref-for-idl-Uint8Array\u2463" }, { "id": "ref-for-idl-Uint8Array\u2464" }, { "id": "ref-for-idl-Uint8Array\u2465" }, { "id": "ref-for-idl-Uint8Array\u2466" }], "title": "5. Interface DecompressionStream" }], "url": "https://webidl.spec.whatwg.org/#idl-Uint8Array" },
                "c7574ff1": { "dfnID": "c7574ff1", "dfnText": "transformAlgorithm", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-transformstream-set-up-transformalgorithm" }], "title": "4. Interface CompressionStream" }, { "refs": [{ "id": "ref-for-transformstream-set-up-transformalgorithm\u2460" }], "title": "5. Interface DecompressionStream" }], "url": "https://streams.spec.whatwg.org/#transformstream-set-up-transformalgorithm" },
                "compress-and-enqueue-a-chunk": { "dfnID": "compress-and-enqueue-a-chunk", "dfnText": "compress and enqueue a chunk", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-compress-and-enqueue-a-chunk" }], "title": "4. Interface CompressionStream" }], "url": "#compress-and-enqueue-a-chunk" },
                "compress-flush-and-enqueue": { "dfnID": "compress-flush-and-enqueue", "dfnText": "compress flush and enqueue", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-compress-flush-and-enqueue" }], "title": "4. Interface CompressionStream" }], "url": "#compress-flush-and-enqueue" },
                "compression-context": { "dfnID": "compression-context", "dfnText": "compression context", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-compression-context" }, { "id": "ref-for-compression-context\u2460" }], "title": "2. Infrastructure" }, { "refs": [{ "id": "ref-for-compression-context\u2461" }], "title": "4. Interface CompressionStream" }, { "refs": [{ "id": "ref-for-compression-context\u2462" }], "title": "5. Interface DecompressionStream" }], "url": "#compression-context" },
                "compressionstream": { "dfnID": "compressionstream", "dfnText": "CompressionStream", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-compressionstream" }, { "id": "ref-for-compressionstream\u2460" }, { "id": "ref-for-compressionstream\u2461" }, { "id": "ref-for-compressionstream\u2462" }, { "id": "ref-for-compressionstream\u2463" }], "title": "4. Interface CompressionStream" }], "url": "#compressionstream" },
                "compressionstream-context": { "dfnID": "compressionstream-context", "dfnText": "context", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-compressionstream-context" }, { "id": "ref-for-compressionstream-context\u2460" }], "title": "4. Interface CompressionStream" }], "url": "#compressionstream-context" },
                "compressionstream-format": { "dfnID": "compressionstream-format", "dfnText": "format", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-compressionstream-format" }, { "id": "ref-for-compressionstream-format\u2460" }, { "id": "ref-for-compressionstream-format\u2461" }], "title": "4. Interface CompressionStream" }], "url": "#compressionstream-format" },
                "d61c5cab": { "dfnID": "d61c5cab", "dfnText": "GenericTransformStream", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-generictransformstream" }], "title": "4. Interface CompressionStream" }, { "refs": [{ "id": "ref-for-generictransformstream\u2460" }], "title": "5. Interface DecompressionStream" }], "url": "https://streams.spec.whatwg.org/#generictransformstream" },
                "decompress-and-enqueue-a-chunk": { "dfnID": "decompress-and-enqueue-a-chunk", "dfnText": "decompress and enqueue a chunk", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-decompress-and-enqueue-a-chunk" }], "title": "5. Interface DecompressionStream" }], "url": "#decompress-and-enqueue-a-chunk" },
                "decompress-flush-and-enqueue": { "dfnID": "decompress-flush-and-enqueue", "dfnText": "decompress flush and enqueue", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-decompress-flush-and-enqueue" }], "title": "5. Interface DecompressionStream" }], "url": "#decompress-flush-and-enqueue" },
                "decompressionstream": { "dfnID": "decompressionstream", "dfnText": "DecompressionStream", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-decompressionstream" }, { "id": "ref-for-decompressionstream\u2460" }, { "id": "ref-for-decompressionstream\u2461" }, { "id": "ref-for-decompressionstream\u2462" }, { "id": "ref-for-decompressionstream\u2463" }], "title": "5. Interface DecompressionStream" }], "url": "#decompressionstream" },
                "decompressionstream-context": { "dfnID": "decompressionstream-context", "dfnText": "context", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-decompressionstream-context" }, { "id": "ref-for-decompressionstream-context\u2460" }, { "id": "ref-for-decompressionstream-context\u2461" }], "title": "5. Interface DecompressionStream" }], "url": "#decompressionstream-context" },
                "decompressionstream-format": { "dfnID": "decompressionstream-format", "dfnText": "format", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-decompressionstream-format" }, { "id": "ref-for-decompressionstream-format\u2460" }, { "id": "ref-for-decompressionstream-format\u2461" }], "title": "5. Interface DecompressionStream" }], "url": "#decompressionstream-format" },
                "dom-compressionformat-deflate": { "dfnID": "dom-compressionformat-deflate", "dfnText": "\"deflate\"", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-dom-compressionformat-deflate" }], "title": "3. Supported formats" }], "url": "#dom-compressionformat-deflate" },
                "dom-compressionformat-deflate-raw": { "dfnID": "dom-compressionformat-deflate-raw", "dfnText": "\"deflate-raw\"", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-dom-compressionformat-deflate-raw" }], "title": "3. Supported formats" }], "url": "#dom-compressionformat-deflate-raw" },
                "dom-compressionformat-gzip": { "dfnID": "dom-compressionformat-gzip", "dfnText": "\"gzip\"", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-dom-compressionformat-gzip" }], "title": "3. Supported formats" }], "url": "#dom-compressionformat-gzip" },
                "dom-compressionstream-compressionstream": { "dfnID": "dom-compressionstream-compressionstream", "dfnText": "new CompressionStream(format)", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-dom-compressionstream-compressionstream" }], "title": "4. Interface CompressionStream" }], "url": "#dom-compressionstream-compressionstream" },
                "dom-compressionstream-compressionstream-format-format": { "dfnID": "dom-compressionstream-compressionstream-format-format", "dfnText": "format", "external": false, "refSections": [], "url": "#dom-compressionstream-compressionstream-format-format" },
                "dom-decompressionstream-decompressionstream": { "dfnID": "dom-decompressionstream-decompressionstream", "dfnText": "new DecompressionStream(format)", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-dom-decompressionstream-decompressionstream" }], "title": "5. Interface DecompressionStream" }], "url": "#dom-decompressionstream-decompressionstream" },
                "dom-decompressionstream-decompressionstream-format-format": { "dfnID": "dom-decompressionstream-decompressionstream-format-format", "dfnText": "format", "external": false, "refSections": [], "url": "#dom-decompressionstream-decompressionstream-format-format" },
                "eade7401": { "dfnID": "eade7401", "dfnText": "transform", "external": true, "refSections": [{ "refs": [{ "id": "ref-for-generictransformstream-transform" }, { "id": "ref-for-generictransformstream-transform\u2460" }, { "id": "ref-for-generictransformstream-transform\u2461" }, { "id": "ref-for-generictransformstream-transform\u2462" }], "title": "4. Interface CompressionStream" }, { "refs": [{ "id": "ref-for-generictransformstream-transform\u2463" }, { "id": "ref-for-generictransformstream-transform\u2464" }, { "id": "ref-for-generictransformstream-transform\u2465" }, { "id": "ref-for-generictransformstream-transform\u2466" }], "title": "5. Interface DecompressionStream" }], "url": "https://streams.spec.whatwg.org/#generictransformstream-transform" },
                "enumdef-compressionformat": { "dfnID": "enumdef-compressionformat", "dfnText": "CompressionFormat", "external": false, "refSections": [{ "refs": [{ "id": "ref-for-enumdef-compressionformat" }], "title": "4. Interface CompressionStream" }, { "refs": [{ "id": "ref-for-enumdef-compressionformat\u2460" }], "title": "5. Interface DecompressionStream" }], "url": "#enumdef-compressionformat" },
            };

            document.addEventListener("DOMContentLoaded", () => {
                genAllDfnPanels();

                document.body.addEventListener("click", (e) => {
                    // If not handled already, just hide all dfn panels.
                    hideAllDfnPanels();
                });
            });

            window.addEventListener("resize", () => {
                // Pin any visible dfn panel
                queryAll(".dfn-panel.on, .dfn-panel.activated").forEach(el => positionDfnPanel(el));
            });

            function genAllDfnPanels() {
                for (const panelData of Object.values(dfnPanelData)) {
                    const dfnID = panelData.dfnID;
                    const dfn = document.getElementById(dfnID);
                    if (!dfn) {
                        console.log(`Can't find dfn#${dfnID}.`, panelData);
                        continue;
                    }
                    dfn.panelData = panelData;
                    insertDfnPopupAction(dfn);
                }
            }

            function genDfnPanel(dfn, { dfnID, url, dfnText, refSections, external }) {
                const dfnPanel = mk.aside({
                    class: "dfn-panel on",
                    id: `infopanel-for-${dfnID}`,
                    "data-for": dfnID,
                    "aria-labelled-by": `infopaneltitle-for-${dfnID}`,
                },
                    mk.span({ id: `infopaneltitle-for-${dfnID}`, style: "display:none" },
                        `Info about the '${dfnText}' ${external ? "external" : ""} reference.`),
                    mk.a({ href: url, class: "dfn-link" }, url),
                    refSections.length == 0 ? [] :
                        mk.b({}, "Referenced in:"),
                    mk.ul({},
                        ...refSections.map(section =>
                            mk.li({},
                                ...section.refs.map((ref, refI) =>
                                    [
                                        mk.a({ href: `#${ref.id}` },
                                            (refI == 0) ? section.title : `(${refI + 1})`
                                        ),
                                        " ",
                                    ]
                                ),
                            ),
                        ),
                    ),
                    genLinkingSyntaxes(dfn),
                );

                dfnPanel.addEventListener('click', (event) => {
                    if (event.target.nodeName == 'A') {
                        scrollToTargetAndHighlight(event);
                        pinDfnPanel(dfnPanel);
                    }
                    event.stopPropagation();
                    refocusOnTarget(event);
                });
                dfnPanel.addEventListener('keydown', (event) => {
                    if (event.keyCode == 27) { // Escape key
                        hideDfnPanel({ dfnPanel });
                        event.stopPropagation();
                        event.preventDefault();
                    }
                });

                dfnPanel.dfn = dfn;
                dfn.dfnPanel = dfnPanel;
                return dfnPanel;
            }



            function hideAllDfnPanels() {
                // Delete the currently-active dfn panel.
                queryAll(".dfn-panel").forEach(dfnPanel => hideDfnPanel({ dfnPanel }));
            }

            function showDfnPanel(dfn) {
                hideAllDfnPanels(); // Only display one at a time.

                dfn.setAttribute("aria-expanded", "true");

                const dfnPanel = genDfnPanel(dfn, dfn.panelData);

                // Give the dfn a unique tabindex, and then
                // give all the tabbable panel bits successive indexes.
                let tabIndex = 100;
                dfn.tabIndex = tabIndex++;
                const tabbable = dfnPanel.querySelectorAll(":is(a, button)");
                for (const el of tabbable) {
                    el.tabIndex = tabIndex++;
                }

                append(document.body, dfnPanel);
                positionDfnPanel(dfnPanel);
            }

            function positionDfnPanel(dfnPanel) {
                const dfn = dfnPanel.dfn;
                const dfnPos = getBounds(dfn);
                dfnPanel.style.top = dfnPos.bottom + "px";
                dfnPanel.style.left = dfnPos.left + "px";

                const panelPos = dfnPanel.getBoundingClientRect();
                const panelMargin = 8;
                const maxRight = document.body.parentNode.clientWidth - panelMargin;
                if (panelPos.right > maxRight) {
                    const overflowAmount = panelPos.right - maxRight;
                    const newLeft = Math.max(panelMargin, dfnPos.left - overflowAmount);
                    dfnPanel.style.left = newLeft + "px";
                }
            }

            function pinDfnPanel(dfnPanel) {
                // Switch it to "activated" state, which pins it.
                dfnPanel.classList.add("activated");
                dfnPanel.style.position = "fixed";
                dfnPanel.style.left = null;
                dfnPanel.style.top = null;
            }

            function hideDfnPanel({ dfn, dfnPanel }) {
                if (!dfnPanel) dfnPanel = dfn.dfnPanel;
                if (!dfn) dfn = dfnPanel.dfn;
                dfn.dfnPanel = undefined;
                dfnPanel.dfn = undefined;
                dfn.setAttribute("aria-expanded", "false");
                dfn.tabIndex = undefined;
                dfnPanel.remove()
            }

            function toggleDfnPanel(dfn) {
                if (dfn.dfnPanel) {
                    hideDfnPanel(dfn);
                } else {
                    showDfnPanel(dfn);
                }
            }

            function insertDfnPopupAction(dfn) {
                dfn.setAttribute('role', 'button');
                dfn.setAttribute('aria-expanded', 'false')
                dfn.tabIndex = 0;
                dfn.classList.add('has-dfn-panel');
                dfn.addEventListener('click', (event) => {
                    toggleDfnPanel(dfn);
                    event.stopPropagation();
                });
                dfn.addEventListener('keypress', (event) => {
                    const kc = event.keyCode;
                    // 32->Space, 13->Enter
                    if (kc == 32 || kc == 13) {
                        toggleDfnPanel(dfn);
                        event.stopPropagation();
                        event.preventDefault();
                    }
                });
            }

            function refocusOnTarget(event) {
                const target = event.target;
                setTimeout(() => {
                    // Refocus on the event.target element.
                    // This is needed after browser scrolls to the destination.
                    target.focus();
                });
            }

            // TODO: shared util
            // Returns the root-level absolute position {left and top} of element.
            function getBounds(el, relativeTo = document.body) {
                const relativeRect = relativeTo.getBoundingClientRect();
                const elRect = el.getBoundingClientRect();
                const top = elRect.top - relativeRect.top;
                const left = elRect.left - relativeRect.left;
                return {
                    top,
                    left,
                    bottom: top + elRect.height,
                    right: left + elRect.width,
                }
            }

            function scrollToTargetAndHighlight(event) {
                let hash = event.target.hash;
                if (hash) {
                    hash = decodeURIComponent(hash.substring(1));
                    const dest = document.getElementById(hash);
                    if (dest) {
                        dest.classList.add('highlighted');
                        setTimeout(() => dest.classList.remove('highlighted'), 1000);
                    }
                }
            }

            // Functions, divided by link type, that wrap an autolink's
            // contents with the appropriate outer syntax.
            // Alternately, a string naming another type they format
            // the same as.
            function needsFor(type) {
                switch (type) {
                    case "descriptor":
                    case "value":
                    case "element-attr":
                    case "attr-value":
                    case "element-state":
                    case "method":
                    case "constructor":
                    case "argument":
                    case "attribute":
                    case "const":
                    case "dict-member":
                    case "event":
                    case "enum-value":
                    case "stringifier":
                    case "serializer":
                    case "iterator":
                    case "maplike":
                    case "setlike":
                    case "state":
                    case "mode":
                    case "context":
                    case "facet": return true;

                    default: return false;
                }
            }
            function refusesFor(type) {
                switch (type) {
                    case "property":
                    case "element":
                    case "interface":
                    case "namespace":
                    case "callback":
                    case "dictionary":
                    case "enum":
                    case "exception":
                    case "typedef":
                    case "http-header":
                    case "permission": return true;

                    default: return false;
                }
            }
            function linkFormatterFromType(type) {
                switch (type) {
                    case 'scheme':
                    case 'permission':
                    case 'dfn': return (text) => `[=${text}=]`;

                    case 'abstract-op': return (text) => `[\$${text}\$]`;

                    case 'function':
                    case 'at-rule':
                    case 'selector':
                    case 'value': return (text) => `''${text}''`;

                    case 'http-header': return (text) => `[:${text}:]`;

                    case 'interface':
                    case 'constructor':
                    case 'method':
                    case 'argument':
                    case 'attribute':
                    case 'callback':
                    case 'dictionary':
                    case 'dict-member':
                    case 'enum':
                    case 'enum-value':
                    case 'exception':
                    case 'const':
                    case 'typedef':
                    case 'stringifier':
                    case 'serializer':
                    case 'iterator':
                    case 'maplike':
                    case 'setlike':
                    case 'extended-attribute':
                    case 'event':
                    case 'idl': return (text) => `{{${text}}}`;

                    case 'element-state':
                    case 'element-attr':
                    case 'attr-value':
                    case 'element': return (element) => `<{${element}}>`;

                    case 'grammar': return (text) => `${text} (within a <pre class=prod>)`;

                    case 'type': return (text) => `<<${text}>>`;

                    case 'descriptor':
                    case 'property': return (text) => `'${text}'`;

                    default: return;
                };
            };

            function genLinkingSyntaxes(dfn) {
                if (dfn.tagName != "DFN") return;

                const type = dfn.getAttribute('data-dfn-type');
                if (!type) {
                    console.log(`<dfn> doesn't have a data-dfn-type:`, dfn);
                    return [];
                }

                // Return a function that wraps link text based on the type
                const linkFormatter = linkFormatterFromType(type);
                if (!linkFormatter) {
                    console.log(`<dfn> has an unknown data-dfn-type:`, dfn);
                    return [];
                }

                let ltAlts;
                if (dfn.hasAttribute('data-lt')) {
                    ltAlts = dfn.getAttribute('data-lt')
                        .split("|")
                        .map(x => x.trim());
                } else {
                    ltAlts = [dfn.textContent.trim()];
                }
                if (type == "type") {
                    // lt of "<foo>", but "foo" is the interior;
                    // <<foo/bar>> is how you write it with a for,
                    // not <foo/<bar>> or whatever.
                    for (var i = 0; i < ltAlts.length; i++) {
                        const lt = ltAlts[i];
                        const match = /<(.*)>/.exec(lt);
                        if (match) { ltAlts[i] = match[1]; }
                    }
                }

                let forAlts;
                if (dfn.hasAttribute('data-dfn-for')) {
                    forAlts = dfn.getAttribute('data-dfn-for')
                        .split(",")
                        .map(x => x.trim());
                } else {
                    forAlts = [''];
                }

                let linkingSyntaxes = [];
                if (!needsFor(type)) {
                    for (const lt of ltAlts) {
                        linkingSyntaxes.push(linkFormatter(lt));
                    }
                }
                if (!refusesFor(type)) {
                    for (const f of forAlts) {
                        linkingSyntaxes.push(linkFormatter(`${f}/${ltAlts[0]}`))
                    }
                }
                return [
                    mk.b({}, 'Possible linking syntaxes:'),
                    mk.ul({},
                        ...linkingSyntaxes.map(link => {
                            const copyLink = async () =>
                                await navigator.clipboard.writeText(link);
                            return mk.li({},
                                mk.div({ class: 'link-item' },
                                    mk.button({
                                        class: 'copy-icon', title: 'Copy',
                                        type: 'button',
                                        _onclick: copyLink,
                                        tabindex: 0,
                                    }, mk.span({ class: 'icon' })),
                                    mk.span({}, link)
                                )
                            );
                        })
                    )
                ];
            }
        }
    </script>
    <script>/* Boilerplate: script-position-annos */
        "use strict";
        {
            function repositionAnnoPanels() {
                const panels = [...document.querySelectorAll("[data-anno-for]")];
                hydratePanels(panels);
                let vSoFar = 0;
                for (const panel of panels.sort(cmpTops)) {
                    if (panel.top < vSoFar) {
                        panel.top = vSoFar;
                        panel.style.top = vSoFar + "px";
                    }
                    vSoFar = panel.top + panel.height + 15;
                }
            }
            function hydratePanels(panels) {
                const main = document.querySelector("main");
                let mainRect;
                if (main) mainRect = main.getBoundingClientRect();
                // First display them all, if they're not already visible.
                for (const panel of panels) {
                    panel.classList.remove("unpositioned");
                }
                // Measure them all
                for (const panel of panels) {
                    const dfn = document.getElementById(panel.getAttribute("data-anno-for"));
                    if (!dfn) {
                        console.log("Can't find the annotation panel target:", panel);
                        continue;
                    }
                    panel.dfn = dfn;
                    panel.top = window.scrollY + dfn.getBoundingClientRect().top;
                    let panelRect = panel.getBoundingClientRect();
                    panel.height = panelRect.height;
                    if (main) {
                        panel.overlappingMain = panelRect.left < mainRect.right;
                    } else {
                        panel.overlappingMain = false;
                    }
                }
                // And finally position them
                for (const panel of panels) {
                    const dfn = panel.dfn;
                    if (!dfn) continue;
                    panel.style.top = panel.top + "px";
                    panel.classList.toggle("overlapping-main", panel.overlappingMain);
                }
            }

            function cmpTops(a, b) {
                return a.top - b.top;
            }

            window.addEventListener("load", repositionAnnoPanels);
            window.addEventListener("resize", repositionAnnoPanels);
        }
    </script>
    <script>/* Boilerplate: script-ref-hints */
        "use strict";
        {
            let refsData = {
                "#compress-and-enqueue-a-chunk": { "displayText": "compress and enqueue a chunk", "export": true, "for_": [], "level": "", "normative": true, "shortname": "compression", "spec": "compression", "status": "local", "text": "compress and enqueue a chunk", "type": "dfn", "url": "#compress-and-enqueue-a-chunk" },
                "#compress-flush-and-enqueue": { "displayText": "compress flush and enqueue", "export": true, "for_": [], "level": "", "normative": true, "shortname": "compression", "spec": "compression", "status": "local", "text": "compress flush and enqueue", "type": "dfn", "url": "#compress-flush-and-enqueue" },
                "#compression-context": { "displayText": "compression context", "export": true, "for_": [], "level": "", "normative": true, "shortname": "compression", "spec": "compression", "status": "local", "text": "compression context", "type": "dfn", "url": "#compression-context" },
                "#compressionstream": { "displayText": "CompressionStream", "export": true, "for_": [], "level": "", "normative": true, "shortname": "compression", "spec": "compression", "status": "local", "text": "CompressionStream", "type": "interface", "url": "#compressionstream" },
                "#compressionstream-context": { "displayText": "context", "export": true, "for_": ["CompressionStream"], "level": "", "normative": true, "shortname": "compression", "spec": "compression", "status": "local", "text": "context", "type": "dfn", "url": "#compressionstream-context" },
                "#compressionstream-format": { "displayText": "format", "export": true, "for_": ["CompressionStream"], "level": "", "normative": true, "shortname": "compression", "spec": "compression", "status": "local", "text": "format", "type": "dfn", "url": "#compressionstream-format" },
                "#decompress-and-enqueue-a-chunk": { "displayText": "decompress and enqueue a chunk", "export": true, "for_": [], "level": "", "normative": true, "shortname": "compression", "spec": "compression", "status": "local", "text": "decompress and enqueue a chunk", "type": "dfn", "url": "#decompress-and-enqueue-a-chunk" },
                "#decompress-flush-and-enqueue": { "displayText": "decompress flush and enqueue", "export": true, "for_": [], "level": "", "normative": true, "shortname": "compression", "spec": "compression", "status": "local", "text": "decompress flush and enqueue", "type": "dfn", "url": "#decompress-flush-and-enqueue" },
                "#decompressionstream": { "displayText": "DecompressionStream", "export": true, "for_": [], "level": "", "normative": true, "shortname": "compression", "spec": "compression", "status": "local", "text": "DecompressionStream", "type": "interface", "url": "#decompressionstream" },
                "#decompressionstream-context": { "displayText": "context", "export": true, "for_": ["DecompressionStream"], "level": "", "normative": true, "shortname": "compression", "spec": "compression", "status": "local", "text": "context", "type": "dfn", "url": "#decompressionstream-context" },
                "#decompressionstream-format": { "displayText": "format", "export": true, "for_": ["DecompressionStream"], "level": "", "normative": true, "shortname": "compression", "spec": "compression", "status": "local", "text": "format", "type": "dfn", "url": "#decompressionstream-format" },
                "#dom-compressionformat-deflate": { "displayText": "\"deflate\"", "export": true, "for_": ["CompressionFormat"], "level": "", "normative": true, "shortname": "compression", "spec": "compression", "status": "local", "text": "\"deflate\"", "type": "enum-value", "url": "#dom-compressionformat-deflate" },
                "#dom-compressionformat-deflate-raw": { "displayText": "\"deflate-raw\"", "export": true, "for_": ["CompressionFormat"], "level": "", "normative": true, "shortname": "compression", "spec": "compression", "status": "local", "text": "\"deflate-raw\"", "type": "enum-value", "url": "#dom-compressionformat-deflate-raw" },
                "#dom-compressionformat-gzip": { "displayText": "\"gzip\"", "export": true, "for_": ["CompressionFormat"], "level": "", "normative": true, "shortname": "compression", "spec": "compression", "status": "local", "text": "\"gzip\"", "type": "enum-value", "url": "#dom-compressionformat-gzip" },
                "#dom-compressionstream-compressionstream": { "displayText": "CompressionStream(format)", "export": true, "for_": ["CompressionStream"], "level": "", "normative": true, "shortname": "compression", "spec": "compression", "status": "local", "text": "CompressionStream(format)", "type": "constructor", "url": "#dom-compressionstream-compressionstream" },
                "#dom-decompressionstream-decompressionstream": { "displayText": "DecompressionStream(format)", "export": true, "for_": ["DecompressionStream"], "level": "", "normative": true, "shortname": "compression", "spec": "compression", "status": "local", "text": "DecompressionStream(format)", "type": "constructor", "url": "#dom-decompressionstream-decompressionstream" },
                "#enumdef-compressionformat": { "displayText": "CompressionFormat", "export": true, "for_": [], "level": "", "normative": true, "shortname": "compression", "spec": "compression", "status": "local", "text": "CompressionFormat", "type": "enum", "url": "#enumdef-compressionformat" },
                "https://infra.spec.whatwg.org/#list-iterate": { "displayText": "for each", "export": true, "for_": ["list", "set"], "level": "1", "normative": true, "shortname": "infra", "spec": "infra", "status": "current", "text": "for each", "type": "dfn", "url": "https://infra.spec.whatwg.org/#list-iterate" },
                "https://streams.spec.whatwg.org/#generictransformstream": { "displayText": "GenericTransformStream", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "streams", "spec": "streams", "status": "current", "text": "GenericTransformStream", "type": "interface", "url": "https://streams.spec.whatwg.org/#generictransformstream" },
                "https://streams.spec.whatwg.org/#generictransformstream-transform": { "displayText": "transform", "export": true, "for_": ["GenericTransformStream"], "level": "1", "normative": true, "shortname": "streams", "spec": "streams", "status": "current", "text": "transform", "type": "dfn", "url": "https://streams.spec.whatwg.org/#generictransformstream-transform" },
                "https://streams.spec.whatwg.org/#readablestream": { "displayText": "ReadableStream", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "streams", "spec": "streams", "status": "current", "text": "ReadableStream", "type": "interface", "url": "https://streams.spec.whatwg.org/#readablestream" },
                "https://streams.spec.whatwg.org/#transformstream": { "displayText": "TransformStream", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "streams", "spec": "streams", "status": "current", "text": "TransformStream", "type": "interface", "url": "https://streams.spec.whatwg.org/#transformstream" },
                "https://streams.spec.whatwg.org/#transformstream-enqueue": { "displayText": "enqueue", "export": true, "for_": ["TransformStream"], "level": "1", "normative": true, "shortname": "streams", "spec": "streams", "status": "current", "text": "enqueue", "type": "dfn", "url": "https://streams.spec.whatwg.org/#transformstream-enqueue" },
                "https://streams.spec.whatwg.org/#transformstream-set-up": { "displayText": "set up", "export": true, "for_": ["TransformStream"], "level": "1", "normative": true, "shortname": "streams", "spec": "streams", "status": "current", "text": "set up", "type": "dfn", "url": "https://streams.spec.whatwg.org/#transformstream-set-up" },
                "https://streams.spec.whatwg.org/#transformstream-set-up-flushalgorithm": { "displayText": "flushAlgorithm", "export": true, "for_": ["TransformStream/set up"], "level": "1", "normative": true, "shortname": "streams", "spec": "streams", "status": "current", "text": "flushalgorithm", "type": "dfn", "url": "https://streams.spec.whatwg.org/#transformstream-set-up-flushalgorithm" },
                "https://streams.spec.whatwg.org/#transformstream-set-up-transformalgorithm": { "displayText": "transformAlgorithm", "export": true, "for_": ["TransformStream/set up"], "level": "1", "normative": true, "shortname": "streams", "spec": "streams", "status": "current", "text": "transformalgorithm", "type": "dfn", "url": "https://streams.spec.whatwg.org/#transformstream-set-up-transformalgorithm" },
                "https://streams.spec.whatwg.org/#writablestream": { "displayText": "WritableStream", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "streams", "spec": "streams", "status": "current", "text": "WritableStream", "type": "interface", "url": "https://streams.spec.whatwg.org/#writablestream" },
                "https://webidl.spec.whatwg.org/#BufferSource": { "displayText": "BufferSource", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "webidl", "spec": "webidl", "status": "current", "text": "BufferSource", "type": "typedef", "url": "https://webidl.spec.whatwg.org/#BufferSource" },
                "https://webidl.spec.whatwg.org/#exceptiondef-typeerror": { "displayText": "TypeError", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "webidl", "spec": "webidl", "status": "current", "text": "TypeError", "type": "exception", "url": "https://webidl.spec.whatwg.org/#exceptiondef-typeerror" },
                "https://webidl.spec.whatwg.org/#idl-Uint8Array": { "displayText": "Uint8Array", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "webidl", "spec": "webidl", "status": "current", "text": "Uint8Array", "type": "interface", "url": "https://webidl.spec.whatwg.org/#idl-Uint8Array" },
                "https://webidl.spec.whatwg.org/#new": { "displayText": "new", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "webidl", "spec": "webidl", "status": "current", "text": "new", "type": "dfn", "url": "https://webidl.spec.whatwg.org/#new" },
                "https://webidl.spec.whatwg.org/#this": { "displayText": "this", "export": true, "for_": [], "level": "1", "normative": true, "shortname": "webidl", "spec": "webidl", "status": "current", "text": "this", "type": "dfn", "url": "https://webidl.spec.whatwg.org/#this" },
            };

            function mkRefHint(link, ref) {
                const linkText = link.textContent;
                let dfnTextElements = '';
                if (ref.displayText.toLowerCase() != linkText.toLowerCase()) {
                    // Give the original term if it's being displayed in a different way.
                    // But allow casing differences, they're insignificant.
                    dfnTextElements =
                        mk.li({},
                            mk.b({}, "Term: "),
                            mk.span({}, ref.displayText)
                        );
                }
                const forList = ref.for_;
                let forListElements;
                if (forList.length == 0) {
                    forListElements = [];
                } else if (forList.length == 1) {
                    forListElements = mk.li({},
                        mk.b({}, "For: "),
                        mk.span({}, forList[0]),
                    );
                } else {
                    forListElements = mk.li({},
                        mk.b({}, "For: "),
                        mk.ul({},
                            ...forList.map(forItem =>
                                mk.li({},
                                    mk.span({}, forItem)
                                ),
                            ),
                        ),
                    );
                }
                const url = ref.url;
                const safeUrl = encodeURIComponent(url);
                const hintPanel = mk.aside({
                    class: "ref-hint",
                    id: `ref-hint-for-${safeUrl}`,
                    "data-for": url,
                    "aria-labelled-by": `ref-hint-for-${safeUrl}`,
                },
                    mk.ul({},
                        dfnTextElements,
                        mk.li({},
                            mk.b({}, "URL: "),
                            mk.a({ href: url, class: "ref" }, url),
                        ),
                        mk.li({},
                            mk.b({}, "Type: "),
                            mk.span({}, `${ref.type}`),
                        ),
                        mk.li({},
                            mk.b({}, "Spec: "),
                            mk.span({}, `${ref.spec ? ref.spec : ''}`),
                        ),
                        forListElements
                    ),
                );
                hintPanel.forLink = link;
                setupRefHintEventListeners(link, hintPanel);
                return hintPanel;
            }

            function hideAllRefHints() {
                queryAll(".ref-hint").forEach(el => hideRefHint(el));
            }

            function hideRefHint(refHint) {
                const link = refHint.forLink;
                link.setAttribute("aria-expanded", "false");
                if (refHint.teardownEventListeners) {
                    refHint.teardownEventListeners();
                }
                refHint.remove();
            }

            function showRefHint(link) {
                if (link.classList.contains("dfn-link")) return;
                const url = link.getAttribute("href");
                const refHintKey = link.getAttribute("data-refhint-key");
                let key = url;
                if (refHintKey) {
                    key = refHintKey + "_" + url;
                }
                const ref = refsData[key];
                if (!ref) return;

                hideAllRefHints(); // Only display one at this time.

                const refHint = mkRefHint(link, ref);
                append(document.body, refHint);
                link.setAttribute("aria-expanded", "true");
                positionRefHint(refHint);
            }

            function setupRefHintEventListeners(link, refHint) {
                if (refHint.teardownEventListeners) return;
                // Add event handlers to hide the refHint after the user moves away
                // from both the link and refHint, if not hovering either within one second.
                let timeout = null;
                const startHidingRefHint = (event) => {
                    if (timeout) {
                        clearTimeout(timeout);
                    }
                    timeout = setTimeout(() => {
                        hideRefHint(refHint);
                    }, 1000);
                }
                const resetHidingRefHint = (event) => {
                    if (timeout) clearTimeout(timeout);
                    timeout = null;
                };
                link.addEventListener("mouseleave", startHidingRefHint);
                link.addEventListener("mouseenter", resetHidingRefHint);
                link.addEventListener("blur", startHidingRefHint);
                link.addEventListener("focus", resetHidingRefHint);
                refHint.addEventListener("mouseleave", startHidingRefHint);
                refHint.addEventListener("mouseenter", resetHidingRefHint);
                refHint.addEventListener("blur", startHidingRefHint);
                refHint.addEventListener("focus", resetHidingRefHint);

                refHint.teardownEventListeners = () => {
                    // remove event listeners
                    resetHidingRefHint();
                    link.removeEventListener("mouseleave", startHidingRefHint);
                    link.removeEventListener("mouseenter", resetHidingRefHint);
                    link.removeEventListener("blur", startHidingRefHint);
                    link.removeEventListener("focus", resetHidingRefHint);
                    refHint.removeEventListener("mouseleave", startHidingRefHint);
                    refHint.removeEventListener("mouseenter", resetHidingRefHint);
                    refHint.removeEventListener("blur", startHidingRefHint);
                    refHint.removeEventListener("focus", resetHidingRefHint);
                };
            }

            function positionRefHint(refHint) {
                const link = refHint.forLink;
                const linkPos = getBounds(link);
                refHint.style.top = linkPos.bottom + "px";
                refHint.style.left = linkPos.left + "px";

                const panelPos = refHint.getBoundingClientRect();
                const panelMargin = 8;
                const maxRight = document.body.parentNode.clientWidth - panelMargin;
                if (panelPos.right > maxRight) {
                    const overflowAmount = panelPos.right - maxRight;
                    const newLeft = Math.max(panelMargin, linkPos.left - overflowAmount);
                    refHint.style.left = newLeft + "px";
                }
            }

            // TODO: shared util
            // Returns the root-level absolute position {left and top} of element.
            function getBounds(el, relativeTo = document.body) {
                const relativeRect = relativeTo.getBoundingClientRect();
                const elRect = el.getBoundingClientRect();
                const top = elRect.top - relativeRect.top;
                const left = elRect.left - relativeRect.left;
                return {
                    top,
                    left,
                    bottom: top + elRect.height,
                    right: left + elRect.width,
                }
            }

            function showRefHintListener(e) {
                // If the target isn't in a link (or is a link),
                // just ignore it.
                let link = e.target.closest("a");
                if (!link) return;

                // If the target is in a ref-hint panel
                // (aka a link in the already-open one),
                // also just ignore it.
                if (link.closest(".ref-hint")) return;

                // Otherwise, show the panel for the link.
                showRefHint(link);
            }

            function hideAllHintsListener(e) {
                // If the click is inside a ref-hint panel, ignore it.
                if (e.target.closest(".ref-hint")) return;
                // Otherwise, close all the current panels.
                hideAllRefHints();
            }

            document.addEventListener("DOMContentLoaded", () => {
                document.body.addEventListener("mousedown", showRefHintListener);
                document.body.addEventListener("focus", showRefHintListener);

                document.body.addEventListener("click", hideAllHintsListener);
            });

            window.addEventListener("resize", () => {
                // Hide any open ref hint.
                hideAllRefHints();
            });
        }
    </script>
    <script>/* Boilerplate: script-var-click-highlighting */
        "use strict";
        {
            /*
            Color-choosing design:
            
            * Colors are ordered by goodness.
            * On clicking a var, give it the earliest color
                with the lowest usage in the algorithm.
            * On re-clicking, re-use the var's most recent color
                if that's not currently being used elsewhere.
            */

            const COLOR_COUNT = 7;

            document.addEventListener("click", e => {
                if (e.target.nodeName == "VAR") {
                    highlightSameAlgoVars(e.target);
                }
            });

            function highlightSameAlgoVars(v) {
                // Find the algorithm container.
                let algoContainer = findAlgoContainer(v);

                // Not highlighting document-global vars,
                // too likely to be unrelated.
                if (algoContainer == null) return;

                const varName = nameFromVar(v);
                if (!v.hasAttribute("data-var-color")) {
                    const newColor = chooseHighlightColor(algoContainer, v);
                    for (const el of algoContainer.querySelectorAll("var")) {
                        if (nameFromVar(el) == varName) {
                            el.setAttribute("data-var-color", newColor);
                            el.setAttribute("data-var-last-color", newColor);
                        }
                    }
                } else {
                    for (const el of algoContainer.querySelectorAll("var")) {
                        if (nameFromVar(el) == varName) {
                            el.removeAttribute("data-var-color");
                        }
                    }
                }
            }
            function findAlgoContainer(el) {
                while (el != document.body) {
                    if (el.hasAttribute("data-algorithm")) return el;
                    el = el.parentNode;
                }
                return null;
            }
            function nameFromVar(el) {
                return el.textContent.replace(/(\s|\xa0)+/g, " ").trim();
            }
            function colorCountsFromContainer(container) {
                const namesFromColor = Array.from({ length: COLOR_COUNT }, x => new Set());
                for (let v of container.querySelectorAll("var[data-var-color]")) {
                    let color = +v.getAttribute("data-var-color");
                    namesFromColor[color].add(nameFromVar(v));
                }

                return namesFromColor.map(x => x.size);
            }
            function leastUsedColor(colors) {
                // Find the earliest color with the lowest count.
                let minCount = Infinity;
                let minColor = null;
                for (var i = 0; i < colors.length; i++) {
                    if (colors[i] < minCount) {
                        minColor = i;
                        minCount = colors[i];
                    }
                }
                return minColor;
            }
            function chooseHighlightColor(container, v) {
                const colorCounts = colorCountsFromContainer(container);
                if (v.hasAttribute("data-var-last-color")) {
                    let color = +v.getAttribute("data-var-last-color");
                    if (colorCounts[color] == 0) return color;
                }
                return leastUsedColor(colorCounts);
            }
        }
    </script>